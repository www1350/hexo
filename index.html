<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/hexo/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hexo/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hexo/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/hexo/images/logo.svg" color="#222">

<link rel="stylesheet" href="/hexo/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www1350.github.io","root":"/hexo/","images":"/hexo/images","scheme":"Mist","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/hexo/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/hexo/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="Absurd博客">
<meta property="og:url" content="https://www1350.github.io/hexo/index.html">
<meta property="og:site_name" content="Absurd博客">
<meta property="og:locale">
<meta property="article:author" content="Absurd">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www1350.github.io/hexo/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Absurd博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/hexo/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/hexo/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Absurd博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/hexo/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/hexo/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/hexo/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/hexo/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/hexo/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-bookmarks"><a href="/hexo/bookmarks/" rel="section"><i class="fa fa-archive fa-fw"></i>bookmarks</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Absurd"
      src="/hexo/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Absurd</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/hexo/archives/">
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/hexo/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/hexo/tags/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/www1350" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;www1350" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:www_1350@163.com" title="E-Mail → mailto:www_1350@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/1690d21b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/1690d21b.html" class="post-title-link" itemprop="url">函数式编程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-09 23:06:59" itemprop="dateCreated datePublished" datetime="2022-03-09T23:06:59+08:00">2022-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-03-11 00:01:59" itemprop="dateModified" datetime="2022-03-11T00:01:59+08:00">2022-03-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="编程范式"><a href="#编程范式" class="headerlink" title="编程范式"></a>编程范式</h2><p>Programming paradigm(编程范式) 是指某种编程语言典型的编程风格或编程方式。 编程范式是编程语言的一种分类方式，它并不针对某种编程语言。就编程语言而言，一种编程语言也可以适用多种编程范式。</p>
<p>常见的编程范型有：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%87%BD%E6%95%B8%E5%BC%8F%E7%B7%A8%E7%A8%8B">函数式编程</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8C%87%E4%BB%A4%E5%BC%8F%E7%BC%96%E7%A8%8B">指令式编程</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BF%87%E7%A8%8B%E5%BC%8F%E7%BC%96%E7%A8%8B">过程式编程</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B">面向对象编程</a>等等。</p>
<h3 id="指令式编程"><a href="#指令式编程" class="headerlink" title="指令式编程"></a>指令式编程</h3><p><strong>指令式编程、命令式编程</strong>（英语：Imperative programming）；是一种描述电脑所需作出的行为的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B7%A8%E7%A8%8B%E5%85%B8%E7%AF%84">编程典范</a>。几乎所有电脑的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%A1%AC%E9%AB%94">硬件</a>都是指令式工作；几乎所有电脑的硬件都是能执行<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%A9%9F%E5%99%A8%E7%A2%BC">机器代码</a>，而机器代码是使用指令式的风格来写的。较高端的指令式<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B7%A8%E7%A8%8B%E8%AA%9E%E8%A8%80">编程语言</a>使用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%8A%E6%95%B8">变量</a>和更复杂的语句，但仍依从相同的典范。菜谱和行动清单，虽非计算机程序，但与指令式编程有相似的风格：每步都是指令。因为指令式编程的基础观念，不但概念上比较熟悉，而且较容易具体表现于硬件，所以大部分的编程语言都是指令式的。</p>
<h4 id="原理和基础"><a href="#原理和基础" class="headerlink" title="原理和基础"></a>原理和基础</h4><p>很多指令式编程语言（比如<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Fortran">Fortran</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/BASIC">BASIC</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%E8%AF%AD%E8%A8%80">C</a>）是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80">汇编语言</a>的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E5%8C%96_(%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A7%91%E5%AD%B8)">抽象化</a>。</p>
<p>大部分的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%AB%98%E7%BA%A7%E8%AF%AD%E8%A8%80">高级语言</a>都支持四种基本的语句：</p>
<ol>
<li><strong>运算语句</strong>一般来说都表现了在存储器内的资料进行运算的行为，然后将结果存入存储器中以便日后使用。高端指令式编程语言更能处理复杂的表达式，可能会产生四则运算和函数计算的结合。</li>
<li><strong>循环语句</strong>容许一些语句反复执行数次。循环可依据一个默认的数目来决定执行这些语句的次数；或反复执行它们，直至某些条件改变。</li>
<li><strong>条件分支语句</strong>容许仅当某些条件成立时才执行某个区块。否则，这个区块中的语句会略去，然后按区块后的语句继续执行。</li>
<li><strong>无条件分支语句</strong>容许执行顺序转移到程序的其他部分之中。包括跳跃（在很多语言中称为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Goto">Goto</a>）、副程序和Procedure等。</li>
</ol>
<p>循环、条件分支和无条件分支都是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B">控制流程</a>。</p>
<p>一些语言，如：Fortran, <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/java/">Java</a>, <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/c-programming-language/">C</a>, <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/c-plus-plus/">C++</a> </p>
<h3 id="声明式编程"><a href="#声明式编程" class="headerlink" title="声明式编程"></a>声明式编程</h3><p><strong>声明式编程</strong>（英语：Declarative programming）或译为声明式编程，是对与<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8C%87%E4%BB%A4%E5%BC%8F%E7%B7%A8%E7%A8%8B">命令式编程</a>不同的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%9E%8B">编程范型</a>的一种合称。它们建造计算机程序的结构和元素，表达<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97">计算</a>的逻辑而不用描述它的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B">控制流程</a>。开发人员更关心的答案。它声明那种我们想要的结果,编程语言只关注如何产生</p>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul>
<li>命令式编程：命令“机器”如何去做事情(how)，这样不管你想要的是什么(what)，它都会按照你的命令实现。</li>
<li>声明式编程：告诉“机器”你想要的是什么(what)，让机器想出如何去做(how)。</li>
</ul>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/157470078-42270eb9-131b-46f4-a7a6-7b8d38d177a7-20220309233741541.png" alt="img"></p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646646643161-8f4178d6-cb26-4802-a3e6-059d5f87ad6a.png" alt="image.png"></p>
<p>现在下面这样的表达式</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>+<span class="number">2</span>) * <span class="number">8</span> / <span class="number">4</span></span><br></pre></td></tr></table></figure>



<p>命令式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span> + <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> b = a * <span class="number">8</span>;</span><br><span class="line"><span class="keyword">int</span> c = b / <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<p>声明式</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">divide(multiply(add(<span class="number">1</span>, <span class="number">2</span>), <span class="number">3</span>), <span class="number">4</span>)</span><br></pre></td></tr></table></figure>



<h3 id="过程式编程"><a href="#过程式编程" class="headerlink" title="过程式编程"></a>过程式编程</h3><p><strong>过程式程序设计</strong>（英语：Procedural programming），又称过程化编程，一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B7%A8%E7%A8%8B%E5%85%B8%E7%AF%84">编程典范</a>，派生自<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8C%87%E4%BB%A4%E5%BC%8F%E7%B7%A8%E7%A8%8B">指令式编程</a>，有时会被视为是同义语。主要要采取<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%90%E7%A8%8B%E5%BA%8F">过程调用</a>或函数调用的方式来进行<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6">流程控制</a>。流程则由包涵一系列运算步骤的过程（Procedures），例程（routines），<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%90%E7%A8%8B%E5%BA%8F">子程序</a>（subroutines）, 方法（methods），或函数（functions）来控制。在程序执行的任何一个时间点，都可以调用某个特定的程序。任何一个特定的程序，也能被任意一个程序或是它自己本身调用。</p>
<p>过程化语言适合解决线性的算法问题，强调“自上而下”、“精益求精”的设计方式。</p>
<p>最初的主要过程式编程语言出现在大约1957年至1964年，包括<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Fortran">Fortran</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ALGOL">ALGOL</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/COBOL">COBOL</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PL/I">PL/I</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/BASIC">BASIC</a>，后来的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Pascal_(%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80)">Pascal</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%E8%AF%AD%E8%A8%80">C</a>发表于大约1970年至1972年。</p>
<h3 id="面向对象编程"><a href="#面向对象编程" class="headerlink" title="面向对象编程"></a>面向对象编程</h3><p><strong>面向对象程序设计</strong>（英语：Object-oriented programming，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BC%A9%E5%86%99">缩写</a>：OOP）是种具有<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AF%B9%E8%B1%A1_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">对象</a>概念的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%9E%8B">编程典范</a>，同时也是一种程序开发的抽象方针。它可能包含<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE">数据</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%89%B9%E6%80%A7_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">特性</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%BA%90%E4%BB%A3%E7%A0%81">代码</a>与<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%96%B9%E6%B3%95_(%E9%9B%BB%E8%85%A6%E7%A7%91%E5%AD%B8)">方法</a>。对象则指的是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B1%BB_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">类</a>（class）的实例。它将<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%89%A9%E4%BB%B6_(%E9%9B%BB%E8%85%A6%E7%A7%91%E5%AD%B8)">对象</a>作为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F">程序</a>的基本单元，将程序和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE">数据</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B0%81%E8%A3%9D_(%E7%89%A9%E4%BB%B6%E5%B0%8E%E5%90%91%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88)">封装</a>其中，以提高软件的重用性、灵活性和扩展性，对象里的程序可以访问及经常修改对象相关连的数据。在面向对象程序编程里，计算机程序会被设计成彼此相关的对象。</p>
<p>重要的面向对象编程语言包含<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Common_Lisp">Common Lisp</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Python">Python</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%2B%2B">C++</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Objective-C">Objective-C</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Smalltalk">Smalltalk</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Delphi">Delphi</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Java">Java</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Swift_(%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80)">Swift</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%E2%99%AF">C#</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Perl">Perl</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Ruby">Ruby</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JavaScript">JavaScript</a> 与 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PHP">PHP</a>等。</p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20220309233528183-6840323.png" alt="image-20220309233528183"></p>
<h3 id="并行编程模式"><a href="#并行编程模式" class="headerlink" title="并行编程模式"></a>并行编程模式</h3><p>在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6">计算机科学</a>中，<strong>并行编程模型</strong>（Parallel programming model）是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97">并行计算机</a>架构的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E5%8C%96_(%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A7%91%E5%AD%B8)">抽象化</a>，通过它可方便的表达<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%AE%97%E6%B3%95">算法</a>和它们在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A8%8B%E5%BA%8F">程序</a>中的合成。判别编程模型的价值可以通过它的通用性：在各种不同架构上能表达多大范围的不同问题，和它的性能：编译的程序在执行时有多高的效率[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B#cite_note-Skillicorn-1">1]</a>。并行编程模型的实现形式可以是从“顺序编程”语言中调用的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%87%BD%E5%BC%8F%E5%BA%AB">函数库</a>，作为现存语言的扩展，或作为全新的语言。</p>
<p>围绕特定编程模型的共识是很重要的，这可导致建造不同的并行计算机来支持这个模型，从而促进软件的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BB%9F%E9%AB%94%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%80%A7">可移植性</a>。在这个意义上，编程模型被称为在硬件和软件之间的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%9E%8B&action=edit&redlink=1">桥接</a>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B#cite_note-Valiant1990-2">2]</a>。</p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646723393125-4ee8e029-5dcd-4f9f-b8b5-f12af590eab8-20220311000150546.png" alt="image.png"></p>
<p>关键：</p>
<ul>
<li>任务分解，识别出多个能够并发执行的任务</li>
<li>数据分解，识别出从属于每个任务的局部数据</li>
<li>分组任务和排序分组的方式满足时间约束</li>
<li>任务之间的依赖分析</li>
</ul>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646723405108-44c8f62d-6eca-465d-86ce-9945b18b3f0a.png" alt="img"></p>
<p>关键：</p>
<ul>
<li>任务并行，重点要解决任务之间的依赖性，解决顺序依赖约束和共享数据依赖约束，可以通过消除依赖、分离依赖等方式解决；通过轮询、工作窃取法等方式来实现调度</li>
<li></li>
</ul>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646723420340-41d09cf6-6f16-42fc-920d-3c7d218c9c91-6840367.png" alt="img"></p>
<p>关键：</p>
<ul>
<li>SPMD（单程序多数据）。在SPMD程序中，所有UE（执行单元）并行执行同一个程序（单程序），但每个UE都拥有自己的私有数据集（多数据）</li>
<li>主从模式。主进程为从进程建立一个工作池和一个任务包。所有从进程并发执行，每个从进程迭代的从任务包中移除一个任务并处理它，指导所有任务都处理完毕或到达某些终止条件为止</li>
<li>循环并行。该模式解决计算密集型循环为主导串行程序转成并行程序时出现的问题</li>
<li>派生聚合模式Fork/Join 模式。一个主UE里面Fork出多个子的UE，这些子UE并行完成任务的一部分，等待这一步的全部子UE完成了这些任务之后，进行聚合操作。</li>
<li>共享数据。解决多个UE共享数据时常见问题，并讨论正确性和性能。<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98">共享内存</a>是在进程间传递数据的高效方式。在共享内存模型中，并行进程共享它们可以异步读与写的全局地址空间。异步并发访问可能导致<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%AB%9E%E4%BA%89%E6%9D%A1%E4%BB%B6">竞争条件</a>，和用来避免它们的机制如：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%94%81_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">锁</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BF%A1%E5%8F%B7%E9%87%8F">信号量</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%9B%91%E8%A7%86%E5%99%A8_(%E7%A8%8B%E5%BA%8F%E5%90%8C%E6%AD%A5%E5%8C%96)">监视器</a>。常规的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E6%A0%B8%E5%A4%84%E7%90%86%E5%99%A8">多核处理器</a>直接支持共享内存</li>
<li>分布式数组模式。一维或多维数组，被划分为多个子数组，并在进程或线程间进行分配</li>
</ul>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646723444427-c4d5040f-4fb8-40e8-9029-d8326dd23d62-6840376.png" alt="img"></p>
<p>关键：</p>
<ul>
<li>UE管理。线程/进程的创建和销毁</li>
<li>同步。内存同步和围栅、栏栅、互斥</li>
<li>通信。消息传递、集合通信</li>
</ul>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646646751422-c6d6dd51-5936-43d7-b357-90e299f9f76e-6840384.png" alt="img"></p>
<h3 id="逻辑编程"><a href="#逻辑编程" class="headerlink" title="逻辑编程"></a>逻辑编程</h3><p>逻辑编程是种编程典范，它设定答案须符合的规则来解决问题，而非设定步骤来解决问题，过程是事实+规则=结果。</p>
<p>事实</p>
<p>实际上，每个逻辑程序都需要使用事实才能实现给定的目标。事实基本上是关于程序和数据的真实陈述。例如，新德里是印度的首都。</p>
<p>规则</p>
<p>实际上，规则是允许我们对问题域做出结论的约束。规则基本上写成逻辑条款来表达各种事实。例如，如果我们正在构建任何游戏，那么必须定义所有规则。</p>
<p>规则对于解决逻辑编程中的任何问题非常重要。规则基本上是逻辑结论，可以表达事实。以下是规则的语法</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A∶− B1,B2,...,Bn.</span><br></pre></td></tr></table></figure>

<p>这里，A是头部，B1，B2，… Bn是身体。</p>
<p>例如 − ancestor(X,Y) :- father(X,Y).</p>
<p>ancestor(X,Z) :- father(X,Y), ancestor(Y,Z).</p>
<p>这可以理解为，对于每个X和Y，如果X是Y的父亲而Y是Z的祖先，则X是Z的祖先。对于每个X和Y，X是Z的祖先，如果X是Y和Y的父亲是Z的祖先。</p>
<p>python-kanren</p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646727263171-2b1c6cb6-7791-4703-843d-e21ee7509e08.png" alt="img"></p>
<h3 id="数据驱动编程"><a href="#数据驱动编程" class="headerlink" title="数据驱动编程"></a>数据驱动编程</h3><p>在计算机编程中，<strong>数据驱动</strong>编程，是一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F">编程范式</a>，在其中程序语句描述要匹配的数据，和对它需要做的处理，程序本身不定义选取数据的一序列文件操作步骤[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8%E7%BC%96%E7%A8%8B#cite_note-awk-1">1]</a>。数据驱动语言的标准例子是文本处理语言<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Sed">sed</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/AWK">AWK</a>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8%E7%BC%96%E7%A8%8B#cite_note-awk-1">1]</a>，在其中数据是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%A8%99%E6%BA%96%E4%B8%B2%E6%B5%81">输入流</a>中的一序列的行，因而它们也叫面向行的语言，而<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D">模式匹配</a>主要通过<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F">正则表达式</a>或行号来完成。</p>
<p>在数据驱动的编程中,由数据本身驱动程序的逻辑。在游戏编程中,通常是数据驱动的编程方式使用某种形式的脚本语言。游戏的行为由变化的数据文件决定,而不做任何重新编译。</p>
<p>无数据驱动的时候</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data_lloyd = &#123;&#x27;name&#x27;: &#x27;Lloyd&#x27;, &#x27;lives&#x27;: &#x27;Alcoy &#125;</span><br><span class="line">data_jason = &#123;&#x27;name&#x27;: &#x27;Jason&#x27;, &#x27;lives&#x27;: &#x27;London&#x27; &#125;</span><br><span class="line">go = function(x) </span><br><span class="line">    if x.name == &#x27;Lloyd&#x27; </span><br><span class="line">    then </span><br><span class="line">        print(&quot;Alcoy, Spain&quot;) </span><br><span class="line">    else </span><br><span class="line">        print(&quot;London, UK&quot;) </span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<p>数据驱动</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data_lloyd = &#123;&#x27;name&#x27;: &#x27;Lloyd&#x27;, &#x27;lives&#x27;: function()&#123; print(&quot;Alcoy, Spain&quot;) &#125;</span><br><span class="line">data_jason = &#123;&#x27;name&#x27;: &#x27;Jason&#x27;, &#x27;lives&#x27;: function()&#123; print(&quot;London, UK&quot;) &#125;</span><br><span class="line">go = function(x)</span><br><span class="line">    x.lives()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>





<p>demo：</p>
<p>我们将使用一个简单的门。当玩家进入一个触发器区域,门打开时,当玩家离开引发地区,门关闭:</p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646731476987-ba1b4d64-4ef2-4e4d-91c4-1b04fcabf94a.png" alt="img"></p>
<p>如果我们让触发器区域覆盖整个门,然后门更多的是一种视觉细节,像一个星际旅行输送机的门:</p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646731517811-695d1abd-95bc-4dc0-94cb-caee362d0549.png" alt="img"></p>
<p>我们可以创建一个触发门对象有两个部分:一个触发器区域(即不是画在屏幕上),和一个物理的门,这是绘制在屏幕上,和通过阻止玩家/怪物。我们的门可以有两种状态,打开和关闭。关闭时,碰撞区域的门充满整个部分的走廊,当打开碰撞区域移动(或门对象标记为一个对象,不会撞上东西。)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorldObject</span></span></span><br><span class="line"><span class="class">   &#123;</span></span><br><span class="line"><span class="class">       <span class="title">public</span> <span class="title">Vector2</span> <span class="title">Position</span> &#123; <span class="title">get</span>; <span class="title">set</span>; &#125;</span></span><br><span class="line"><span class="class">       <span class="title">public</span> <span class="title">Rectangle</span> <span class="title">CollisionArea</span> &#123; <span class="title">get</span>; <span class="title">set</span>; &#125;</span></span><br><span class="line"><span class="class">       <span class="title">public</span> <span class="title">bool</span> <span class="title">CallbackIfNotColliding</span> &#123; <span class="title">get</span>; <span class="title">set</span>; &#125;</span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">       // <span class="title">Called</span> <span class="title">when</span> <span class="title">the</span> <span class="title">world</span> <span class="title">detects</span> <span class="title">a</span> <span class="title">collision</span>, <span class="title">with</span> <span class="title">a</span> <span class="title">pointer</span></span></span><br><span class="line"><span class="class">       //  <span class="title">to</span> <span class="title">the</span> <span class="title">object</span> <span class="title">we</span> <span class="title">collided</span> <span class="title">with</span></span></span><br><span class="line"><span class="class">       <span class="title">public</span> <span class="title">virtual</span> <span class="title">void</span> <span class="title">Collide</span>(<span class="params">WorldObject otherObject</span>) &#123; &#125;</span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">       // <span class="title">Called</span> <span class="title">when</span> <span class="title">we</span> <span class="title">don</span>&#x27;<span class="title">t</span> <span class="title">collide</span> <span class="title">with</span> <span class="title">anything</span>, <span class="title">if</span> <span class="title">our</span></span></span><br><span class="line"><span class="class">       // <span class="title">CallbackIfNotColliding</span> <span class="title">flag</span> <span class="title">is</span> <span class="title">set</span></span></span><br><span class="line"><span class="class">       <span class="title">public</span> <span class="title">virtual</span> <span class="title">void</span> <span class="title">NoCollision</span>() &#123; &#125;</span></span><br><span class="line"><span class="class">   &#125;</span></span><br><span class="line"><span class="class">   <span class="title">class</span> <span class="title">Door</span> :</span> WorldObject</span><br><span class="line">   &#123;</span><br><span class="line">       public void Draw(Spritebatch sb)</span><br><span class="line">       &#123;</span><br><span class="line">            <span class="keyword">if</span> (mIsOpen)</span><br><span class="line">            &#123;</span><br><span class="line">            	// Draw <span class="built_in">open</span> door</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">            	// Draw closed door</span><br><span class="line">            &#125;</span><br><span class="line">       </span><br><span class="line">       		// Could also keep track <span class="keyword">if</span> door <span class="keyword">is</span> opening / closing, draw animation</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       public void Update(GameTime gameTime)</span><br><span class="line">       &#123;</span><br><span class="line">            // Updating <span class="keyword">for</span> <span class="built_in">any</span> dynamic behavior (like animating opening / closing,</span><br><span class="line">            //    <span class="keyword">or</span> a revolving door, <span class="keyword">or</span> something <span class="keyword">else</span>)       </span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">        public <span class="built_in">bool</span> IsOpen</span><br><span class="line">        &#123;</span><br><span class="line">            get</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mIsOpen;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">set</span></span><br><span class="line">            &#123;</span><br><span class="line">            	<span class="keyword">if</span> (value != mIsOpen)</span><br><span class="line">                &#123;</span><br><span class="line">                  // Either modify collision volume that world uses, <span class="keyword">or</span> <span class="built_in">set</span> a flag</span><br><span class="line">                  //  <span class="keyword">for</span> the world to ignore / allow collisions <span class="keyword">with</span> this door </span><br><span class="line">                  mIsOpen = value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       		</span><br><span class="line">       private <span class="built_in">bool</span> mIsOpen;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>







<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TriggeredDoor</span> :</span> WorldObject</span><br><span class="line">&#123;</span><br><span class="line">     private Door mDoor;</span><br><span class="line"></span><br><span class="line">     public override void Collide(WorldObject otherObject)</span><br><span class="line">     &#123;</span><br><span class="line">     	Door.IsOpen = true;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     public override void NoCollide()</span><br><span class="line">     &#123;</span><br><span class="line">     	Door.IsOpen = false;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TriggeredDoor</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">TriggerArea</span> <span class="attr">type</span> = <span class="string">&quot;Rectangle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">x</span>&gt;</span></span><br><span class="line">      300</span><br><span class="line">    <span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">y</span>&gt;</span> </span><br><span class="line">      200</span><br><span class="line">    <span class="tag">&lt;/<span class="name">y</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">w</span>&gt;</span></span><br><span class="line">      30</span><br><span class="line">    <span class="tag">&lt;/<span class="name">w</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h</span>&gt;</span></span><br><span class="line">      20</span><br><span class="line">    <span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">TriggerArea</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ClosedCollisionArea</span> <span class="attr">type</span> = <span class="string">&quot;Rectangle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">x</span>&gt;</span></span><br><span class="line">      320</span><br><span class="line">    <span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">y</span>&gt;</span> </span><br><span class="line">      200</span><br><span class="line">    <span class="tag">&lt;/<span class="name">y</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">w</span>&gt;</span></span><br><span class="line">      5</span><br><span class="line">    <span class="tag">&lt;/<span class="name">w</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h</span>&gt;</span></span><br><span class="line">      20</span><br><span class="line">    <span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ClosedCollisionArea</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">OpenCollisionArea</span> <span class="attr">type</span> = <span class="string">&quot;Rectangle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">x</span>&gt;</span></span><br><span class="line">      320</span><br><span class="line">    <span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">y</span>&gt;</span> </span><br><span class="line">      200</span><br><span class="line">    <span class="tag">&lt;/<span class="name">y</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">w</span>&gt;</span></span><br><span class="line">      5</span><br><span class="line">    <span class="tag">&lt;/<span class="name">w</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h</span>&gt;</span></span><br><span class="line">      2</span><br><span class="line">    <span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">OpenCollisionArea</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">OpenTexture</span> <span class="attr">type</span> = <span class="string">&quot;String&quot;</span>&gt;</span>OpenDoor1<span class="tag">&lt;/<span class="name">OpenTexture</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ClosedTexture</span> <span class="attr">type</span> = <span class="string">&quot;String&quot;</span>&gt;</span>ClosedDoor1<span class="tag">&lt;/<span class="name">ClosedTexture</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">TexturePosition</span> <span class="attr">type</span> = <span class="string">&quot;Vector2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">x</span>&gt;</span></span><br><span class="line">      100</span><br><span class="line">    <span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">y</span>&gt;</span> </span><br><span class="line">      100</span><br><span class="line">      </span><br><span class="line">      <span class="tag">&lt;/<span class="name">TexturePosition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">TriggeredDoor</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当你输入一个特定的体积。如果有一个全局函数,关掉灯,我们可以在我们的世界文件中创建一个条目,看起来像下面的:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TriggeringArea</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Area</span> <span class="attr">type</span> = <span class="string">&quot;Rectangle&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">x</span>&gt;</span></span><br><span class="line">         100</span><br><span class="line">      <span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">y</span>&gt;</span></span><br><span class="line">         50</span><br><span class="line">      <span class="tag">&lt;/<span class="name">y</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">w</span>&gt;</span></span><br><span class="line">         30</span><br><span class="line">      <span class="tag">&lt;/<span class="name">w</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">h</span>&gt;</span></span><br><span class="line">          10</span><br><span class="line">      <span class="tag">&lt;/<span class="name">h</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">Area</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">code</span>&gt;</span></span><br><span class="line">       TurnOffLights()</span><br><span class="line">   <span class="tag">&lt;/<span class="name">code</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">triggeringarea</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>脚本执行器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Object obj = Scripting.GetInstance();                              // Get a pointer ot the object</span><br><span class="line">MethodType method = obj.GetType().GetMethod(&quot;TurnOnLights&quot;);       // Get a pointer to the method object</span><br><span class="line">Obj [] params = new Obj[0];                                        // Array of parameters (none, in this example)</span><br><span class="line">method.Invoke(obj, params);                                        // Call the method</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<p>在其之下隐藏的设计思想</p>
<p>1、控制复杂度。通过把程序逻辑的复杂度转移到人类更容易处理的数据中来，从而达到控制复杂度的目标。代码流程从命令式变成了 声明式<br>2、隔离变化。像上面的例子，每个消息处理的逻辑是不变的，但是消息可能是变化的，那就把容易变化的消息和不容易变化的逻辑分离。<br>3、机制和策略的分离。机制就是消息的处理逻辑，策略就是不同的消息处理。</p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646654817397-cc4ea5b6-a55e-4d97-a923-7f3810607fbb.png" alt="img"></p>
<h3 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h3><p><strong>函数式编程</strong>，或称<strong>函数程序设计</strong>、<strong>泛函编程</strong>（英語：Functional programming），是一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F">编程范式</a>，它将<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E8%85%A6%E9%81%8B%E7%AE%97">电脑运算</a>视为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%87%BD%E6%95%B0">函数</a>运算，并且避免使用程式<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E7%8A%B6%E6%80%81_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)&action=edit&redlink=1">状态</a>（英语：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/State_(computer_science)">State (computer science)</a>）以及<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%8D%E5%8F%AF%E8%AE%8A%E7%89%A9%E4%BB%B6">易变物件</a>。其中，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%CE%9B%E6%BC%94%E7%AE%97">λ演算</a>为该语言最重要的基础。而且，λ演算的函数可以接受函数作为输入參數和输出返回值。</p>
<p>比起<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8C%87%E4%BB%A4%E5%BC%8F%E7%B7%A8%E7%A8%8B">指令式編程</a>，函数式编程更加强调程序执行的结果而非执行的过程，倡导利用若干简单的执行单元让计算结果不断渐进，逐层推导复杂的运算，而不是设计一个复杂的执行过程。</p>
<p>在函数式编程中，函数是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%A4%B4%E7%AD%89%E5%AF%B9%E8%B1%A1">头等对象</a>，意思是说一个函数，既可以作为其它函数的输入参数值，也可以从函数中返回值，被修改或者被分配给一个变量。</p>
<p>早在50年代函数式编程开始之前，Lisp 语言就已经在 IBM 700/7000 系列的科学计算机上运行了。Lisp 引入了很多与我们现在的函数式编程有关的示例与功能，我们甚至可以称 Lisp 是所有函数式编程语言的鼻祖。</p>
<p>这也是函数式编程中最有趣的方面，所有函数式编程语言都是基于相同的 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%CE%9B%E6%BC%94%E7%AE%97">λ演算</a>，这种简单数学基础。</p>
<p>λ演算是图灵完备的，它是一种通用的计算模型，可用于模拟任何一台单带图灵机。它名字中的希腊字母 lambda（λ），被使用在了 lambda 表达式和 lambda 项绑定函数中的变量中。</p>
<p>λ演算是一个极其简单但又十分强大的概念。它的核心主要有两个概念：</p>
<ul>
<li>函数的抽象，通过引入变量来归纳得出表达式；</li>
<li>函数的应用，通过给变量赋值来对已得出的表达式进行计算；</li>
</ul>
<p>让我们来看个小例子，单参数函数 f，将参数递增1。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f = λ x. x+1 </span><br></pre></td></tr></table></figure>

<p>假设我们应用函数在数字5上，那么函数读取如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f(5) =&gt; 5 + 1</span><br></pre></td></tr></table></figure>



<h4 id="函数式编程的基本原理"><a href="#函数式编程的基本原理" class="headerlink" title="函数式编程的基本原理"></a>函数式编程的基本原理</h4><p>现在，数学知识已经够了。让我们看一下使函数式编程变得强大的特性有哪些？</p>
<h5 id="头等函数（first-class-function）"><a href="#头等函数（first-class-function）" class="headerlink" title="头等函数（first-class function）"></a>头等函数（first-class function）</h5><p>在函数式编程中，函数是一等公民，意思是说函数可以赋值给变量，例如在 <a target="_blank" rel="noopener" href="http://elixir-lang.org/getting-started/introduction.html">elixir</a> 中，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double = fn(x) -&gt; x * 2 </span><br></pre></td></tr></table></figure>

<p>然后我们可以如下来调用函数：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">double.(2) </span><br></pre></td></tr></table></figure>

<p>scala</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def m(x: Int):Int = x * 2</span><br><span class="line"></span><br><span class="line">m(2) //输出4</span><br></pre></td></tr></table></figure>



<p>scala匿名函数/闭包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val m = (x: Int) =&gt; x * 2</span><br></pre></td></tr></table></figure>





<p>java中的运用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line">interface FunctionMul&#123;</span><br><span class="line">    int multiTwo(int x);</span><br><span class="line">&#125;        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FunctionMul func = x -&gt; x * 2;</span><br><span class="line">func.multi(2); //输出4</span><br></pre></td></tr></table></figure>

<p>一个最常用的Function</p>
<p><img src="/hexo/images/1646740610546-c1403a0d-4ca7-498b-8b57-eb4c33e699b4.png" alt="img"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;Integer,Integer&gt; function = x -&gt; x * 2;</span><br><span class="line"></span><br><span class="line">function.apply(2); // </span><br></pre></td></tr></table></figure>





<h5 id="高阶函数（higher-order-function）"><a href="#高阶函数（higher-order-function）" class="headerlink" title="高阶函数（higher-order function）"></a>高阶函数（higher-order function）</h5><p>高阶函数的定义是，接收一个或多个函数变量作为参数，然后生成的新函数，即为高阶函数。具体有两种情况：</p>
<ol>
<li>函数可以作为参数被传递</li>
<li>函数可以作为返回值输出</li>
</ol>
<p>让我们再次使用函数 double 来说明这个概念：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">double = fn(x) -&gt; x * 2</span><br><span class="line">Enum.map(1..10, double) </span><br></pre></td></tr></table></figure>

<p>这例子中，Enum.map 将一个枚举列表作为第一参数，之前定义的函数作为第二参数；然后将这个函数应用到枚举中的每一个元素，结果为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2,4,6,8,10,12,14,16,18,20] </span><br></pre></td></tr></table></figure>

<p>scala中的高阶函数</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def test(f:Int =&gt; String , num : Int) = f(num)</span><br><span class="line"></span><br><span class="line">def f(num:Int) : String = &#123;</span><br><span class="line">  10 + num + &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def main(args: Array[String]): Unit = &#123;</span><br><span class="line">  println(test(f,10))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>java中的例子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Integer[] arr = new Integer[]&#123;2,4,6,8,10,12,14,16,18,20&#125;;</span><br><span class="line">Arrays.stream(arr)</span><br><span class="line">                .map(function)</span><br><span class="line">                .toArray();</span><br></pre></td></tr></table></figure>



<p>java非常常见的写法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.sort(arr, (s1, s2)-&gt;s1.compareToIgnoreCase(s2));</span><br></pre></td></tr></table></figure>





<h5 id="不可变状态（Immutable-State）"><a href="#不可变状态（Immutable-State）" class="headerlink" title="不可变状态（Immutable State）"></a>不可变状态（Immutable State）</h5><p>在函数式编程语言中，状态是不可变的。这意味着一旦一个变量被绑定了一个值，它将不能再被重新定义。这在防止副作用与条件竞争上有明显的优势，使并发编程更简单。</p>
<p>另外，函数式编程中的“值不可变性”避免了对公共的可变状态进行同步访问控制的复杂问题，能够较好满足分布式并行编程的需求，适应大数据时代的到来。</p>
<p>和上面一样，让我们使用 Elixir 来说明一下这概念：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; tuple = &#123;:ok, &quot;hello&quot;&#125; </span><br><span class="line">&#123;:ok, &quot;hello&quot;&#125; </span><br><span class="line">iex&gt; put_elem(tuple, 1, &quot;world&quot;) </span><br><span class="line">&#123;:ok, &quot;world&quot;&#125; </span><br><span class="line">iex&gt; tuple </span><br><span class="line">&#123;:ok, &quot;hello&quot;&#125; </span><br></pre></td></tr></table></figure>

<p>这个例子中，tuple 的值从来没有改变过，第三行 put_elem 是返回了一个完全新的 tuple， 而没有去修改原有的值。</p>
<p>Scala 中定义变量分为 var（可变变量）和 val（不可变变量）</p>
<p>Scala 中集合框架也分为可变集合和不可变集合。比如 List（列表） 和 Tuple（元组）本身就是不可变的，set 和 map 分为可变和不可变的，默认为不可变。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//创建List</span><br><span class="line">val list = List(&quot;abc&quot;,&quot;xyz&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//添加元素。list本身不变，返回一个新的list</span><br><span class="line">val list1 = list :+ 6 //加到后面 List(abc, xyz, 6)</span><br><span class="line">val list2 = 10 +: list //加到前面 List(10, abc, xyz)</span><br></pre></td></tr></table></figure>





<h5 id="函数组合子（Functional-Combinators）"><a href="#函数组合子（Functional-Combinators）" class="headerlink" title="函数组合子（Functional Combinators）"></a>函数组合子（Functional Combinators）</h5><p>组合子逻辑意图作为简单的元逻辑，它能澄清在逻辑符号中的量化变量的意义，并真正的消除对它们的需要。消除量化变量的另一种方式是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%92%AF%E5%9B%A0">蒯因</a>的谓词函子。尽管多数组合子逻辑系统超出了一阶逻辑的表达能力，蒯因的谓词函子的表达能力等价于一阶逻辑</p>
<ul>
<li>map对列表中的每个元素应用一个函数，返回应用后的元素所组成的列表。</li>
<li>filter移除任何对传入函数计算结果为false的元素。返回一个布尔值的函数通常被称为谓词函数[或判定函数]。</li>
<li>zip将两个列表的内容聚合到一个对偶列表中。</li>
<li>partition将使用给定的谓词函数分割列表。</li>
<li>find返回集合中第一个匹配谓词函数的元素。</li>
<li>foldLeft，0为初始值（记住numbers是List[Int]类型），m作为一个累加器。</li>
<li>flatten将嵌套结构扁平化为一个层次的集合。</li>
<li>flatMap是一种常用的组合子，结合映射[mapping]和扁平化[flattening]。 flatMap需要一个处理嵌套列表的函数，然后将结果串连起来。</li>
</ul>
<p>scala</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; numbers.map((i: Int) =&gt; i * 2)</span><br><span class="line">res0: List[Int] = List(2, 4, 6, 8)</span><br><span class="line"></span><br><span class="line">scala&gt; numbers.filter((i: Int) =&gt; i % 2 == 0)</span><br><span class="line">res0: List[Int] = List(2, 4)</span><br><span class="line"></span><br><span class="line">scala&gt; List(1, 2, 3).zip(List(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;))</span><br><span class="line">res0: List[(Int, String)] = List((1,a), (2,b), (3,c))</span><br><span class="line"></span><br><span class="line">scala&gt; val numbers = List(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)</span><br><span class="line">scala&gt; numbers.partition(_ % 2 == 0)</span><br><span class="line">res0: (List[Int], List[Int]) = (List(2, 4, 6, 8, 10),List(1, 3, 5, 7, 9))</span><br><span class="line"></span><br><span class="line">scala&gt; numbers.find((i: Int) =&gt; i &gt; 5)</span><br><span class="line">res0: Option[Int] = Some(6)</span><br><span class="line"></span><br><span class="line">scala&gt; numbers.foldLeft(0)((m: Int, n: Int) =&gt; m + n)</span><br><span class="line">res0: Int = 55</span><br></pre></td></tr></table></figure>





<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Integer[] arr = new Integer[]&#123;2,4,6,8,10,12,14,16,18,20&#125;;</span><br><span class="line">Arrays.stream(arr)</span><br><span class="line">        .map(x -&gt; x * 2)</span><br><span class="line">        .toArray();</span><br></pre></td></tr></table></figure>



<h5 id="柯里化函数-Currying"><a href="#柯里化函数-Currying" class="headerlink" title="柯里化函数(Currying)"></a>柯里化函数(Currying)</h5><p>在计算机科学中，柯里化（Currying）是把接受多个参数的函数变换成接受一个单一参数(最初函数的第一个参数)的函数，并且返回接受余下的参数且返回结果的新函数的技术。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">mul</span></span>(x:<span class="type">Int</span>,y:<span class="type">Int</span>):<span class="type">Int</span> = x *y</span><br><span class="line">mul: (x: <span class="type">Int</span>, y: <span class="type">Int</span>)<span class="type">Int</span></span><br><span class="line"></span><br><span class="line">scala&gt; mul(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">res12: <span class="type">Int</span> = <span class="number">42</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">mul2</span></span>(x:<span class="type">Int</span>)(y:<span class="type">Int</span>)=x*y</span><br><span class="line">mul2: (x: <span class="type">Int</span>)(y: <span class="type">Int</span>)<span class="type">Int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; mul2(<span class="number">6</span>)(<span class="number">7</span>)</span><br><span class="line">res14: <span class="type">Int</span> = <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际上是先变成这样一个函数</span></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">def</span> <span class="title">mul2</span></span>(x:<span class="type">Int</span>)=(y:<span class="type">Int</span>)=&gt;x*y</span><br><span class="line">mul2: (x: <span class="type">Int</span>)<span class="type">Int</span> =&gt; <span class="type">Int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> result = mul2(<span class="number">6</span>)</span><br><span class="line">result: (y:<span class="type">Int</span>)=&gt;<span class="number">6</span>*y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> sum = result(<span class="number">7</span>)</span><br><span class="line">sum: <span class="number">42</span></span><br></pre></td></tr></table></figure>







<p>运用</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLines</span></span>(filename: <span class="type">String</span>)(isFileReadable: (<span class="type">File</span>) =&gt; <span class="type">Boolean</span>)(closableStream: (<span class="type">Closeable</span>) =&gt; <span class="type">Unit</span>):<span class="type">List</span>[<span class="type">String</span>] = &#123;</span><br><span class="line">  <span class="keyword">val</span> file = <span class="keyword">new</span> <span class="type">File</span>(filename)</span><br><span class="line">  <span class="keyword">if</span> (isFileReadable(file)) &#123;</span><br><span class="line">    <span class="keyword">val</span> readerStream = <span class="keyword">new</span> <span class="type">FileReader</span>(file)</span><br><span class="line">    <span class="keyword">val</span> buffer = <span class="keyword">new</span> <span class="type">BufferedReader</span>(readerStream)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> list: <span class="type">List</span>[<span class="type">String</span>] = <span class="type">List</span>()</span><br><span class="line">      <span class="keyword">var</span> str = <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="keyword">var</span> isReadOver = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">while</span> (!isReadOver) &#123;</span><br><span class="line">        str = buffer.readLine()</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="literal">null</span>) isReadOver = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">else</span> list = str :: list</span><br><span class="line">      &#125;</span><br><span class="line">      list.reverse</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      closableStream(buffer)</span><br><span class="line">      closableStream(readerStream)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">List</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isReadable</span></span>(file: <span class="type">File</span>) = &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> != file &amp;&amp; file.exists() &amp;&amp; file.canRead()) <span class="literal">true</span></span><br><span class="line">  <span class="keyword">else</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">closeStream</span></span>(stream: <span class="type">Closeable</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> != stream) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      stream.close</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> ex =&gt; <span class="type">Log</span>.error(“[”+<span class="keyword">this</span>.getClass.getName+”.closeStream]”,ex.getMessage)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLines</span></span>(filename:<span class="type">String</span>):<span class="type">List</span>[<span class="type">String</span>]=&#123;</span><br><span class="line">  getLines(filename)(isReadable)(closeStream)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>spark源码</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql</span></span>(sqlText: <span class="type">String</span>): <span class="type">DataFrame</span> = &#123;</span><br><span class="line">    <span class="type">Dataset</span>.ofRows(self, sessionState.sqlParser.parsePlan(sqlText))</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">parsePlan</span></span>(sqlText: <span class="type">String</span>): <span class="type">LogicalPlan</span> = parse(sqlText) &#123; parser =&gt;</span><br><span class="line">    astBuilder.visitSingleStatement(parser.singleStatement()) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> plan: <span class="type">LogicalPlan</span> =&gt; plan</span><br><span class="line">      <span class="keyword">case</span> _ =&gt;</span><br><span class="line">        <span class="keyword">val</span> position = <span class="type">Origin</span>(<span class="type">None</span>, <span class="type">None</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ParseException</span>(<span class="type">Option</span>(sqlText), <span class="string">&quot;Unsupported SQL statement&quot;</span>, position, position)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">parse</span></span>[<span class="type">T</span>](command: <span class="type">String</span>)(toResult: <span class="type">SqlBaseParser</span> =&gt; <span class="type">T</span>): <span class="type">T</span> = &#123;</span><br><span class="line">    logInfo(<span class="string">s&quot;Parsing command: <span class="subst">$command</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> lexer = <span class="keyword">new</span> <span class="type">SqlBaseLexer</span>(<span class="keyword">new</span> <span class="type">ANTLRNoCaseStringStream</span>(command))</span><br><span class="line">    lexer.removeErrorListeners()</span><br><span class="line">    lexer.addErrorListener(<span class="type">ParseErrorListener</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tokenStream = <span class="keyword">new</span> <span class="type">CommonTokenStream</span>(lexer)</span><br><span class="line">    <span class="keyword">val</span> parser = <span class="keyword">new</span> <span class="type">SqlBaseParser</span>(tokenStream)</span><br><span class="line">    parser.addParseListener(<span class="type">PostProcessor</span>)</span><br><span class="line">    parser.removeErrorListeners()</span><br><span class="line">    parser.addErrorListener(<span class="type">ParseErrorListener</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// first, try parsing with potentially faster SLL mode</span></span><br><span class="line">        parser.getInterpreter.setPredictionMode(<span class="type">PredictionMode</span>.<span class="type">SLL</span>)</span><br><span class="line">        toResult(parser)</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<p>java中的柯里化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;String,</span><br><span class="line">Function&lt;String,</span><br><span class="line">Function&lt;String, String&gt;&gt;&gt; sum =</span><br><span class="line">    a -&gt; b -&gt; c -&gt; a + b + c; </span><br><span class="line"></span><br><span class="line">Function&lt;String, Function&lt;String, String&gt;&gt; hi =</span><br><span class="line">    sum.apply(<span class="string">&quot;Hi &quot;</span>);</span><br><span class="line">Function&lt;String, String&gt; ho = hi.apply(<span class="string">&quot;Ho &quot;</span>);</span><br><span class="line">        System.out.println(ho.apply(<span class="string">&quot;Hup&quot;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="函数式编程下的并发编程"><a href="#函数式编程下的并发编程" class="headerlink" title="函数式编程下的并发编程"></a>函数式编程下的并发编程</h4><p>一般来说有两种策略用来在并发线程中进行通信：共享数据和消息传递。使用共享数据方式的并发编程面临的最大的一个问题就是数据条件竞争。处理各种锁的问题是让人十分头痛的一件事。</p>
<p>传统多数流行的语言并发是基于多线程之间的共享内存，使用同步方法防止写争夺，Actors使用消息模型，每个Actor在同一时间处理最多一个消息，可以发送消息给其他Actor，保证了单独写原则。从而巧妙避免了多线程写争夺。和共享数据方式相比，消息传递机制最大的优点就是不会产生数据竞争状态。实现消息传递有两种常见的类型：基于channel（golang为典型代表）的消息传递和基于Actor（erlang为代表）的消息传递。</p>
<h5 id="Actor简介"><a href="#Actor简介" class="headerlink" title="Actor简介"></a>Actor简介</h5><p>Actor模型(Actor model)首先是由Carl Hewitt在1973定义， 由Erlang OTP 推广，其 消息传递更加符合面向对象的原始意图。Actor属于并发组件模型，通过组件方式定义并发编程范式的高级阶段，避免使用者直接接触多线程并发或线程池等基础概念。</p>
<p>Actor模型=数据+行为+消息。</p>
<p>erlang，在语言层面就提供了Actor模型的支持，RabbitMQ 就是基于erlang开发的。</p>
<h5 id="无锁"><a href="#无锁" class="headerlink" title="无锁"></a>无锁</h5><p>JAVA并发编程时需要特别的关注锁和内存原子性等一系列线程问题，而Actor模型内部的状态由它自己维护即它内部数据只能由它自己修改(通过消息传递来进行状态修改)，所以使用Actors模型进行并发编程可以很好地避免这些问题。Actor内部是以单线程的模式来执行的，类似于redis，所以Actor完全可以实现分布式锁类似的应用。</p>
<h5 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h5><p>每个Actor都有一个专用的MailBox来接收消息，这也是Actor实现异步的基础。当一个Actor实例向另外一个Actor发消息的时候，并非直接调用Actor的方法，而是把消息传递到对应的MailBox里，就好像邮递员，并不是把邮件直接送到收信人手里，而是放进每家的邮箱，这样邮递员就可以快速的进行下一项工作。所以在Actor系统里，Actor发送一条消息是非常快的。</p>
<p><img src="/hexo/images/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/1646915681082-e71378c3-a1e2-44c5-88b9-98ce0d485827.png" alt="img"></p>
<p>这样的设计主要优势就是解耦了Actor，数万个Actor并发的运行，每个actor都以自己的步调运行，且发送消息，接收消息都不会被阻塞。</p>
<h5 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h5><p>每个Actor的实例都维护这自己的状态，与其他Actor实例处于物理隔离状态，并非像 多线程+锁 模式那样基于共享数据。Actor通过消息的模式与其他Actor进行通信，与OO式的消息传递方式不同，Actor之间消息的传递是真正物理上的消息传递。</p>
<h5 id="天生分布式"><a href="#天生分布式" class="headerlink" title="天生分布式"></a>天生分布式</h5><p>每个Actor实例的位置透明，无论Actor地址是在本地还是在远程机器上对于代码来说都是一样的。每个Actor的实例非常小，最多几百字节，所以单机几十万的Actor的实例很轻松。如果你写过golang代码，就会发现其实Actor在重量级上很像Goroutine。由于位置透明性，所以Actor系统可以随意的横向扩展来应对并发，对于调用者来说，调用的Actor的位置就在本地，当然这也得益于Actor系统强大的路由系统。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">SetRequest</span>(<span class="params">key: <span class="type">String</span>, value: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AkkademyDb</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> map = <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]</span><br><span class="line">  <span class="keyword">val</span> log = <span class="type">Logging</span>(context.system, <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">SetRequest</span>(key, value) =&gt; &#123;</span><br><span class="line">      log.info(<span class="string">&quot;received SetRequest - key: &#123;&#125; value: &#123;&#125;&quot;</span>, key, value)</span><br><span class="line">      map.put(key, value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> o =&gt; log.info(<span class="string">&quot;received unknown message: &#123;&#125;&quot;</span>, o);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> actorRef = <span class="type">TestActorRef</span>(<span class="keyword">new</span> <span class="type">AkkademyDb</span>)</span><br><span class="line">actorRef ! <span class="type">SetRequest</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="思维的转变"><a href="#思维的转变" class="headerlink" title="思维的转变"></a>思维的转变</h3><p>总结下函数式常用思维方式：</p>
<ol>
<li><strong>表达式化</strong><br>就是去掉变量，去掉循环，通过表达式处理逻辑。</li>
<li><strong>数据与行为分离，无副作用</strong><br>由于严格作用域，必须没有副作用。</li>
<li><strong>高阶思维</strong><br>能用 map 解决的，就不要 for 循环</li>
<li><strong>组合思维</strong><br>函数式和面向对象是相反的，面向对象是自顶向下的设计，函数式是自底向上的设计，也就是先定义基本操作，然后不断组合。比如 sql 定义了 select， from， where … 这些组合子来满足查询需求。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/d6c1b591.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/d6c1b591.html" class="post-title-link" itemprop="url">dubbo3源码解析（十二）-Triple协议解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-28 15:26:04" itemprop="dateCreated datePublished" datetime="2022-01-28T15:26:04+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-03-09 22:49:11" itemprop="dateModified" datetime="2022-03-09T22:49:11+08:00">2022-03-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/26f8b378.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/26f8b378.html" class="post-title-link" itemprop="url">tomcat 启用gzip</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-28 15:09:17" itemprop="dateCreated datePublished" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">容器</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>编辑conf/server.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span>               <span class="attr">maxHttpHeaderSize</span>=<span class="string">&quot;8192&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">maxThreads</span>=<span class="string">&quot;150&quot;</span> <span class="attr">minSpareThreads</span>=<span class="string">&quot;25&quot;</span> <span class="attr">maxSpareThreads</span>=<span class="string">&quot;75&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">enableLookups</span>=<span class="string">&quot;false&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> <span class="attr">acceptCount</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">disableUploadTimeout</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">compression</span>=<span class="string">&quot;on&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">compressionMinSize</span>=<span class="string">&quot;2048&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">noCompressionUserAgents</span>=<span class="string">&quot;gozilla,traviata&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">compressableMimeType</span>=<span class="string">&quot;text/html,text/xml,text/javascript,text/css,text/plain&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>compression=”on” 打开压缩功能</li>
<li>compressionMinSize=”2048” 启用压缩的输出内容大小，这里面默认为2KB</li>
<li>noCompressionUserAgents=”gozilla, traviata” 对于以下的浏览器，不启用压缩&lt;60;</li>
<li>compressableMimeType=”text/html,text/xml” 压缩类型</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://hongjiang.info/index/tomcat/">http://hongjiang.info/index/tomcat/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/b34a8cb1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/b34a8cb1.html" class="post-title-link" itemprop="url">uu加速器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-02 22:02:02" itemprop="dateCreated datePublished" datetime="2021-04-02T22:02:02+08:00">2021-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  uu加速器需要会员非常麻烦，根据下面步骤可以绕过。</p>
<h2 id="下载uu加速器"><a href="#下载uu加速器" class="headerlink" title="下载uu加速器"></a>下载uu加速器</h2><p>这个步骤省略，登录 <a target="_blank" rel="noopener" href="https://uu.163.com/">https://uu.163.com/</a> 下载</p>
<h2 id="下载安装翻墙软件"><a href="#下载安装翻墙软件" class="headerlink" title="下载安装翻墙软件"></a>下载安装翻墙软件</h2><p>下载地址：<a target="_blank" rel="noopener" href="https://www.mediafire.com/folder/sfqz8bmodqdx5/shadowsocks%E7%9B%B8%E5%85%B3%E5%AE%A2%E6%88%B7%E7%AB%AF">https://www.mediafire.com/folder/sfqz8bmodqdx5/shadowsocks%E7%9B%B8%E5%85%B3%E5%AE%A2%E6%88%B7%E7%AB%AF</a> </p>
<p>如果是windows系统，第一次电脑系统使用SSR/SS客户端时，如果提示你需要安装NET Framework 4.0，网上搜一下这个东西，安装一下即可。NET Framework 4.0是SSR/SS的运行库，没有这个SSR/SS客户端无法正常运行。有的电脑系统可能会自带NET Framework 4.0。</p>
<p>安装过程省略</p>
<h2 id="使用免费账号"><a href="#使用免费账号" class="headerlink" title="使用免费账号"></a>使用免费账号</h2><p>地址：<a target="_blank" rel="noopener" href="https://github.com/Alvin9999/new-pac/wiki/ss%E5%85%8D%E8%B4%B9%E8%B4%A6%E5%8F%B7#%E5%85%8D%E8%B4%B9ssssr%E8%B4%A6%E5%8F%B7%E8%8A%82%E7%82%B9%E5%88%97%E8%A1%A8%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0">https://github.com/Alvin9999/new-pac/wiki/ss%E5%85%8D%E8%B4%B9%E8%B4%A6%E5%8F%B7#%E5%85%8D%E8%B4%B9ssssr%E8%B4%A6%E5%8F%B7%E8%8A%82%E7%82%B9%E5%88%97%E8%A1%A8%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0</a></p>
<p>选中其中一个链接复制到浏览器</p>
<p><img src="https://user-images.githubusercontent.com/7789698/113422899-13523e80-9400-11eb-8951-694a334ee6f1.png" alt="image-20210402220849250"></p>
<p>打开自动导入</p>
<p><img src="https://user-images.githubusercontent.com/7789698/113422952-354bc100-9400-11eb-8919-df134b2cbcdc.png" alt="image-20210402221015608"></p>
<p>选中，并勾选打开shadowsocks</p>
<p><img src="https://user-images.githubusercontent.com/7789698/113423016-557b8000-9400-11eb-9728-ac731ceb386a.png" alt="image-20210402221108746"></p>
<p>切换全局模式</p>
<p><img src="https://user-images.githubusercontent.com/7789698/113423135-865bb500-9400-11eb-89ef-400e1aaf43c7.png" alt="image-20210402221231427"></p>
<h2 id="开始uu加速"><a href="#开始uu加速" class="headerlink" title="开始uu加速"></a>开始uu加速</h2><p>打开uu加速器。不要登录直接选择一款游戏选择节点，连接后按教程去配置你的switch或者ps4</p>
<p><img src="https://user-images.githubusercontent.com/7789698/113423342-e5212e80-9400-11eb-8c9a-8f1be7bd731d.png" alt="image-20210402221359124"></p>
<h2 id="关闭翻墙软件"><a href="#关闭翻墙软件" class="headerlink" title="关闭翻墙软件"></a>关闭翻墙软件</h2><p>把全局模式切回Pac模式或者直接关闭翻墙软件。</p>
<p>ps.如果发现部分不可描述的页面打不开，点开高级设置，替换GFW LIST URL 为： <a target="_blank" rel="noopener" href="https://github.com/www1350/gfwlist/blob/master/gfwlist.txt">https://github.com/www1350/gfwlist/blob/master/gfwlist.txt</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/82582a1f.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/82582a1f.html" class="post-title-link" itemprop="url">从0开始学习opencv（二）-highGui初步</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-11-16 21:33:06" itemprop="dateCreated datePublished" datetime="2019-11-16T21:33:06+08:00">2019-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%B8%B8%E6%88%8F/" itemprop="url" rel="index"><span itemprop="name">游戏</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HighGui界面初步"><a href="#HighGui界面初步" class="headerlink" title="HighGui界面初步"></a>HighGui界面初步</h1><h2 id="图像的载入"><a href="#图像的载入" class="headerlink" title="图像的载入"></a>图像的载入</h2><p>imread函数，用在读取图像到Mat矩阵，可以看下官方注释</p>
<ul>
<li>这个函数从指定文件加载图片返回，如果图片无法读取，就会返回空矩阵(Mat::data == null)，支持如下格式<ul>
<li>windows位图，*.bmp, *.dib</li>
<li>JPEG文件，*.jpeg, *.jpg, *.jpe</li>
<li>JPEG2000文件，*.jp2</li>
<li>便携式文件格式，*.pbm, *.pgm, *.ppm *.pxm, *.pnm</li>
<li>Sun rasters光栅文件，*.sr, *.ras </li>
<li>TIFF文件，*.tiff, *.tif</li>
<li>OpenEXR图片文件，*.exr </li>
<li>HDR文件，*.hdr, *.pic </li>
<li>栅格和矢量地理空间数据</li>
</ul>
</li>
<li>第二个参数，载入标识，指定一个加载图片的颜色类型，自带的默认值为1。也就是三通道BGR。<ul>
<li>flag&gt;0 返回一个三通道的彩色图像</li>
<li>flag=0 返回灰度图像</li>
<li>flag&lt;0 返回包含alpha通道加载图像</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ImreadModes</span> &#123;</span></span><br><span class="line">       IMREAD_UNCHANGED            = <span class="number">-1</span>, <span class="comment">//!&lt; If set, return the loaded image as is (with alpha channel, otherwise it gets cropped).已废弃</span></span><br><span class="line">       IMREAD_GRAYSCALE            = <span class="number">0</span>,  <span class="comment">//!&lt; If set, always convert image to the single channel grayscale image (codec internal conversion).转成灰度</span></span><br><span class="line">       IMREAD_COLOR                = <span class="number">1</span>,  <span class="comment">//!&lt; If set, always convert image to the 3 channel BGR color image.</span></span><br><span class="line">       IMREAD_ANYDEPTH             = <span class="number">2</span>,  <span class="comment">//!&lt; If set, return 16-bit/32-bit image when the input has the corresponding depth, otherwise convert it to 8-bit.载入16或32位深度图像，否则转化为8位返回</span></span><br><span class="line">       IMREAD_ANYCOLOR             = <span class="number">4</span>,  <span class="comment">//!&lt; If set, the image is read in any possible color format. </span></span><br><span class="line">       IMREAD_LOAD_GDAL            = <span class="number">8</span>,  <span class="comment">//!&lt; If set, use the gdal driver for loading the image.</span></span><br><span class="line">       IMREAD_REDUCED_GRAYSCALE_2  = <span class="number">16</span>, <span class="comment">//!&lt; If set, always convert image to the single channel grayscale image and the image size reduced 1/2.</span></span><br><span class="line">       IMREAD_REDUCED_COLOR_2      = <span class="number">17</span>, <span class="comment">//!&lt; If set, always convert image to the 3 channel BGR color image and the image size reduced 1/2.</span></span><br><span class="line">       IMREAD_REDUCED_GRAYSCALE_4  = <span class="number">32</span>, <span class="comment">//!&lt; If set, always convert image to the single channel grayscale image and the image size reduced 1/4.</span></span><br><span class="line">       IMREAD_REDUCED_COLOR_4      = <span class="number">33</span>, <span class="comment">//!&lt; If set, always convert image to the 3 channel BGR color image and the image size reduced 1/4.</span></span><br><span class="line">       IMREAD_REDUCED_GRAYSCALE_8  = <span class="number">64</span>, <span class="comment">//!&lt; If set, always convert image to the single channel grayscale image and the image size reduced 1/8.</span></span><br><span class="line">       IMREAD_REDUCED_COLOR_8      = <span class="number">65</span>, <span class="comment">//!&lt; If set, always convert image to the 3 channel BGR color image and the image size reduced 1/8.</span></span><br><span class="line">       IMREAD_IGNORE_ORIENTATION   = <span class="number">128</span> <span class="comment">//!&lt; If set, do not rotate the image according to EXIF&#x27;s orientation flag.</span></span><br><span class="line">     &#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">The function imread loads an image from the specified file <span class="keyword">and</span> returns it. <span class="function">If the image cannot be</span></span><br><span class="line"><span class="function"><span class="title">read</span> <span class="params">(because of missing file, improper permissions, unsupported <span class="keyword">or</span> invalid format)</span>, the function</span></span><br><span class="line"><span class="function">returns an empty <span class="title">matrix</span> <span class="params">( Mat::data==<span class="literal">NULL</span> )</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Currently, the following file formats are supported:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-   Windows bitmaps - \*.bmp, \*.dib (always supported)</span></span><br><span class="line"><span class="function">-   JPEG files - \*.jpeg, \*.jpg, \*.jpe (see the *Note* section)</span></span><br><span class="line"><span class="function">-   JPEG <span class="number">2000</span> files - \*.jp2 (see the *Note* section)</span></span><br><span class="line"><span class="function">-   Portable Network Graphics - \*.png (see the *Note* section)</span></span><br><span class="line"><span class="function">-   WebP - \*.webp (see the *Note* section)</span></span><br><span class="line"><span class="function">-   Portable image format - \*.pbm, \*.pgm, \*.ppm \*.pxm, \*.pnm (always supported)</span></span><br><span class="line"><span class="function">-   Sun rasters - \*.sr, \*.ras (always supported)</span></span><br><span class="line"><span class="function">-   TIFF files - \*.tiff, \*.tif (see the *Note* section)</span></span><br><span class="line"><span class="function">-   OpenEXR Image files - \*.exr (see the *Note* section)</span></span><br><span class="line"><span class="function">-   Radiance HDR - \*.hdr, \*.pic (always supported)</span></span><br><span class="line"><span class="function">-   Raster and Vector geospatial data supported by GDAL (see the *Note* section)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">@note</span></span><br><span class="line"><span class="function">-   The function determines the type of an image by the content, not by the file extension.</span></span><br><span class="line"><span class="function">-   In the case of color images, the decoded images will have the channels stored in **B G R** order.</span></span><br><span class="line"><span class="function">-   When using IMREAD_GRAYSCALE, the codec<span class="string">&#x27;s internal grayscale conversion will be used, if available.</span></span></span><br><span class="line"><span class="string"><span class="function">    Results may differ to the output of cvtColor()</span></span></span><br><span class="line"><span class="string"><span class="function">-   On Microsoft Windows\* OS and MacOSX\*, the codecs shipped with an OpenCV image (libjpeg,</span></span></span><br><span class="line"><span class="string"><span class="function">    libpng, libtiff, and libjasper) are used by default. So, OpenCV can always read JPEGs, PNGs,</span></span></span><br><span class="line"><span class="string"><span class="function">    and TIFFs. On MacOSX, there is also an option to use native MacOSX image readers. But beware</span></span></span><br><span class="line"><span class="string"><span class="function">    that currently these native image loaders give images with different pixel values because of</span></span></span><br><span class="line"><span class="string"><span class="function">    the color management embedded into MacOSX.</span></span></span><br><span class="line"><span class="string"><span class="function">-   On Linux\*, BSD flavors and other Unix-like open-source operating systems, OpenCV looks for</span></span></span><br><span class="line"><span class="string"><span class="function">    codecs supplied with an OS image. Install the relevant packages (do not forget the development</span></span></span><br><span class="line"><span class="string"><span class="function">    files, for example, &quot;libjpeg-dev&quot;, in Debian\* and Ubuntu\*) to get the codec support or turn</span></span></span><br><span class="line"><span class="string"><span class="function">    on the OPENCV_BUILD_3RDPARTY_LIBS flag in CMake.</span></span></span><br><span class="line"><span class="string"><span class="function">-   In the case you set *WITH_GDAL* flag to true in CMake and @ref IMREAD_LOAD_GDAL to load the image,</span></span></span><br><span class="line"><span class="string"><span class="function">    then the [GDAL](http://www.gdal.org) driver will be used in order to decode the image, supporting</span></span></span><br><span class="line"><span class="string"><span class="function">    the following formats: [Raster](http://www.gdal.org/formats_list.html),</span></span></span><br><span class="line"><span class="string"><span class="function">    [Vector](http://www.gdal.org/ogr_formats.html).</span></span></span><br><span class="line"><span class="string"><span class="function">-   If EXIF information are embedded in the image file, the EXIF orientation will be taken into account</span></span></span><br><span class="line"><span class="string"><span class="function">    and thus the image will be rotated accordingly except if the flag @ref IMREAD_IGNORE_ORIENTATION is passed.</span></span></span><br><span class="line"><span class="string"><span class="function">-   By default number of pixels must be less than 2^30. Limit can be set using system</span></span></span><br><span class="line"><span class="string"><span class="function">    variable OPENCV_IO_MAX_IMAGE_PIXELS</span></span></span><br><span class="line"><span class="string"><span class="function"></span></span></span><br><span class="line"><span class="string"><span class="function">@param filename Name of file to be loaded.</span></span></span><br><span class="line"><span class="string"><span class="function">@param flags Flag that can take values of cv::ImreadModes</span></span></span><br><span class="line"><span class="string"><span class="function">*/</span></span></span><br><span class="line"><span class="string"><span class="function">CV_EXPORTS_W Mat imread( const String&amp; filename, int flags = IMREAD_COLOR );</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mat img = imread(&quot;a.jpg&quot;, 2 | 4); //载入无损源图像</span><br><span class="line">Mat img = imread(&quot;a.jpg&quot;, 0); //载入灰度图</span><br></pre></td></tr></table></figure>

<h2 id="图像的显示"><a href="#图像的显示" class="headerlink" title="图像的显示"></a>图像的显示</h2><p>imshow函数，用在指定界面显示图像</p>
<ul>
<li>如果窗口使用cv::WINDOW_AUTOSIZE创建，会显示原始大小（还是会受限屏幕），否则会将图片缩放适合窗口。缩放图像取决于深度：<ul>
<li>8位无符号，显示图像原来样子</li>
<li>16位无符号或32位整型，用像素值除以256，值在 [0,255]</li>
<li>如果图像是32位或64位浮点型，像素乘以255，[0,1] 映射到[0,255]</li>
</ul>
</li>
<li>如果窗口创建，设定了支持openGL，imshow 还支持 ogl::Buffer , ogl::Texture2D 和<br>cuda::GpuMat 作为输入.</li>
<li>如果你需要显示图像大于屏幕，在imshow前需要调用namedWindow(“”, WINDOW_NORMAL).</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** @brief Displays an image in the specified window.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The function imshow displays an image in the specified window. If the window was created with the</span></span><br><span class="line"><span class="comment">cv::WINDOW_AUTOSIZE flag, the image is shown with its original size, however it is still limited by the screen resolution.</span></span><br><span class="line"><span class="comment">Otherwise, the image is scaled to fit the window. The function may scale the image, depending on its depth:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-   If the image is 8-bit unsigned, it is displayed as is.</span></span><br><span class="line"><span class="comment">-   If the image is 16-bit unsigned or 32-bit integer, the pixels are divided by 256. That is, the</span></span><br><span class="line"><span class="comment">    value range [0,255\*256] is mapped to [0,255].</span></span><br><span class="line"><span class="comment">-   If the image is 32-bit or 64-bit floating-point, the pixel values are multiplied by 255. That is, the</span></span><br><span class="line"><span class="comment">    value range [0,1] is mapped to [0,255].</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">If window was created with OpenGL support, cv::imshow also support ogl::Buffer , ogl::Texture2D and</span></span><br><span class="line"><span class="comment">cuda::GpuMat as input.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">If the window was not created before this function, it is assumed creating a window with cv::WINDOW_AUTOSIZE.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">If you need to show an image that is bigger than the screen resolution, you will need to call namedWindow(&quot;&quot;, WINDOW_NORMAL) before the imshow.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@note This function should be followed by cv::waitKey function which displays the image for specified</span></span><br><span class="line"><span class="comment">milliseconds. Otherwise, it won&#x27;t display the image. For example, **waitKey(0)** will display the window</span></span><br><span class="line"><span class="comment">infinitely until any keypress (it is suitable for image display). **waitKey(25)** will display a frame</span></span><br><span class="line"><span class="comment">for 25 ms, after which display will be automatically closed. (If you put it in a loop to read</span></span><br><span class="line"><span class="comment">videos, it will display the video frame-by-frame)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@note</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[__Windows Backend Only__] Pressing Ctrl+C will copy the image to the clipboard.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[__Windows Backend Only__] Pressing Ctrl+S will show a dialog to save the image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param winname Name of the window.</span></span><br><span class="line"><span class="comment">@param mat Image to be shown.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CV_EXPORTS_W <span class="keyword">void</span> <span class="title">imshow</span><span class="params">(<span class="keyword">const</span> String&amp; winname, InputArray mat)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="InputArray类型"><a href="#InputArray类型" class="headerlink" title="InputArray类型"></a>InputArray类型</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> _InputArray&amp; InputArray;</span><br></pre></td></tr></table></figure>



<p>_InputArray在core.hpp头文件里面</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////// Input/Output Array Arguments /////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @brief This is the proxy class for passing read-only input arrays into OpenCV functions.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">It is defined as:</span></span><br><span class="line"><span class="comment">@code</span></span><br><span class="line"><span class="comment">    typedef const _InputArray&amp; InputArray;</span></span><br><span class="line"><span class="comment">@endcode</span></span><br><span class="line"><span class="comment">where _InputArray is a class that can be constructed from `Mat`, `Mat_&lt;T&gt;`, `Matx&lt;T, m, n&gt;`,</span></span><br><span class="line"><span class="comment">`std::vector&lt;T&gt;`, `std::vector&lt;std::vector&lt;T&gt; &gt;`, `std::vector&lt;Mat&gt;`, `std::vector&lt;Mat_&lt;T&gt; &gt;`,</span></span><br><span class="line"><span class="comment">`UMat`, `std::vector&lt;UMat&gt;` or `double`. It can also be constructed from a matrix expression.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Since this is mostly implementation-level class, and its interface may change in future versions, we</span></span><br><span class="line"><span class="comment">do not describe it in details. There are a few key things, though, that should be kept in mind:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-   When you see in the reference manual or in OpenCV source code a function that takes</span></span><br><span class="line"><span class="comment">    InputArray, it means that you can actually pass `Mat`, `Matx`, `vector&lt;T&gt;` etc. (see above the</span></span><br><span class="line"><span class="comment">    complete list).</span></span><br><span class="line"><span class="comment">-   Optional input arguments: If some of the input arrays may be empty, pass cv::noArray() (or</span></span><br><span class="line"><span class="comment">    simply cv::Mat() as you probably did before).</span></span><br><span class="line"><span class="comment">-   The class is designed solely for passing parameters. That is, normally you *should not*</span></span><br><span class="line"><span class="comment">    declare class members, local and global variables of this type.</span></span><br><span class="line"><span class="comment">-   If you want to design your own function or a class method that can operate of arrays of</span></span><br><span class="line"><span class="comment">    multiple types, you can use InputArray (or OutputArray) for the respective parameters. Inside</span></span><br><span class="line"><span class="comment">    a function you should use _InputArray::getMat() method to construct a matrix header for the</span></span><br><span class="line"><span class="comment">    array (without copying data). _InputArray::kind() can be used to distinguish Mat from</span></span><br><span class="line"><span class="comment">    `vector&lt;&gt;` etc., but normally it is not needed.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Here is how you can use a function that takes InputArray :</span></span><br><span class="line"><span class="comment">@code</span></span><br><span class="line"><span class="comment">    std::vector&lt;Point2f&gt; vec;</span></span><br><span class="line"><span class="comment">    // points or a circle</span></span><br><span class="line"><span class="comment">    for( int i = 0; i &lt; 30; i++ )</span></span><br><span class="line"><span class="comment">        vec.push_back(Point2f((float)(100 + 30*cos(i*CV_PI*2/5)),</span></span><br><span class="line"><span class="comment">                              (float)(100 - 30*sin(i*CV_PI*2/5))));</span></span><br><span class="line"><span class="comment">    cv::transform(vec, vec, cv::Matx23f(0.707, -0.707, 10, 0.707, 0.707, 20));</span></span><br><span class="line"><span class="comment">@endcode</span></span><br><span class="line"><span class="comment">That is, we form an STL vector containing points, and apply in-place affine transformation to the</span></span><br><span class="line"><span class="comment">vector using the 2x3 matrix created inline as `Matx&lt;float, 2, 3&gt;` instance.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Here is how such a function can be implemented (for simplicity, we implement a very specific case of</span></span><br><span class="line"><span class="comment">it, according to the assertion statement inside) :</span></span><br><span class="line"><span class="comment">@code</span></span><br><span class="line"><span class="comment">    void myAffineTransform(InputArray _src, OutputArray _dst, InputArray _m)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        // get Mat headers for input arrays. This is O(1) operation,</span></span><br><span class="line"><span class="comment">        // unless _src and/or _m are matrix expressions.</span></span><br><span class="line"><span class="comment">        Mat src = _src.getMat(), m = _m.getMat();</span></span><br><span class="line"><span class="comment">        CV_Assert( src.type() == CV_32FC2 &amp;&amp; m.type() == CV_32F &amp;&amp; m.size() == Size(3, 2) );</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // [re]create the output array so that it has the proper size and type.</span></span><br><span class="line"><span class="comment">        // In case of Mat it calls Mat::create, in case of STL vector it calls vector::resize.</span></span><br><span class="line"><span class="comment">        _dst.create(src.size(), src.type());</span></span><br><span class="line"><span class="comment">        Mat dst = _dst.getMat();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        for( int i = 0; i &lt; src.rows; i++ )</span></span><br><span class="line"><span class="comment">            for( int j = 0; j &lt; src.cols; j++ )</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                Point2f pt = src.at&lt;Point2f&gt;(i, j);</span></span><br><span class="line"><span class="comment">                dst.at&lt;Point2f&gt;(i, j) = Point2f(m.at&lt;float&gt;(0, 0)*pt.x +</span></span><br><span class="line"><span class="comment">                                                m.at&lt;float&gt;(0, 1)*pt.y +</span></span><br><span class="line"><span class="comment">                                                m.at&lt;float&gt;(0, 2),</span></span><br><span class="line"><span class="comment">                                                m.at&lt;float&gt;(1, 0)*pt.x +</span></span><br><span class="line"><span class="comment">                                                m.at&lt;float&gt;(1, 1)*pt.y +</span></span><br><span class="line"><span class="comment">                                                m.at&lt;float&gt;(1, 2));</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">@endcode</span></span><br><span class="line"><span class="comment">There is another related type, InputArrayOfArrays, which is currently defined as a synonym for</span></span><br><span class="line"><span class="comment">InputArray:</span></span><br><span class="line"><span class="comment">@code</span></span><br><span class="line"><span class="comment">    typedef InputArray InputArrayOfArrays;</span></span><br><span class="line"><span class="comment">@endcode</span></span><br><span class="line"><span class="comment">It denotes function arguments that are either vectors of vectors or vectors of matrices. A separate</span></span><br><span class="line"><span class="comment">synonym is needed to generate Python/Java etc. wrappers properly. At the function implementation</span></span><br><span class="line"><span class="comment">level their use is similar, but _InputArray::getMat(idx) should be used to get header for the</span></span><br><span class="line"><span class="comment">idx-th component of the outer vector and _InputArray::size().area() should be used to find the</span></span><br><span class="line"><span class="comment">number of components (vectors/matrices) of the outer vector.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">In general, type support is limited to cv::Mat types. Other types are forbidden.</span></span><br><span class="line"><span class="comment">But in some cases we need to support passing of custom non-general Mat types, like arrays of cv::KeyPoint, cv::DMatch, etc.</span></span><br><span class="line"><span class="comment">This data is not intented to be interpreted as an image data, or processed somehow like regular cv::Mat.</span></span><br><span class="line"><span class="comment">To pass such custom type use rawIn() / rawOut() / rawInOut() wrappers.</span></span><br><span class="line"><span class="comment">Custom type is wrapped as Mat-compatible `CV_8UC&lt;N&gt;` values (N = sizeof(T), N &lt;= CV_CN_MAX).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CV_EXPORTS</span> _<span class="title">InputArray</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">        KIND_SHIFT = <span class="number">16</span>,</span><br><span class="line">        FIXED_TYPE = <span class="number">0x8000</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        FIXED_SIZE = <span class="number">0x4000</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        KIND_MASK = <span class="number">31</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line"></span><br><span class="line">        NONE              = <span class="number">0</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        MAT               = <span class="number">1</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        MATX              = <span class="number">2</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_VECTOR        = <span class="number">3</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_VECTOR_VECTOR = <span class="number">4</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_VECTOR_MAT    = <span class="number">5</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        EXPR              = <span class="number">6</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        OPENGL_BUFFER     = <span class="number">7</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        CUDA_HOST_MEM     = <span class="number">8</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        CUDA_GPU_MAT      = <span class="number">9</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        UMAT              =<span class="number">10</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_VECTOR_UMAT   =<span class="number">11</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_BOOL_VECTOR   =<span class="number">12</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_VECTOR_CUDA_GPU_MAT = <span class="number">13</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_ARRAY         =<span class="number">14</span> &lt;&lt; KIND_SHIFT,</span><br><span class="line">        STD_ARRAY_MAT     =<span class="number">15</span> &lt;&lt; KIND_SHIFT</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    _InputArray();</span><br><span class="line">    _InputArray(<span class="keyword">int</span> _flags, <span class="keyword">void</span>* _obj);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> Mat&amp; m);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> MatExpr&amp; expr);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> std::vector&lt;Mat&gt;&amp; vec);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt; _InputArray(<span class="keyword">const</span> Mat_&lt;_Tp&gt;&amp; m);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt; _InputArray(<span class="keyword">const</span> std::vector&lt;_Tp&gt;&amp; vec);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> std::vector&lt;<span class="keyword">bool</span>&gt;&amp; vec);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt; _InputArray(<span class="keyword">const</span> std::vector&lt;std::vector&lt;_Tp&gt; &gt;&amp; vec);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> std::vector&lt;std::vector&lt;<span class="keyword">bool</span>&gt; &gt;&amp;);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt; _InputArray(<span class="keyword">const</span> std::vector&lt;Mat_&lt;_Tp&gt; &gt;&amp; vec);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt; _InputArray(<span class="keyword">const</span> _Tp* vec, <span class="keyword">int</span> n);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">int</span> m, <span class="keyword">int</span> n&gt; _InputArray(<span class="keyword">const</span> Matx&lt;_Tp, m, n&gt;&amp; matx);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> <span class="keyword">double</span>&amp; val);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> cuda::GpuMat&amp; d_mat);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> std::vector&lt;cuda::GpuMat&gt;&amp; d_mat_array);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> ogl::Buffer&amp; buf);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> cuda::HostMem&amp; cuda_mem);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt; _InputArray(<span class="keyword">const</span> cudev::GpuMat_&lt;_Tp&gt;&amp; m);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> UMat&amp; um);</span><br><span class="line">    _InputArray(<span class="keyword">const</span> std::vector&lt;UMat&gt;&amp; umv);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CV_CXX_STD_ARRAY</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, std::<span class="keyword">size_t</span> _Nm&gt; _InputArray(<span class="keyword">const</span> std::array&lt;_Tp, _Nm&gt;&amp; arr);</span><br><span class="line">    <span class="keyword">template</span>&lt;std::<span class="keyword">size_t</span> _Nm&gt; _InputArray(<span class="keyword">const</span> std::array&lt;Mat, _Nm&gt;&amp; arr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt; <span class="keyword">static</span> _InputArray <span class="title">rawIn</span><span class="params">(<span class="keyword">const</span> std::vector&lt;_Tp&gt;&amp; vec)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CV_CXX_STD_ARRAY</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, std::<span class="keyword">size_t</span> _Nm&gt; <span class="keyword">static</span> _InputArray <span class="title">rawIn</span><span class="params">(<span class="keyword">const</span> std::array&lt;_Tp, _Nm&gt;&amp; arr)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function">Mat <span class="title">getMat</span><span class="params">(<span class="keyword">int</span> idx=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">Mat <span class="title">getMat_</span><span class="params">(<span class="keyword">int</span> idx=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">UMat <span class="title">getUMat</span><span class="params">(<span class="keyword">int</span> idx=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getMatVector</span><span class="params">(std::vector&lt;Mat&gt;&amp; mv)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getUMatVector</span><span class="params">(std::vector&lt;UMat&gt;&amp; umv)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getGpuMatVector</span><span class="params">(std::vector&lt;cuda::GpuMat&gt;&amp; gpumv)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">cuda::GpuMat <span class="title">getGpuMat</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">ogl::Buffer <span class="title">getOGlBuffer</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getFlags</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span>* <span class="title">getObj</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">Size <span class="title">getSz</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">kind</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">dims</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">cols</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">rows</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">Size <span class="title">size</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sizend</span><span class="params">(<span class="keyword">int</span>* sz, <span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">sameSize</span><span class="params">(<span class="keyword">const</span> _InputArray&amp; arr)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">total</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">depth</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">channels</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isContinuous</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSubmatrix</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">copyTo</span><span class="params">(<span class="keyword">const</span> _OutputArray&amp; arr)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">copyTo</span><span class="params">(<span class="keyword">const</span> _OutputArray&amp; arr, <span class="keyword">const</span> _InputArray &amp; mask)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">offset</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">step</span><span class="params">(<span class="keyword">int</span> i=<span class="number">-1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isMat</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isUMat</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isMatVector</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isUMatVector</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isMatx</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isVector</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isGpuMat</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isGpuMatVector</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    ~_InputArray();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">void</span>* obj;</span><br><span class="line">    Size sz;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> _flags, <span class="keyword">const</span> <span class="keyword">void</span>* _obj)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> _flags, <span class="keyword">const</span> <span class="keyword">void</span>* _obj, Size _sz)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果你看到使用InputArray,可以当成 <code>Mat</code>, <code>Matx</code>, <code>vector&lt;T&gt;</code> 等</li>
</ul>
<h2 id="创建窗口namedWindow-函数"><a href="#创建窗口namedWindow-函数" class="headerlink" title="创建窗口namedWindow()函数"></a>创建窗口namedWindow()函数</h2><p>上面说过，简单显示不需要调用，如果需要用到窗口则需要用到.</p>
<ul>
<li>如果窗口名已经存在，则不做任何处理</li>
<li>调用 cv::destroyWindow 或 cv::destroyAllWindows 关闭窗口 释放内存空间。如果是简单程序，退出时，资源会被系统释放掉</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @brief Creates a window.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The function namedWindow creates a window that can be used as a placeholder for images and</span></span><br><span class="line"><span class="comment">trackbars. Created windows are referred to by their names.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">If a window with the same name already exists, the function does nothing.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">You can call cv::destroyWindow or cv::destroyAllWindows to close the window and de-allocate any associated</span></span><br><span class="line"><span class="comment">memory usage. For a simple program, you do not really have to call these functions because all the</span></span><br><span class="line"><span class="comment">resources and windows of the application are closed automatically by the operating system upon exit.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@note</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Qt backend supports additional flags:</span></span><br><span class="line"><span class="comment"> -   **WINDOW_NORMAL or WINDOW_AUTOSIZE:** WINDOW_NORMAL enables you to resize the</span></span><br><span class="line"><span class="comment">     window, whereas WINDOW_AUTOSIZE adjusts automatically the window size to fit the</span></span><br><span class="line"><span class="comment">     displayed image (see imshow ), and you cannot change the window size manually.</span></span><br><span class="line"><span class="comment"> -   **WINDOW_FREERATIO or WINDOW_KEEPRATIO:** WINDOW_FREERATIO adjusts the image</span></span><br><span class="line"><span class="comment">     with no respect to its ratio, whereas WINDOW_KEEPRATIO keeps the image ratio.</span></span><br><span class="line"><span class="comment"> -   **WINDOW_GUI_NORMAL or WINDOW_GUI_EXPANDED:** WINDOW_GUI_NORMAL is the old way to draw the window</span></span><br><span class="line"><span class="comment">     without statusbar and toolbar, whereas WINDOW_GUI_EXPANDED is a new enhanced GUI.</span></span><br><span class="line"><span class="comment">By default, flags == WINDOW_AUTOSIZE | WINDOW_KEEPRATIO | WINDOW_GUI_EXPANDED</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param winname Name of the window in the window caption that may be used as a window identifier.</span></span><br><span class="line"><span class="comment">@param flags Flags of the window. The supported flags are: (cv::WindowFlags)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CV_EXPORTS_W <span class="keyword">void</span> <span class="title">namedWindow</span><span class="params">(<span class="keyword">const</span> String&amp; winname, <span class="keyword">int</span> flags = WINDOW_AUTOSIZE)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>第二个参数flags，窗口标识<ul>
<li>WINDOW_NORMAL，用户可以改变窗口大小</li>
<li>WINDOW_AUTOSIZE，窗口自动适应显示图像，无法手动改变</li>
<li>WINDOW_OPENGL, 支持openGL</li>
<li>WINDOW_FULLSCREEN， 全屏</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! Flags for cv::namedWindow</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">WindowFlags</span> &#123;</span></span><br><span class="line">       WINDOW_NORMAL     = <span class="number">0x00000000</span>, <span class="comment">//!&lt; the user can resize the window (no constraint) / also use to switch a fullscreen window to a normal size.</span></span><br><span class="line">       WINDOW_AUTOSIZE   = <span class="number">0x00000001</span>, <span class="comment">//!&lt; the user cannot resize the window, the size is constrainted by the image displayed.</span></span><br><span class="line">       WINDOW_OPENGL     = <span class="number">0x00001000</span>, <span class="comment">//!&lt; window with opengl support.</span></span><br><span class="line"></span><br><span class="line">       WINDOW_FULLSCREEN = <span class="number">1</span>,          <span class="comment">//!&lt; change the window to fullscreen.</span></span><br><span class="line">       WINDOW_FREERATIO  = <span class="number">0x00000100</span>, <span class="comment">//!&lt; the image expends as much as it can (no ratio constraint).</span></span><br><span class="line">       WINDOW_KEEPRATIO  = <span class="number">0x00000000</span>, <span class="comment">//!&lt; the ratio of the image is respected.</span></span><br><span class="line">       WINDOW_GUI_EXPANDED=<span class="number">0x00000000</span>, <span class="comment">//!&lt; status bar and tool bar</span></span><br><span class="line">       WINDOW_GUI_NORMAL = <span class="number">0x00000010</span>, <span class="comment">//!&lt; old fashious way</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="输出图像到文件：imwrite"><a href="#输出图像到文件：imwrite" class="headerlink" title="输出图像到文件：imwrite()"></a>输出图像到文件：imwrite()</h2><p>函数会写入到指定文件，图像格式基于拓展名。只有8位单通道或者3通道BGR图像可以使用这个函数写入，</p>
<ul>
<li><p>16位无符号图像可以保存PNG, JPEG 2000, and TIFF 格式</p>
</li>
<li><p>32位浮点可以保存TIFF, OpenEXR, and Radiance HDR格式；3通道TIFF图像可以使用LogLuv高动态范围编码（每像素4字节）保存</p>
</li>
<li><p>可以保存带有alpha通道的PNG图像。8或16位的4通道BGRA图像（最后一个通道是alpha通道）。把alpha设置为0就是透明像素，完全不透明像素应将alpha设置为255/65535</p>
</li>
<li><p>如果格式、通道、深度不同，用Mat::convertTo 和 cv::cvtColor转换或者使用通用文件存储I/O</p>
<p>函数将图像保存为XML或YAML格式</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @brief Saves an image to a specified file.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The function imwrite saves the image to the specified file. The image format is chosen based on the</span></span><br><span class="line"><span class="comment">filename extension (see cv::imread for the list of extensions). In general, only 8-bit</span></span><br><span class="line"><span class="comment">single-channel or 3-channel (with &#x27;BGR&#x27; channel order) images</span></span><br><span class="line"><span class="comment">can be saved using this function, with these exceptions:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- 16-bit unsigned (CV_16U) images can be saved in the case of PNG, JPEG 2000, and TIFF formats</span></span><br><span class="line"><span class="comment">- 32-bit float (CV_32F) images can be saved in TIFF, OpenEXR, and Radiance HDR formats; 3-channel</span></span><br><span class="line"><span class="comment">(CV_32FC3) TIFF images will be saved using the LogLuv high dynamic range encoding (4 bytes per pixel)</span></span><br><span class="line"><span class="comment">- PNG images with an alpha channel can be saved using this function. To do this, create</span></span><br><span class="line"><span class="comment">8-bit (or 16-bit) 4-channel image BGRA, where the alpha channel goes last. Fully transparent pixels</span></span><br><span class="line"><span class="comment">should have alpha set to 0, fully opaque pixels should have alpha set to 255/65535 (see the code sample below).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">If the format, depth or channel order is different, use</span></span><br><span class="line"><span class="comment">Mat::convertTo and cv::cvtColor to convert it before saving. Or, use the universal FileStorage I/O</span></span><br><span class="line"><span class="comment">functions to save the image to XML or YAML format.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The sample below shows how to create a BGRA image and save it to a PNG file. It also demonstrates how to set custom</span></span><br><span class="line"><span class="comment">compression parameters:</span></span><br><span class="line"><span class="comment">@include snippets/imgcodecs_imwrite.cpp</span></span><br><span class="line"><span class="comment">@param filename Name of the file.</span></span><br><span class="line"><span class="comment">@param img Image to be saved.</span></span><br><span class="line"><span class="comment">@param params Format-specific parameters encoded as pairs (paramId_1, paramValue_1, paramId_2, paramValue_2, ... .) see cv::ImwriteFlags</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">CV_EXPORTS_W <span class="keyword">bool</span> <span class="title">imwrite</span><span class="params">( <span class="keyword">const</span> String&amp; filename, InputArray img,</span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; params = std::vector&lt;<span class="keyword">int</span>&gt;())</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>第一个参数filename，文件名需要带拓展名</li>
<li>第二个参数输入一个矩阵Mat</li>
<li>第三个参数是为特定格式保存的参数编码。有默认值，一般不需要填。<ul>
<li>JPEG格式图片，这个参数0-100(CV_IMWRITE_JPEG_QUALITY),默认95</li>
<li>PNG格式，压缩级别0-9（CV_IMWRITE_PNG_COMPRESSION），数值越大表明更小尺寸更长压缩时间，默认3</li>
<li>PPM，PGM或PBM，表示二进制格式标示（CV_IMWRITE_PXM_BINARY），参数0-1，默认1</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    CV_IMWRITE_JPEG_QUALITY =<span class="number">1</span>,</span><br><span class="line">    CV_IMWRITE_JPEG_PROGRESSIVE =<span class="number">2</span>,</span><br><span class="line">    CV_IMWRITE_JPEG_OPTIMIZE =<span class="number">3</span>,</span><br><span class="line">    CV_IMWRITE_JPEG_RST_INTERVAL =<span class="number">4</span>,</span><br><span class="line">    CV_IMWRITE_JPEG_LUMA_QUALITY =<span class="number">5</span>,</span><br><span class="line">    CV_IMWRITE_JPEG_CHROMA_QUALITY =<span class="number">6</span>,</span><br><span class="line">    CV_IMWRITE_PNG_COMPRESSION =<span class="number">16</span>,</span><br><span class="line">    CV_IMWRITE_PNG_STRATEGY =<span class="number">17</span>,</span><br><span class="line">    CV_IMWRITE_PNG_BILEVEL =<span class="number">18</span>,</span><br><span class="line">    CV_IMWRITE_PNG_STRATEGY_DEFAULT =<span class="number">0</span>,</span><br><span class="line">    CV_IMWRITE_PNG_STRATEGY_FILTERED =<span class="number">1</span>,</span><br><span class="line">    CV_IMWRITE_PNG_STRATEGY_HUFFMAN_ONLY =<span class="number">2</span>,</span><br><span class="line">    CV_IMWRITE_PNG_STRATEGY_RLE =<span class="number">3</span>,</span><br><span class="line">    CV_IMWRITE_PNG_STRATEGY_FIXED =<span class="number">4</span>,</span><br><span class="line">    CV_IMWRITE_PXM_BINARY =<span class="number">32</span>,</span><br><span class="line">    CV_IMWRITE_EXR_TYPE = <span class="number">48</span>,</span><br><span class="line">    CV_IMWRITE_WEBP_QUALITY =<span class="number">64</span>,</span><br><span class="line">    CV_IMWRITE_PAM_TUPLETYPE = <span class="number">128</span>,</span><br><span class="line">    CV_IMWRITE_PAM_FORMAT_NULL = <span class="number">0</span>,</span><br><span class="line">    CV_IMWRITE_PAM_FORMAT_BLACKANDWHITE = <span class="number">1</span>,</span><br><span class="line">    CV_IMWRITE_PAM_FORMAT_GRAYSCALE = <span class="number">2</span>,</span><br><span class="line">    CV_IMWRITE_PAM_FORMAT_GRAYSCALE_ALPHA = <span class="number">3</span>,</span><br><span class="line">    CV_IMWRITE_PAM_FORMAT_RGB = <span class="number">4</span>,</span><br><span class="line">    CV_IMWRITE_PAM_FORMAT_RGB_ALPHA = <span class="number">5</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="滑动条创建和使用"><a href="#滑动条创建和使用" class="headerlink" title="滑动条创建和使用"></a>滑动条创建和使用</h2><ul>
<li><p>创建滑动条，这个函数通过指定名字和范围来创建一个滑动条。</p>
<ul>
<li>第一个参数trackbarname，滑动条名字</li>
<li>第二个参数winname，滑动条要依附的窗口名</li>
<li>第三个参数value，指针，表示滑块的位置</li>
<li>第四个参数count，表示滑块可以到达的最大位置</li>
<li>第五个参数onChange，指向回调函数的指针，每次滑块改变位置都会回调该函数<ul>
<li>第一个参数是滑块条的位置</li>
<li>第二个参数是用户数据</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @brief Callback function for Trackbar see cv::createTrackbar</span></span><br><span class="line"><span class="comment">@param pos current position of the specified trackbar.</span></span><br><span class="line"><span class="comment">@param userdata The optional parameter.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*TrackbarCallback)</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">void</span>* userdata)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>用户数据指针将会被传递到滑块回调函数</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @brief Creates a trackbar and attaches it to the specified window.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The function createTrackbar creates a trackbar (a slider or range control) with the specified name</span></span><br><span class="line"><span class="comment">and range, assigns a variable value to be a position synchronized with the trackbar and specifies</span></span><br><span class="line"><span class="comment">the callback function onChange to be called on the trackbar position change. The created trackbar is</span></span><br><span class="line"><span class="comment">displayed in the specified window winname.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@note</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[__Qt Backend Only__] winname can be empty (or NULL) if the trackbar should be attached to the</span></span><br><span class="line"><span class="comment">control panel.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Clicking the label of each trackbar enables editing the trackbar values manually.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param trackbarname Name of the created trackbar.</span></span><br><span class="line"><span class="comment">@param winname Name of the window that will be used as a parent of the created trackbar.</span></span><br><span class="line"><span class="comment">@param value Optional pointer to an integer variable whose value reflects the position of the</span></span><br><span class="line"><span class="comment">slider. Upon creation, the slider position is defined by this variable.</span></span><br><span class="line"><span class="comment">@param count Maximal position of the slider. The minimal position is always 0.</span></span><br><span class="line"><span class="comment">@param onChange Pointer to the function to be called every time the slider changes position. This</span></span><br><span class="line"><span class="comment">function should be prototyped as void Foo(int,void\*); , where the first parameter is the trackbar</span></span><br><span class="line"><span class="comment">position and the second parameter is the user data (see the next parameter). If the callback is</span></span><br><span class="line"><span class="comment">the NULL pointer, no callbacks are called, but only value is updated.</span></span><br><span class="line"><span class="comment">@param userdata User data that is passed as is to the callback. It can be used to handle trackbar</span></span><br><span class="line"><span class="comment">events without using global variables.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CV_EXPORTS <span class="keyword">int</span> <span class="title">createTrackbar</span><span class="params">(<span class="keyword">const</span> String&amp; trackbarname, <span class="keyword">const</span> String&amp; winname,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">int</span>* value, <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="params"><span class="function">                              TrackbarCallback onChange = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">void</span>* userdata = <span class="number">0</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取当前滑动条位置.<ul>
<li>第一个参数指定要获取的滑动条名</li>
<li>第二个参数指定滑块归属的窗口名</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @brief Returns the trackbar position.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The function returns the current position of the specified trackbar.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@note</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[__Qt Backend Only__] winname can be empty (or NULL) if the trackbar is attached to the control</span></span><br><span class="line"><span class="comment">panel.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param trackbarname Name of the trackbar.</span></span><br><span class="line"><span class="comment">@param winname Name of the window that is the parent of the trackbar.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CV_EXPORTS_W <span class="keyword">int</span> <span class="title">getTrackbarPos</span><span class="params">(<span class="keyword">const</span> String&amp; trackbarname, <span class="keyword">const</span> String&amp; winname)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>鼠标操作。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @brief Sets mouse handler for the specified window</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@param winname Name of the window.</span></span><br><span class="line"><span class="comment">@param onMouse Callback function for mouse events. See OpenCV samples on how to specify and use the callback.</span></span><br><span class="line"><span class="comment">@param userdata The optional parameter passed to the callback.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CV_EXPORTS <span class="keyword">void</span> <span class="title">setMouseCallback</span><span class="params">(<span class="keyword">const</span> String&amp; winname, MouseCallback onMouse, <span class="keyword">void</span>* userdata = <span class="number">0</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第一个参数，窗口名</p>
</li>
<li><p>第二个参数onMouse,鼠标事件回调函数</p>
<ul>
<li>事件</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! Mouse Events see cv::MouseCallback</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">MouseEventTypes</span> &#123;</span></span><br><span class="line">       EVENT_MOUSEMOVE      = <span class="number">0</span>, <span class="comment">//!&lt; indicates that the mouse pointer has moved over the window.</span></span><br><span class="line">       EVENT_LBUTTONDOWN    = <span class="number">1</span>, <span class="comment">//!&lt; indicates that the left mouse button is pressed.</span></span><br><span class="line">       EVENT_RBUTTONDOWN    = <span class="number">2</span>, <span class="comment">//!&lt; indicates that the right mouse button is pressed.</span></span><br><span class="line">       EVENT_MBUTTONDOWN    = <span class="number">3</span>, <span class="comment">//!&lt; indicates that the middle mouse button is pressed.</span></span><br><span class="line">       EVENT_LBUTTONUP      = <span class="number">4</span>, <span class="comment">//!&lt; indicates that left mouse button is released.</span></span><br><span class="line">       EVENT_RBUTTONUP      = <span class="number">5</span>, <span class="comment">//!&lt; indicates that right mouse button is released.</span></span><br><span class="line">       EVENT_MBUTTONUP      = <span class="number">6</span>, <span class="comment">//!&lt; indicates that middle mouse button is released.</span></span><br><span class="line">       EVENT_LBUTTONDBLCLK  = <span class="number">7</span>, <span class="comment">//!&lt; indicates that left mouse button is double clicked.</span></span><br><span class="line">       EVENT_RBUTTONDBLCLK  = <span class="number">8</span>, <span class="comment">//!&lt; indicates that right mouse button is double clicked.</span></span><br><span class="line">       EVENT_MBUTTONDBLCLK  = <span class="number">9</span>, <span class="comment">//!&lt; indicates that middle mouse button is double clicked.</span></span><br><span class="line">       EVENT_MOUSEWHEEL     = <span class="number">10</span>,<span class="comment">//!&lt; positive and negative values mean forward and backward scrolling, respectively.</span></span><br><span class="line">       EVENT_MOUSEHWHEEL    = <span class="number">11</span> <span class="comment">//!&lt; positive and negative values mean right and left scrolling, respectively.</span></span><br><span class="line">     &#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! Mouse Event Flags see cv::MouseCallback</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">MouseEventFlags</span> &#123;</span></span><br><span class="line">       EVENT_FLAG_LBUTTON   = <span class="number">1</span>, <span class="comment">//!&lt; indicates that the left mouse button is down.</span></span><br><span class="line">       EVENT_FLAG_RBUTTON   = <span class="number">2</span>, <span class="comment">//!&lt; indicates that the right mouse button is down.</span></span><br><span class="line">       EVENT_FLAG_MBUTTON   = <span class="number">4</span>, <span class="comment">//!&lt; indicates that the middle mouse button is down.</span></span><br><span class="line">       EVENT_FLAG_CTRLKEY   = <span class="number">8</span>, <span class="comment">//!&lt; indicates that CTRL Key is pressed.</span></span><br><span class="line">       EVENT_FLAG_SHIFTKEY  = <span class="number">16</span>,<span class="comment">//!&lt; indicates that SHIFT Key is pressed.</span></span><br><span class="line">       EVENT_FLAG_ALTKEY    = <span class="number">32</span> <span class="comment">//!&lt; indicates that ALT Key is pressed.</span></span><br><span class="line">     &#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @brief Callback function for mouse events. see cv::setMouseCallback</span></span><br><span class="line"><span class="comment">@param event one of the cv::MouseEventTypes constants.</span></span><br><span class="line"><span class="comment">@param x The x-coordinate of the mouse event.</span></span><br><span class="line"><span class="comment">@param y The y-coordinate of the mouse event.</span></span><br><span class="line"><span class="comment">@param flags one of the cv::MouseEventFlags constants.</span></span><br><span class="line"><span class="comment">@param userdata The optional parameter.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MouseCallback)</span><span class="params">(<span class="keyword">int</span> event, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> flags, <span class="keyword">void</span>* userdata)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>第三个参数是传递给回调的用户数据指针</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/a2eaa8a6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/a2eaa8a6.html" class="post-title-link" itemprop="url">从0开始学习opencv（一）-配置环境</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-10-27 01:43:39" itemprop="dateCreated datePublished" datetime="2019-10-27T01:43:39+08:00">2019-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%B8%B8%E6%88%8F/" itemprop="url" rel="index"><span itemprop="name">游戏</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Mac环境，安装OpenCV，VScode调试C-程序"><a href="#Mac环境，安装OpenCV，VScode调试C-程序" class="headerlink" title="Mac环境，安装OpenCV，VScode调试C++程序"></a>Mac环境，安装OpenCV，VScode调试C++程序</h1><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><ul>
<li>macOS版本 catalina 10.15版本</li>
<li>opencv3</li>
<li>vscode</li>
</ul>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li><p>安装XCode工具Command Line <code>**sudo** xcode-select --install</code></p>
</li>
<li><p>安装homebrew，可以用Homebrew安装很多东西</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span><br></pre></td></tr></table></figure>

<p>brew下载后发生很慢的情况，是因为某种不可描述的原因。这时候需要国内镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git -C &quot;$(brew --repo)&quot; remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git</span><br><span class="line"></span><br><span class="line">git -C &quot;$(brew --repo homebrew/core)&quot; remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git</span><br><span class="line"></span><br><span class="line">git -C &quot;$(brew --repo homebrew/cask)&quot; remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-cask.git</span><br><span class="line"></span><br><span class="line">brew update</span><br></pre></td></tr></table></figure></li>
<li><p>安装cmake，如果你用的<code>homebrew</code>方式安裝<code>opencv</code>那麼CMake就不是必須的.</p>
<p>到<a target="_blank" rel="noopener" href="https://cmake.org/download/%E4%B8%8B%E4%B8%8B%E8%BD%BDcmake%E5%AE%89%E8%A3%85%E5%8C%85%E5%AE%89%E8%A3%85">https://cmake.org/download/下下载cmake安装包安装</a></p>
<p><img src="https://user-images.githubusercontent.com/7789698/67623984-33222200-f85e-11e9-88fd-a132f96d7a57.png" alt="image"></p>
<p>或者使用<code>brew install cmake</code></p>
</li>
<li><p>安装opencv,使用brew安装<code>brew install opencv@3</code></p>
<p>如果遇到<code>Cloning into &#39;/Users/wangwenwei/Library/Caches/Homebrew/aom--git&#39;... fatal: unable to access &#39;https://aomedia.googlesource.com/aom.git/&#39;: Failed to connect to aomedia.googlesource.com port 443: Operation timed out</code>肯定又是因为某种不可描述的问题，无法安装aom</p>
<p>解决方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/Homebrew/homebrew-core/master/Formula/aom.rb</span><br><span class="line"> </span><br><span class="line"># 用本站提供的一份代码拷贝来替代原来的地址</span><br><span class="line">$ sed -i &quot;&quot; &quot;s/https:\/\/aomedia\.googlesource\.com\/aom\.git/https:\/\/www.mobibrw.com\/wp-content\/uploads\/2019\/04\/aom.zip/g&quot; aom.rb</span><br><span class="line"> </span><br><span class="line">$ brew uninstall --ignore-dependencies aom</span><br><span class="line"> </span><br><span class="line">$ brew install --build-from-source aom.rb --env=std</span><br></pre></td></tr></table></figure>

<p>(如果某种不可描述的原因连wget都不行，则直接访问<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/Homebrew/homebrew-core/master/Formula/aom.rb%E6%8A%8A%E5%86%85%E5%AE%B9%E6%8B%B7%E8%B4%9D%E5%88%B0aom.rb">https://raw.githubusercontent.com/Homebrew/homebrew-core/master/Formula/aom.rb把内容拷贝到aom.rb</a>)</p>
</li>
<li><p>写个demo测试gcc可用性</p>
<p>新建编辑main.cpp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/// ./main.cpp</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    std::cout &lt;&lt; &quot;absurd!\n&quot;;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">absurd$ g++ -g ./main.cpp -o ./main.o</span><br><span class="line">absurd$ ./main.o</span><br><span class="line">absurd!</span><br><span class="line">absurd$</span><br></pre></td></tr></table></figure></li>
<li><p>配置pkg-config</p>
<p>由 <code>brew list opencv</code>可以看到现在opencv的路径，拷贝相关配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/Cellar/opencv/4.1.2/lib/pkgconfig/opencv4.pc /usr/local/lib/pkgconfig/opencv.pc</span><br></pre></td></tr></table></figure>

<p>配置bash环境（永久的走/etc/profile）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">absurd$ echo PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig &gt;&gt; ~/.bash_profile</span><br><span class="line">absurd$ echo export PKG_CONFIG_PATH &gt;&gt; ~/.bash_profile</span><br><span class="line">absurd$ source ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>配置完后执行</p>
<p><code>pkg-config opencv --libs --cflags opencv</code></p>
</li>
<li><p>测试opencv的DEMO</p>
<p><img src="https://github.com/QianMo/OpenCV3-Intro-Book-Src/blob/master/OpenCV3-examples/src/%E3%80%901%E3%80%91%E7%AC%AC%E4%B8%80%E7%AB%A0/%E3%80%901%E3%80%91OpenCV%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E9%85%8D%E7%BD%AE/1_HelloOpenCV/1.jpg?raw=true" alt="image"></p>
<p>新建test.cpp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;opencv2/opencv.hpp&gt; //头文件</span><br><span class="line">using namespace cv; //包含cv命名空间</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	// 【1】读入一张图片</span><br><span class="line">	Mat img=imread(&quot;1.jpg&quot;);</span><br><span class="line">	// 【2】在窗口中显示载入的图片</span><br><span class="line">	imshow(&quot;【载入的图片】&quot;,img);</span><br><span class="line">	// 【3】等待6000 ms后窗口自动关闭</span><br><span class="line">	waitKey(6000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译<code>g++ </code>pkg-config opencv –libs –cflags opencv<code> ./test.cpp -o ./test.o</code>,</p>
<p>执行<code>./test.o</code></p>
<p>可以看到弹出图片</p>
</li>
<li><p>下载安装vscode，<a target="_blank" rel="noopener" href="https://code.visualstudio.com/">https://code.visualstudio.com/</a></p>
<p>安装插件C/C++、C++ Intellisense、C++ Clang Command Adapter、Chinese (Simplified) Language Pack for Visual Studio Code（中文语言包，看个人喜好）</p>
<p><img src="https://user-images.githubusercontent.com/7789698/67624402-af1e6900-f862-11e9-805f-5667049e317a.png" alt="image"></p>
</li>
<li><p>配置vscode</p>
<p><img src="https://user-images.githubusercontent.com/7789698/67629549-51197200-f8b2-11e9-9cea-2e9ff7906105.png" alt="image"></p>
<ul>
<li><p>“command+shift+p”打开命令行工具窗口，输入或者选择“Edit Configurations”命令。</p>
<p>此时会在当前工作空间目录生成.vscode配置目录，同时在配置目录会生成一个c_cpp_properties.json文件。</p>
<p>includePath使用的opencv通过<code> ~ brew list opencv@3</code>获取到include</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;Mac&quot;,</span><br><span class="line">            &quot;includePath&quot;: [</span><br><span class="line">                &quot;/usr/local/include&quot;,</span><br><span class="line">                &quot;/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/bin&quot;,</span><br><span class="line">                &quot;/usr/local/Cellar/opencv@3/3.4.5_6/include/&quot;,      </span><br><span class="line">                &quot;$&#123;workspaceFolder&#125;/**&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;defines&quot;: [],</span><br><span class="line">            &quot;macFrameworkPath&quot;: [</span><br><span class="line">                &quot;/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/System/Library/Frameworks&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;compilerPath&quot;: &quot;/usr/bin/clang&quot;,</span><br><span class="line">            &quot;cStandard&quot;: &quot;c11&quot;,</span><br><span class="line">            &quot;cppStandard&quot;: &quot;c++17&quot;,</span><br><span class="line">            &quot;intelliSenseMode&quot;: &quot;clang-x64&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;version&quot;: 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>“command+shift+p”打开命令行工具窗口，输入或者选择“Tasks: Configure Task”</p>
<p>配置 tasks.json文件</p>
<p><img src="https://user-images.githubusercontent.com/7789698/67629567-7a3a0280-f8b2-11e9-94c1-c9942d9d4bae.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">// 有关 tasks.json 格式的文档，请参见</span><br><span class="line">    // https://go.microsoft.com/fwlink/?LinkId=733558</span><br><span class="line">    &quot;version&quot;: &quot;2.0.0&quot;,</span><br><span class="line">    &quot;tasks&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;shell&quot;,</span><br><span class="line">            &quot;label&quot;: &quot;g++ build active file&quot;,</span><br><span class="line">            &quot;command&quot;: &quot;/usr/bin/g++&quot;,</span><br><span class="line">            &quot;args&quot;: [</span><br><span class="line">                &quot;-g&quot;,</span><br><span class="line">                &quot;$&#123;file&#125;&quot;,</span><br><span class="line">                &quot;-o&quot;,</span><br><span class="line">                &quot;$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;.out&quot;,</span><br><span class="line">                &quot;`pkg-config&quot;,</span><br><span class="line">                &quot;--libs&quot;,</span><br><span class="line">                &quot;--cflags&quot;,</span><br><span class="line">                &quot;opencv`&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;options&quot;: &#123;</span><br><span class="line">                &quot;cwd&quot;: &quot;/usr/bin&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;problemMatcher&quot;: [</span><br><span class="line">                &quot;$gcc&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;group&quot;: &quot;build&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置launch.json。“command+shift+p”打开命令行工具窗口，输入或者选择<strong>Debug: Open launch.json</strong>命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // 使用 IntelliSense 了解相关属性。 </span><br><span class="line">    // 悬停以查看现有属性的描述。</span><br><span class="line">    // 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;g++ build active file&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;cppdbg&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/$&#123;fileBasenameNoExtension&#125;.out&quot;,</span><br><span class="line">            &quot;args&quot;: [],</span><br><span class="line">            &quot;stopAtEntry&quot;: false,</span><br><span class="line">            &quot;cwd&quot;: &quot;$&#123;workspaceFolder&#125;&quot;,</span><br><span class="line">            &quot;environment&quot;: [ &#123;&quot;name&quot;: &quot;PKG_CONFIG_PATH&quot;, &quot;value&quot;: &quot;/usr/local/lib/pkgconfig&quot;&#125;,   // 這是opencv解壓碼後創建的release目錄下的unix-install, 要保證該目錄下下有opencv.pc文件</span><br><span class="line">                &#123;&quot;name&quot;: &quot;DYLD_LIBRARY_PATH&quot;, &quot;value&quot;: &quot;/usr/local/opencv/build/lib&quot;&#125;   // 這個是你在編譯時，opencv make時`CMAKE_INSTALL_PREFIX`指定的目錄</span><br><span class="line">            ],</span><br><span class="line">            &quot;externalConsole&quot;: true,</span><br><span class="line">            &quot;MIMode&quot;: &quot;lldb&quot;,</span><br><span class="line">            &quot;preLaunchTask&quot;:&quot;g++ build active file&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>开始调试</p>
</li>
</ol>
<p><img src="https://user-images.githubusercontent.com/7789698/67629588-c422e880-f8b2-11e9-86c1-e3f20ab171c7.png" alt="image"></p>
<p>调试如果出现图片就是成功了</p>
<p><img src="https://user-images.githubusercontent.com/7789698/67629814-00584800-f8b7-11e9-9173-d295d6daf500.png" alt="image"></p>
<p>如果类似上图显示波浪形，就是c_cpp_properties.json的includePath没有引用到正确的库，配置下就好了</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/f79dc38d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/f79dc38d.html" class="post-title-link" itemprop="url">Mysql索引</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-23 22:41:14" itemprop="dateCreated datePublished" datetime="2018-11-23T22:41:14+08:00">2018-11-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="B-Tree-索引（B-Tree）"><a href="#B-Tree-索引（B-Tree）" class="headerlink" title="B-Tree 索引（B+Tree）"></a>B-Tree 索引（B+Tree）</h2><p>当你需要查找两个值之间的多个元素时，成本是 O(N)，因为你必须查找树的每一个节点，以判断它是否处于那 2 个值之间（例如，对树使用中序遍历）。而且这个操作不是磁盘I/O有利的，因为你必须读取整个树。我们需要找到高效的范围查询方法。为了解决这个问题，现代数据库使用了B+树。在一个B+树里：</p>
<ul>
<li>只有最底层的节点（叶子节点）才保存信息（相关表的行位置）</li>
<li>其它节点只是在搜索中用来指引到正确节点的。</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/7789698/48948736-9467b400-ef70-11e8-8c9e-e7ba0d3b4a35.png" alt="image"></p>
<p>你可以看到，节点更多了（多了两倍）。确实，你有了额外的节点，它们就是帮助你找到正确节点的『决策节点』（正确节点保存着相关表中行的位置）。但是搜索复杂度还是在 O(log(N))（只多了一层）。一个重要的不同点是，最底层的节点是跟后续节点相连接的。</p>
<p>用这个 B+树，假设你要找40到100间的值：</p>
<ul>
<li>你只需要找 40（若40不存在则找40之后最贴近的值），就像你在上一个树中所做的那样。</li>
<li>然后用那些连接来收集40的后续节点，直到找到100。</li>
</ul>
<p>比方说你找到了 M 个后续节点，树总共有 N 个节点。对指定节点的搜索成本是 log(N)，跟上一个树相同。但是当你找到这个节点，你得通过后续节点的连接得到 M 个后续节点，这需要 M 次运算。那么这次搜索只消耗了 M+log(N) 次运算，区别于上一个树所用的 N 次运算。此外，你不需要读取整个树（仅需要读 M+log(N) 个节点）,这意味着更少的磁盘访问。如果 M 很小（比如 200 行）并且 N 很大（1,000,000），那结果就是天壤之别了。</p>
<p>如果你在数据库中增加或删除一行（从而在相关的 B+树索引里）：</p>
<ul>
<li>你必须在B+树中的节点之间保持顺序，否则节点会变得一团糟，你无法从中找到想要的节点。</li>
<li>你必须尽可能降低B+树的层数，否则 O(log(N)) 复杂度会变成 O(N)。</li>
</ul>
<p>换句话说，B+树需要自我整理和自我平衡。谢天谢地，我们有智能删除和插入。但是这样也带来了成本：在B+树中，插入和删除操作是 O(log(N)) 复杂度。所以有些人听到过使用太多索引不是个好主意这类说法。没错，你减慢了快速插入/更新/删除表中的一个行的操作，因为数据库需要以代价高昂的每索引 O(log(N)) 运算来更新表的索引。再者，增加索引意味着给事务管理器带来更多的工作负荷。</p>
<h2 id="MyISAM索引实现："><a href="#MyISAM索引实现：" class="headerlink" title="MyISAM索引实现："></a>MyISAM索引实现：</h2><p>MyISAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。</p>
<p>1）主键索引：</p>
<p>MyISAM引擎使用B+Tree作为索引结构，叶节点的data域存放的是数据记录的地址。下图是MyISAM主键索引的原理图：</p>
<p><img src="https://user-images.githubusercontent.com/7789698/48948771-b3664600-ef70-11e8-99a1-479039340dcc.png" alt="image"></p>
<p>这里设表一共有三列，假设我们以Col1为主键，图myisam1是一个MyISAM表的主索引（Primary key）示意。可以看出MyISAM的索引文件仅仅保存数据记录的地址。</p>
<p>2）辅助索引（Secondary key）</p>
<p>在MyISAM中，主索引和辅助索引（Secondary key）在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复。如果我们在Col2上建立一个辅助索引，则此索引的结构如下图所示：</p>
<p><img src="https://user-images.githubusercontent.com/7789698/48948783-c0833500-ef70-11e8-847e-52cdcc542e41.png" alt="image"></p>
<p>同样也是一颗B+Tree，data域保存数据记录的地址。因此，MyISAM中索引检索的算法为首先按照B+Tree搜索算法搜索索引，如果指定的Key存在，则取出其data域的值，然后以data域的值为地址，读取相应数据记录。</p>
<p>MyISAM的索引方式也叫做“非聚集”的，之所以这么称呼是为了与InnoDB的聚集索引区分。</p>
<h2 id="InnoDB索引实现"><a href="#InnoDB索引实现" class="headerlink" title="InnoDB索引实现"></a>InnoDB索引实现</h2><p>InnoDB也使用B+Tree作为索引结构，但具体实现方式却与MyISAM截然不同.</p>
<p>1）主键索引：</p>
<p>InnoDB中，表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是主索引。</p>
<p><img src="https://user-images.githubusercontent.com/7789698/48948817-d264d800-ef70-11e8-8d9b-2b6b8428ee76.png" alt="image"></p>
<p>可以看到叶节点包含了完整的数据记录。这种索引叫做聚集索引。因为InnoDB的数据文件本身要按主键聚集，所以InnoDB要求表必须有主键（MyISAM可以没有），如果没有显式指定，则MySQL系统会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则MySQL自动为InnoDB表生成一个隐含字段作为主键，这个字段长度为6个字节，类型为长整形。</p>
<p>2）InnoDB的辅助索引</p>
<pre><code>InnoDB的所有辅助索引都引用主键作为data域。
</code></pre>
<p>例如，下图为定义在Col3上的一个辅助索引：</p>
<p><img src="https://user-images.githubusercontent.com/7789698/48948834-dd1f6d00-ef70-11e8-9a8b-26dda162a433.png" alt="image"></p>
<p>   InnoDB 表是基于聚簇索引建立的。因此InnoDB 的索引能提供一种非常快速的主键查找性能。不过，它的辅助索引（Secondary Index， 也就是非主键索引）也会包含主键列，所以，如果主键定义的比较大，其他索引也将很大。如果想在表上定义 、很多索引，则争取尽量把主键定义得小一些。InnoDB 不会压缩索引。</p>
<pre><code>  文字符的ASCII码作为比较准则。聚集索引这种实现方式使得按主键的搜索十分高效，辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录。

  不同存储引擎的索引实现方式对于正确使用和优化索引都非常有帮助，例如知道了InnoDB的索引实现后，就很容易明白
</code></pre>
<p>1、为什么不建议使用过长的字段作为主键，因为所有辅助索引都引用主索引，过长的主索引会令辅助索引变得过大。再例如，</p>
<p>2、用非单调的字段作为主键在InnoDB中不是个好主意，因为InnoDB数据文件本身是一颗B+Tree，非单调的主键会造成在插入新记录时数据文件为了维持B+Tree的特性而频繁的分裂调整，十分低效，而使用自增字段作为主键则是一个很好的选择。</p>
<h3 id="InnoDB索引和MyISAM索引的区别："><a href="#InnoDB索引和MyISAM索引的区别：" class="headerlink" title="InnoDB索引和MyISAM索引的区别："></a>InnoDB索引和MyISAM索引的区别：</h3><p>一是主索引的区别，InnoDB的数据文件本身就是索引文件。而MyISAM的索引和数据是分开的。</p>
<p>二是辅助索引的区别：InnoDB的辅助索引data域存储相应记录主键的值而不是地址。而MyISAM的辅助索引和主索引没有多大区别。</p>
<h2 id="Hash-索引"><a href="#Hash-索引" class="headerlink" title="Hash 索引"></a>Hash 索引</h2><p>基于哈希表实现，优点是查找非常快。</p>
<p>在 MySQL 中只有 Memory 引擎显式支持哈希索引。</p>
<p>InnoDB 引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用的非常频繁时，会在 B-Tree 索引之上再创建一个哈希索引，这样就让 B-Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。</p>
<p>限制：哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值来避免读取行。不过，访问内存中的行的速度很快，所以大部分情况下这一点对性能影响并不明显；无法用于分组与排序；只支持精确查找，无法用于部分查找和范围查找；如果哈希冲突很多，查找速度会变得很慢。</p>
<h2 id="Fulltext-索引"><a href="#Fulltext-索引" class="headerlink" title="Fulltext 索引"></a>Fulltext 索引</h2><p>全文索引是MyISAM的一个特殊索引类型，主要用于全文检索。 </p>
<h2 id="R-Tree-索引"><a href="#R-Tree-索引" class="headerlink" title="R-Tree 索引"></a>R-Tree 索引</h2><p>MyISAM支持空间索引，主要用于地理空间数据类型，例如GEOMETRY。 </p>
<h2 id="聚集索引与非聚集索引区别？"><a href="#聚集索引与非聚集索引区别？" class="headerlink" title="聚集索引与非聚集索引区别？"></a>聚集索引与非聚集索引区别？</h2><p>聚集索引</p>
<p>索引的键值逻辑顺序决定了表数据行的物理存储顺序，也就是在数据库上连接的记录在磁盘上的物理存储地址也是相邻的。由于聚集索引规定了数据项，也可以说是记录在表中的物理存储顺序，物理顺序唯一，自然每张表中的聚集索引也是唯一的，但是它可以包含多个列，多个字段。</p>
<p>非聚集索引</p>
<p>非聚集索引也就是存储的键值逻辑连续，但是在表数据行物理存储顺序上不一定连续的索引，也就是索引的逻辑顺序与磁盘上的物理存储顺序不同。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/6275b0e6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/6275b0e6.html" class="post-title-link" itemprop="url">mysql事务隔离机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-23 22:32:45" itemprop="dateCreated datePublished" datetime="2018-11-23T22:32:45+08:00">2018-11-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Isolation.DEFAULT(TransactionDefinition.ISOLATION_DEFAULT)使用数据库默认的事务隔离级别。</p>
</blockquote>
<blockquote>
<p>Isolation.READ_UNCOMMITTED(TransactionDefinition.ISOLATION_READ_UNCOMMITTED),这是事务最低的隔离级别，它允许另外一个事务可以看到这个事务未提交的数据。这种隔离级别会产生脏读，不可重复读和幻像读。</p>
<p>实现：SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED</p>
</blockquote>
<blockquote>
<p>Isolation.READ_COMMITTED(TransactionDefinition.ISOLATION_READ_COMMITTED),保证一个事务修改的数据提交后才能被另外一个事务读取。另外一个事务不能读取该事务未提交的数据。这种事务隔离级别可以避免脏读出现，但是可能会出现不可重复读和幻像读。</p>
<p>实现：SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED</p>
</blockquote>
<blockquote>
<p>Isolation.REPEATABLE_READ(TransactionDefinition.ISOLATION_REPEATABLE_READ),这种事务隔离级别可以防止脏读，不可重复读。但是可能出现幻像读。</p>
<p>实现：SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ</p>
</blockquote>
<blockquote>
<p>Isolation.SERIALIZABLE(TransactionDefinition.ISOLATION_SERIALIZABLE);这是花费最高代价但是最可靠的事务隔离级别。事务被处理为顺序执行。除了防止脏读，不可重复读外，还避免了幻读。</p>
<p>实现：SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE</p>
</blockquote>
<p>√: 可能出现    ×: 不会出现</p>
<table>
<thead>
<tr>
<th></th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>Read uncommitted</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Read committed</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Repeatable read</td>
<td>×</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>Serializable</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
</tbody></table>
<ul>
<li>未提交读(Read Uncommitted)：允许脏读，也就是可能读取到其他会话中未提交事务修改的数据</li>
<li>提交读(Read Committed)：只能读取到已经提交的数据。Oracle等多数数据库默认都是该级别 (不重复读)</li>
<li>可重复读(Repeated Read)：可重复读。在同一个事务内的查询都是事务开始时刻一致的，InnoDB默认级别。在SQL标准中，该隔离级别消除了不可重复读，但是还存在幻象读</li>
<li>串行读(Serializable)：完全串行化的读，每次读都需要获得表级共享锁，读写相互都会阻塞</li>
</ul>
<h2 id="为什么RU级别会发生脏读，而其他的隔离级别能够避免？"><a href="#为什么RU级别会发生脏读，而其他的隔离级别能够避免？" class="headerlink" title="为什么RU级别会发生脏读，而其他的隔离级别能够避免？"></a>为什么RU级别会发生脏读，而其他的隔离级别能够避免？</h2><p>RU级别的操作其实就是对事务内的每一条更新语句对应的行记录加上读写锁来操作，而不把一个事务当成一个整体来加锁，所以会导致脏读。但是RC和RR能够通过MVCC来保证记录只有在最后COMMIT后才会让别的事务看到。</p>
<p>Read Committed（读取提交内容）</p>
<p>在RC级别中，数据的读取都是不加锁的，但是数据的写入、修改和删除是需要加锁的。</p>
<p>由于MySQL的InnoDB默认是使用的RR级别，所以我们先要将该session开启成RC级别，并且设置binlog的模式</p>
<p>SET session transaction isolation level read committed;</p>
<p>SET SESSION binlog_format = ‘ROW’;（或者是MIXED）</p>
<p>Repeatable Read（可重读）</p>
<p>这是MySQL中InnoDB默认的隔离级别。我们姑且分“读”和“写”两个模块来讲解。</p>
<p>读</p>
<p>读就是可重读，可重读这个概念是一事务的多个实例在并发读取数据时，会看到同样的数据行，有点抽象，我们来看一下效果。</p>
<p>RC（不可重读）模式下的展现</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>begin;</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=1; idclass_nameteacher_id 1初三二班1 2初三一班1</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>update class_teacher set class_name=’初三三班’ where id=1;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>commit;</td>
<td></td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=1; idclass_nameteacher_id 1初三三班1 2初三一班1 读到了事务B修改的数据，和第一次查询的结果不一样，是不可重读的。</td>
<td></td>
<td></td>
</tr>
<tr>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>事务B修改id=1的数据提交之后，事务A同样的查询，后一次和前一次的结果不一样，这就是不可重读（重新读取产生的结果不一样）。这就很可能带来一些问题，那么我们来看看在RR级别中MySQL的表现：</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
<th>事务C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;</td>
<td>begin;</td>
<td>begin;</td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=1; idclass_nameteacher_id 1初三二班1 2初三一班1</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>update class_teacher set class_name=’初三三班’ where id=1; commit;</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into class_teacher values (null,’初三三班’,1);commit;</td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=1; idclass_nameteacher_id 1初三二班1 2初三一班1 没有读到事务B修改的数据，和第一次sql读取的一样，是可重复读的。 没有读到事务C新添加的数据。</td>
<td></td>
<td></td>
</tr>
<tr>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>我们注意到，当teacher_id=1时，事务A先做了一次读取，事务B中间修改了id=1的数据，并commit之后，事务A第二次读到的数据和第一次完全相同。所以说它是可重读的。那么MySQL是怎么做到的呢？这里姑且卖个关子，我们往下看。</p>
<h2 id="为什么RC级别不能重复读，而RR级别能够避免？"><a href="#为什么RC级别不能重复读，而RR级别能够避免？" class="headerlink" title="为什么RC级别不能重复读，而RR级别能够避免？"></a>为什么RC级别不能重复读，而RR级别能够避免？</h2><p>在RC事务隔离级别下,每次语句执行都关闭ReadView,然后重新创建一份ReadView。而在RR下,事务开始后第一个读操作创建ReadView,一直到事务结束关闭</p>
<h3 id="不可重复读和幻读的区别"><a href="#不可重复读和幻读的区别" class="headerlink" title="不可重复读和幻读的区别"></a>不可重复读和幻读的区别</h3><p>很多人容易搞混不可重复读和幻读，确实这两者有些相似。但不可重复读重点在于update和delete，而幻读的重点在于insert。</p>
<p>如果使用锁机制来实现这两种隔离级别，在可重复读中，该sql第一次读取到数据后，就将这些数据加锁，其它事务无法修改这些数据，就可以实现可重复读了。但这种方法却无法锁住insert的数据，所以当事务A先前读取了数据，或者修改了全部数据，事务B还是可以insert数据提交，这时事务A就会发现莫名其妙多了一条之前没有的数据，这就是幻读，不能通过行锁来避免。需要Serializable隔离级别 ，读用读锁，写用写锁，读锁和写锁互斥，这么做可以有效的避免幻读、不可重复读、脏读等问题，但会极大的降低数据库的并发能力。</p>
<p>所以说不可重复读和幻读最大的区别，就在于如何通过锁机制来解决他们产生的问题。</p>
<p>上文说的，是使用悲观锁机制来处理这两种问题，但是MySQL、ORACLE、PostgreSQL等成熟的数据库，出于性能考虑，都是使用了以乐观锁为理论基础的MVCC（多版本并发控制）来避免这两种问题。</p>
<ul>
<li><p>快照读：就是select</p>
</li>
<li><ul>
<li>select * from table ….;</li>
</ul>
</li>
<li><p>当前读：特殊的读操作，插入/更新/删除操作，属于当前读，处理的都是当前的数据，需要加锁。</p>
</li>
<li><ul>
<li>select * from table where ? lock in share mode;</li>
<li>select * from table where ? for update;</li>
<li>insert;</li>
<li>update ;</li>
<li>delete;</li>
</ul>
</li>
</ul>
<p>GAP间隙锁</p>
<p>RC级别：</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>begin;</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=30; idclass_nameteacher_id 2初三二班30</td>
<td></td>
<td></td>
</tr>
<tr>
<td>update class_teacher set class_name=’初三四班’ where teacher_id=30;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into class_teacher values (null,’初三二班’,30); commit;</td>
<td></td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=30; idclass_nameteacher_id 2初三四班30 10初三二班30</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>RR级别：</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>begin;</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=30; idclass_nameteacher_id 2初三二班30</td>
<td></td>
<td></td>
</tr>
<tr>
<td>update class_teacher set class_name=’初三四班’ where teacher_id=30;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into class_teacher values (null,’初三二班’,30); waiting….</td>
<td></td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher where teacher_id=30; idclass_nameteacher_id 2初三四班30</td>
<td></td>
<td></td>
</tr>
<tr>
<td>commit;</td>
<td>事务Acommit后，事务B的insert执行。</td>
<td></td>
</tr>
</tbody></table>
<p>通过对比我们可以发现，在RC级别中，事务A修改了所有teacher_id=30的数据，但是当事务Binsert进新数据后，事务A发现莫名其妙多了一行teacher_id=30的数据，而且没有被之前的update语句所修改，这就是“当前读”的幻读。</p>
<p>RR级别中，事务A在update后加锁，事务B无法插入新数据，这样事务A在update前后读的数据保持一致，避免了幻读。这个锁，就是Gap锁。</p>
<p>MySQL是这么实现的：</p>
<p>在class_teacher这张表中，teacher_id是个索引，那么它就会维护一套B+树的数据关系，为了简化，我们用链表结构来表达（实际上是个树形结构，但原理相同）</p>
<p><img src="https://user-images.githubusercontent.com/7789698/48948565-de03cf00-ef6f-11e8-8b15-400d86f16bf4.png" alt="image">如图所示，InnoDB使用的是聚集索引，teacher_id身为二级索引，就要维护一个索引字段和主键id的树状结构（这里用链表形式表现），并保持顺序排列。</p>
<p>Innodb将这段数据分成几个个区间</p>
<ul>
<li>(negative infinity, 5],</li>
<li>(5,30],</li>
<li>(30,positive infinity)；</li>
</ul>
<p>update class_teacher set class_name=’初三四班’ where teacher_id=30;不仅用行锁，锁住了相应的数据行；同时也在两边的区间，（5,30]和（30，positive infinity），都加入了gap锁。这样事务B就无法在这个两个区间insert进新数据。</p>
<p>受限于这种实现方式，Innodb很多时候会锁住不需要锁的区间。如下所示：</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
<th>事务C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;</td>
<td>begin;</td>
<td>begin;</td>
</tr>
<tr>
<td>select id,class_name,teacher_id from class_teacher; idclass_nameteacher_id 1初三一班5  2初三二班30</td>
<td></td>
<td></td>
</tr>
<tr>
<td>update class_teacher set class_name=’初一一班’ where teacher_id=20;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into class_teacher values (null,’初三五班’,10); waiting …..</td>
<td>insert into class_teacher values (null,’初三五班’,40);</td>
</tr>
<tr>
<td>commit;</td>
<td>事务A commit之后，这条语句才插入成功</td>
<td>commit;</td>
</tr>
<tr>
<td></td>
<td>commit;</td>
<td></td>
</tr>
</tbody></table>
<p>update的teacher_id=20是在(5，30]区间，即使没有修改任何数据，Innodb也会在这个区间加gap锁，而其它区间不会影响，事务C正常插入。</p>
<p>如果使用的是没有索引的字段，比如update class_teacher set teacher_id=7 where class_name=’初三八班（即使没有匹配到任何数据）’,那么会给全表加入gap锁。同时，它不能像上文中行锁一样经过MySQL Server过滤自动解除不满足条件的锁，因为没有索引，则这些字段也就没有排序，也就没有区间。除非该事务提交，否则其它事务无法插入任何数据。</p>
<p>行锁防止别的事务修改或删除，GAP锁防止别的事务新增，行锁和GAP锁结合形成的的Next-Key锁共同解决了RR级别在写数据时的幻读问题。</p>
<h3 id="Read-uncommitted-读未提交"><a href="#Read-uncommitted-读未提交" class="headerlink" title="Read uncommitted 读未提交"></a>Read uncommitted 读未提交</h3><p>公司发工资了，领导把5000元打到singo的账号上，但是该事务并未提交，而singo正好去查看账户，发现工资已经到账，是5000元整，非常高兴。可是不幸的是，领导发现发给singo的工资金额不对，是2000元，于是迅速回滚了事务，修改金额后，将事务提交，最后singo实际的工资只有2000元，singo空欢喜一场。</p>
<p><img src="https://user-images.githubusercontent.com/7789698/48948598-fe338e00-ef6f-11e8-86d1-1aceac364782.png" alt="image"></p>
<p>出现上述情况，即我们所说的脏读，两个并发的事务，“事务A：领导给singo发工资”、“事务B：singo查询工资账户”，事务B读取了事务A尚未提交的数据。</p>
<p>当隔离级别设置为Read uncommitted时，就可能出现脏读，如何避免脏读，请看下一个隔离级别。</p>
<h4 id="Read-committed-读提交"><a href="#Read-committed-读提交" class="headerlink" title="Read committed 读提交"></a>Read committed 读提交</h4><p>singo拿着工资卡去消费，系统读取到卡里确实有2000元，而此时她的老婆也正好在网上转账，把singo工资卡的2000元转到另一账户，并在singo之前提交了事务，当singo扣款时，系统检查到singo的工资卡已经没有钱，扣款失败，singo十分纳闷，明明卡里有钱，为何……</p>
<p>出现上述情况，即我们所说的不可重复读，两个并发的事务，“事务A：singo消费”、“事务B：singo的老婆网上转账”，事务A事先读取了数据，事务B紧接了更新了数据，并提交了事务，而事务A再次读取该数据时，数据已经发生了改变。</p>
<p>当隔离级别设置为Read committed时，避免了脏读，但是可能会造成不可重复读。</p>
<p>大多数数据库的默认级别就是Read committed，比如Sql Server , Oracle。如何解决不可重复读这一问题，请看下一个隔离级别。</p>
<h4 id="Repeatable-read-重复读"><a href="#Repeatable-read-重复读" class="headerlink" title="Repeatable read 重复读"></a>Repeatable read 重复读</h4><p>当隔离级别设置为Repeatable read时，可以避免不可重复读。当singo拿着工资卡去消费时，一旦系统开始读取工资卡信息（即事务开始），singo的老婆就不可能对该记录进行修改，也就是singo的老婆不能在此时转账。</p>
<p>虽然Repeatable read避免了不可重复读，但还有可能出现幻读。</p>
<p>singo的老婆工作在银行部门，她时常通过银行内部系统查看singo的信用卡消费记录。有一天，她正在查询到singo当月信用卡的总消费金额（select sum(amount) from transaction where month = 本月）为80元，而singo此时正好在外面胡吃海塞后在收银台买单，消费1000元，即新增了一条1000元的消费记录（insert transaction … ），并提交了事务，随后singo的老婆将singo当月信用卡消费的明细打印到A4纸上，却发现消费总额为1080元，singo的老婆很诧异，以为出现了幻觉，幻读就这样产生了。</p>
<p>注：Mysql的默认隔离级别就是Repeatable read。</p>
<h4 id="Serializable-序列化"><a href="#Serializable-序列化" class="headerlink" title="Serializable 序列化"></a>Serializable 序列化</h4><p>Serializable是最高的事务隔离级别，同时代价也花费最高，性能很低，一般很少使用，在该级别下，事务顺序执行，不仅可以避免脏读、不可重复读，还避免了幻像读。</p>
<h1 id="MySql-ACID如何保证？"><a href="#MySql-ACID如何保证？" class="headerlink" title="MySql ACID如何保证？"></a>MySql ACID如何保证？</h1><p>ACID，指数据库事务正确执行的四个基本要素的缩写。包含：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability） </p>
<h2 id="为什么InnoDB能够保证原子性？"><a href="#为什么InnoDB能够保证原子性？" class="headerlink" title="为什么InnoDB能够保证原子性？"></a>为什么InnoDB能够保证原子性？</h2><p>在事务里任何对数据的修改都会写一个Undo log，然后进行数据的修改，如果出现错误或者用户需要回滚的时候可以利用Undo log的备份数据恢复到事务开始之前的状态。</p>
<h2 id="为什么InnoDB能够保证持久性？"><a href="#为什么InnoDB能够保证持久性？" class="headerlink" title="为什么InnoDB能够保证持久性？"></a>为什么InnoDB能够保证持久性？</h2><p>在一个事务中的每一次SQL操作之后都会写入一个redo log到buffer中，在最后COMMIT的时候，必须先将该事务的所有日志写入到redo log file进行持久化（这里的写入是顺序写的），待事务的COMMIT操作完成才算完成。即使COMMIT后数据库有任何的问题，在下次重启后依然能够通过redo log的checkpoint进行恢复。</p>
<h2 id="为什么InnoDB能够保证一致性？"><a href="#为什么InnoDB能够保证一致性？" class="headerlink" title="为什么InnoDB能够保证一致性？"></a>为什么InnoDB能够保证一致性？</h2><p>在事务处理的ACID属性中，一致性是最基本的属性，其它的三个属性都为了保证一致性而存在的。</p>
<p>首先回顾一下一致性的定义。所谓一致性，指的是数据处于一种有意义的状态，这种状态是语义上的而不是语法上的。最常见的例子是转帐。例如从帐户A转一笔钱到帐户B上，如果帐户A上的钱减少了，而帐户B上的钱却没有增加，那么我们认为此时数据处于不一致的状态。</p>
<p>在数据库实现的场景中，一致性可以分为数据库外部的一致性和数据库内部的一致性。前者由外部应用的编码来保证，即某个应用在执行转帐的数据库操作时，必须在同一个事务内部调用对帐户A和帐户B的操作。如果在这个层次出现错误，这不是数据库本身能够解决的，也不属于我们需要讨论的范围。后者由数据库来保证，即在同一个事务内部的一组操作必须全部执行成功（或者全部失败）。这就是事务处理的原子性。（上面说过了是用Undo log来保证的）</p>
<p>但是，原子性并不能完全保证一致性。在多个事务并行进行的情况下，即使保证了每一个事务的原子性，仍然可能导致数据不一致的结果，比如丢失更新问题。</p>
<p>为了保证并发情况下的一致性，引入了隔离性，即保证每一个事务能够看到的数据总是一致的，就好象其它并发事务并不存在一样。用术语来说，就是多个事务并发执行后的状态，和它们串行执行后的状态是等价的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/bc931ae8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/bc931ae8.html" class="post-title-link" itemprop="url">fastjson IdentityHashMap 内存泄漏排查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-08-17 13:39:23" itemprop="dateCreated datePublished" datetime="2018-08-17T13:39:23+08:00">2018-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一个安稳的周末，突然线上传来报警，保留现场过后紧急重启下，然后开始分析。让运维把oom 的dump数据和jstack数据传来</p>
<p>dump文件太大，传过来之前先分析下jstack日志。</p>
<p>jstack发现了一丝异样</p>
<blockquote>
<p>“http-nio-8080-exec-197” #7490 daemon prio=5 os_prio=0 tid=0x00007fdd5806b000 nid=0xed1 waiting for monitor entry [0x00007fdd1b7d5000]<br>   java.lang.Thread.State: BLOCKED (on object monitor)<br>    at org.apache.catalina.webresources.CachedResource.validateResources(CachedResource.java:125)<br>    - waiting to lock &lt;0x000000008015c660&gt; (a org.apache.catalina.webresources.CachedResource)<br>    at org.apache.catalina.webresources.Cache.getResources(Cache.java:129)<br>    at org.apache.catalina.webresources.StandardRoot.getResources(StandardRoot.java:315)<br>    at org.apache.catalina.webresources.StandardRoot.getClassLoaderResources(StandardRoot.java:231)<br>    at org.apache.catalina.loader.WebappClassLoaderBase.findResources(WebappClassLoaderBase.java:995)<br>    at java.lang.ClassLoader.getResources(ClassLoader.java:1142)<br>    at com.alibaba.fastjson.util.ServiceLoader.load(ServiceLoader.java:33)<br>    at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:459)<br>    at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:354)<br>    at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:639)<br>    at com.alibaba.fastjson.JSON.parseObject(JSON.java:350)<br>    at com.alibaba.fastjson.JSON.parseObject(JSON.java:318)<br>    at com.alibaba.fastjson.JSON.parseObject(JSON.java:281)</p>
</blockquote>
<p>看到这个线程是阻塞状态，也就是tomcat请求http-nio-8080-exec-197现在是阻塞状态，等待&lt;0x000000008015c660&gt;释放。而且waiting to lock &lt;0x000000008015c660&gt;出现了11次，也就是有11个线程正在等待释放</p>
<p>关于线程状态：</p>
<p><img src="https://user-images.githubusercontent.com/7789698/44249880-86ddb800-a224-11e8-9e28-084e8bfebbb9.png" alt="image"></p>
<p><strong>新建（New）</strong></p>
<p>创建后尚未启动。</p>
<p><strong>可运行（Runnable）</strong></p>
<p>可能正在运行，也可能正在等待 CPU 时间片。</p>
<p>包含了操作系统线程状态中的 Running 和 Ready。</p>
<p><strong>阻塞（Blocking）</strong></p>
<p>等待获取一个排它锁，如果其线程释放了锁就会结束此状态。</p>
<p><strong>无限期等待（Waiting）</strong></p>
<p>等待其它线程显式地唤醒，否则不会被分配 CPU 时间片。</p>
<table>
<thead>
<tr>
<th>进入方法</th>
<th>退出方法</th>
</tr>
</thead>
<tbody><tr>
<td>没有设置 Timeout 参数的 Object.wait() 方法</td>
<td>Object.notify() / Object.notifyAll()</td>
</tr>
<tr>
<td>没有设置 Timeout 参数的 Thread.join() 方法</td>
<td>被调用的线程执行完毕</td>
</tr>
<tr>
<td>LockSupport.park() 方法</td>
<td>-</td>
</tr>
</tbody></table>
<p><strong>限期等待（Timed Waiting）</strong></p>
<p>无需等待其它线程显式地唤醒，在一定时间之后会被系统自动唤醒。</p>
<p>调用 Thread.sleep() 方法使线程进入限期等待状态时，常常用“使一个线程睡眠”进行描述。</p>
<p>调用 Object.wait() 方法使线程进入限期等待或者无限期等待时，常常用“挂起一个线程”进行描述。</p>
<p>睡眠和挂起是用来描述行为，而阻塞和等待用来描述状态。</p>
<p>阻塞和等待的区别在于，阻塞是被动的，它是在等待获取一个排它锁。而等待是主动的，通过调用 Thread.sleep() 和 Object.wait() 等方法进入。</p>
<table>
<thead>
<tr>
<th>进入方法</th>
<th>退出方法</th>
</tr>
</thead>
<tbody><tr>
<td>Thread.sleep() 方法</td>
<td>时间结束</td>
</tr>
<tr>
<td>设置了 Timeout 参数的 Object.wait() 方法</td>
<td>时间结束 / Object.notify() / Object.notifyAll()</td>
</tr>
<tr>
<td>设置了 Timeout 参数的 Thread.join() 方法</td>
<td>时间结束 / 被调用的线程执行完毕</td>
</tr>
<tr>
<td>LockSupport.parkNanos() 方法</td>
<td>-</td>
</tr>
<tr>
<td>LockSupport.parkUntil() 方法</td>
<td>-</td>
</tr>
</tbody></table>
<p><strong>死亡（Terminated）</strong></p>
<p>可以是线程结束任务之后自己结束，或者产生了异常而结束。</p>
<p>往下一看</p>
<blockquote>
<p>at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)<br>at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212)<br>at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:94)<br>at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:496)<br>at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)<br>at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)<br>at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)<br>at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:502)<br>at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1132)<br>at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:684)<br>at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1539)<br>at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1495)</p>
<ul>
<li>locked &lt;0x0000000094c40718&gt; (a org.apache.tomcat.util.net.NioChannel)<br>at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)<br>at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)<br>at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)<br>at java.lang.Thread.run(Thread.java:745)</li>
</ul>
</blockquote>
<p>通过查找&lt;0x000000008015c660&gt; 发现有个线程badge-thread-18锁住了它 ，</p>
<blockquote>
<p>“badge-thread-18” #438 prio=5 os_prio=0 tid=0x00007fdd6403d800 nid=0x5b36 runnable [0x00007fdd282bb000]<br>   java.lang.Thread.State: RUNNABLE<br>    at java.util.zip.ZipFile.open(Native Method)<br>    at java.util.zip.ZipFile.<init>(ZipFile.java:219)<br>    at java.util.zip.ZipFile.<init>(ZipFile.java:149)<br>    at java.util.jar.JarFile.<init>(JarFile.java:166)<br>    at java.util.jar.JarFile.<init>(JarFile.java:130)<br>    at org.apache.tomcat.util.compat.JreCompat.jarFileNewInstance(JreCompat.java:170)<br>    at org.apache.tomcat.util.compat.JreCompat.jarFileNewInstance(JreCompat.java:155)<br>    at org.apache.catalina.webresources.AbstractArchiveResourceSet.openJarFile(AbstractArchiveResourceSet.java:316)<br>    - locked &lt;0x00000000903a4828&gt; (a java.lang.Object)<br>    at org.apache.catalina.webresources.AbstractSingleArchiveResourceSet.getArchiveEntry(AbstractSingleArchiveResourceSet.java:96)<br>    at org.apache.catalina.webresources.AbstractArchiveResourceSet.getResource(AbstractArchiveResourceSet.java:265)<br>    at org.apache.catalina.webresources.StandardRoot.getResourcesInternal(StandardRoot.java:327)<br>    at org.apache.catalina.webresources.CachedResource.validateResources(CachedResource.java:127)<br>    - locked &lt;0x000000008015c660&gt; (a org.apache.catalina.webresources.CachedResource)<br>    at org.apache.catalina.webresources.Cache.getResources(Cache.java:147)<br>    at org.apache.catalina.webresources.StandardRoot.getResources(StandardRoot.java:315)<br>    at org.apache.catalina.webresources.StandardRoot.getClassLoaderResources(StandardRoot.java:231)<br>    at org.apache.catalina.loader.WebappClassLoaderBase.findResources(WebappClassLoaderBase.java:995)<br>    at java.lang.ClassLoader.getResources(ClassLoader.java:1142)<br>    at com.alibaba.fastjson.util.ServiceLoader.load(ServiceLoader.java:33)<br>    at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:459)<br>    at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:354)<br>    at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:639)<br>    at com.alibaba.fastjson.JSON.parseObject(JSON.java:350)<br>    at com.alibaba.fastjson.JSON.parseObject(JSON.java:318)<br>    at com.alibaba.fastjson.JSON.parseObject(JSON.java:281)</p>
</blockquote>
<p>通过上面的堆栈，我们先猜测下跟ParserConfig的getDeserializer方法可能有若干关系，先看下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    ObjectDeserializer derializer = deserializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">        type = clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    derializer = deserializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        JSONType annotation = clazz.getAnnotation(JSONType.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; mappingTo = annotation.mappingTo();</span><br><span class="line">            <span class="keyword">if</span> (mappingTo != Void.class) &#123;</span><br><span class="line">                <span class="keyword">return</span> getDeserializer(mappingTo, mappingTo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type <span class="keyword">instanceof</span> WildcardType || type <span class="keyword">instanceof</span> TypeVariable || type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        derializer = deserializers.get(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String className = clazz.getName();</span><br><span class="line">    className = className.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.awt.&quot;</span>) <span class="comment">//</span></span><br><span class="line">        &amp;&amp; AwtCodec.support(clazz)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!awtError) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.awt.Point&quot;</span>), AwtCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.awt.Font&quot;</span>), AwtCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.awt.Rectangle&quot;</span>), AwtCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.awt.Color&quot;</span>), AwtCodec.instance);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                <span class="comment">// skip</span></span><br><span class="line">                awtError = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            derializer = AwtCodec.instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!jdk8Error) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.time.&quot;</span>)) &#123;</span><br><span class="line">                </span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.LocalDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.LocalDate&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.LocalTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.ZonedDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.OffsetDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.OffsetTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.ZoneOffset&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.ZoneRegion&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.ZoneId&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.Period&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.Duration&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.time.Instant&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                </span><br><span class="line">                derializer = deserializers.get(clazz);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.util.Optional&quot;</span>)) &#123;</span><br><span class="line">                </span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.util.Optional&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.util.OptionalDouble&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.util.OptionalInt&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                deserializers.put(Class.forName(<span class="string">&quot;java.util.OptionalLong&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                </span><br><span class="line">                derializer = deserializers.get(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// skip</span></span><br><span class="line">            jdk8Error = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (className.equals(<span class="string">&quot;java.nio.file.Path&quot;</span>)) &#123;</span><br><span class="line">        deserializers.put(clazz, MiscCodec.instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == Map.Entry.class) &#123;</span><br><span class="line">        deserializers.put(clazz, MiscCodec.instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (AutowiredObjectDeserializer autowired : ServiceLoader.load(AutowiredObjectDeserializer.class,classLoader)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Type forType : autowired.getAutowiredFor()) &#123;</span><br><span class="line">                deserializers.put(forType, autowired);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (derializer == <span class="keyword">null</span>) &#123;</span><br><span class="line">        derializer = deserializers.get(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz.isEnum()) &#123;</span><br><span class="line">        derializer = <span class="keyword">new</span> EnumDeserializer(clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.isArray()) &#123;</span><br><span class="line">        derializer = ObjectArrayCodec.instance;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz == Set.class || clazz == HashSet.class || clazz == Collection.class || clazz == List.class</span><br><span class="line">               || clazz == ArrayList.class) &#123;</span><br><span class="line">        derializer = CollectionCodec.instance;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Collection.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        derializer = CollectionCodec.instance;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        derializer = MapDeserializer.instance;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Throwable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        derializer = <span class="keyword">new</span> ThrowableDeserializer(<span class="keyword">this</span>, clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        derializer = createJavaBeanDeserializer(clazz, type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    putDeserializer(type, derializer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> derializer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>deserializers又指的是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IdentityHashMap&lt;Type, ObjectDeserializer&gt; deserializers         = <span class="keyword">new</span> IdentityHashMap&lt;Type, ObjectDeserializer&gt;();</span><br></pre></td></tr></table></figure>

<p>大致逻辑是先通过缓存的IdentityHashMap查找，找不到就判断是否注解@JSONType，从中解析。如果还是找不到如果类型是WildcardType、TypeVariable 、 ParameterizedType从中解析。还是不行就使用当前线程类加载器 查找 META-INF/services/AutowiredObjectDeserializer.class实现类。余下就不分析了，当大多数json解析走至此处就要想一下，为什么从缓存的IdentityHashMap查找不到该类型？</p>
<p>通过dump分析可以得到com.alibaba.fastjson.util.IdentityHashMap非常大，也验证了我的看法。</p>
<p>IdentityHashMap是通过System.identityHashCode获取的key，但是这个几乎是唯一的，就算是同一个类型并不是同一个引用都将会有问题</p>
<p>引发这段代码的业务代码大致如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">leak</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Student student=<span class="keyword">new</span> Student();</span><br><span class="line">    student.setName(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    CacheWrapper cacheWrapper = <span class="keyword">new</span> CacheWrapper();</span><br><span class="line">    cacheWrapper.setCacheObject(student);</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = JSON.toJSONBytes(cacheWrapper);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">        Object o = JSON.parseObject(bytes, <span class="keyword">new</span> ParameterizedTypeImpl(<span class="keyword">new</span> Type[]&#123;Student.class&#125;, CacheWrapper.class.getDeclaringClass(), CacheWrapper.class));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheWrapper</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span>, <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T cacheObject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存时长</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expire;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CacheWrapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CacheWrapper</span><span class="params">(T cacheObject, <span class="keyword">int</span> expire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cacheObject=cacheObject;</span><br><span class="line">        <span class="keyword">this</span>.expire=expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        CacheWrapper&lt;T&gt; tmp=(CacheWrapper&lt;T&gt;)<span class="keyword">super</span>.clone();</span><br><span class="line">        tmp.setCacheObject(<span class="keyword">this</span>.cacheObject);</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getCacheObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCacheObject</span><span class="params">(T cacheObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cacheObject = cacheObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getExpire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpire</span><span class="params">(<span class="keyword">int</span> expire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expire = expire;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 -Xmx50m配置我们就能得到</p>
<p>java.lang.OutOfMemoryError: GC overhead limit exceeded</p>
<pre><code>at java.util.Arrays.copyOf(Arrays.java:3236)
at java.lang.StringCoding.safeTrim(StringCoding.java:79)
at java.lang.StringCoding.access$300(StringCoding.java:50)
at java.lang.StringCoding$StringEncoder.encode(StringCoding.java:305)
at java.lang.StringCoding.encode(StringCoding.java:344)
at java.lang.String.getBytes(String.java:918)
at java.io.UnixFileSystem.getBooleanAttributes0(Native Method)
at java.io.UnixFileSystem.getBooleanAttributes(UnixFileSystem.java:242)
at java.io.File.exists(File.java:819)
at sun.misc.URLClassPath$FileLoader.getResource(URLClassPath.java:1245)
at sun.misc.URLClassPath$FileLoader.findResource(URLClassPath.java:1212)
at sun.misc.URLClassPath$1.next(URLClassPath.java:240)
at sun.misc.URLClassPath$1.hasMoreElements(URLClassPath.java:250)
at java.net.URLClassLoader$3$1.run(URLClassLoader.java:601)
at java.net.URLClassLoader$3$1.run(URLClassLoader.java:599)
at java.security.AccessController.doPrivileged(Native Method)
at java.net.URLClassLoader$3.next(URLClassLoader.java:598)
at java.net.URLClassLoader$3.hasMoreElements(URLClassLoader.java:623)
at sun.misc.CompoundEnumeration.next(CompoundEnumeration.java:45)
at sun.misc.CompoundEnumeration.hasMoreElements(CompoundEnumeration.java:54)
at com.alibaba.fastjson.util.ServiceLoader.load(ServiceLoader.java:34)
at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:459)
at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:354)
at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:639)
at com.alibaba.fastjson.JSON.parseObject(JSON.java:350)
at com.alibaba.fastjson.JSON.parseObject(JSON.java:318)
at com.alibaba.fastjson.JSON.parseObject(JSON.java:281)
at com.alibaba.fastjson.JSON.parseObject(JSON.java:381)
at com.alibaba.fastjson.JSON.parseObject(JSON.java:361)
</code></pre>
<p>通过分析发现，每次new一个ParameterizedTypeImpl，就算泛型是一个类，也会在IdentityHashMap储存两遍，这样造成了内存泄漏。</p>
<p>ParameterizedTypeImpl的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterizedTypeImpl</span> <span class="keyword">implements</span> <span class="title">ParameterizedType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Type[] actualTypeArguments;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Type   ownerType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Type   rawType;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParameterizedTypeImpl</span><span class="params">(Type[] actualTypeArguments, Type ownerType, Type rawType)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.actualTypeArguments = actualTypeArguments;</span><br><span class="line">        <span class="keyword">this</span>.ownerType = ownerType;</span><br><span class="line">        <span class="keyword">this</span>.rawType = rawType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Type[] getActualTypeArguments() &#123;</span><br><span class="line">        <span class="keyword">return</span> actualTypeArguments;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getOwnerType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ownerType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Type <span class="title">getRawType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> rawType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        ParameterizedTypeImpl that = (ParameterizedTypeImpl) o;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Probably incorrect - comparing Object[] arrays with Arrays.equals</span></span><br><span class="line">        <span class="keyword">if</span> (!Arrays.equals(actualTypeArguments, that.actualTypeArguments)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (ownerType != <span class="keyword">null</span> ? !ownerType.equals(that.ownerType) : that.ownerType != <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> rawType != <span class="keyword">null</span> ? rawType.equals(that.rawType) : that.rawType == <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = actualTypeArguments != <span class="keyword">null</span> ? Arrays.hashCode(actualTypeArguments) : <span class="number">0</span>;</span><br><span class="line">        result = <span class="number">31</span> * result + (ownerType != <span class="keyword">null</span> ? ownerType.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + (rawType != <span class="keyword">null</span> ? rawType.hashCode() : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果通过hashcode而不是System.identityHashCode就不会有内存泄漏的问题。所以我们尝试把ParameterizedTypeImpl缓存一下。代码大致如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ConcurrentMap&lt;Type, Type&gt; classTypeCache</span><br><span class="line">            = <span class="keyword">new</span> ConcurrentHashMap&lt;Type, Type&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixLeak</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Student student=<span class="keyword">new</span> Student();</span><br><span class="line">    student.setName(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    CacheWrapper cacheWrapper = <span class="keyword">new</span> CacheWrapper();</span><br><span class="line">    cacheWrapper.setCacheObject(student);</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = JSON.toJSONBytes(cacheWrapper);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">        Type argkey = <span class="keyword">new</span> ParameterizedTypeImpl(<span class="keyword">new</span> Type[]&#123;Student.class&#125;, CacheWrapper.class.getDeclaringClass(), CacheWrapper.class);</span><br><span class="line">        Type cachedType = classTypeCache.get(argkey);</span><br><span class="line">        <span class="keyword">if</span> (cachedType == <span class="keyword">null</span>) &#123;</span><br><span class="line">            classTypeCache.putIfAbsent(argkey, argkey);</span><br><span class="line">            cachedType = classTypeCache.get(argkey);</span><br><span class="line">        &#125;</span><br><span class="line">        Object o = JSON.parseObject(bytes, cachedType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过测试发现不会在发生问题了</p>
<p>上线后监控一段时间问题解决.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/7583e99e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/7583e99e.html" class="post-title-link" itemprop="url">dubbo源码解析（十一）SPI内核</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-07-12 14:38:29" itemprop="dateCreated datePublished" datetime="2018-07-12T14:38:29+08:00">2018-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>关于java SPI和dubbo SPI的简单阐述<a href="https://www1350.github.io/#post/114">https://www1350.github.io/#post/114</a></p>
<p>拿解析一的ServiceConfig的doExportUrlsFor1Protocol为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br></pre></td></tr></table></figure>

<p>这里的protocol来自</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();</span><br></pre></td></tr></table></figure>

<p>但是我们debug的时候会发现这个protocol命名是com.alibaba.dubbo.rpc.Protocol$Adaptive,可见是动态生成的。</p>
<p>通过ExtensionLoader的createAdaptiveExtensionClassCode方法。我们可以获取到这么一段代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.rpc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Protocol</span>$<span class="title">Adaptive</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">dubbo</span>.<span class="title">rpc</span>.<span class="title">Protocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;method public abstract void com.alibaba.dubbo.rpc.Protocol.destroy() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;method public abstract int com.alibaba.dubbo.rpc.Protocol.getDefaultPort() of interface com.alibaba.dubbo.rpc.Protocol is not adaptive method!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.rpc.<span class="function">Exporter <span class="title">export</span><span class="params">(com.alibaba.dubbo.rpc.Invoker arg0)</span> <span class="keyword">throws</span> com.alibaba.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;com.alibaba.dubbo.rpc.Invoker argument == null&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (arg0.getUrl() == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;com.alibaba.dubbo.rpc.Invoker argument getUrl() == null&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.common.URL url = arg0.getUrl();</span><br><span class="line">        String extName = (url.getProtocol() == <span class="keyword">null</span> ? <span class="string">&quot;dubbo&quot;</span> : url.getProtocol());</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&quot;</span> + url.toString() + <span class="string">&quot;) use keys([protocol])&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.export(arg0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.rpc.<span class="function">Invoker <span class="title">refer</span><span class="params">(java.lang.Class arg0, com.alibaba.dubbo.common.URL arg1)</span> <span class="keyword">throws</span> com.alibaba.dubbo.rpc.RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg1 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.common.URL url = arg1;</span><br><span class="line">        String extName = (url.getProtocol() == <span class="keyword">null</span> ? <span class="string">&quot;dubbo&quot;</span> : url.getProtocol());</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fail to get extension(com.alibaba.dubbo.rpc.Protocol) name from url(&quot;</span> + url.toString() + <span class="string">&quot;) use keys([protocol])&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.refer(arg0, arg1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI(&quot;dubbo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Adaptive</span></span><br><span class="line">    &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到动态生成的代码里面，通过getAdaptiveExtension获取的时候，如果没有注解@Adaptive就会把实现类写成UnsupportedOperationException，而对于@Adaptive我们看下一个动态生成的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.remoting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.extension.ExtensionLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transporter</span>$<span class="title">Adaptive</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">dubbo</span>.<span class="title">remoting</span>.<span class="title">Transporter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.remoting.<span class="function">Client <span class="title">connect</span><span class="params">(com.alibaba.dubbo.common.URL arg0, com.alibaba.dubbo.remoting.ChannelHandler arg1)</span> <span class="keyword">throws</span> com.alibaba.dubbo.remoting.RemotingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.common.URL url = arg0;</span><br><span class="line">        String extName = url.getParameter(<span class="string">&quot;client&quot;</span>, url.getParameter(<span class="string">&quot;transporter&quot;</span>, <span class="string">&quot;netty&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fail to get extension(com.alibaba.dubbo.remoting.Transporter) name from url(&quot;</span> + url.toString() + <span class="string">&quot;) use keys([client, transporter])&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.remoting.Transporter extension = (com.alibaba.dubbo.remoting.Transporter) ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.remoting.Transporter.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.connect(arg0, arg1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.remoting.<span class="function">Server <span class="title">bind</span><span class="params">(com.alibaba.dubbo.common.URL arg0, com.alibaba.dubbo.remoting.ChannelHandler arg1)</span> <span class="keyword">throws</span> com.alibaba.dubbo.remoting.RemotingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.common.URL url = arg0;</span><br><span class="line">        String extName = url.getParameter(<span class="string">&quot;server&quot;</span>, url.getParameter(<span class="string">&quot;transporter&quot;</span>, <span class="string">&quot;netty&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (extName == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fail to get extension(com.alibaba.dubbo.remoting.Transporter) name from url(&quot;</span> + url.toString() + <span class="string">&quot;) use keys([server, transporter])&quot;</span>);</span><br><span class="line">        com.alibaba.dubbo.remoting.Transporter extension = (com.alibaba.dubbo.remoting.Transporter) ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.remoting.Transporter.class).getExtension(extName);</span><br><span class="line">        <span class="keyword">return</span> extension.bind(arg0, arg1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们注意到所不同的地方在于</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String extName = url.getParameter(<span class="string">&quot;client&quot;</span>, url.getParameter(<span class="string">&quot;transporter&quot;</span>, <span class="string">&quot;netty&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>和</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.dubbo.common.URL url = arg0.getUrl(); </span><br><span class="line">String extName = (url.getProtocol() == <span class="keyword">null</span> ? <span class="string">&quot;dubbo&quot;</span> : url.getProtocol());</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI(&quot;netty&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transporter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Adaptive(&#123;Constants.SERVER_KEY, Constants.TRANSPORTER_KEY&#125;)</span></span><br><span class="line">    <span class="function">Server <span class="title">bind</span><span class="params">(URL url, ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//client    transporter</span></span><br><span class="line">    <span class="meta">@Adaptive(&#123;Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY&#125;)</span></span><br><span class="line">    <span class="function">Client <span class="title">connect</span><span class="params">(URL url, ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们大胆猜测，@Adaptive如果没有设置参数，extName就会拿url.get+接口名；如果有设置参数，extName就会拿最后一个参数和SPI的name获取url.getParameter(最后一个参数名, SPI名)，得到的结果在用url.getParameter(倒数第二个参数名，上一个结果)，一直这样直到取完参数。另外还通过官方文档了解到，接口方法不注解@Adaptive，在实现类注解@Adaptive将会自动激活这个拓展。</p>
<p>另外一点我们注意到不管参数顺序如何，都能拿到url，这里可能进行了类型判断。接下来我们就验证下想象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object instance = cachedAdaptiveInstance.get();</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//单例double check</span></span><br><span class="line">        <span class="keyword">if</span> (createAdaptiveInstanceError == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (cachedAdaptiveInstance) &#123;</span><br><span class="line">                instance = cachedAdaptiveInstance.get();</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//这里是关键</span></span><br><span class="line">                        instance = createAdaptiveExtension();</span><br><span class="line">                        cachedAdaptiveInstance.set(instance);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        createAdaptiveInstanceError = t;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;fail to create adaptive instance: &quot;</span> + t.toString(), t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;fail to create adaptive instance: &quot;</span> + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">    getExtensionClasses();</span><br><span class="line">    <span class="comment">//实现类有注解Adaptive，就直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (cachedAdaptiveClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cachedAdaptiveClass;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没有实现类，类上注解Adaptive，动态生成</span></span><br><span class="line">    <span class="keyword">return</span> cachedAdaptiveClass = createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">    <span class="comment">//DCL</span></span><br><span class="line">    <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">            classes = cachedClasses.get();</span><br><span class="line">            <span class="keyword">if</span> (classes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                classes = loadExtensionClasses();</span><br><span class="line">                cachedClasses.set(classes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取SPI，并获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">    <span class="keyword">final</span> SPI defaultAnnotation = type.getAnnotation(SPI.class);</span><br><span class="line">    <span class="keyword">if</span> (defaultAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String value = defaultAnnotation.value();</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; (value = value.trim()).length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String[] names = NAME_SEPARATOR.split(value);</span><br><span class="line">            <span class="keyword">if</span> (names.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;more than 1 default extension name on extension &quot;</span> + type.getName()</span><br><span class="line">                        + <span class="string">&quot;: &quot;</span> + Arrays.toString(names));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (names.length == <span class="number">1</span>) cachedDefaultName = names[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">    <span class="comment">// /META-INF/dubbo/internal/</span></span><br><span class="line">    loadFile(extensionClasses, DUBBO_INTERNAL_DIRECTORY);</span><br><span class="line">    <span class="comment">//   META-INF/dubbo/</span></span><br><span class="line">    loadFile(extensionClasses, DUBBO_DIRECTORY);</span><br><span class="line">    <span class="comment">//   META-INF/services/  因为这里是存到cache里面的，所以优先级自然是反过来services&gt;dubbo&gt;internal</span></span><br><span class="line">    loadFile(extensionClasses, SERVICES_DIRECTORY);</span><br><span class="line">    <span class="keyword">return</span> extensionClasses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们进入到了SPI机制的核心,通过loadFile可以加载到所有配置的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadFile</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir)</span> </span>&#123;</span><br><span class="line">    String fileName = dir + type.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;java.net.URL&gt; urls;</span><br><span class="line">        ClassLoader classLoader = findClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            urls = classLoader.getResources(fileName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            urls = ClassLoader.getSystemResources(fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (urls != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                java.net.URL url = urls.nextElement();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(url.openStream(), <span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        String line = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//去除注释</span></span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> ci = line.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) line = line.substring(<span class="number">0</span>, ci);</span><br><span class="line">                            line = line.trim();</span><br><span class="line">                            <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    String name = <span class="keyword">null</span>;</span><br><span class="line">                                    <span class="keyword">int</span> i = line.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                                    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                        <span class="comment">//获取name</span></span><br><span class="line">                                        name = line.substring(<span class="number">0</span>, i).trim();</span><br><span class="line">                                        <span class="comment">//获取class 全限定类名</span></span><br><span class="line">                                        line = line.substring(i + <span class="number">1</span>).trim();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                        Class&lt;?&gt; clazz = Class.forName(line, <span class="keyword">true</span>, classLoader);</span><br><span class="line">                         <span class="comment">//类上注解Adaptive，缓存到cachedAdaptiveClass</span></span><br><span class="line">                                        <span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">                                            <span class="keyword">if</span> (cachedAdaptiveClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                                cachedAdaptiveClass = clazz;</span><br><span class="line">                                            &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">                                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                                <span class="comment">//有构造方法是带一个参数且参数类型是接口</span></span><br><span class="line">                                                clazz.getConstructor(type);</span><br><span class="line">                                                Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</span><br><span class="line">                                                <span class="keyword">if</span> (wrappers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                          <span class="comment">//没有Adaptive注解，反射所有实现类带参构造放入cachedWrapperClasses</span></span><br><span class="line">                                                    cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">                                                    wrappers = cachedWrapperClasses;</span><br><span class="line">                                                &#125;</span><br><span class="line">                                                wrappers.add(clazz);</span><br><span class="line">                                            &#125; </span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="comment">// end of while read lines</span></span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        reader.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Exception when load extension class(interface: &quot;</span> +</span><br><span class="line">                            type + <span class="string">&quot;, class file: &quot;</span> + url + <span class="string">&quot;) in &quot;</span> + url, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="comment">// end of while urls</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Exception when load extension class(interface: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;, description file: &quot;</span> + fileName + <span class="string">&quot;).&quot;</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createAdaptiveExtension</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> injectExtension((T) getAdaptiveExtensionClass().newInstance());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Can not create adaptive extension &quot;</span> + type + <span class="string">&quot;, cause: &quot;</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; createAdaptiveExtensionClass() &#123;</span><br><span class="line">    <span class="comment">//生成拼接源码</span></span><br><span class="line">    String code = createAdaptiveExtensionClassCode();</span><br><span class="line">    <span class="comment">//获取自定义ClassLoader -&gt;ExtensionLoader</span></span><br><span class="line">    ClassLoader classLoader = findClassLoader();</span><br><span class="line">    <span class="comment">//获取到AdaptiveCompiler</span></span><br><span class="line">    com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br><span class="line">    <span class="comment">//最终使用JavassistCompiler编译</span></span><br><span class="line">    <span class="keyword">return</span> compiler.compile(code, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>下面是$Adaptive类生成的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">createAdaptiveExtensionClassCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuilder codeBuidler = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    Method[] methods = type.getMethods();</span><br><span class="line">    <span class="keyword">boolean</span> hasAdaptiveAnnotation = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//接口是否有@Adaptive注解</span></span><br><span class="line">    <span class="keyword">for</span> (Method m : methods) &#123;</span><br><span class="line">        <span class="keyword">if</span> (m.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">            hasAdaptiveAnnotation = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 没有Adaptive注解直接报错</span></span><br><span class="line">    <span class="keyword">if</span> (!hasAdaptiveAnnotation)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No adaptive method on extension &quot;</span> + type.getName() + <span class="string">&quot;, refuse to create the adaptive class!&quot;</span>);</span><br><span class="line"><span class="comment">//接口所在包 &quot;package com.alibaba.dubbo.rpc;&quot;</span></span><br><span class="line">    codeBuidler.append(<span class="string">&quot;package &quot;</span> + type.getPackage().getName() + <span class="string">&quot;;&quot;</span>);</span><br><span class="line"><span class="comment">// &quot;import com.alibaba.dubbo.common.extension.ExtensionLoader;&quot;</span></span><br><span class="line">    codeBuidler.append(<span class="string">&quot;\nimport &quot;</span> + ExtensionLoader.class.getName() + <span class="string">&quot;;&quot;</span>);</span><br><span class="line"><span class="comment">// 接口名+$Adaptive生成类名   &quot;public class Protocol$Adaptive implements com.alibaba.dubbo.rpc.Protocol &#123;&quot;</span></span><br><span class="line">    codeBuidler.append(<span class="string">&quot;\npublic class &quot;</span> + type.getSimpleName() + <span class="string">&quot;$Adaptive&quot;</span> + <span class="string">&quot; implements &quot;</span> + type.getCanonicalName() + <span class="string">&quot; &#123;&quot;</span>);</span><br><span class="line"><span class="comment">//遍历方法</span></span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        <span class="comment">//返回</span></span><br><span class="line">        Class&lt;?&gt; rt = method.getReturnType();</span><br><span class="line">        <span class="comment">//入参</span></span><br><span class="line">        Class&lt;?&gt;[] pts = method.getParameterTypes();</span><br><span class="line">        <span class="comment">//异常</span></span><br><span class="line">        Class&lt;?&gt;[] ets = method.getExceptionTypes();</span><br><span class="line">        <span class="comment">//获取方法Adaptive注解</span></span><br><span class="line">        Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class);</span><br><span class="line">        StringBuilder code = <span class="keyword">new</span> StringBuilder(<span class="number">512</span>);</span><br><span class="line">        <span class="comment">//没有Adaptive注解的 拼接实现为“throw new UnsupportedOperationException”</span></span><br><span class="line">        <span class="keyword">if</span> (adaptiveAnnotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            code.append(<span class="string">&quot;throw new UnsupportedOperationException(\&quot;method &quot;</span>)</span><br><span class="line">                    .append(method.toString()).append(<span class="string">&quot; of interface &quot;</span>)</span><br><span class="line">                    .append(type.getName()).append(<span class="string">&quot; is not adaptive method!\&quot;);&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> urlTypeIndex = -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//获取类型为url的参数</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pts[i].equals(URL.class)) &#123;</span><br><span class="line">                    urlTypeIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 有url类型参数</span></span><br><span class="line">            <span class="keyword">if</span> (urlTypeIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 判空 “if (arg0 == null) throw new IllegalArgumentException”</span></span><br><span class="line">                String s = String.format(<span class="string">&quot;\nif (arg%d == null) throw new IllegalArgumentException(\&quot;url == null\&quot;);&quot;</span>,</span><br><span class="line">                        urlTypeIndex);</span><br><span class="line">                code.append(s);</span><br><span class="line">                <span class="comment">//“Url url = ”</span></span><br><span class="line">                s = String.format(<span class="string">&quot;\n%s url = arg%d;&quot;</span>, URL.class.getName(), urlTypeIndex);</span><br><span class="line">                code.append(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 参数里面没有url类型的参数，取每个参数里面getxxx看有没有getUrl</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                String attribMethod = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 找到getUrl，LBL_PTS为了一个break跳出两层循环</span></span><br><span class="line">                LBL_PTS:</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">                    Method[] ms = pts[i].getMethods();</span><br><span class="line">                    <span class="keyword">for</span> (Method m : ms) &#123;</span><br><span class="line">                        String name = m.getName();</span><br><span class="line">                        <span class="keyword">if</span> ((name.startsWith(<span class="string">&quot;get&quot;</span>) || name.length() &gt; <span class="number">3</span>)</span><br><span class="line">                                &amp;&amp; Modifier.isPublic(m.getModifiers())</span><br><span class="line">                                &amp;&amp; !Modifier.isStatic(m.getModifiers())</span><br><span class="line">                                &amp;&amp; m.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">                                &amp;&amp; m.getReturnType() == URL.class) &#123;</span><br><span class="line">                            urlTypeIndex = i;</span><br><span class="line">                            attribMethod = name;</span><br><span class="line">                            <span class="keyword">break</span> LBL_PTS;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (attribMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;fail to create adaptive class for interface &quot;</span> + type.getName()</span><br><span class="line">                            + <span class="string">&quot;: not found url parameter or url attribute in parameters of method &quot;</span> + method.getName());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 判空</span></span><br><span class="line">                String s = String.format(<span class="string">&quot;\nif (arg%d == null) throw new IllegalArgumentException(\&quot;%s argument == null\&quot;);&quot;</span>,</span><br><span class="line">                        urlTypeIndex, pts[urlTypeIndex].getName());</span><br><span class="line">                code.append(s);</span><br><span class="line">                s = String.format(<span class="string">&quot;\nif (arg%d.%s() == null) throw new IllegalArgumentException(\&quot;%s argument %s() == null\&quot;);&quot;</span>,</span><br><span class="line">                        urlTypeIndex, attribMethod, pts[urlTypeIndex].getName(), attribMethod);</span><br><span class="line">                code.append(s);</span><br><span class="line"></span><br><span class="line">                s = String.format(<span class="string">&quot;%s url = arg%d.%s();&quot;</span>, URL.class.getName(), urlTypeIndex, attribMethod);</span><br><span class="line">                code.append(s);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String[] value = adaptiveAnnotation.value();</span><br><span class="line">            <span class="comment">// Adaptive注解没有参数get+接口名</span></span><br><span class="line">            <span class="keyword">if</span> (value.length == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">char</span>[] charArray = type.getSimpleName().toCharArray();</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; charArray.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (Character.isUpperCase(charArray[i])) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                            sb.append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        sb.append(Character.toLowerCase(charArray[i]));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        sb.append(charArray[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                value = <span class="keyword">new</span> String[]&#123;sb.toString()&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> hasInvocation = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pts[i].getName().equals(<span class="string">&quot;com.alibaba.dubbo.rpc.Invocation&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// Invoker判空</span></span><br><span class="line">                    String s = String.format(<span class="string">&quot;\nif (arg%d == null) throw new IllegalArgumentException(\&quot;invocation == null\&quot;);&quot;</span>, i);</span><br><span class="line">                    code.append(s);</span><br><span class="line">                    s = String.format(<span class="string">&quot;\nString methodName = arg%d.getMethodName();&quot;</span>, i);</span><br><span class="line">                    code.append(s);</span><br><span class="line">                    hasInvocation = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String defaultExtName = cachedDefaultName;</span><br><span class="line">            String getNameCode = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = value.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == value.length - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != defaultExtName) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="string">&quot;protocol&quot;</span>.equals(value[i]))</span><br><span class="line">                            <span class="keyword">if</span> (hasInvocation)</span><br><span class="line">                                getNameCode = String.format(<span class="string">&quot;url.getMethodParameter(methodName, \&quot;%s\&quot;, \&quot;%s\&quot;)&quot;</span>, value[i], defaultExtName);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                getNameCode = String.format(<span class="string">&quot;url.getParameter(\&quot;%s\&quot;, \&quot;%s\&quot;)&quot;</span>, value[i], defaultExtName);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            <span class="comment">//如果是protocol，取defaultExtName，也就是SPI的value</span></span><br><span class="line">                            getNameCode = String.format(<span class="string">&quot;( url.getProtocol() == null ? \&quot;%s\&quot; : url.getProtocol() )&quot;</span>, defaultExtName);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="string">&quot;protocol&quot;</span>.equals(value[i]))</span><br><span class="line">                            <span class="keyword">if</span> (hasInvocation)</span><br><span class="line">                                getNameCode = String.format(<span class="string">&quot;url.getMethodParameter(methodName, \&quot;%s\&quot;, \&quot;%s\&quot;)&quot;</span>, value[i], defaultExtName);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                getNameCode = String.format(<span class="string">&quot;url.getParameter(\&quot;%s\&quot;)&quot;</span>, value[i]);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            getNameCode = <span class="string">&quot;url.getProtocol()&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="string">&quot;protocol&quot;</span>.equals(value[i]))</span><br><span class="line">                        <span class="keyword">if</span> (hasInvocation)</span><br><span class="line">                            getNameCode = String.format(<span class="string">&quot;url.getMethodParameter(methodName, \&quot;%s\&quot;, \&quot;%s\&quot;)&quot;</span>, value[i], defaultExtName);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            getNameCode = String.format(<span class="string">&quot;url.getParameter(\&quot;%s\&quot;, %s)&quot;</span>, value[i], getNameCode);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        getNameCode = String.format(<span class="string">&quot;url.getProtocol() == null ? (%s) : url.getProtocol()&quot;</span>, getNameCode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            code.append(<span class="string">&quot;\nString extName = &quot;</span>).append(getNameCode).append(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">            <span class="comment">// check extName == null?</span></span><br><span class="line">            String s = String.format(<span class="string">&quot;\nif(extName == null) &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;throw new IllegalStateException(\&quot;Fail to get extension(%s) name from url(\&quot; + url.toString() + \&quot;) use keys(%s)\&quot;);&quot;</span>,</span><br><span class="line">                    type.getName(), Arrays.toString(value));</span><br><span class="line">            code.append(s);</span><br><span class="line"></span><br><span class="line">            s = String.format(<span class="string">&quot;\n%s extension = (%&lt;s)%s.getExtensionLoader(%s.class).getExtension(extName);&quot;</span>,</span><br><span class="line">                    type.getName(), ExtensionLoader.class.getSimpleName(), type.getName());</span><br><span class="line">            code.append(s);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// return statement</span></span><br><span class="line">            <span class="keyword">if</span> (!rt.equals(<span class="keyword">void</span>.class)) &#123;</span><br><span class="line">                code.append(<span class="string">&quot;\nreturn &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            s = String.format(<span class="string">&quot;extension.%s(&quot;</span>, method.getName());</span><br><span class="line">            code.append(s);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i != <span class="number">0</span>)</span><br><span class="line">                    code.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                code.append(<span class="string">&quot;arg&quot;</span>).append(i);</span><br><span class="line">            &#125;</span><br><span class="line">            code.append(<span class="string">&quot;);&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        codeBuidler.append(<span class="string">&quot;\npublic &quot;</span> + rt.getCanonicalName() + <span class="string">&quot; &quot;</span> + method.getName() + <span class="string">&quot;(&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pts.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                codeBuidler.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            codeBuidler.append(pts[i].getCanonicalName());</span><br><span class="line">            codeBuidler.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            codeBuidler.append(<span class="string">&quot;arg&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        codeBuidler.append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ets.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            codeBuidler.append(<span class="string">&quot; throws &quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ets.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    codeBuidler.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                codeBuidler.append(ets[i].getCanonicalName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        codeBuidler.append(<span class="string">&quot; &#123;&quot;</span>);</span><br><span class="line">        codeBuidler.append(code.toString());</span><br><span class="line">        codeBuidler.append(<span class="string">&quot;\n&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    codeBuidler.append(<span class="string">&quot;\n&#125;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(codeBuidler.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> codeBuidler.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>现在我们还有个疑问？如果只分析这些代码,会认为最开始的解析一例子，暴露的是RegistryProtocol，然而外面又包裹了两层：ProtocolListenerWrapper和ProtocolFilterWrapper，这是如何实现的呢？</p>
<p><code> com.alibaba.dubbo.rpc.Protocol extension = (com.alibaba.dubbo.rpc.Protocol) ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.rpc.Protocol.class).getExtension(extName);</code></p>
<p>拿到的是ProtocolListenerWrapper，下面我们分析下getExtension，他最终通过createExtension创建对象实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createExtension</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取从配置文件得到的类</span></span><br><span class="line">    Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> findException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//得到实例</span></span><br><span class="line">        T instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());</span><br><span class="line">            instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将其他实例注入这个实例的set方法</span></span><br><span class="line">        <span class="comment">//这里是RegistryProtocol的实例</span></span><br><span class="line">        injectExtension(instance);</span><br><span class="line">        <span class="comment">//获取接口的所有实现类 ，ProtocolFilterWrapper、ProtocolListenerWrapper</span></span><br><span class="line">        <span class="comment">//RegistryProtocol注入ProtocolFilterWrapper构造方法得到实例，接着注入ProtocolListenerWrapper得到实例</span></span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br><span class="line">        <span class="keyword">if</span> (wrapperClasses != <span class="keyword">null</span> &amp;&amp; !wrapperClasses.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">                instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回ProtocolListenerWrapper</span></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Extension instance(name: &quot;</span> + name + <span class="string">&quot;, class: &quot;</span> +</span><br><span class="line">                type + <span class="string">&quot;)  could not be instantiated: &quot;</span> + t.getMessage(), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/hexo/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/hexo/page/8/">8</a><a class="extend next" rel="next" href="/hexo/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Absurd</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/hexo/js/comments.js"></script><script src="/hexo/js/utils.js"></script><script src="/hexo/js/motion.js"></script><script src="/hexo/js/schemes/muse.js"></script><script src="/hexo/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/hexo/js/third-party/search/local-search.js"></script>





  





</body>
</html>
