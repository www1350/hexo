<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/hexo/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hexo/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hexo/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/hexo/images/logo.svg" color="#222">

<link rel="stylesheet" href="/hexo/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www1350.github.io","root":"/hexo/","images":"/hexo/images","scheme":"Mist","darkmode":true,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/hexo/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/hexo/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="Absurd博客">
<meta property="og:url" content="https://www1350.github.io/hexo/page/5/index.html">
<meta property="og:site_name" content="Absurd博客">
<meta property="og:locale">
<meta property="article:author" content="Absurd">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www1350.github.io/hexo/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Absurd博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/hexo/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/hexo/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Absurd博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/hexo/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/hexo/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/hexo/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/hexo/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/hexo/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-bookmarks"><a href="/hexo/bookmarks/" rel="section"><i class="fa fa-archive fa-fw"></i>bookmarks</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Absurd"
      src="/hexo/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Absurd</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/hexo/archives/">
          <span class="site-state-item-count">75</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/hexo/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/hexo/tags/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/www1350" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;www1350" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:www_1350@163.com" title="E-Mail → mailto:www_1350@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/5909dfe9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/5909dfe9.html" class="post-title-link" itemprop="url">RocketMQ 源码分析(四) ----rocketmq-store分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-04-02 18:42:19" itemprop="dateCreated datePublished" datetime="2018-04-02T18:42:19+08:00">2018-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="存储层"><a href="#存储层" class="headerlink" title="存储层"></a>存储层</h2><p>rocketmq-store主要提供了消息存储及管理。主要针对CommitLog、ConsumeQueue的相关操作。 ConsumeQueue是消息的逻辑队列，队列的每一个元素是一个20字节的定长的数据，元素结构有三部分构成：commitLogOffset（8byte,消息所在CommitLog的实际偏移量），size(4byte,消息的大小),hashTag(8byte,消息Tag的哈希值)）。 实际上ConsumeQueue中存储的只是消息所在CommitLog的偏移量，可以理解为是CommitLog的索引文件。</p>
<h3 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h3><ul>
<li><p>提供保存消息至CommitLog并持久化到物理文件(刷盘方式：同步、异步)</p>
</li>
<li><p>维护Topic与ConsumeQueue的关系</p>
</li>
<li><p>维护内存映射文件及队列（MapedFile、MapedFileQueue）</p>
</li>
<li><p>提供broker主从同步功能（同步双写、异步复制）</p>
</li>
<li><p>提供recover数据恢复功能（正常恢复、异常恢复（OSCRASH或者JVM CRASH或者机器掉电等））</p>
</li>
<li><p>提供数据索引服务</p>
</li>
</ul>
<h3 id="BrokerRole"><a href="#BrokerRole" class="headerlink" title="BrokerRole"></a>BrokerRole</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">BrokerRole</span> </span>&#123;</span><br><span class="line">    ASYNC_MASTER,</span><br><span class="line">    SYNC_MASTER,</span><br><span class="line">    SLAVE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FlushDiskType"><a href="#FlushDiskType" class="headerlink" title="FlushDiskType"></a>FlushDiskType</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">FlushDiskType</span> </span>&#123;</span><br><span class="line">    SYNC_FLUSH,<span class="comment">//同步刷盘</span></span><br><span class="line">    ASYNC_FLUSH<span class="comment">//异步刷盘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CommitLog"><a href="#CommitLog" class="headerlink" title="CommitLog"></a>CommitLog</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Message&#x27;s MAGIC CODE daa320a7</span></span><br><span class="line"><span class="comment">//魔数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MESSAGE_MAGIC_CODE = <span class="number">0xAABBCCDD</span> ^ <span class="number">1880681586</span> + <span class="number">8</span>;</span><br><span class="line"><span class="comment">// End of file empty MAGIC CODE cbd43194</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> BLANK_MAGIC_CODE = <span class="number">0xBBCCDDEE</span> ^ <span class="number">1880681586</span> + <span class="number">8</span>;</span><br><span class="line"><span class="comment">//消息文件队列，包含所有保存在磁盘上的文件</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MappedFileQueue mappedFileQueue;</span><br><span class="line"><span class="comment">//默认消息存储类对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultMessageStore defaultMessageStore;</span><br><span class="line"><span class="comment">//刷盘操作服务类</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FlushCommitLogService flushCommitLogService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//If TransientStorePool enabled, we must flush message to FileChannel at fixed periods</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FlushCommitLogService commitLogService;</span><br><span class="line"><span class="comment">//添加消息的回调，在doAppend方法中追加消息到内存</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AppendMessageCallback appendMessageCallback;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;MessageExtBatchEncoder&gt; batchEncoderThreadLocal;</span><br><span class="line"><span class="comment">//Topic与每个队列的偏移量关系</span></span><br><span class="line"><span class="keyword">private</span> HashMap&lt;String<span class="comment">/* topic-queueid */</span>, Long<span class="comment">/* offset */</span>&gt; topicQueueTable = <span class="keyword">new</span> HashMap&lt;String, Long&gt;(<span class="number">1024</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> confirmOffset = -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> beginTimeInLock = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PutMessageLock putMessageLock;</span><br></pre></td></tr></table></figure>

<p>putMessage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PutMessageResult <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Set the storage time</span></span><br><span class="line">    msg.setStoreTimestamp(System.currentTimeMillis());</span><br><span class="line">    <span class="comment">// Set the message body BODY CRC (consider the most appropriate setting</span></span><br><span class="line">    <span class="comment">// on the client)</span></span><br><span class="line">    msg.setBodyCRC(UtilAll.crc32(msg.getBody()));</span><br><span class="line">    <span class="comment">// Back to Results</span></span><br><span class="line">    AppendMessageResult result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    StoreStatsService storeStatsService = <span class="keyword">this</span>.defaultMessageStore.getStoreStatsService();</span><br><span class="line"></span><br><span class="line">    String topic = msg.getTopic();</span><br><span class="line">    <span class="keyword">int</span> queueId = msg.getQueueId();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</span><br><span class="line">    <span class="keyword">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE</span><br><span class="line">        || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</span><br><span class="line">        <span class="comment">// Delay Delivery</span></span><br><span class="line">        <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">                msg.setDelayTimeLevel(<span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            topic = ScheduleMessageService.SCHEDULE_TOPIC;</span><br><span class="line">            queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Backup real topic, queueId</span></span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</span><br><span class="line">            msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line"></span><br><span class="line">            msg.setTopic(topic);</span><br><span class="line">            msg.setQueueId(queueId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> eclipseTimeInLock = <span class="number">0</span>;</span><br><span class="line">    MappedFile unlockMappedFile = <span class="keyword">null</span>;</span><br><span class="line">    MappedFile mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile();</span><br><span class="line"></span><br><span class="line">    putMessageLock.lock(); <span class="comment">//spin or ReentrantLock ,depending on store config</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> beginLockTimestamp = <span class="keyword">this</span>.defaultMessageStore.getSystemClock().now();</span><br><span class="line">        <span class="keyword">this</span>.beginTimeInLock = beginLockTimestamp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Here settings are stored timestamp, in order to ensure an orderly</span></span><br><span class="line">        <span class="comment">// global</span></span><br><span class="line">        msg.setStoreTimestamp(beginLockTimestamp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mappedFile || mappedFile.isFull()) &#123;</span><br><span class="line">            mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(<span class="number">0</span>); <span class="comment">// Mark: NewFile may be cause noise</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mappedFile) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;create mapped file1 error, topic: &quot;</span> + msg.getTopic() + <span class="string">&quot; clientAddr: &quot;</span> + msg.getBornHostString());</span><br><span class="line">            beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = mappedFile.appendMessage(msg, <span class="keyword">this</span>.appendMessageCallback);</span><br><span class="line">        <span class="keyword">switch</span> (result.getStatus()) &#123;</span><br><span class="line">            <span class="keyword">case</span> PUT_OK:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> END_OF_FILE:</span><br><span class="line">                unlockMappedFile = mappedFile;</span><br><span class="line">                <span class="comment">// Create a new file, re-write the message</span></span><br><span class="line">                mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == mappedFile) &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></span><br><span class="line">                    log.error(<span class="string">&quot;create mapped file2 error, topic: &quot;</span> + msg.getTopic() + <span class="string">&quot; clientAddr: &quot;</span> + msg.getBornHostString());</span><br><span class="line">                    beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);</span><br><span class="line">                &#125;</span><br><span class="line">                result = mappedFile.appendMessage(msg, <span class="keyword">this</span>.appendMessageCallback);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MESSAGE_SIZE_EXCEEDED:</span><br><span class="line">            <span class="keyword">case</span> PROPERTIES_SIZE_EXCEEDED:</span><br><span class="line">                beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);</span><br><span class="line">            <span class="keyword">case</span> UNKNOWN_ERROR:</span><br><span class="line">                beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eclipseTimeInLock = <span class="keyword">this</span>.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;</span><br><span class="line">        beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putMessageLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eclipseTimeInLock &gt; <span class="number">500</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;[NOTIFYME]putMessage in lock cost time(ms)=&#123;&#125;, bodyLength=&#123;&#125; AppendMessageResult=&#123;&#125;&quot;</span>, eclipseTimeInLock, msg.getBody().length, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != unlockMappedFile &amp;&amp; <span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultMessageStore.unlockMappedFile(unlockMappedFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PutMessageResult putMessageResult = <span class="keyword">new</span> PutMessageResult(PutMessageStatus.PUT_OK, result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Statistics</span></span><br><span class="line">    storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).incrementAndGet();</span><br><span class="line">    storeStatsService.getSinglePutMessageTopicSizeTotal(topic).addAndGet(result.getWroteBytes());</span><br><span class="line"></span><br><span class="line">    handleDiskFlush(result, putMessageResult, msg);</span><br><span class="line">    handleHA(result, putMessageResult, msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> putMessageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ConsumeQueue</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CQ_STORE_UNIT_SIZE = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultMessageStore defaultMessageStore;</span><br><span class="line"><span class="comment">//消息文件队列，包含所有保存在磁盘上的文件</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MappedFileQueue mappedFileQueue;</span><br><span class="line"><span class="comment">//Topic名称</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String topic;</span><br><span class="line"><span class="comment">//队列ID</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> queueId;</span><br><span class="line"><span class="comment">//内存中索引位置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer byteBufferIndex;</span><br><span class="line"><span class="comment">//存储的位置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String storePath;</span><br><span class="line"><span class="comment">//映射文件的大小</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mappedFileSize;</span><br><span class="line"><span class="comment">//CommitLog最大的偏移</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> maxPhysicOffset = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">//CommitLog最小的偏移</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> minLogicOffset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> ConsumeQueueExt consumeQueueExt = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>MappedFileQueue</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DELETE_FILES_BATCH_MAX = <span class="number">10</span>;</span><br><span class="line"><span class="comment">//存储的位置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String storePath;</span><br><span class="line"><span class="comment">//映射文件的大小</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mappedFileSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArrayList&lt;MappedFile&gt; mappedFiles = <span class="keyword">new</span> CopyOnWriteArrayList&lt;MappedFile&gt;();</span><br><span class="line"><span class="comment">//预创建MapedFile服务，MapedFile</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AllocateMappedFileService allocateMappedFileService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> flushedWhere = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//已刷盘位置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> committedWhere = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//最后刷盘完成的时间</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> storeTimestamp = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>MappedFile</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//系统每页缓存大小为4K</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OS_PAGE_SIZE = <span class="number">1024</span> * <span class="number">4</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//总共映射虚拟内存的大小</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger TOTAL_MAPPED_FILES = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//文件开始写的位置</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> AtomicInteger wrotePosition = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//文件已经刷盘的位置</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> AtomicInteger committedPosition = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger flushedPosition = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//文件大小</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> fileSize;</span><br><span class="line"><span class="keyword">protected</span> FileChannel fileChannel;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Message will put to here first, and then reput to FileChannel if writeBuffer is not null.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> ByteBuffer writeBuffer = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">protected</span> TransientStorePool transientStorePool = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//文件名称</span></span><br><span class="line"><span class="keyword">private</span> String fileName;</span><br><span class="line"><span class="comment">//文件的全局offset，也就是文件名的前缀</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> fileFromOffset;</span><br><span class="line"><span class="comment">//文件对象</span></span><br><span class="line"><span class="keyword">private</span> File file;</span><br><span class="line"><span class="comment">//文件映射的内存</span></span><br><span class="line"><span class="keyword">private</span> MappedByteBuffer mappedByteBuffer;</span><br><span class="line"><span class="comment">//最后刷盘完成的时间</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> storeTimestamp = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> firstCreateInQueue = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>



<p>接口MessageStore</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageStore</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载之前存储的消息</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Launch this message store.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception if there is any error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shutdown this message store.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Destroy this message store. Generally, all persistent files should be removed after invocation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Store a message into store.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg Message instance to store</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> result of store operation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">PutMessageResult <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Store a batch of messages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageExtBatch Message batch.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> result of storing batch messages.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">PutMessageResult <span class="title">putMessages</span><span class="params">(<span class="keyword">final</span> MessageExtBatch messageExtBatch)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query at most &lt;code&gt;maxMsgNums&lt;/code&gt; messages belonging to &lt;code&gt;topic&lt;/code&gt; at &lt;code&gt;queueId&lt;/code&gt; starting</span></span><br><span class="line"><span class="comment">     * from given &lt;code&gt;offset&lt;/code&gt;. Resulting messages will further be screened using provided message filter.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> group Consumer group that launches this query.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic to query.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID to query.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offset Logical offset to start from.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxMsgNums Maximum count of messages to query.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageFilter Message filter used to screen desired messages.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Matched messages.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">GetMessageResult <span class="title">getMessage</span><span class="params">(<span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> maxMsgNums, <span class="keyword">final</span> MessageFilter messageFilter)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get maximum offset of the topic queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Maximum offset at present.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getMaxOffsetInQueue</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the minimum offset of the topic queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Minimum offset at present.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getMinOffsetInQueue</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the offset of the message in the commit log, which is also known as physical offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic of the message to lookup.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> consumeQueueOffset offset of consume queue.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> physical offset.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getCommitLogOffsetInQueue</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> consumeQueueOffset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Look up the physical offset of the message whose store timestamp is as specified.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic of the message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timestamp Timestamp to look up.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> physical offset which matches.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getOffsetInQueueByTime</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Look up the message by given commit log offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commitLogOffset physical offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Message whose physical offset is as specified.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">MessageExt <span class="title">lookMessageByOffset</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> commitLogOffset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get one message from the specified commit log offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commitLogOffset commit log offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> wrapped result of the message.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SelectMappedBufferResult <span class="title">selectOneMessageByOffset</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> commitLogOffset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get one message from the specified commit log offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commitLogOffset commit log offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgSize message size.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> wrapped result of the message.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SelectMappedBufferResult <span class="title">selectOneMessageByOffset</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> commitLogOffset, <span class="keyword">final</span> <span class="keyword">int</span> msgSize)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the running information of this store.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> message store running info.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getRunningDataInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Message store runtime information, which should generally contains various statistical information.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> runtime information of the message store in format of key-value pairs.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HashMap&lt;String, String&gt; <span class="title">getRuntimeInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the maximum commit log offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> maximum commit log offset.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getMaxPhyOffset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the minimum commit log offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> minimum commit log offset.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getMinPhyOffset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the store time of the earliest message in the given queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic of the messages to query.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID to find.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> store time of the earliest message.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getEarliestMessageTime</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the store time of the earliest message in this store.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> timestamp of the earliest message in this store.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getEarliestMessageTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the store time of the message specified.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic message topic.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> consumeQueueOffset consume queue offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> store timestamp of the message.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getMessageStoreTimeStamp</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> consumeQueueOffset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the total number of the messages in the specified queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> total number.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getMessageTotalInQueue</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the raw commit log data starting from the given offset, which should used for replication purpose.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offset starting offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> commit log data.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">SelectMappedBufferResult <span class="title">getCommitLogData</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> offset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Append data to commit log.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startOffset starting offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data data to append.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if success; false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">appendToCommitLog</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> startOffset, <span class="keyword">final</span> <span class="keyword">byte</span>[] data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute file deletion manually.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">executeDeleteFilesManually</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query messages by given key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic topic of the message.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key message key.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxNum maximum number of the messages possible.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin begin timestamp.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end end timestamp.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">QueryMessageResult <span class="title">queryMessage</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> maxNum, <span class="keyword">final</span> <span class="keyword">long</span> begin,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> <span class="keyword">long</span> end)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Update HA master address.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newAddr new address.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateHaMasterAddress</span><span class="params">(<span class="keyword">final</span> String newAddr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return how much the slave falls behind.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> number of bytes that slave falls behind.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">slaveFallBehindMuch</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the current timestamp of the store.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> current time in milliseconds since 1970-01-01.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">now</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Clean unused topics.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topics all valid topics.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> number of the topics deleted.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">cleanUnusedTopic</span><span class="params">(<span class="keyword">final</span> Set&lt;String&gt; topics)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Clean expired consume queues.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cleanExpiredConsumerQueue</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if the given message has been swapped out of the memory.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic topic.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> consumeOffset consume queue offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the message is no longer in memory; false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">checkInDiskByConsumeOffset</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">long</span> consumeOffset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get number of the bytes that have been stored in commit log and not yet dispatched to consume queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> number of the bytes to dispatch.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">dispatchBehindBytes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flush the message store to persist all data.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> maximum offset flushed to persistent storage device.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reset written offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phyOffset new offset.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if success; false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resetWriteOffset</span><span class="params">(<span class="keyword">long</span> phyOffset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get confirm offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> confirm offset.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getConfirmOffset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set confirm offset.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phyOffset confirm offset to set.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setConfirmOffset</span><span class="params">(<span class="keyword">long</span> phyOffset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if the operation system page cache is busy or not.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the OS page cache is busy; false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isOSPageCacheBusy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get lock time in milliseconds of the store by far.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> lock time in milliseconds.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">lockTimeMills</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if the transient store pool is deficient.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the transient store pool is running out; false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTransientStorePoolDeficient</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the dispatcher list.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> list of the dispatcher.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">LinkedList&lt;CommitLogDispatcher&gt; <span class="title">getDispatcherList</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get consume queue of the topic/queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic Topic.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueId Queue ID.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Consume queue.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ConsumeQueue <span class="title">getConsumeQueue</span><span class="params">(String topic, <span class="keyword">int</span> queueId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="DefaultMessageStore"><a href="#DefaultMessageStore" class="headerlink" title="DefaultMessageStore"></a>DefaultMessageStore</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/5e828f26.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/5e828f26.html" class="post-title-link" itemprop="url">ConcurrentHashMap源码分析（jdk1.8）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-24 22:42:17" itemprop="dateCreated datePublished" datetime="2018-03-24T22:42:17+08:00">2018-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>不同版本jdk实现都不太一样。<br>关于1.6<br><a target="_blank" rel="noopener" href="http://ifeve.com/java-concurrent-hashmap-1/">http://ifeve.com/java-concurrent-hashmap-1/</a><br><a target="_blank" rel="noopener" href="http://ifeve.com/java-concurrent-hashmap-2/">http://ifeve.com/java-concurrent-hashmap-2/</a><br><a target="_blank" rel="noopener" href="http://www.importnew.com/16147.html">http://www.importnew.com/16147.html</a><br>为什么ConcurrentHashMap是弱一致的？ （注意这是jdk1.6，1.7、1.8都不是弱一致了）<br><a target="_blank" rel="noopener" href="http://ifeve.com/concurrenthashmap-weakly-consistent/">http://ifeve.com/concurrenthashmap-weakly-consistent/</a></p>
<p>关于1.7<br><a target="_blank" rel="noopener" href="http://www.blogjava.net/DLevin/archive/2013/10/18/405030.html">http://www.blogjava.net/DLevin/archive/2013/10/18/405030.html</a></p>
<p>关于1.7和1.8区别<br><a target="_blank" rel="noopener" href="http://www.importnew.com/23610.html">http://www.importnew.com/23610.html</a></p>
<p>接下来我们来分析1.8源码<br>先看下类的层次结构<br><img src="https://user-images.githubusercontent.com/7789698/38029713-3789bf9e-32c9-11e8-8e4c-bf0ea2e685b8.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ConcurrentMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最大容量不得超过1&lt;&lt;30</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认初始化容量，ConcurrentHashMap容量必须是2的幂次方</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The largest possible (non-power of two) array size.</span></span><br><span class="line"><span class="comment">     * Needed by toArray and related methods.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表的默认并发级别</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CONCURRENCY_LEVEL = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认装载因子，0.75是权衡空间和时间开销之后的综合考虑</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//超过这个阈值将使用红黑树组织桶中的结点，而不是链表</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只有表的大小超过这个阈值，桶才可以被转换成树而不是链表（为超过这个值时，应该使用resize）</span></span><br><span class="line"><span class="comment">//这个值是TREEIFY_THRESHOLD的4倍，以便resizing和treeification之间产生冲突</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Minimum number of rebinnings per transfer step. Ranges are</span></span><br><span class="line"><span class="comment">     * subdivided to allow multiple resizer threads.  This value</span></span><br><span class="line"><span class="comment">     * serves as a lower bound to avoid resizers encountering</span></span><br><span class="line"><span class="comment">     * excessive memory contention.  The value should be at least</span></span><br><span class="line"><span class="comment">     * DEFAULT_CAPACITY.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TRANSFER_STRIDE = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of bits used for generation stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     * Must be at least 6 for 32bit arrays.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> RESIZE_STAMP_BITS = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The maximum number of threads that can help resize.</span></span><br><span class="line"><span class="comment">     * Must fit in 32 - RESIZE_STAMP_BITS bits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_RESIZERS = (<span class="number">1</span> &lt;&lt; (<span class="number">32</span> - RESIZE_STAMP_BITS)) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The bit shift for recording size stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESIZE_STAMP_SHIFT = <span class="number">32</span> - RESIZE_STAMP_BITS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hash for forwarding nodes</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hash for roots of trees</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Number of CPUS, to place bounds on some sizings */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** For serialization compatibility. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = &#123;</span><br><span class="line">        <span class="keyword">new</span> ObjectStreamField(<span class="string">&quot;segments&quot;</span>, Segment[].class),</span><br><span class="line">        <span class="keyword">new</span> ObjectStreamField(<span class="string">&quot;segmentMask&quot;</span>, Integer.TYPE),</span><br><span class="line">        <span class="keyword">new</span> ObjectStreamField(<span class="string">&quot;segmentShift&quot;</span>, Integer.TYPE)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储元素的实体数组</span></span><br><span class="line">  <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base counter value, used mainly when there is no contention,</span></span><br><span class="line"><span class="comment">     * but also as a fallback during table initialization</span></span><br><span class="line"><span class="comment">     * races. Updated via CAS.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//表初始化和扩容的控制变量</span></span><br><span class="line">     <span class="comment">//负数时候表正在初始化或者扩容的时候：-1表示初始化，其他时候是-(1+活跃的扩容线程数)</span></span><br><span class="line">     <span class="comment">//正数表空的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The next table index (plus one) to split while resizing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> transferIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// views</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> KeySetView&lt;K,V&gt; keySet;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ValuesView&lt;K,V&gt; values;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> EntrySetView&lt;K,V&gt; entrySet;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">            initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">        <span class="keyword">long</span> size = (<span class="keyword">long</span>)(<span class="number">1.0</span> + (<span class="keyword">long</span>)initialCapacity / loadFactor);</span><br><span class="line">        <span class="keyword">int</span> cap = (size &gt;= (<span class="keyword">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">            MAXIMUM_CAPACITY : tableSizeFor((<span class="keyword">int</span>)size);</span><br><span class="line">        <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; k = ConcurrentHashMap.class;</span><br><span class="line">            <span class="comment">//取到sizeCtl字段的偏移值，用于CAS操作</span></span><br><span class="line">            SIZECTL = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;sizeCtl&quot;</span>));</span><br><span class="line">            TRANSFERINDEX = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;transferIndex&quot;</span>));</span><br><span class="line">            BASECOUNT = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;baseCount&quot;</span>));</span><br><span class="line">            CELLSBUSY = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">&quot;cellsBusy&quot;</span>));</span><br><span class="line">            Class&lt;?&gt; ck = CounterCell.class;</span><br><span class="line">            CELLVALUE = U.objectFieldOffset</span><br><span class="line">                (ck.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">            Class&lt;?&gt; ak = Node[].class;</span><br><span class="line">            <span class="comment">//Node数组首指针偏移量</span></span><br><span class="line">            ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">            <span class="comment">//数组中元素的增量地址</span></span><br><span class="line">            <span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">            <span class="comment">//不是2的平方报错</span></span><br><span class="line">            <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;data type scale not a power of two&quot;</span>);</span><br><span class="line">                <span class="comment">//log&lt;sub&gt;2&lt;/sub&gt;(x)  数组元素的bit偏移量</span></span><br><span class="line">            ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们看下最重要的Node类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line"><span class="comment">//与hashmap的Node区别最重要的一点，使用volatile保证可见性防重排</span></span><br><span class="line">        <span class="keyword">volatile</span> V val;</span><br><span class="line">        <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="keyword">this</span>.hash = hash;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">            <span class="keyword">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> val; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> key + <span class="string">&quot;=&quot;</span> + val; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Object k, v, u; Map.Entry&lt;?,?&gt; e;</span><br><span class="line">            <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &amp;&amp;</span><br><span class="line">                    (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (v = e.getValue()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (k == key || k.equals(key)) &amp;&amp;</span><br><span class="line"><span class="comment">//取出快照</span></span><br><span class="line">                    (v == (u = val) || v.equals(u)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历链表取到结点</span></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            Node&lt;K,V&gt; e = <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    K ek;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//小于0表示另一个线程在使用，挂起等待</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="comment">//第一个参数为需要改变的对象，第二个为偏移量(即之前求出来的valueOffset的值)，第三个参数为期待的值，第四个为更新后的值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hash算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">spread</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (h ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; HASH_BITS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CAS判断获取桶的第i个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CAS设置桶的第i个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CAS设置桶第i个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">    U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>put</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">           <span class="comment">//表为空初始化</span></span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">                tab = initTable();</span><br><span class="line">            <span class="comment">//hash不到（桶空的）</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                             <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                    <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果hash到结点是-1，表示hash到ForwardingNode</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="comment">//hash到的桶里不为空</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                V oldVal = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//多线程同步</span></span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="comment">//再次取出节点，还是那个节点的话，表示没被其他线程修改</span></span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="comment">//hash值大于0</span></span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                                K ek;</span><br><span class="line">                                <span class="comment">//找到一样的节点，替换掉</span></span><br><span class="line">                                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    oldVal = e.val;</span><br><span class="line">                                    <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                        e.val = value;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">//不一样则尾插</span></span><br><span class="line">                                Node&lt;K,V&gt; pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                              value, <span class="keyword">null</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//如果是红黑树，更新或添加节点</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            Node&lt;K,V&gt; p;</span><br><span class="line">                            binCount = <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                           value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                oldVal = p.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    p.val = value;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果链表节点binCount大于8个转化为红黑树</span></span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                        treeifyBin(tab, i);</span><br><span class="line">                    <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> oldVal;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>hash值为-1的节点，代表正在扩容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">    ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">        <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// loop to avoid arbitrarily deep recursion on forwarding nodes</span></span><br><span class="line">        outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e; <span class="keyword">int</span> n;</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="keyword">null</span> || tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">                (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> eh; K ek;</span><br><span class="line">                <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">                <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                        tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                        <span class="keyword">continue</span> outer;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>链表转红黑树</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//桶长度小于64，则会触发扩容，不转树</span></span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//桶大于64，重新取出该位置元素</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="comment">//未被操作</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                        <span class="comment">//遍历构造每一个</span></span><br><span class="line">                        TreeNode&lt;K,V&gt; p =</span><br><span class="line">                            <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                              <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="comment">//首节点设为hd</span></span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//给定的容量若&gt;=MAXIMUM_CAPACITY的一半，直接扩容到允许的最大值，否则调用tableSizeFor函数扩容 </span></span><br><span class="line">    <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">        tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="comment">//只有大于等于0才表示该线程可以扩容，小于0时候表示有线程正在扩容，自旋等待下</span></span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">        <span class="comment">//空的，重新初始化</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="comment">//同样设置为-1表示正在扩容</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//没被其他线程修改过</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                Node&lt;K,V&gt;[] nt;</span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    <span class="comment">//真正扩容的地方</span></span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>transfer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                     (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                   nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                bound = nextBound;</span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="keyword">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                nextTable = <span class="keyword">null</span>;</span><br><span class="line">                table = nextTab;</span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/cba0f441.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/cba0f441.html" class="post-title-link" itemprop="url">RocketMQ 源码分析(三) ----broker模块分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-19 22:41:53" itemprop="dateCreated datePublished" datetime="2018-03-19T22:41:53+08:00">2018-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="脚本分析"><a href="#脚本分析" class="headerlink" title="脚本分析"></a>脚本分析</h1><p>mqbroker.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">if [ -z &quot;$ROCKETMQ_HOME&quot; ] ; then</span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># resolve links - $0 may be a link to maven&#x27;s home</span></span></span><br><span class="line">  PRG=&quot;$0&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> need this <span class="keyword">for</span> relative symlinks</span></span><br><span class="line">  while [ -h &quot;$PRG&quot; ] ; do</span><br><span class="line">    ls=`ls -ld &quot;$PRG&quot;`</span><br><span class="line">    link=`expr &quot;$ls&quot; : &#x27;.*-&gt; \(.*\)$&#x27;`</span><br><span class="line">    if expr &quot;$link&quot; : &#x27;/.*&#x27; &gt; /dev/null; then</span><br><span class="line">      PRG=&quot;$link&quot;</span><br><span class="line">    else</span><br><span class="line">      PRG=&quot;`dirname &quot;$PRG&quot;`/$link&quot;</span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">  saveddir=`pwd`</span><br><span class="line"></span><br><span class="line">  ROCKETMQ_HOME=`dirname &quot;$PRG&quot;`/..</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> make it fully qualified</span></span><br><span class="line">  ROCKETMQ_HOME=`cd &quot;$ROCKETMQ_HOME&quot; &amp;&amp; pwd`</span><br><span class="line"></span><br><span class="line">  cd &quot;$saveddir&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">export ROCKETMQ_HOME</span><br><span class="line"></span><br><span class="line">sh $&#123;ROCKETMQ_HOME&#125;/bin/runbroker.sh org.apache.rocketmq.broker.BrokerStartup $@</span><br></pre></td></tr></table></figure>

<p><code>BrokerStartup</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerStartup</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Properties properties = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommandLine commandLine = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String configFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        start(createBrokerController(args));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title">start</span><span class="params">(BrokerController controller)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            controller.start();</span><br><span class="line">            String tip = <span class="string">&quot;The broker[&quot;</span> + controller.getBrokerConfig().getBrokerName() + <span class="string">&quot;, &quot;</span></span><br><span class="line">                + controller.getBrokerAddr() + <span class="string">&quot;] boot success. serializeType=&quot;</span> + RemotingCommand.getSerializeTypeConfigInThisServer();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != controller.getBrokerConfig().getNamesrvAddr()) &#123;</span><br><span class="line">                tip += <span class="string">&quot; and name server is &quot;</span> + controller.getBrokerConfig().getNamesrvAddr();</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(tip);</span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title">createBrokerController</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置rocketmq.remoting.version，设置版本号</span></span><br><span class="line">        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line">        <span class="comment">//获取com.rocketmq.remoting.socket.sndbuf.size配置，没有则设置为131072</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_SNDBUF_SIZE)) &#123;</span><br><span class="line">            NettySystemConfig.socketSndbufSize = <span class="number">131072</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//com.rocketmq.remoting.socket.rcvbuf.size配置</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_RCVBUF_SIZE)) &#123;</span><br><span class="line">            NettySystemConfig.socketRcvbufSize = <span class="number">131072</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Options options = ServerUtil.buildCommandlineOptions(<span class="keyword">new</span> Options());</span><br><span class="line">            commandLine = ServerUtil.parseCmdLine(<span class="string">&quot;mqbroker&quot;</span>, args, buildCommandlineOptions(options),</span><br><span class="line">                <span class="keyword">new</span> PosixParser());</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == commandLine) &#123;</span><br><span class="line">                System.exit(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> BrokerConfig brokerConfig = <span class="keyword">new</span> BrokerConfig();</span><br><span class="line">            <span class="keyword">final</span> NettyServerConfig nettyServerConfig = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">            <span class="keyword">final</span> NettyClientConfig nettyClientConfig = <span class="keyword">new</span> NettyClientConfig();</span><br><span class="line">            nettyServerConfig.setListenPort(<span class="number">10911</span>);</span><br><span class="line">            <span class="keyword">final</span> MessageStoreConfig messageStoreConfig = <span class="keyword">new</span> MessageStoreConfig();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ASYNC_MASTER,SYNC_MASTER,SLAVE; new的时候默认ASYNC_MASTER</span></span><br><span class="line">            <span class="keyword">if</span> (BrokerRole.SLAVE == messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="keyword">int</span> ratio = messageStoreConfig.getAccessMessageInMemoryMaxRatio() - <span class="number">10</span>;</span><br><span class="line">                messageStoreConfig.setAccessMessageInMemoryMaxRatio(ratio);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (commandLine.hasOption(<span class="string">&#x27;c&#x27;</span>)) &#123;</span><br><span class="line">                String file = commandLine.getOptionValue(<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    configFile = file;</span><br><span class="line">                    InputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">                    properties = <span class="keyword">new</span> Properties();</span><br><span class="line">                    properties.load(in);</span><br><span class="line">                    properties2SystemEnv(properties);</span><br><span class="line">                    MixAll.properties2Object(properties, brokerConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, nettyClientConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, messageStoreConfig);</span><br><span class="line">                    BrokerPathConfigHelper.setBrokerConfigPath(file);</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), brokerConfig);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == brokerConfig.getRocketmqHome()) &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;Please set the &quot;</span> + MixAll.ROCKETMQ_HOME_ENV</span><br><span class="line">                    + <span class="string">&quot; variable in your environment to match the location of the RocketMQ installation&quot;</span>);</span><br><span class="line">                System.exit(-<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String namesrvAddr = brokerConfig.getNamesrvAddr();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != namesrvAddr) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String[] addrArray = namesrvAddr.split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span> (String addr : addrArray) &#123;</span><br><span class="line">                        RemotingUtil.string2SocketAddress(addr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.out.printf(</span><br><span class="line">                        <span class="string">&quot;The Name Server Address[%s] illegal, please set it as follows, \&quot;127.0.0.1:9876;192.168.0.1:9876\&quot;%n&quot;</span>,</span><br><span class="line">                        namesrvAddr);</span><br><span class="line">                    System.exit(-<span class="number">3</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="keyword">case</span> ASYNC_MASTER:</span><br><span class="line">                <span class="keyword">case</span> SYNC_MASTER:</span><br><span class="line">                    brokerConfig.setBrokerId(MixAll.MASTER_ID);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> SLAVE:</span><br><span class="line">                    <span class="keyword">if</span> (brokerConfig.getBrokerId() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        System.out.printf(<span class="string">&quot;Slave&#x27;s brokerId must be &gt; 0&quot;</span>);</span><br><span class="line">                        System.exit(-<span class="number">3</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            messageStoreConfig.setHaListenPort(nettyServerConfig.getListenPort() + <span class="number">1</span>);</span><br><span class="line">            LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();</span><br><span class="line">            JoranConfigurator configurator = <span class="keyword">new</span> JoranConfigurator();</span><br><span class="line">            configurator.setContext(lc);</span><br><span class="line">            lc.reset();</span><br><span class="line">            configurator.doConfigure(brokerConfig.getRocketmqHome() + <span class="string">&quot;/conf/logback_broker.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (commandLine.hasOption(<span class="string">&#x27;p&#x27;</span>)) &#123;</span><br><span class="line">                Logger console = LoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">                MixAll.printObjectProperties(console, brokerConfig);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyServerConfig);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyClientConfig);</span><br><span class="line">                MixAll.printObjectProperties(console, messageStoreConfig);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (commandLine.hasOption(<span class="string">&#x27;m&#x27;</span>)) &#123;</span><br><span class="line">                Logger console = LoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">                MixAll.printObjectProperties(console, brokerConfig, <span class="keyword">true</span>);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyServerConfig, <span class="keyword">true</span>);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyClientConfig, <span class="keyword">true</span>);</span><br><span class="line">                MixAll.printObjectProperties(console, messageStoreConfig, <span class="keyword">true</span>);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</span><br><span class="line">            MixAll.printObjectProperties(log, brokerConfig);</span><br><span class="line">            MixAll.printObjectProperties(log, nettyServerConfig);</span><br><span class="line">            MixAll.printObjectProperties(log, nettyClientConfig);</span><br><span class="line">            MixAll.printObjectProperties(log, messageStoreConfig);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> BrokerController controller = <span class="keyword">new</span> BrokerController(</span><br><span class="line">                brokerConfig,</span><br><span class="line">                nettyServerConfig,</span><br><span class="line">                nettyClientConfig,</span><br><span class="line">                messageStoreConfig);</span><br><span class="line">            <span class="comment">// remember all configs to prevent discard</span></span><br><span class="line">            controller.getConfiguration().registerConfig(properties);</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line">            <span class="keyword">boolean</span> initResult = controller.initialize();</span><br><span class="line">            <span class="keyword">if</span> (!initResult) &#123;</span><br><span class="line">                controller.shutdown();</span><br><span class="line">                System.exit(-<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasShutdown = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">private</span> AtomicInteger shutdownTimes = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                        log.info(<span class="string">&quot;Shutdown hook was invoked, &#123;&#125;&quot;</span>, <span class="keyword">this</span>.shutdownTimes.incrementAndGet());</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="keyword">this</span>.hasShutdown) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.hasShutdown = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">long</span> beginTime = System.currentTimeMillis();</span><br><span class="line">                            controller.shutdown();</span><br><span class="line">                            <span class="keyword">long</span> consumingTimeTotal = System.currentTimeMillis() - beginTime;</span><br><span class="line">                            log.info(<span class="string">&quot;Shutdown hook over, consuming total time(ms): &#123;&#125;&quot;</span>, consumingTimeTotal);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">&quot;ShutdownHook&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BrokerController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BrokerConfig brokerConfig;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NettyServerConfig nettyServerConfig;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NettyClientConfig nettyClientConfig;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageStoreConfig messageStoreConfig;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConsumerOffsetManager consumerOffsetManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConsumerManager consumerManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConsumerFilterManager consumerFilterManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ProducerManager producerManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClientHousekeepingService clientHousekeepingService;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PullMessageProcessor pullMessageProcessor;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PullRequestHoldService pullRequestHoldService;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageArrivingListener messageArrivingListener;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Broker2Client broker2Client;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SubscriptionGroupManager subscriptionGroupManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConsumerIdsChangeListener consumerIdsChangeListener;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RebalanceLockManager rebalanceLockManager = <span class="keyword">new</span> RebalanceLockManager();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BrokerOuterAPI brokerOuterAPI;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService = Executors.newSingleThreadScheduledExecutor(<span class="keyword">new</span> ThreadFactoryImpl(</span><br><span class="line">    <span class="string">&quot;BrokerControllerScheduledThread&quot;</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SlaveSynchronize slaveSynchronize;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sendThreadPoolQueue;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; pullThreadPoolQueue;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; queryThreadPoolQueue;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; clientManagerThreadPoolQueue;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; consumerManagerThreadPoolQueue;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FilterServerManager filterServerManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BrokerStatsManager brokerStatsManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;SendMessageHook&gt; sendMessageHookList = <span class="keyword">new</span> ArrayList&lt;SendMessageHook&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;ConsumeMessageHook&gt; consumeMessageHookList = <span class="keyword">new</span> ArrayList&lt;ConsumeMessageHook&gt;();</span><br><span class="line"><span class="keyword">private</span> MessageStore messageStore;</span><br><span class="line"><span class="keyword">private</span> RemotingServer remotingServer;</span><br><span class="line"><span class="keyword">private</span> RemotingServer fastRemotingServer;</span><br><span class="line"><span class="keyword">private</span> TopicConfigManager topicConfigManager;</span><br><span class="line"><span class="keyword">private</span> ExecutorService sendMessageExecutor;</span><br><span class="line"><span class="keyword">private</span> ExecutorService pullMessageExecutor;</span><br><span class="line"><span class="keyword">private</span> ExecutorService queryMessageExecutor;</span><br><span class="line"><span class="keyword">private</span> ExecutorService adminBrokerExecutor;</span><br><span class="line"><span class="keyword">private</span> ExecutorService clientManageExecutor;</span><br><span class="line"><span class="keyword">private</span> ExecutorService consumerManageExecutor;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> updateMasterHAServerAddrPeriodically = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">private</span> BrokerStats brokerStats;</span><br><span class="line"><span class="keyword">private</span> InetSocketAddress storeHost;</span><br><span class="line"><span class="keyword">private</span> BrokerFastFailure brokerFastFailure;</span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br></pre></td></tr></table></figure>

<p>initialize</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">    <span class="comment">//加载主要模块的配置信息</span></span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">this</span>.topicConfigManager.load();</span><br><span class="line"></span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.consumerOffsetManager.load();</span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.subscriptionGroupManager.load();</span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.consumerFilterManager.load();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.messageStore =</span><br><span class="line">                    <span class="keyword">new</span> DefaultMessageStore(<span class="keyword">this</span>.messageStoreConfig, <span class="keyword">this</span>.brokerStatsManager, <span class="keyword">this</span>.messageArrivingListener,</span><br><span class="line">                        <span class="keyword">this</span>.brokerConfig);</span><br><span class="line">                <span class="keyword">this</span>.brokerStats = <span class="keyword">new</span> BrokerStats((DefaultMessageStore) <span class="keyword">this</span>.messageStore);</span><br><span class="line">                <span class="comment">//load plugin</span></span><br><span class="line">                MessageStorePluginContext context = <span class="keyword">new</span> MessageStorePluginContext(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);</span><br><span class="line">                <span class="keyword">this</span>.messageStore = MessageStoreFactory.build(context, <span class="keyword">this</span>.messageStore);</span><br><span class="line">                <span class="keyword">this</span>.messageStore.getDispatcherList().addFirst(<span class="keyword">new</span> CommitLogDispatcherCalcBitMap(<span class="keyword">this</span>.brokerConfig, <span class="keyword">this</span>.consumerFilterManager));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                result = <span class="keyword">false</span>;</span><br><span class="line">                log.error(<span class="string">&quot;Failed to initialize&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.messageStore.load();</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line"> <span class="comment">//启动服务器初始化</span></span><br><span class="line">            <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">            NettyServerConfig fastConfig = (NettyServerConfig) <span class="keyword">this</span>.nettyServerConfig.clone();</span><br><span class="line">            fastConfig.setListenPort(nettyServerConfig.getListenPort() - <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.fastRemotingServer = <span class="keyword">new</span> NettyRemotingServer(fastConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line"><span class="comment">//初始化线程池</span></span><br><span class="line">            <span class="keyword">this</span>.sendMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.sendThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">&quot;SendMessageThread_&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.pullMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.pullThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">&quot;PullMessageThread_&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.adminBrokerExecutor =</span><br><span class="line">                Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getAdminBrokerThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(</span><br><span class="line">                    <span class="string">&quot;AdminBrokerThread_&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.clientManageExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">                <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">                <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">                TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">this</span>.clientManagerThreadPoolQueue,</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">&quot;ClientManageThread_&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.consumerManageExecutor =</span><br><span class="line">                Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getConsumerManageThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(</span><br><span class="line">                    <span class="string">&quot;ConsumerManageThread_&quot;</span>));</span><br><span class="line"><span class="comment">//注册请求处理器</span></span><br><span class="line">            <span class="keyword">this</span>.registerProcessor();</span><br><span class="line"><span class="comment">//设置各种定时任务 、、等等。</span></span><br><span class="line">            <span class="comment">//获取broker状态的</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> initialDelay = UtilAll.computNextMorningTimeMillis() - System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> period = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.getBrokerStats().record();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;schedule record error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//周期性将消费者的offset刷到硬盘</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.consumerOffsetManager.persist();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;schedule persist consumerOffset error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//周期性将消费者消息记录写入文件</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.consumerFilterManager.persist();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;schedule persist consumer filter error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//周期性检查消费者的消费能力以保护broker</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.protectBroker();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;protectBroker error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line"><span class="comment">//定期打印消息消费标记</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.printWaterMark();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;printWaterMark error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">10</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        log.info(<span class="string">&quot;dispatch behind commit log &#123;&#125; bytes&quot;</span>, BrokerController.<span class="keyword">this</span>.getMessageStore().dispatchBehindBytes());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;schedule dispatchBehindBytes error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//获取name server的地址</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.getNamesrvAddr() != <span class="keyword">null</span>) &#123;  <span class="keyword">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">                log.info(<span class="string">&quot;Set user specified name server address: &#123;&#125;&quot;</span>, <span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            BrokerController.<span class="keyword">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                            log.error(<span class="string">&quot;ScheduledTask fetchNameServerAddr exception&quot;</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="keyword">this</span>.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress() != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress().length() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.messageStore.updateHaMasterAddress(<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">                    <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//如果是slave，主从同步</span></span><br><span class="line">                <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            BrokerController.<span class="keyword">this</span>.slaveSynchronize.syncAll();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                            log.error(<span class="string">&quot;ScheduledTask syncAll slave exception&quot;</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//打印主从差异配置</span></span><br><span class="line">                <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            BrokerController.<span class="keyword">this</span>.printMasterAndSlaveDiff();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                            log.error(<span class="string">&quot;schedule printMasterAndSlaveDiff error.&quot;</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>start</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//启动存储服务</span></span><br><span class="line">    <span class="comment">//包括逻辑队列刷盘服务，就是把内存的msg刷入磁盘</span></span><br><span class="line">    <span class="comment">//元数据刷盘服务</span></span><br><span class="line">    <span class="comment">//存储层状态服务 比如 put_tps get_found_tps get_miss_tps get_transfered_tps</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.messageStore != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.messageStore.start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//启动 netty serverBootstrap 绑定端口 监听等</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.remotingServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fastRemotingServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//客户端netty启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.brokerOuterAPI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerOuterAPI.start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//启动请求Hold服务</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.pullRequestHoldService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.pullRequestHoldService.start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//定期检测客户端连接</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.clientHousekeepingService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.clientHousekeepingService.start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//过滤服务启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.filterServerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.filterServerManager.start();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//向namesrv注册broker</span></span><br><span class="line">    <span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BrokerController.<span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;registerBrokerAll Exception&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">30</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">// broker状态管理启动</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.brokerStatsManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerStatsManager.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.brokerFastFailure != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerFastFailure.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>registerBrokerAll</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">registerBrokerAll</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> checkOrderConfig, <span class="keyword">boolean</span> oneway)</span> </span>&#123;</span><br><span class="line">    TopicConfigSerializeWrapper topicConfigWrapper = <span class="keyword">this</span>.getTopicConfigManager().buildTopicConfigSerializeWrapper();</span><br><span class="line"> <span class="comment">//同步 Broker 读写权限</span></span><br><span class="line">    <span class="keyword">if</span> (!PermName.isWriteable(<span class="keyword">this</span>.getBrokerConfig().getBrokerPermission())</span><br><span class="line">        || !PermName.isReadable(<span class="keyword">this</span>.getBrokerConfig().getBrokerPermission())) &#123;</span><br><span class="line">        ConcurrentHashMap&lt;String, TopicConfig&gt; topicConfigTable = <span class="keyword">new</span> ConcurrentHashMap&lt;String, TopicConfig&gt;();</span><br><span class="line">        <span class="keyword">for</span> (TopicConfig topicConfig : topicConfigWrapper.getTopicConfigTable().values()) &#123;</span><br><span class="line">            TopicConfig tmp =</span><br><span class="line">                <span class="keyword">new</span> TopicConfig(topicConfig.getTopicName(), topicConfig.getReadQueueNums(), topicConfig.getWriteQueueNums(),</span><br><span class="line">                    <span class="keyword">this</span>.brokerConfig.getBrokerPermission());</span><br><span class="line">            topicConfigTable.put(topicConfig.getTopicName(), tmp);</span><br><span class="line">        &#125;</span><br><span class="line">        topicConfigWrapper.setTopicConfigTable(topicConfigTable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RegisterBrokerResult registerBrokerResult = <span class="keyword">this</span>.brokerOuterAPI.registerBrokerAll(</span><br><span class="line">        <span class="keyword">this</span>.brokerConfig.getBrokerClusterName(),</span><br><span class="line">        <span class="keyword">this</span>.getBrokerAddr(),</span><br><span class="line">        <span class="keyword">this</span>.brokerConfig.getBrokerName(),</span><br><span class="line">        <span class="keyword">this</span>.brokerConfig.getBrokerId(),</span><br><span class="line">        <span class="keyword">this</span>.getHAServerAddr(),</span><br><span class="line">        topicConfigWrapper,</span><br><span class="line">        <span class="keyword">this</span>.filterServerManager.buildNewFilterServerList(),</span><br><span class="line">        oneway,</span><br><span class="line">        <span class="keyword">this</span>.brokerConfig.getRegisterBrokerTimeoutMills());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (registerBrokerResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.updateMasterHAServerAddrPeriodically &amp;&amp; registerBrokerResult.getHaServerAddr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.messageStore.updateHaMasterAddress(registerBrokerResult.getHaServerAddr());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.slaveSynchronize.setMasterAddr(registerBrokerResult.getMasterAddr());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (checkOrderConfig) &#123;</span><br><span class="line">            <span class="keyword">this</span>.getTopicConfigManager().updateOrderTopicConfig(registerBrokerResult.getKvTable());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/58cc55f9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/58cc55f9.html" class="post-title-link" itemprop="url">RocketMQ 源码分析(二) ----通信模块分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-19 22:41:42" itemprop="dateCreated datePublished" datetime="2018-03-19T22:41:42+08:00">2018-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="rocketMQ通信模块"><a href="#rocketMQ通信模块" class="headerlink" title="rocketMQ通信模块"></a>rocketMQ通信模块</h2><p><img src="https://user-images.githubusercontent.com/7789698/32897440-358e21d4-caab-11e7-8f66-76a302229a2d.png" alt="image"></p>
<p>NettyRemotingClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//业务线程池</span></span><br><span class="line">        <span class="keyword">this</span>.defaultEventExecutorGroup = <span class="keyword">new</span> DefaultEventExecutorGroup(</span><br><span class="line">            nettyClientConfig.getClientWorkerThreads(),</span><br><span class="line">            <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                <span class="keyword">private</span> AtomicInteger threadIndex = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;NettyClientWorkerThread_&quot;</span> + <span class="keyword">this</span>.threadIndex.incrementAndGet());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        Bootstrap handler = <span class="keyword">this</span>.bootstrap.group(<span class="keyword">this</span>.eventLoopGroupWorker).channel(NioSocketChannel.class)</span><br><span class="line">            .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">            .option(ChannelOption.SO_KEEPALIVE, <span class="keyword">false</span>)</span><br><span class="line">            .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, nettyClientConfig.getConnectTimeoutMillis())</span><br><span class="line">            .option(ChannelOption.SO_SNDBUF, nettyClientConfig.getClientSocketSndBufSize())</span><br><span class="line">            .option(ChannelOption.SO_RCVBUF, nettyClientConfig.getClientSocketRcvBufSize())</span><br><span class="line">            .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ch.pipeline().addLast(</span><br><span class="line">                        defaultEventExecutorGroup,</span><br><span class="line"><span class="comment">//编码（RemotingCommand 的Header和Body依次写入）</span></span><br><span class="line">                        <span class="keyword">new</span> NettyEncoder(),</span><br><span class="line"><span class="comment">//解码（LengthFieldBasedFrameDecoder自定义长度解码器解决TCP粘包）</span></span><br><span class="line">                        <span class="keyword">new</span> NettyDecoder(),</span><br><span class="line"><span class="comment">//netty 4.X心跳检测 </span></span><br><span class="line"><span class="comment">//readerIdleTime：为读超时时间（即测试端一定时间内未接受到被测试端消息）、writerIdleTime：为写超时时间（即测试端一定时间内向被测试端发送消息）、allIdleTime：所有类型的超时时间 120</span></span><br><span class="line">                        <span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">0</span>, nettyClientConfig.getClientChannelMaxIdleTimeSeconds()),</span><br><span class="line"><span class="comment">//连接管理handler,处理connect, disconnect, close等事件</span></span><br><span class="line">                        <span class="keyword">new</span> NettyConnectManageHandler(),</span><br><span class="line"><span class="comment">//处理接收到RemotingCommand消息后的事件, 收到服务器端响应后的相关操作</span></span><br><span class="line">                        <span class="keyword">new</span> NettyClientHandler());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="comment">//每次有消息需要发送, 就会生成resposneFuture用于接收消息回应, 但是如果始终没有收到回应, //Map(scanResponseTable)中的responseFuture就会堆积.</span></span><br><span class="line"><span class="comment">//这个时候就需要一个线程来专门做Map的清理回收,</span></span><br><span class="line">        <span class="keyword">this</span>.timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    NettyRemotingClient.<span class="keyword">this</span>.scanResponseTable();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;scanResponseTable exception&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">3</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.channelEventListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nettyEventExecutor.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanResponseTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;ResponseFuture&gt; rfList = <span class="keyword">new</span> LinkedList&lt;ResponseFuture&gt;();</span><br><span class="line">        Iterator&lt;Entry&lt;Integer, ResponseFuture&gt;&gt; it = <span class="keyword">this</span>.responseTable.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            Entry&lt;Integer, ResponseFuture&gt; next = it.next();</span><br><span class="line">            ResponseFuture rep = next.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((rep.getBeginTimestamp() + rep.getTimeoutMillis() + <span class="number">1000</span>) &lt;= System.currentTimeMillis()) &#123;</span><br><span class="line">                rep.release();</span><br><span class="line">                it.remove();</span><br><span class="line">                rfList.add(rep);</span><br><span class="line">                log.warn(<span class="string">&quot;remove timeout request, &quot;</span> + rep);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ResponseFuture rf : rfList) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                executeInvokeCallback(rf);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;scanResponseTable, operationComplete Exception&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ-通信编解码源码解析"><a href="#RocketMQ-通信编解码源码解析" class="headerlink" title="RocketMQ 通信编解码源码解析"></a>RocketMQ 通信编解码源码解析</h2><p>编码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">RemotingCommand</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(RemotingHelper.ROCKETMQ_REMOTING);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand remotingCommand, ByteBuf out)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//nio ByteBuffer 具体见http://www1350.github.io/#post/115</span></span><br><span class="line">            ByteBuffer header = remotingCommand.encodeHeader();</span><br><span class="line">            out.writeBytes(header);</span><br><span class="line">            <span class="keyword">byte</span>[] body = remotingCommand.getBody();</span><br><span class="line">            <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</span><br><span class="line">                out.writeBytes(body);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;encode exception, &quot;</span> + RemotingHelper.parseChannelRemoteAddr(ctx.channel()), e);</span><br><span class="line">            <span class="keyword">if</span> (remotingCommand != <span class="keyword">null</span>) &#123;</span><br><span class="line">                log.error(remotingCommand.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            RemotingUtil.closeChannel(ctx.channel());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>解码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyDecoder</span> <span class="keyword">extends</span> <span class="title">LengthFieldBasedFrameDecoder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(RemotingHelper.ROCKETMQ_REMOTING);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_MAX_LENGTH =</span><br><span class="line">        Integer.parseInt(System.getProperty(<span class="string">&quot;com.rocketmq.remoting.frameMaxLength&quot;</span>, <span class="string">&quot;16777216&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NettyDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(FRAME_MAX_LENGTH, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteBuf frame = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            frame = (ByteBuf) <span class="keyword">super</span>.decode(ctx, in);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == frame) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//netty的ByteBuf 转化为nio 的ByteBuffer</span></span><br><span class="line"><span class="comment">//  http://www.jianshu.com/p/0f93834f23de</span></span><br><span class="line">            ByteBuffer byteBuffer = frame.nioBuffer();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> RemotingCommand.decode(byteBuffer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;decode exception, &quot;</span> + RemotingHelper.parseChannelRemoteAddr(ctx.channel()), e);</span><br><span class="line">            RemotingUtil.closeChannel(ctx.channel());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != frame) &#123;</span><br><span class="line">                frame.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抓一下包：<br>三次握手<br><img src="https://user-images.githubusercontent.com/7789698/33132848-be28c574-cfd5-11e7-87d4-0630b2c14a4a.png" alt="b79ea69e-e0c3-4400-813b-66d201dab19d"></p>
<p>内容<br><img width="1253" alt="wx20171122-225830 2x" src="https://user-images.githubusercontent.com/7789698/33133766-c3a83662-cfd8-11e7-8f9a-043d4ceb7682.png"></p>
<p>我们来看看通信的时候编解码的包：<br><img src="https://user-images.githubusercontent.com/7789698/32903410-e1ca3d8c-cb2f-11e7-85dd-7cabb312482c.jpg" alt="main"></p>
<p>处理header</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">encodeHeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> encodeHeader(<span class="keyword">this</span>.body != <span class="keyword">null</span> ? <span class="keyword">this</span>.body.length : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">encodeHeader</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> bodyLength)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1&gt; header length size</span></span><br><span class="line">        <span class="keyword">int</span> length = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2&gt; header data length</span></span><br><span class="line">        <span class="keyword">byte</span>[] headerData;</span><br><span class="line">        headerData = <span class="keyword">this</span>.headerEncode();</span><br><span class="line"></span><br><span class="line">        length += headerData.length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3&gt; body data length</span></span><br><span class="line">        length += bodyLength;</span><br><span class="line"></span><br><span class="line">        ByteBuffer result = ByteBuffer.allocate(<span class="number">4</span> + length - bodyLength);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// length</span></span><br><span class="line">        result.putInt(length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// header length</span></span><br><span class="line">        result.put(markProtocolType(headerData.length, serializeTypeCurrentRPC));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// header data</span></span><br><span class="line">        result.put(headerData);</span><br><span class="line"></span><br><span class="line">        result.flip();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] markProtocolType(<span class="keyword">int</span> source, SerializeType type) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] result = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        result[<span class="number">0</span>] = type.getCode();</span><br><span class="line">        result[<span class="number">1</span>] = (<span class="keyword">byte</span>) ((source &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">        result[<span class="number">2</span>] = (<span class="keyword">byte</span>) ((source &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">        result[<span class="number">3</span>] = (<span class="keyword">byte</span>) (source &amp; <span class="number">0xFF</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h3 id="header内容："><a href="#header内容：" class="headerlink" title="header内容："></a>header内容：</h3><table>
<thead>
<tr>
<th>字段名</th>
<th align="center">类型</th>
<th align="center">Request</th>
<th align="center">Response</th>
<th align="right">描述</th>
</tr>
</thead>
<tbody><tr>
<td>code</td>
<td align="center">short</td>
<td align="center">请求操作码，请求接收方根据不同代码做不同操作</td>
<td align="center">应答结果代码，0成功非0失败</td>
<td align="right"></td>
</tr>
<tr>
<td>language</td>
<td align="center">byte</td>
<td align="center">请求发起方语言，默认JAVA</td>
<td align="center">应答接收方语言</td>
<td align="right">详见LanguageCode</td>
</tr>
<tr>
<td>version</td>
<td align="center">short</td>
<td align="center">请求发起方版本</td>
<td align="center">应答接收方</td>
<td align="right">环境变量 rocketmq.remoting.version</td>
</tr>
<tr>
<td>opaque</td>
<td align="center">int</td>
<td align="center">请求发起方在同一连接不同的请求标识符,多线程连接时复用</td>
<td align="center">应答方不做处理直接返回</td>
<td align="right">RPC请求的序号</td>
</tr>
<tr>
<td>flag</td>
<td align="center">int</td>
<td align="center">通信层标志位</td>
<td align="center">通信层标志位</td>
<td align="right">区分是普通RPC还是onewayRPC得标志</td>
</tr>
<tr>
<td>remark</td>
<td align="center">String</td>
<td align="center">传输自定义文本</td>
<td align="center">错误详细描述信息</td>
<td align="right"></td>
</tr>
<tr>
<td>extFields</td>
<td align="center">HashMap&lt;String, String&gt;</td>
<td align="center">请求自定义字段</td>
<td align="center">应答自定义字段</td>
<td align="right">customHeader的每个字段</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RPC_TYPE = <span class="number">0</span>; <span class="comment">// 0, REQUEST_COMMAND rpc类型的标注，一种是普通的RPC请求</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RPC_ONEWAY = <span class="number">1</span>; <span class="comment">// 0, 这种ONEWAY 是指单向RPC,比如心跳包</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;? extends CommandCustomHeader&gt;, Field[]&gt; clazzFieldsCache =</span><br><span class="line">        <span class="keyword">new</span> HashMap&lt;Class&lt;? extends CommandCustomHeader&gt;, Field[]&gt;();<span class="comment">//**CommandCustomHader**是所有headerData都要实现的接口，后面的Field[]就是解析header所对应的成员属性，所以这个map就是解析时候的字段缓存，下面两个map也是分别对应类名缓存和注解缓存。</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class, String&gt; canonicalNameCache = <span class="keyword">new</span> HashMap&lt;Class, String&gt;();</span><br><span class="line"> <span class="comment">// 1, RESPONSE_COMMAND</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Field, Annotation&gt; notNullAnnotationCache = <span class="keyword">new</span> HashMap&lt;Field, Annotation&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger requestId = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);<span class="comment">//这里的requestId是RPC请求的序号，每次请求的时候都会increment一下，同时后面会讲到的responseTable会用这个requestId作为key。   </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> code;<span class="comment">//这里的code是用来区分request类型的</span></span><br><span class="line"><span class="keyword">private</span> LanguageCode language = LanguageCode.JAVA;<span class="comment">//区分语言种类</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> version = <span class="number">0</span>;<span class="comment">//RPC版本号</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> opaque = requestId.getAndIncrement();<span class="comment">//这里的opaque就是requestId</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> flag = <span class="number">0</span>;<span class="comment">//区分是普通RPC还是onewayRPC得标志</span></span><br><span class="line"><span class="keyword">private</span> String remark;<span class="comment">//标注信息</span></span><br><span class="line"><span class="keyword">private</span> HashMap&lt;String, String&gt; extFields;<span class="comment">//存放本次RPC通信中所有的extFeilds，extFeilds其实就可以理解成本次通信的包头数据</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> CommandCustomHeader customHeader; <span class="comment">//包头数据，注意transient标记，不会被序列化</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">byte</span>[] body; <span class="comment">//body数据，注意transient标记，不会被序列化</span></span><br></pre></td></tr></table></figure>


 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">byte</span>[] headerEncode() &#123;</span><br><span class="line">        <span class="keyword">this</span>.makeCustomHeaderToNet();</span><br><span class="line"><span class="comment">//基于rocketmq还是基于JSON的序列化方式</span></span><br><span class="line">        <span class="keyword">if</span> (SerializeType.ROCKETMQ == serializeTypeCurrentRPC) &#123;</span><br><span class="line">            <span class="keyword">return</span> RocketMQSerializable.rocketMQProtocolEncode(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> RemotingSerializable.encode(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeCustomHeaderToNet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.customHeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Field[] fields = getClazzFields(customHeader.getClass());</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">this</span>.extFields) &#123;</span><br><span class="line">                <span class="keyword">this</span>.extFields = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    String name = field.getName();</span><br><span class="line">                    <span class="keyword">if</span> (!name.startsWith(<span class="string">&quot;this&quot;</span>)) &#123;</span><br><span class="line">                        Object value = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                            value = field.get(<span class="keyword">this</span>.customHeader);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            log.error(<span class="string">&quot;Failed to access field [&#123;&#125;]&quot;</span>, name, e);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.extFields.put(name, value.toString());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/7789698/32938009-b6449d98-cbb5-11e7-848a-cebb2631fc97.png" alt="ba3e2d6c-d79a-4148-9c88-facba76ff0e1"></p>
<h3 id="RocketMQ序列化"><a href="#RocketMQ序列化" class="headerlink" title="RocketMQ序列化"></a>RocketMQ序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] rocketMQProtocolEncode(RemotingCommand cmd) &#123;</span><br><span class="line">        <span class="comment">// String remark</span></span><br><span class="line">        <span class="keyword">byte</span>[] remarkBytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> remarkLen = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (cmd.getRemark() != <span class="keyword">null</span> &amp;&amp; cmd.getRemark().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            remarkBytes = cmd.getRemark().getBytes(CHARSET_UTF8);</span><br><span class="line">            remarkLen = remarkBytes.length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// HashMap&lt;String, String&gt; extFields</span></span><br><span class="line">        <span class="keyword">byte</span>[] extFieldsBytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> extLen = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (cmd.getExtFields() != <span class="keyword">null</span> &amp;&amp; !cmd.getExtFields().isEmpty()) &#123;</span><br><span class="line">            extFieldsBytes = mapSerialize(cmd.getExtFields());</span><br><span class="line">            extLen = extFieldsBytes.length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> totalLen = calTotalLen(remarkLen, extLen);</span><br><span class="line"></span><br><span class="line">        ByteBuffer headerBuffer = ByteBuffer.allocate(totalLen);</span><br><span class="line">        <span class="comment">// int code(~32767)</span></span><br><span class="line">        headerBuffer.putShort((<span class="keyword">short</span>) cmd.getCode());</span><br><span class="line">        <span class="comment">// LanguageCode language</span></span><br><span class="line">        headerBuffer.put(cmd.getLanguage().getCode());</span><br><span class="line">        <span class="comment">// int version(~32767)</span></span><br><span class="line">        headerBuffer.putShort((<span class="keyword">short</span>) cmd.getVersion());</span><br><span class="line">        <span class="comment">// int opaque</span></span><br><span class="line">        headerBuffer.putInt(cmd.getOpaque());</span><br><span class="line">        <span class="comment">// int flag</span></span><br><span class="line">        headerBuffer.putInt(cmd.getFlag());</span><br><span class="line">        <span class="comment">// String remark</span></span><br><span class="line">        <span class="keyword">if</span> (remarkBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            headerBuffer.putInt(remarkBytes.length);</span><br><span class="line">            headerBuffer.put(remarkBytes);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            headerBuffer.putInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// HashMap&lt;String, String&gt; extFields;</span></span><br><span class="line">        <span class="keyword">if</span> (extFieldsBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            headerBuffer.putInt(extFieldsBytes.length);</span><br><span class="line">            headerBuffer.put(extFieldsBytes);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            headerBuffer.putInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> headerBuffer.array();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="JSON序列化"><a href="#JSON序列化" class="headerlink" title="JSON序列化"></a>JSON序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encode(<span class="keyword">final</span> Object obj) &#123;</span><br><span class="line">    <span class="keyword">final</span> String json = toJson(obj, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> json.getBytes(CHARSET_UTF8);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OnewayRPC"><a href="#OnewayRPC" class="headerlink" title="OnewayRPC"></a>OnewayRPC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markOnewayRPC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> bits = <span class="number">1</span> &lt;&lt; RPC_ONEWAY;</span><br><span class="line">    <span class="keyword">this</span>.flag |= bits;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JSONField(serialize = false)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOnewayRPC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> bits = <span class="number">1</span> &lt;&lt; RPC_ONEWAY;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.flag &amp; bits) == bits;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JSONField(serialize = false)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isResponseType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> bits = <span class="number">1</span> &lt;&lt; RPC_TYPE;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.flag &amp; bits) == bits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">RemotingCommand</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        processMessageReceived(ctx, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processMessageReceived</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> RemotingCommand cmd = msg;</span><br><span class="line">    <span class="keyword">if</span> (cmd != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (cmd.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> REQUEST_COMMAND:</span><br><span class="line">                processRequestCommand(ctx, cmd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RESPONSE_COMMAND:</span><br><span class="line">                processResponseCommand(ctx, cmd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="processRequestCommand"><a href="#processRequestCommand" class="headerlink" title="processRequestCommand"></a>processRequestCommand</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequestCommand</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> RemotingCommand cmd)</span> </span>&#123;</span><br><span class="line"><span class="comment">//缓存着每个请求的code对应的处理器</span></span><br><span class="line"><span class="comment">//MQClientAPIImpl构造器里面初始化了</span></span><br><span class="line"><span class="comment">//CHECK_TRANSACTION_STATE(39)、NOTIFY_CONSUMER_IDS_CHANGED(40)、RESET_CONSUMER_CLIENT_OFFSET(220)、GET_CONSUMER_STATUS_FROM_CLIENT(221)、GET_CONSUMER_RUNNING_INFO(307)、CONSUME_MESSAGE_DIRECTLY（309）</span></span><br><span class="line">        <span class="keyword">final</span> Pair&lt;NettyRequestProcessor, ExecutorService&gt; matched = <span class="keyword">this</span>.processorTable.get(cmd.getCode());</span><br><span class="line">        <span class="keyword">final</span> Pair&lt;NettyRequestProcessor, ExecutorService&gt; pair = <span class="keyword">null</span> == matched ? <span class="keyword">this</span>.defaultRequestProcessor : matched;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> opaque = cmd.getOpaque();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pair != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Runnable run = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        RPCHook rpcHook = NettyRemotingAbstract.<span class="keyword">this</span>.getRPCHook();</span><br><span class="line">                        <span class="keyword">if</span> (rpcHook != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            rpcHook.doBeforeRequest(RemotingHelper.parseChannelRemoteAddr(ctx.channel()), cmd);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">final</span> RemotingCommand response = pair.getObject1().processRequest(ctx, cmd);</span><br><span class="line">                        <span class="keyword">if</span> (rpcHook != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            rpcHook.doAfterResponse(RemotingHelper.parseChannelRemoteAddr(ctx.channel()), cmd, response);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                response.setOpaque(opaque);</span><br><span class="line">                                response.markResponseType();</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    ctx.writeAndFlush(response);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                                    log.error(<span class="string">&quot;process request over, but response failed&quot;</span>, e);</span><br><span class="line">                                    log.error(cmd.toString());</span><br><span class="line">                                    log.error(response.toString());</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;process request exception&quot;</span>, e);</span><br><span class="line">                        log.error(cmd.toString());</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                            <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_ERROR,</span><br><span class="line">                                RemotingHelper.exceptionSimpleDesc(e));</span><br><span class="line">                            response.setOpaque(opaque);</span><br><span class="line">                            ctx.writeAndFlush(response);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pair.getObject1().rejectRequest()) &#123;</span><br><span class="line">                <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_BUSY,</span><br><span class="line">                    <span class="string">&quot;[REJECTREQUEST]system busy, start flow control for a while&quot;</span>);</span><br><span class="line">                response.setOpaque(opaque);</span><br><span class="line">                ctx.writeAndFlush(response);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> RequestTask requestTask = <span class="keyword">new</span> RequestTask(run, ctx.channel(), cmd);</span><br><span class="line">                pair.getObject2().submit(requestTask);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((System.currentTimeMillis() % <span class="number">10000</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    log.warn(RemotingHelper.parseChannelRemoteAddr(ctx.channel())</span><br><span class="line">                        + <span class="string">&quot;, too many requests and system thread pool busy, RejectedExecutionException &quot;</span></span><br><span class="line">                        + pair.getObject2().toString()</span><br><span class="line">                        + <span class="string">&quot; request code: &quot;</span> + cmd.getCode());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_BUSY,</span><br><span class="line">                        <span class="string">&quot;[OVERLOAD]system busy, start flow control for a while&quot;</span>);</span><br><span class="line">                    response.setOpaque(opaque);</span><br><span class="line">                    ctx.writeAndFlush(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String error = <span class="string">&quot; request type &quot;</span> + cmd.getCode() + <span class="string">&quot; not supported&quot;</span>;</span><br><span class="line">            <span class="keyword">final</span> RemotingCommand response =</span><br><span class="line">                RemotingCommand.createResponseCommand(RemotingSysResponseCode.REQUEST_CODE_NOT_SUPPORTED, error);</span><br><span class="line">            response.setOpaque(opaque);</span><br><span class="line">            ctx.writeAndFlush(response);</span><br><span class="line">            log.error(RemotingHelper.parseChannelRemoteAddr(ctx.channel()) + error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="processRequestCommand-1"><a href="#processRequestCommand-1" class="headerlink" title="processRequestCommand"></a>processRequestCommand</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResponseCommand</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> opaque = cmd.getOpaque();</span><br><span class="line">       <span class="comment">//获取请求对应的responseFuture</span></span><br><span class="line">        <span class="keyword">final</span> ResponseFuture responseFuture = responseTable.get(opaque);</span><br><span class="line">        <span class="keyword">if</span> (responseFuture != <span class="keyword">null</span>) &#123;</span><br><span class="line">            responseFuture.setResponseCommand(cmd);</span><br><span class="line"></span><br><span class="line">            responseFuture.release();</span><br><span class="line"></span><br><span class="line">            responseTable.remove(opaque);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (responseFuture.getInvokeCallback() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                executeInvokeCallback(responseFuture);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                responseFuture.putResponse(cmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;receive response, but not matched any request, &quot;</span> + RemotingHelper.parseChannelRemoteAddr(ctx.channel()));</span><br><span class="line">            log.warn(cmd.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/7789698/33025070-d7112ef8-ce47-11e7-913f-4893bde369be.jpg" alt="sequencediagram1"></p>
<p>部分重点代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> SendResult <span class="title">sendKernelImpl</span><span class="params">(<span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> MessageQueue mq,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> CommunicationMode communicationMode,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> SendCallback sendCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> TopicPublishInfo topicPublishInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> <span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">        String brokerAddr = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == brokerAddr) &#123;</span><br><span class="line">            tryToFindTopicPublishInfo(mq.getTopic());</span><br><span class="line">            brokerAddr = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SendMessageContext context = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (brokerAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            brokerAddr = MixAll.brokerVIPChannel(<span class="keyword">this</span>.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] prevBody = msg.getBody();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//for MessageBatch,ID has been set in the generating process</span></span><br><span class="line">                <span class="keyword">if</span> (!(msg <span class="keyword">instanceof</span> MessageBatch)) &#123;</span><br><span class="line">                    MessageClientIDSetter.setUniqID(msg);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> sysFlag = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.tryToCompressMessage(msg)) &#123;</span><br><span class="line">                    sysFlag |= MessageSysFlag.COMPRESSED_FLAG;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">                <span class="keyword">if</span> (tranMsg != <span class="keyword">null</span> &amp;&amp; Boolean.parseBoolean(tranMsg)) &#123;</span><br><span class="line">                    sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (hasCheckForbiddenHook()) &#123;</span><br><span class="line">                    CheckForbiddenContext checkForbiddenContext = <span class="keyword">new</span> CheckForbiddenContext();</span><br><span class="line">                    checkForbiddenContext.setNameSrvAddr(<span class="keyword">this</span>.defaultMQProducer.getNamesrvAddr());</span><br><span class="line">                    checkForbiddenContext.setGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</span><br><span class="line">                    checkForbiddenContext.setCommunicationMode(communicationMode);</span><br><span class="line">                    checkForbiddenContext.setBrokerAddr(brokerAddr);</span><br><span class="line">                    checkForbiddenContext.setMessage(msg);</span><br><span class="line">                    checkForbiddenContext.setMq(mq);</span><br><span class="line">                    checkForbiddenContext.setUnitMode(<span class="keyword">this</span>.isUnitMode());</span><br><span class="line">                    <span class="keyword">this</span>.executeCheckForbiddenHook(checkForbiddenContext);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) &#123;</span><br><span class="line">                    context = <span class="keyword">new</span> SendMessageContext();</span><br><span class="line">                    context.setProducer(<span class="keyword">this</span>);</span><br><span class="line">                    context.setProducerGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</span><br><span class="line">                    context.setCommunicationMode(communicationMode);</span><br><span class="line">                    context.setBornHost(<span class="keyword">this</span>.defaultMQProducer.getClientIP());</span><br><span class="line">                    context.setBrokerAddr(brokerAddr);</span><br><span class="line">                    context.setMessage(msg);</span><br><span class="line">                    context.setMq(mq);</span><br><span class="line">                    String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">                    <span class="keyword">if</span> (isTrans != <span class="keyword">null</span> &amp;&amp; isTrans.equals(<span class="string">&quot;true&quot;</span>)) &#123;</span><br><span class="line">                        context.setMsgType(MessageType.Trans_Msg_Half);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (msg.getProperty(<span class="string">&quot;__STARTDELIVERTIME&quot;</span>) != <span class="keyword">null</span> || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        context.setMsgType(MessageType.Delay_Msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">this</span>.executeSendMessageHookBefore(context);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">//构成cmd里面的customHeader</span></span><br><span class="line">                SendMessageRequestHeader requestHeader = <span class="keyword">new</span> SendMessageRequestHeader();</span><br><span class="line">              <span class="comment">//ProducerGroup</span></span><br><span class="line">                requestHeader.setProducerGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</span><br><span class="line">              <span class="comment">//Topic</span></span><br><span class="line">                requestHeader.setTopic(msg.getTopic());</span><br><span class="line">              <span class="comment">//DefaultTopic</span></span><br><span class="line">                requestHeader.setDefaultTopic(<span class="keyword">this</span>.defaultMQProducer.getCreateTopicKey());</span><br><span class="line">  <span class="comment">//DefaultTopicQueueNums在发送消息时，自动创建服务器不存在的topic，默认创建的队列数（默认4）</span></span><br><span class="line">requestHeader.setDefaultTopicQueueNums(<span class="keyword">this</span>.defaultMQProducer.getDefaultTopicQueueNums());</span><br><span class="line">              <span class="comment">//QueueId</span></span><br><span class="line">                requestHeader.setQueueId(mq.getQueueId());</span><br><span class="line">              <span class="comment">//参见MessageSysFlag 跟事务消息有关</span></span><br><span class="line">                requestHeader.setSysFlag(sysFlag);</span><br><span class="line">             <span class="comment">//</span></span><br><span class="line">                requestHeader.setBornTimestamp(System.currentTimeMillis());</span><br><span class="line">               </span><br><span class="line">                requestHeader.setFlag(msg.getFlag());</span><br><span class="line">                requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line">             <span class="comment">//reconsumeTimes代表消息重试次数</span></span><br><span class="line">                requestHeader.setReconsumeTimes(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                requestHeader.setUnitMode(<span class="keyword">this</span>.isUnitMode());</span><br><span class="line">              <span class="comment">//如果是批处理消息，放入状态</span></span><br><span class="line">                requestHeader.setBatch(msg <span class="keyword">instanceof</span> MessageBatch);</span><br><span class="line">                <span class="keyword">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                    String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);</span><br><span class="line">                    <span class="keyword">if</span> (reconsumeTimes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));</span><br><span class="line">                        MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);</span><br><span class="line">                    <span class="keyword">if</span> (maxReconsumeTimes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));</span><br><span class="line">                        MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                SendResult sendResult = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">                    <span class="keyword">case</span> ASYNC:</span><br><span class="line">                        sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">                            brokerAddr,</span><br><span class="line">                            mq.getBrokerName(),</span><br><span class="line">                            msg,</span><br><span class="line">                            requestHeader,</span><br><span class="line">                            timeout,</span><br><span class="line">                            communicationMode,</span><br><span class="line">                            sendCallback,</span><br><span class="line">                            topicPublishInfo,</span><br><span class="line">                            <span class="keyword">this</span>.mQClientFactory,</span><br><span class="line">                            <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(),</span><br><span class="line">                            context,</span><br><span class="line">                            <span class="keyword">this</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> ONEWAY:</span><br><span class="line">                    <span class="keyword">case</span> SYNC:</span><br><span class="line">                        sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">                            brokerAddr,</span><br><span class="line">                            mq.getBrokerName(),</span><br><span class="line">                            msg,</span><br><span class="line">                            requestHeader,</span><br><span class="line">                            timeout,</span><br><span class="line">                            communicationMode,</span><br><span class="line">                            context,</span><br><span class="line">                            <span class="keyword">this</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) &#123;</span><br><span class="line">                    context.setSendResult(sendResult);</span><br><span class="line">                    <span class="keyword">this</span>.executeSendMessageHookAfter(context);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> sendResult;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) &#123;</span><br><span class="line">                    context.setException(e);</span><br><span class="line">                    <span class="keyword">this</span>.executeSendMessageHookAfter(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MQBrokerException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) &#123;</span><br><span class="line">                    context.setException(e);</span><br><span class="line">                    <span class="keyword">this</span>.executeSendMessageHookAfter(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) &#123;</span><br><span class="line">                    context.setException(e);</span><br><span class="line">                    <span class="keyword">this</span>.executeSendMessageHookAfter(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                msg.setBody(prevBody);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;The broker[&quot;</span> + mq.getBrokerName() + <span class="string">&quot;] not exist&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//12</span></span><br><span class="line">request = RemotingCommand.createRequestCommand(RequestCode.SEND_MESSAGE, requestHeader);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemotingCommand <span class="title">createRequestCommand</span><span class="params">(<span class="keyword">int</span> code, CommandCustomHeader customHeader)</span> </span>&#123;</span><br><span class="line">        RemotingCommand cmd = <span class="keyword">new</span> RemotingCommand();</span><br><span class="line">        cmd.setCode(code);</span><br><span class="line">        cmd.customHeader = customHeader;</span><br><span class="line">        setCmdVersion(cmd);</span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>发送端做了什么：<br><img src="https://user-images.githubusercontent.com/7789698/33022975-bcdea14c-ce41-11e7-83ec-895d892a8ce1.png" alt="invokesync-client png"></p>
<ul>
<li>构建ResponseFuture,设置opaque值，把ResponseFuture以opaque为键放入Map中保存</li>
<li>netty发送请送请求</li>
<li>发送成功设置ResponseFuture发送状态为成功；发送失败设置ResponseFuture发送失败，并且从Map存中移除ResponseFuture</li>
<li>responseFuture.waitResponse(timeoutMillis)获取响应(如果超时则抛出异常)</li>
<li>收到服务端的回应以后，从Map中根据opaque拿出responseFuture，将回应写入其中，并从Map中移除</li>
<li>resposneFuture得到回应，并将返回给客户端</li>
</ul>
<p>接收端做了什么：</p>
<ul>
<li>netty监听得到发送过来的消息，分拣给Server端进行处理</li>
<li>根据消息的code得到对应的处理器(Processor)</li>
<li>创建一个新的线程，在这个线程中让处理器去处理消息，并得到回应(Response)。判断如果消息不是单向的(one-way)，则把请求中的opaque放回response中，并把消息发回给请求端。</li>
<li>将线程放入线程池–这里注意 请求消息的code对应了一组(Processor，ExectorService)，处理器和线程池是对应的</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/7789698/33023053-fd89c410-ce41-11e7-9d66-b82a536b1d89.png" alt="invokesync2"></p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">invokeSync</span><span class="params">(String addr, <span class="keyword">final</span> RemotingCommand request, <span class="keyword">long</span> timeoutMillis)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException </span>&#123;</span><br><span class="line"><span class="comment">//根据地址获取channel</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = <span class="keyword">this</span>.getAndCreateChannel(addr);</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span> &amp;&amp; channel.isActive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.rpcHook != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.rpcHook.doBeforeRequest(addr, request);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">                RemotingCommand response = <span class="keyword">this</span>.invokeSyncImpl(channel, request, timeoutMillis);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.rpcHook != <span class="keyword">null</span>) &#123;<span class="keyword">this</span>.rpcHook.doAfterResponse(RemotingHelper.parseChannelRemoteAddr(channel), request, response);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingSendRequestException e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;invokeSync: send request exception, so close the channel[&#123;&#125;]&quot;</span>, addr);</span><br><span class="line">                <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingTimeoutException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nettyClientConfig.isClientCloseSocketIfTimeout()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">                    log.warn(<span class="string">&quot;invokeSync: close socket because of timeout, &#123;&#125;ms, &#123;&#125;&quot;</span>, timeoutMillis, addr);</span><br><span class="line">                &#125;</span><br><span class="line">                log.warn(<span class="string">&quot;invokeSync: wait response timeout exception, the channel[&#123;&#125;]&quot;</span>, addr);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemotingConnectException(addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">invokeSyncImpl</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> RemotingCommand request,</span></span></span><br><span class="line"><span class="params"><span class="function">       <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> InterruptedException, RemotingSendRequestException, RemotingTimeoutException </span>&#123;</span><br><span class="line">         <span class="comment">//获取请求的序号</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> opaque = request.getOpaque();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> ResponseFuture responseFuture = <span class="keyword">new</span> ResponseFuture(opaque, timeoutMillis, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">         <span class="comment">//根据opaque序号存入responseFuture</span></span><br><span class="line">          <span class="keyword">this</span>.responseTable.put(opaque, responseFuture);</span><br><span class="line">         <span class="comment">//获取addr</span></span><br><span class="line">           <span class="keyword">final</span> SocketAddress addr = channel.remoteAddress();</span><br><span class="line">         <span class="comment">//调用netty的channel发送请求，监听返回回写response结果到responseFuture</span></span><br><span class="line">           channel.writeAndFlush(request).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture f)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                   <span class="keyword">if</span> (f.isSuccess()) &#123;</span><br><span class="line">                       responseFuture.setSendRequestOK(<span class="keyword">true</span>);</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       responseFuture.setSendRequestOK(<span class="keyword">false</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">//移除相应opaque对应responseFuture</span></span><br><span class="line">                   responseTable.remove(opaque);</span><br><span class="line">                   responseFuture.setCause(f.cause());</span><br><span class="line">                   responseFuture.putResponse(<span class="keyword">null</span>);</span><br><span class="line">                   log.warn(<span class="string">&quot;send a request command to channel &lt;&quot;</span> + addr + <span class="string">&quot;&gt; failed.&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">            <span class="comment">//等待putResponse 返回结果 this.countDownLatch.await(timeoutMillis, TimeUnit.MILLISECONDS); </span></span><br><span class="line">           RemotingCommand responseCommand = responseFuture.waitResponse(timeoutMillis);</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> == responseCommand) &#123;</span><br><span class="line">               <span class="keyword">if</span> (responseFuture.isSendRequestOK()) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTimeoutException(RemotingHelper.parseSocketAddressAddr(addr), timeoutMillis,</span><br><span class="line">                       responseFuture.getCause());</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RemotingSendRequestException(RemotingHelper.parseSocketAddressAddr(addr), responseFuture.getCause());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> responseCommand;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.responseTable.remove(opaque);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


<p>SendResult [sendStatus=SEND_OK, msgId=AC1107140D7C3764951D701DA4250000, offsetMsgId=AC1128E100002A9F0000000000579CFC, messageQueue=MessageQueue [topic=TopicTest, brokerName=kickseed, queueId=0], queueOffset=7595]</p>
<img width="1279" alt="wx20171122-231321 2x" src="https://user-images.githubusercontent.com/7789698/33134496-d6f9a352-cfda-11e7-9250-2e87e9b32275.png">

<img width="1246" alt="wx20171122-231450 2x" src="https://user-images.githubusercontent.com/7789698/33134824-b2d92ed8-cfdb-11e7-9e4b-dc92a98af1a8.png">

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/e3943dbd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/e3943dbd.html" class="post-title-link" itemprop="url">Tomcat 源码解析（五）--处理线程的产生和处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-12 22:43:23" itemprop="dateCreated datePublished" datetime="2018-03-12T22:43:23+08:00">2018-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Catalina</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">digester.addRule(&quot;Server/Service/Connector&quot;,</span><br><span class="line">                  new ConnectorCreateRule());</span><br><span class="line"> digester.addRule(&quot;Server/Service/Connector&quot;,</span><br><span class="line">                  new SetAllPropertiesRule(new String[]&#123;&quot;executor&quot;, &quot;sslImplementationName&quot;&#125;));</span><br><span class="line"> digester.addSetNext(&quot;Server/Service/Connector&quot;,</span><br><span class="line">                     &quot;addConnector&quot;,</span><br><span class="line">                     &quot;org.apache.catalina.connector.Connector&quot;);</span><br></pre></td></tr></table></figure>

<p>ConnectorCreateRule</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void begin(String namespace, String name, Attributes attributes)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        Service svc = (Service)digester.peek();</span><br><span class="line">        Executor ex = null;</span><br><span class="line">        if ( attributes.getValue(&quot;executor&quot;)!=null ) &#123;</span><br><span class="line">            ex = svc.getExecutor(attributes.getValue(&quot;executor&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">//根据protocol</span><br><span class="line">        Connector con = new Connector(attributes.getValue(&quot;protocol&quot;));</span><br><span class="line">        if (ex != null) &#123;</span><br><span class="line">            setExecutor(con, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        String sslImplementationName = attributes.getValue(&quot;sslImplementationName&quot;);</span><br><span class="line">        if (sslImplementationName != null) &#123;</span><br><span class="line">            setSSLImplementationName(con, sslImplementationName);</span><br><span class="line">        &#125;</span><br><span class="line">        digester.push(con);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Connector</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">    public Connector(String protocol) &#123;</span><br><span class="line">        setProtocol(protocol);</span><br><span class="line">        // Instantiate protocol handler</span><br><span class="line">        ProtocolHandler p = null;</span><br><span class="line">        try &#123;</span><br><span class="line">//加载ProtocolHandlerClassName </span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</span><br><span class="line">            p = (ProtocolHandler) clazz.getConstructor().newInstance();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(</span><br><span class="line">                    &quot;coyoteConnector.protocolHandlerInstantiationFailed&quot;), e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            this.protocolHandler = p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (Globals.STRICT_SERVLET_COMPLIANCE) &#123;</span><br><span class="line">            uriCharset = StandardCharsets.ISO_8859_1;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            uriCharset = StandardCharsets.UTF_8;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Deprecated</span><br><span class="line">    public void setProtocol(String protocol) &#123;</span><br><span class="line"></span><br><span class="line">        boolean aprConnector = AprLifecycleListener.isAprAvailable() &amp;&amp;</span><br><span class="line">                AprLifecycleListener.getUseAprConnector();</span><br><span class="line"></span><br><span class="line">//如果是Connector protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">        if (&quot;HTTP/1.1&quot;.equals(protocol) || protocol == null) &#123;</span><br><span class="line">            if (aprConnector) &#123;</span><br><span class="line">//设置ProtocolHandlerClassName</span><br><span class="line">                setProtocolHandlerClassName(&quot;org.apache.coyote.http11.Http11AprProtocol&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                setProtocolHandlerClassName(&quot;org.apache.coyote.http11.Http11NioProtocol&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (&quot;AJP/1.3&quot;.equals(protocol)) &#123;</span><br><span class="line">            if (aprConnector) &#123;</span><br><span class="line">                setProtocolHandlerClassName(&quot;org.apache.coyote.ajp.AjpAprProtocol&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                setProtocolHandlerClassName(&quot;org.apache.coyote.ajp.AjpNioProtocol&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            setProtocolHandlerClassName(protocol);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Http11AprProtocol</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public Http11AprProtocol() &#123;</span><br><span class="line">        super(new AprEndpoint());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AbstractHttp11Protocol(AbstractEndpoint&lt;S&gt; endpoint) &#123;</span><br><span class="line">        super(endpoint);</span><br><span class="line">        setConnectionTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);</span><br><span class="line">//初始化ConnectionHandler</span><br><span class="line">        ConnectionHandler&lt;S&gt; cHandler = new ConnectionHandler&lt;&gt;(this);</span><br><span class="line">        setHandler(cHandler);</span><br><span class="line">        getEndpoint().setHandler(cHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AbstractProtocol(AbstractEndpoint&lt;S&gt; endpoint) &#123;</span><br><span class="line">        this.endpoint = endpoint;</span><br><span class="line">        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);</span><br><span class="line">        setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public AprEndpoint() &#123;</span><br><span class="line">        // Need to override the default for maxConnections to align it with what</span><br><span class="line">        // was pollerSize (before the two were merged)</span><br><span class="line">        setMaxConnections(8 * 1024);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/7789698/37265784-af4e45f8-25f0-11e8-84bc-03971bf6d410.png" alt="image"></p>
<p>AbstractProtocol的start</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public void start() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">//AbstractEndpoint</span><br><span class="line">        endpoint.start();</span><br><span class="line"></span><br><span class="line">        // Start async timeout thread</span><br><span class="line">        asyncTimeout = new AsyncTimeout();</span><br><span class="line">//创建http-apr-8080-AsyncTimeout线程（守护进程）</span><br><span class="line">//作用：检测超时的请求，并将该请求再转发到工作线程池处理</span><br><span class="line">        Thread timeoutThread = new Thread(asyncTimeout, getNameInternal() + &quot;-AsyncTimeout&quot;);</span><br><span class="line">        int priority = endpoint.getThreadPriority();</span><br><span class="line">        if (priority &lt; Thread.MIN_PRIORITY || priority &gt; Thread.MAX_PRIORITY) &#123;</span><br><span class="line">            priority = Thread.NORM_PRIORITY;</span><br><span class="line">        &#125;</span><br><span class="line">        timeoutThread.setPriority(priority);</span><br><span class="line">        timeoutThread.setDaemon(true);</span><br><span class="line">//启动</span><br><span class="line">        timeoutThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>AprEndpoint（AbstractEndpoint）的start</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">    public final void start() throws Exception &#123;</span><br><span class="line">        if (bindState == BindState.UNBOUND) &#123;</span><br><span class="line">//bind</span><br><span class="line">            bind();</span><br><span class="line">            bindState = BindState.BOUND_ON_START;</span><br><span class="line">        &#125;</span><br><span class="line">        startInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> @Override</span><br><span class="line">    public void startInternal() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        if (!running) &#123;</span><br><span class="line">            running = true;</span><br><span class="line">            paused = false;</span><br><span class="line"></span><br><span class="line">            processorCache = new SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                    socketProperties.getProcessorCache());</span><br><span class="line"></span><br><span class="line">            // Create worker collection</span><br><span class="line">            if (getExecutor() == null) &#123;</span><br><span class="line">                createExecutor();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            initializeConnectionLatch();</span><br><span class="line"></span><br><span class="line">            // Start poller thread</span><br><span class="line">            poller = new Poller();</span><br><span class="line">            poller.init();</span><br><span class="line">            Thread pollerThread = new Thread(poller, getName() + &quot;-Poller&quot;);</span><br><span class="line">            pollerThread.setPriority(threadPriority);</span><br><span class="line">            pollerThread.setDaemon(true);</span><br><span class="line">            pollerThread.start();</span><br><span class="line"></span><br><span class="line">            // Start sendfile thread</span><br><span class="line">            if (getUseSendfile()) &#123;</span><br><span class="line">                sendfile = new Sendfile();</span><br><span class="line">                sendfile.init();</span><br><span class="line">                Thread sendfileThread =</span><br><span class="line">                        new Thread(sendfile, getName() + &quot;-Sendfile&quot;);</span><br><span class="line">                sendfileThread.setPriority(threadPriority);</span><br><span class="line">                sendfileThread.setDaemon(true);</span><br><span class="line">                sendfileThread.start();</span><br><span class="line">            &#125;</span><br><span class="line">//创建Acceptor线程</span><br><span class="line">            startAcceptorThreads();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void createExecutor() &#123;</span><br><span class="line">        internalExecutor = true;</span><br><span class="line">        TaskQueue taskqueue = new TaskQueue();</span><br><span class="line">//http-apr-8080-exec-</span><br><span class="line">        TaskThreadFactory tf = new TaskThreadFactory(getName() + &quot;-exec-&quot;, daemon, getThreadPriority());</span><br><span class="line">        executor = new ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), 60, TimeUnit.SECONDS,taskqueue, tf);</span><br><span class="line">        taskqueue.setParent( (ThreadPoolExecutor) executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    protected final void startAcceptorThreads() &#123;</span><br><span class="line">//accept队列的长度；当accept队列中连接的个数达到acceptCount时，队列满，进来的请求一律被拒绝。默认值是100。</span><br><span class="line">        int count = getAcceptorThreadCount();</span><br><span class="line">        acceptors = new Acceptor[count];</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">//new Acceptor()</span><br><span class="line">            acceptors[i] = createAcceptor();</span><br><span class="line">//http-apr-8080-Acceptor-0</span><br><span class="line">            String threadName = getName() + &quot;-Acceptor-&quot; + i;</span><br><span class="line">            acceptors[i].setThreadName(threadName);</span><br><span class="line">            Thread t = new Thread(acceptors[i], threadName);</span><br><span class="line">            t.setPriority(getAcceptorThreadPriority());</span><br><span class="line">            t.setDaemon(getDaemon());</span><br><span class="line">            t.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>到这里就启动了一个http-apr-8080-AsyncTimeout线程和多个http-apr-8080-Acceptor-线程</p>
<p>这里我们着重看下Acceptor线程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">protected class Acceptor extends AbstractEndpoint.Acceptor &#123;</span><br><span class="line"></span><br><span class="line">        private final Log log = LogFactory.getLog(AprEndpoint.Acceptor.class);</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line"></span><br><span class="line">            int errorDelay = 0;</span><br><span class="line"></span><br><span class="line">            // 除非收到shutdown命令否则一直循环</span><br><span class="line">            while (running) &#123;</span><br><span class="line"></span><br><span class="line">                // Loop if endpoint is paused</span><br><span class="line">                while (paused &amp;&amp; running) &#123;</span><br><span class="line">                    state = AcceptorState.PAUSED;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        Thread.sleep(50);</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        // Ignore</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (!running) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                state = AcceptorState.RUNNING;</span><br><span class="line"></span><br><span class="line">                try &#123;</span><br><span class="line">                    //if we have reached max connections, wait</span><br><span class="line">//使用了connectionLimitLatch限制最大连接数，到达上限就wait</span><br><span class="line">                    countUpOrAwaitConnection();</span><br><span class="line"></span><br><span class="line">                    long socket = 0;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        // Accept the next incoming connection from the server</span><br><span class="line">                        // socket 监听到客户端的连接</span><br><span class="line">                        socket = Socket.accept(serverSock);</span><br><span class="line"></span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        // We didn&#x27;t get a socket</span><br><span class="line">                        countDownConnection();</span><br><span class="line">                        if (running) &#123;</span><br><span class="line">                            // Introduce delay if necessary</span><br><span class="line">                            errorDelay = handleExceptionWithDelay(errorDelay);</span><br><span class="line">                            // re-throw</span><br><span class="line">                            throw e;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // Successful accept, reset the error delay</span><br><span class="line">                    errorDelay = 0;</span><br><span class="line"></span><br><span class="line">                    if (running &amp;&amp; !paused) &#123;</span><br><span class="line">                        // 把这个socket给一个合适的处理器处理</span><br><span class="line">                        if (!processSocketWithOptions(socket)) &#123;</span><br><span class="line">                            // Close socket right away</span><br><span class="line">                            closeSocket(socket);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // Close socket right away</span><br><span class="line">                        // No code path could have added the socket to the</span><br><span class="line">                        // Poller so use destroySocket()</span><br><span class="line">                        destroySocket(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    String msg = sm.getString(&quot;endpoint.accept.fail&quot;);</span><br><span class="line">                    if (t instanceof Error) &#123;</span><br><span class="line">                        Error e = (Error) t;</span><br><span class="line">                        if (e.getError() == 233) &#123;</span><br><span class="line">                            // Not an error on HP-UX so log as a warning</span><br><span class="line">                            // so it can be filtered out on that platform</span><br><span class="line">                            // See bug 50273</span><br><span class="line">                            log.warn(msg, t);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            log.error(msg, t);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                            log.error(msg, t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // The processor will recycle itself when it finishes</span><br><span class="line">            &#125;</span><br><span class="line">            state = AcceptorState.ENDED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected boolean processSocketWithOptions(long socket) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // During shutdown, executor may be null - avoid NPE</span><br><span class="line">            if (running) &#123;</span><br><span class="line">  //包装成AprSocketWrapper</span><br><span class="line">                AprSocketWrapper wrapper = new AprSocketWrapper(Long.valueOf(socket), this);</span><br><span class="line">                wrapper.setKeepAliveLeft(getMaxKeepAliveRequests());</span><br><span class="line">                wrapper.setSecure(isSSLEnabled());</span><br><span class="line">                wrapper.setReadTimeout(getConnectionTimeout());</span><br><span class="line">                wrapper.setWriteTimeout(getConnectionTimeout());</span><br><span class="line">                connections.put(Long.valueOf(socket), wrapper);</span><br><span class="line">//SocketWithOptionsProcessor丢到线程池执行</span><br><span class="line">                getExecutor().execute(new SocketWithOptionsProcessor(wrapper));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (RejectedExecutionException x) &#123;</span><br><span class="line">            log.warn(&quot;Socket processing request was rejected for:&quot;+socket,x);</span><br><span class="line">            return false;</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            // This means we got an OOM or similar creating a thread, or that</span><br><span class="line">            // the pool and its queue are full</span><br><span class="line">            log.error(sm.getString(&quot;endpoint.process.fail&quot;), t);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SocketWithOptionsProcessor</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">protected class SocketWithOptionsProcessor implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        protected SocketWrapperBase&lt;Long&gt; socket = null;</span><br><span class="line"></span><br><span class="line">        public SocketWithOptionsProcessor(SocketWrapperBase&lt;Long&gt; socket) &#123;</span><br><span class="line">            this.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line"></span><br><span class="line">            synchronized (socket) &#123;</span><br><span class="line">                if (!deferAccept) &#123;</span><br><span class="line">                    if (setSocketOptions(socket)) &#123;</span><br><span class="line">                        getPoller().add(socket.getSocket().longValue(),</span><br><span class="line">                                getConnectionTimeout(), Poll.APR_POLLIN);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // Close socket and pool</span><br><span class="line">                        closeSocket(socket.getSocket().longValue());</span><br><span class="line">                        socket = null;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Process the request from this socket</span><br><span class="line">                    if (!setSocketOptions(socket)) &#123;</span><br><span class="line">                        // Close socket and pool</span><br><span class="line">                        closeSocket(socket.getSocket().longValue());</span><br><span class="line">                        socket = null;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // Process the request from this socket</span><br><span class="line">//用Http11AprProtocol 处理</span><br><span class="line">                    Handler.SocketState state = getHandler().process(socket,</span><br><span class="line">                            SocketEvent.OPEN_READ);</span><br><span class="line">                    if (state == Handler.SocketState.CLOSED) &#123;</span><br><span class="line">                        // Close socket and pool</span><br><span class="line">                        closeSocket(socket.getSocket().longValue());</span><br><span class="line">                        socket = null;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">        public SocketState process(SocketWrapperBase&lt;S&gt; wrapper, SocketEvent status) &#123;</span><br><span class="line">            if (wrapper == null) &#123;</span><br><span class="line">                // Nothing to do. Socket has been closed.</span><br><span class="line">                return SocketState.CLOSED;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            S socket = wrapper.getSocket();</span><br><span class="line">//缓存一个map</span><br><span class="line">            Processor processor = connections.get(socket);</span><br><span class="line"></span><br><span class="line">            if (processor != null) &#123;</span><br><span class="line">                // Make sure an async timeout doesn&#x27;t fire</span><br><span class="line">                getProtocol().removeWaitingProcessor(processor);</span><br><span class="line">            &#125; else if (status == SocketEvent.DISCONNECT || status == SocketEvent.ERROR) &#123;</span><br><span class="line">                // Nothing to do. Endpoint requested a close and there is no</span><br><span class="line">                // longer a processor associated with this socket.</span><br><span class="line">                return SocketState.CLOSED;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ContainerThreadMarker.set();</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                if (processor == null) &#123;</span><br><span class="line">                    String negotiatedProtocol = wrapper.getNegotiatedProtocol();</span><br><span class="line">                    if (negotiatedProtocol != null) &#123;</span><br><span class="line">                        UpgradeProtocol upgradeProtocol =</span><br><span class="line">                                getProtocol().getNegotiatedProtocol(negotiatedProtocol);</span><br><span class="line">                        if (upgradeProtocol != null) &#123;</span><br><span class="line">                            processor = upgradeProtocol.getProcessor(</span><br><span class="line">                                    wrapper, getProtocol().getAdapter());</span><br><span class="line">                        &#125; else if (negotiatedProtocol.equals(&quot;http/1.1&quot;)) &#123;</span><br><span class="line">                            // Explicitly negotiated the default protocol.</span><br><span class="line">                            // Obtain a processor below.</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            // TODO:</span><br><span class="line">                            // OpenSSL 1.0.2&#x27;s ALPN callback doesn&#x27;t support</span><br><span class="line">                            // failing the handshake with an error if no</span><br><span class="line">                            // protocol can be negotiated. Therefore, we need to</span><br><span class="line">                            // fail the connection here. Once this is fixed,</span><br><span class="line">                            // replace the code below with the commented out</span><br><span class="line">                            // block.</span><br><span class="line">                            return SocketState.CLOSED;</span><br><span class="line">                            /*</span><br><span class="line">                             * To replace the code above once OpenSSL 1.1.0 is</span><br><span class="line">                             * used.</span><br><span class="line">                            // Failed to create processor. This is a bug.</span><br><span class="line">                            throw new IllegalStateException(sm.getString(</span><br><span class="line">                                    &quot;abstractConnectionHandler.negotiatedProcessor.fail&quot;,</span><br><span class="line">                                    negotiatedProtocol));</span><br><span class="line">                            */</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (processor == null) &#123;</span><br><span class="line">                    processor = recycledProcessors.pop();</span><br><span class="line">                &#125;</span><br><span class="line">                if (processor == null) &#123;</span><br><span class="line">//创建processor，这里不贴代码了。实际上就是Http11AprProtocol（AbstractHttp11Protocol）的createProcessor，最后构造的是Http11Processor类。</span><br><span class="line">                    processor = getProtocol().createProcessor();</span><br><span class="line">                    register(processor);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                processor.setSslSupport(</span><br><span class="line">                        wrapper.getSslSupport(getProtocol().getClientCertProvider()));</span><br><span class="line"></span><br><span class="line">                // Associate the processor with the connection</span><br><span class="line">                connections.put(socket, processor);</span><br><span class="line"></span><br><span class="line">                SocketState state = SocketState.CLOSED;</span><br><span class="line">                do &#123;</span><br><span class="line">//最关键的地方！ </span><br><span class="line">                    state = processor.process(wrapper, status);</span><br><span class="line"></span><br><span class="line">                    if (state == SocketState.UPGRADING) &#123;</span><br><span class="line">...</span><br><span class="line">                       //UPGRADING</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; while ( state == SocketState.UPGRADING);</span><br><span class="line"></span><br><span class="line">                if (state == SocketState.LONG) &#123;</span><br><span class="line">                    // In the middle of processing a request/response. Keep the</span><br><span class="line">                    // socket associated with the processor. Exact requirements</span><br><span class="line">                    // depend on type of long poll</span><br><span class="line">                    longPoll(wrapper, processor);</span><br><span class="line">                    if (processor.isAsync()) &#123;</span><br><span class="line">                        getProtocol().addWaitingProcessor(processor);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (state == SocketState.OPEN) &#123;</span><br><span class="line">                    // In keep-alive but between requests. OK to recycle</span><br><span class="line">                    // processor. Continue to poll for the next request.</span><br><span class="line">                    connections.remove(socket);</span><br><span class="line">                    release(processor);</span><br><span class="line">                    wrapper.registerReadInterest();</span><br><span class="line">                &#125; else if (state == SocketState.SENDFILE) &#123;</span><br><span class="line">                    // Sendfile in progress. If it fails, the socket will be</span><br><span class="line">                    // closed. If it works, the socket either be added to the</span><br><span class="line">                    // poller (or equivalent) to await more data or processed</span><br><span class="line">                    // if there are any pipe-lined requests remaining.</span><br><span class="line">                &#125; else if (state == SocketState.UPGRADED) &#123;</span><br><span class="line">                    // Don&#x27;t add sockets back to the poller if this was a</span><br><span class="line">                    // non-blocking write otherwise the poller may trigger</span><br><span class="line">                    // multiple read events which may lead to thread starvation</span><br><span class="line">                    // in the connector. The write() method will add this socket</span><br><span class="line">                    // to the poller if necessary.</span><br><span class="line">                    if (status != SocketEvent.OPEN_WRITE) &#123;</span><br><span class="line">                        longPoll(wrapper, processor);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (state == SocketState.SUSPENDED) &#123;</span><br><span class="line">                    // Don&#x27;t add sockets back to the poller.</span><br><span class="line">                    // The resumeProcessing() method will add this socket</span><br><span class="line">                    // to the poller.</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">...</span><br><span class="line">//Upgrade</span><br><span class="line">                &#125;</span><br><span class="line">                return state;</span><br><span class="line">            &#125;  finally &#123;</span><br><span class="line">                ContainerThreadMarker.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Make sure socket/processor is removed from the list of current</span><br><span class="line">            // connections</span><br><span class="line">            connections.remove(socket);</span><br><span class="line">            release(processor);</span><br><span class="line">            return SocketState.CLOSED;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/7789698/37266564-00072780-25f6-11e8-8295-a142cb4e9f5f.png" alt="image"></p>
<p>AbstractProcessorLight的process</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public SocketState process(SocketWrapperBase&lt;?&gt; socketWrapper, SocketEvent status)</span><br><span class="line">           throws IOException &#123;</span><br><span class="line"></span><br><span class="line">       SocketState state = SocketState.CLOSED;</span><br><span class="line">       Iterator&lt;DispatchType&gt; dispatches = null;</span><br><span class="line">       do &#123;</span><br><span class="line">           if (dispatches != null) &#123;</span><br><span class="line">               DispatchType nextDispatch = dispatches.next();</span><br><span class="line">               state = dispatch(nextDispatch.getSocketStatus());</span><br><span class="line">           &#125; else if (status == SocketEvent.DISCONNECT) &#123;</span><br><span class="line">               // Do nothing here, just wait for it to get recycled</span><br><span class="line">           &#125; else if (isAsync() || isUpgrade() || state == SocketState.ASYNC_END) &#123;</span><br><span class="line">               state = dispatch(status);</span><br><span class="line">               if (state == SocketState.OPEN) &#123;</span><br><span class="line">                   // There may be pipe-lined data to read. If the data isn&#x27;t</span><br><span class="line">                   // processed now, execution will exit this loop and call</span><br><span class="line">                   // release() which will recycle the processor (and input</span><br><span class="line">                   // buffer) deleting any pipe-lined data. To avoid this,</span><br><span class="line">                   // process it now.</span><br><span class="line">                   state = service(socketWrapper);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; else if (status == SocketEvent.OPEN_WRITE) &#123;</span><br><span class="line">               // Extra write event likely after async, ignore</span><br><span class="line">               state = SocketState.LONG;</span><br><span class="line">           &#125; else if (status == SocketEvent.OPEN_READ)&#123;</span><br><span class="line">               state = service(socketWrapper);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               // Default to closing the socket if the SocketEvent passed in</span><br><span class="line">               // is not consistent with the current state of the Processor</span><br><span class="line">               state = SocketState.CLOSED;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (state != SocketState.CLOSED &amp;&amp; isAsync()) &#123;</span><br><span class="line">               state = asyncPostProcess();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           if (dispatches == null || !dispatches.hasNext()) &#123;</span><br><span class="line">               // Only returns non-null iterator if there are</span><br><span class="line">               // dispatches to process.</span><br><span class="line">               dispatches = getIteratorAndClearDispatches();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; while (state == SocketState.ASYNC_END ||</span><br><span class="line">               dispatches != null &amp;&amp; state != SocketState.CLOSED);</span><br><span class="line"></span><br><span class="line">       return state;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public SocketState service(SocketWrapperBase&lt;?&gt; socketWrapper)</span><br><span class="line">        throws IOException &#123;</span><br><span class="line">        RequestInfo rp = request.getRequestProcessor();</span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);</span><br><span class="line"></span><br><span class="line">        // Setting up the I/O</span><br><span class="line">        setSocketWrapper(socketWrapper);</span><br><span class="line">        inputBuffer.init(socketWrapper);</span><br><span class="line">        outputBuffer.init(socketWrapper);</span><br><span class="line"></span><br><span class="line">        // Flags</span><br><span class="line">        keepAlive = true;</span><br><span class="line">        openSocket = false;</span><br><span class="line">        readComplete = true;</span><br><span class="line">        boolean keptAlive = false;</span><br><span class="line">        SendfileState sendfileState = SendfileState.DONE;</span><br><span class="line"></span><br><span class="line">        while (!getErrorState().isError() &amp;&amp; keepAlive &amp;&amp; !isAsync() &amp;&amp; upgradeToken == null &amp;&amp;</span><br><span class="line">                sendfileState == SendfileState.DONE &amp;&amp; !endpoint.isPaused()) &#123;</span><br><span class="line"></span><br><span class="line">            // Parsing the request header</span><br><span class="line">            try &#123;</span><br><span class="line">//解析请求头，并装入inputBuffer里的私有字段org.apache.coyote.Request的属性里</span><br><span class="line">                if (!inputBuffer.parseRequestLine(keptAlive)) &#123;</span><br><span class="line">                    if (inputBuffer.getParsingRequestLinePhase() == -1) &#123;</span><br><span class="line">                        return SocketState.UPGRADING;</span><br><span class="line">                    &#125; else if (handleIncompleteRequestLineRead()) &#123;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (endpoint.isPaused()) &#123;</span><br><span class="line">                    // 503 - Service unavailable</span><br><span class="line">                    response.setStatus(503);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, null);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    keptAlive = true;</span><br><span class="line">                    // Set this every time in case limit has been changed via JMX</span><br><span class="line">                    request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</span><br><span class="line">                    if (!inputBuffer.parseHeaders()) &#123;</span><br><span class="line">                        // We&#x27;ve read part of the request, don&#x27;t recycle it</span><br><span class="line">                        // instead associate it with the socket</span><br><span class="line">                        openSocket = true;</span><br><span class="line">                        readComplete = false;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!disableUploadTimeout) &#123;</span><br><span class="line">                        socketWrapper.setReadTimeout(connectionUploadTimeout);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                if (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(&quot;http11processor.header.parse&quot;), e);</span><br><span class="line">                &#125;</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CONNECTION_NOW, e);</span><br><span class="line">                break;</span><br><span class="line">            &#125; catch (Throwable t) &#123;</span><br><span class="line">...           </span><br><span class="line">                // 400 - Bad Request</span><br><span class="line">                response.setStatus(400);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                getAdapter().log(request, response, 0);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Has an upgrade been requested?</span><br><span class="line">            Enumeration&lt;String&gt; connectionValues = request.getMimeHeaders().values(&quot;Connection&quot;);</span><br><span class="line">            boolean foundUpgrade = false;</span><br><span class="line">            while (connectionValues.hasMoreElements() &amp;&amp; !foundUpgrade) &#123;</span><br><span class="line">                foundUpgrade = connectionValues.nextElement().toLowerCase(</span><br><span class="line">                        Locale.ENGLISH).contains(&quot;upgrade&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (foundUpgrade) &#123;</span><br><span class="line">                // Check the protocol</span><br><span class="line">                String requestedProtocol = request.getHeader(&quot;Upgrade&quot;);</span><br><span class="line"></span><br><span class="line">                UpgradeProtocol upgradeProtocol = httpUpgradeProtocols.get(requestedProtocol);</span><br><span class="line">//转换传输协议</span><br><span class="line">                if (upgradeProtocol != null) &#123;</span><br><span class="line">                    if (upgradeProtocol.accept(request)) &#123;</span><br><span class="line">                        // TODO Figure out how to handle request bodies at this</span><br><span class="line">                        // point.</span><br><span class="line">                        response.setStatus(HttpServletResponse.SC_SWITCHING_PROTOCOLS);</span><br><span class="line">                        response.setHeader(&quot;Connection&quot;, &quot;Upgrade&quot;);</span><br><span class="line">                        response.setHeader(&quot;Upgrade&quot;, requestedProtocol);</span><br><span class="line">                        action(ActionCode.CLOSE,  null);</span><br><span class="line">                        getAdapter().log(request, response, 0);</span><br><span class="line"></span><br><span class="line">                        InternalHttpUpgradeHandler upgradeHandler =</span><br><span class="line">                                upgradeProtocol.getInternalUpgradeHandler(</span><br><span class="line">                                        getAdapter(), cloneRequest(request));</span><br><span class="line">                        UpgradeToken upgradeToken = new UpgradeToken(upgradeHandler, null, null);</span><br><span class="line">                        action(ActionCode.UPGRADE, upgradeToken);</span><br><span class="line">                        return SocketState.UPGRADING;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!getErrorState().isError()) &#123;</span><br><span class="line">                // Setting up filters, and parse some request headers</span><br><span class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);</span><br><span class="line">                try &#123;</span><br><span class="line">                    prepareRequest();</span><br><span class="line">                &#125; catch (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    if (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(sm.getString(&quot;http11processor.request.prepare&quot;), t);</span><br><span class="line">                    &#125;</span><br><span class="line">                    // 500 - Internal Server Error</span><br><span class="line">                    response.setStatus(500);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                    getAdapter().log(request, response, 0);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (maxKeepAliveRequests == 1) &#123;</span><br><span class="line">                keepAlive = false;</span><br><span class="line">            &#125; else if (maxKeepAliveRequests &gt; 0 &amp;&amp;</span><br><span class="line">                    socketWrapper.decrementKeepAlive() &lt;= 0) &#123;</span><br><span class="line">                keepAlive = false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Process the request in the adapter</span><br><span class="line">//用adapter处理请求</span><br><span class="line">            if (!getErrorState().isError()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE);</span><br><span class="line">                    getAdapter().service(request, response);</span><br><span class="line">                    // Handle when the response was committed before a serious</span><br><span class="line">                    // error occurred.  Throwing a ServletException should both</span><br><span class="line">                    // set the status to 500 and set the errorException.</span><br><span class="line">                    // If we fail here, then the response is likely already</span><br><span class="line">                    // committed, so we can&#x27;t try and set headers.</span><br><span class="line">                    if(keepAlive &amp;&amp; !getErrorState().isError() &amp;&amp; !isAsync() &amp;&amp;</span><br><span class="line">                            statusDropsConnection(response.getStatus())) &#123;</span><br><span class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, null);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (InterruptedIOException e) &#123;</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CONNECTION_NOW, e);</span><br><span class="line">                &#125; catch (HeadersTooLargeException e) &#123;</span><br><span class="line">                    log.error(sm.getString(&quot;http11processor.request.process&quot;), e);</span><br><span class="line">                    // The response should not have been committed but check it</span><br><span class="line">                    // anyway to be safe</span><br><span class="line">                    if (response.isCommitted()) &#123;</span><br><span class="line">                        setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        response.reset();</span><br><span class="line">                        response.setStatus(500);</span><br><span class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, e);</span><br><span class="line">                        response.setHeader(&quot;Connection&quot;, &quot;close&quot;); // TODO: Remove</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    log.error(sm.getString(&quot;http11processor.request.process&quot;), t);</span><br><span class="line">                    // 500 - Internal Server Error</span><br><span class="line">                    response.setStatus(500);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                    getAdapter().log(request, response, 0);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Finish the handling of the request</span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDINPUT);</span><br><span class="line">            if (!isAsync()) &#123;</span><br><span class="line">                // If this is an async request then the request ends when it has</span><br><span class="line">                // been completed. The AsyncContext is responsible for calling</span><br><span class="line">                // endRequest() in that case.</span><br><span class="line">                endRequest();</span><br><span class="line">            &#125;</span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDOUTPUT);</span><br><span class="line"></span><br><span class="line">            // If there was an error, make sure the request is counted as</span><br><span class="line">            // and error, and update the statistics counter</span><br><span class="line">            if (getErrorState().isError()) &#123;</span><br><span class="line">                response.setStatus(500);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!isAsync() || getErrorState().isError()) &#123;</span><br><span class="line">                request.updateCounters();</span><br><span class="line">                if (getErrorState().isIoAllowed()) &#123;</span><br><span class="line">                    inputBuffer.nextRequest();</span><br><span class="line">                    outputBuffer.nextRequest();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!disableUploadTimeout) &#123;</span><br><span class="line">                int soTimeout = endpoint.getConnectionTimeout();</span><br><span class="line">                if(soTimeout &gt; 0) &#123;</span><br><span class="line">                    socketWrapper.setReadTimeout(soTimeout);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    socketWrapper.setReadTimeout(0);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);</span><br><span class="line"></span><br><span class="line">            sendfileState = processSendfile(socketWrapper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);</span><br><span class="line"></span><br><span class="line">        if (getErrorState().isError() || endpoint.isPaused()) &#123;</span><br><span class="line">            return SocketState.CLOSED;</span><br><span class="line">        &#125; else if (isAsync()) &#123;</span><br><span class="line">            return SocketState.LONG;</span><br><span class="line">        &#125; else if (isUpgrade()) &#123;</span><br><span class="line">            return SocketState.UPGRADING;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (sendfileState == SendfileState.PENDING) &#123;</span><br><span class="line">                return SocketState.SENDFILE;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (openSocket) &#123;</span><br><span class="line">                    if (readComplete) &#123;</span><br><span class="line">                        return SocketState.OPEN;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return SocketState.LONG;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    return SocketState.CLOSED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>所以很重要的一句<code>getAdapter().service(request, response);</code>，而这里的adapter就是CoyoteAdapter</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void service(org.apache.coyote.Request req, org.apache.coyote.Response res)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">//org.apache.coyote.Request转化成org.apache.catalina.connector.Request </span><br><span class="line">        Request request = (Request) req.getNote(ADAPTER_NOTES);</span><br><span class="line">//类似</span><br><span class="line">        Response response = (Response) res.getNote(ADAPTER_NOTES);</span><br><span class="line"></span><br><span class="line">        if (request == null) &#123;</span><br><span class="line">            // Create objects</span><br><span class="line">            request = connector.createRequest();</span><br><span class="line">            request.setCoyoteRequest(req);</span><br><span class="line">            response = connector.createResponse();</span><br><span class="line">            response.setCoyoteResponse(res);</span><br><span class="line"></span><br><span class="line">            // Link objects</span><br><span class="line">            request.setResponse(response);</span><br><span class="line">            response.setRequest(request);</span><br><span class="line"></span><br><span class="line">            // Set as notes</span><br><span class="line">            req.setNote(ADAPTER_NOTES, request);</span><br><span class="line">            res.setNote(ADAPTER_NOTES, response);</span><br><span class="line"></span><br><span class="line">            // Set query string encoding</span><br><span class="line">            req.getParameters().setQueryStringCharset(connector.getURICharset());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (connector.getXpoweredBy()) &#123;</span><br><span class="line">            response.addHeader(&quot;X-Powered-By&quot;, POWERED_BY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boolean async = false;</span><br><span class="line">        boolean postParseSuccess = false;</span><br><span class="line"></span><br><span class="line">        req.getRequestProcessor().setWorkerThreadName(THREAD_NAME.get());</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Parse and set Catalina and configuration specific</span><br><span class="line">            // request parameters</span><br><span class="line">//很关键，请求转化为 Host、Context、Wrapper组件</span><br><span class="line">            postParseSuccess = postParseRequest(req, request, res, response);</span><br><span class="line">            if (postParseSuccess) &#123;</span><br><span class="line">                //check valves if we support async</span><br><span class="line">                request.setAsyncSupported(</span><br><span class="line">                        connector.getService().getContainer().getPipeline().isAsyncSupported());</span><br><span class="line">                // Calling the container</span><br><span class="line">//connector.getService()获取StandardService</span><br><span class="line">//getContainer()获取StandardEngine</span><br><span class="line">//getPipeline()获取StandardPipeline</span><br><span class="line">//getFirst() 获取第一个阀 Valve</span><br><span class="line">//这里的基础阀其实就是StandardContextValve，见下面</span><br><span class="line">                connector.getService().getContainer().getPipeline().getFirst().invoke(</span><br><span class="line">                        request, response);</span><br><span class="line">            &#125;</span><br><span class="line">            if (request.isAsync()) &#123;</span><br><span class="line">                async = true;</span><br><span class="line">                ReadListener readListener = req.getReadListener();</span><br><span class="line">                if (readListener != null &amp;&amp; request.isFinished()) &#123;</span><br><span class="line">                    // Possible the all data may have been read during service()</span><br><span class="line">                    // method so this needs to be checked here</span><br><span class="line">                    ClassLoader oldCL = null;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        oldCL = request.getContext().bind(false, null);</span><br><span class="line">                        if (req.sendAllDataReadEvent()) &#123;</span><br><span class="line">                            req.getReadListener().onAllDataRead();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; finally &#123;</span><br><span class="line">                        request.getContext().unbind(false, oldCL);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Throwable throwable =</span><br><span class="line">                        (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line"></span><br><span class="line">                // If an async request was started, is not going to end once</span><br><span class="line">                // this container thread finishes and an error occurred, trigger</span><br><span class="line">                // the async error process</span><br><span class="line">                if (!request.isAsyncCompleting() &amp;&amp; throwable != null) &#123;</span><br><span class="line">                    request.getAsyncContextInternal().setErrorState(throwable, true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                request.finishRequest();</span><br><span class="line">                response.finishResponse();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            // Ignore</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            AtomicBoolean error = new AtomicBoolean(false);</span><br><span class="line">            res.action(ActionCode.IS_ERROR, error);</span><br><span class="line"></span><br><span class="line">            if (request.isAsyncCompleting() &amp;&amp; error.get()) &#123;</span><br><span class="line">                // Connection will be forcibly closed which will prevent</span><br><span class="line">                // completion happening at the usual point. Need to trigger</span><br><span class="line">                // call to onComplete() here.</span><br><span class="line">                res.action(ActionCode.ASYNC_POST_PROCESS,  null);</span><br><span class="line">                async = false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Access log</span><br><span class="line">            if (!async &amp;&amp; postParseSuccess) &#123;</span><br><span class="line">                // Log only if processing was invoked.</span><br><span class="line">                // If postParseRequest() failed, it has already logged it.</span><br><span class="line">                Context context = request.getContext();</span><br><span class="line">                // If the context is null, it is likely that the endpoint was</span><br><span class="line">                // shutdown, this connection closed and the request recycled in</span><br><span class="line">                // a different thread. That thread will have updated the access</span><br><span class="line">                // log so it is OK not to update the access log here in that</span><br><span class="line">                // case.</span><br><span class="line">                if (context != null) &#123;</span><br><span class="line">                    context.logAccess(request, response,</span><br><span class="line">                            System.currentTimeMillis() - req.getStartTime(), false);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            req.getRequestProcessor().setWorkerThreadName(null);</span><br><span class="line"></span><br><span class="line">            // Recycle the wrapper request and response</span><br><span class="line">            if (!async) &#123;</span><br><span class="line">                request.recycle();</span><br><span class="line">                response.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>postParseRequest</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line">protected boolean postParseRequest(org.apache.coyote.Request req, Request request,</span><br><span class="line">            org.apache.coyote.Response res, Response response) throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        // If the processor has set the scheme (AJP does this, HTTP does this if</span><br><span class="line">        // SSL is enabled) use this to set the secure flag as well. If the</span><br><span class="line">        // processor hasn&#x27;t set it, use the settings from the connector</span><br><span class="line">        if (req.scheme().isNull()) &#123;</span><br><span class="line">            // Use connector scheme and secure configuration, (defaults to</span><br><span class="line">            // &quot;http&quot; and false respectively)</span><br><span class="line">            req.scheme().setString(connector.getScheme());</span><br><span class="line">            request.setSecure(connector.getSecure());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // Use processor specified scheme to determine secure state</span><br><span class="line">            request.setSecure(req.scheme().equals(&quot;https&quot;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // At this point the Host header has been processed.</span><br><span class="line">        // Override if the proxyPort/proxyHost are set</span><br><span class="line">        String proxyName = connector.getProxyName();</span><br><span class="line">        int proxyPort = connector.getProxyPort();</span><br><span class="line">        if (proxyPort != 0) &#123;</span><br><span class="line">            req.setServerPort(proxyPort);</span><br><span class="line">        &#125; else if (req.getServerPort() == -1) &#123;</span><br><span class="line">            // Not explicitly set. Use default ports based on the scheme</span><br><span class="line">            if (req.scheme().equals(&quot;https&quot;)) &#123;</span><br><span class="line">                req.setServerPort(443);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                req.setServerPort(80);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (proxyName != null) &#123;</span><br><span class="line">            req.serverName().setString(proxyName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">//uri</span><br><span class="line">        MessageBytes undecodedURI = req.requestURI();</span><br><span class="line"></span><br><span class="line">        // Check for ping OPTIONS * request</span><br><span class="line">        if (undecodedURI.equals(&quot;*&quot;)) &#123;</span><br><span class="line">            if (req.method().equalsIgnoreCase(&quot;OPTIONS&quot;)) &#123;</span><br><span class="line">                StringBuilder allow = new StringBuilder();</span><br><span class="line">                allow.append(&quot;GET, HEAD, POST, PUT, DELETE&quot;);</span><br><span class="line">                // Trace if allowed</span><br><span class="line">                if (connector.getAllowTrace()) &#123;</span><br><span class="line">                    allow.append(&quot;, TRACE&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                // Always allow options</span><br><span class="line">                allow.append(&quot;, OPTIONS&quot;);</span><br><span class="line">                res.setHeader(&quot;Allow&quot;, allow.toString());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                res.setStatus(404);</span><br><span class="line">                res.setMessage(&quot;Not found&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            connector.getService().getContainer().logAccess(</span><br><span class="line">                    request, response, 0, true);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MessageBytes decodedURI = req.decodedURI();</span><br><span class="line"></span><br><span class="line">        if (undecodedURI.getType() == MessageBytes.T_BYTES) &#123;</span><br><span class="line">            // Copy the raw URI to the decodedURI</span><br><span class="line">            decodedURI.duplicate(undecodedURI);</span><br><span class="line"></span><br><span class="line">            // Parse the path parameters. This will:</span><br><span class="line">            //   - strip out the path parameters</span><br><span class="line">            //   - convert the decodedURI to bytes</span><br><span class="line">            parsePathParameters(req, request);</span><br><span class="line"></span><br><span class="line">            // URI decoding</span><br><span class="line">            // %xx decoding of the URL</span><br><span class="line">            try &#123;</span><br><span class="line">                req.getURLDecoder().convert(decodedURI, false);</span><br><span class="line">            &#125; catch (IOException ioe) &#123;</span><br><span class="line">                res.setStatus(400);</span><br><span class="line">                res.setMessage(&quot;Invalid URI: &quot; + ioe.getMessage());</span><br><span class="line">                connector.getService().getContainer().logAccess(</span><br><span class="line">                        request, response, 0, true);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            // Normalization</span><br><span class="line">            if (!normalize(req.decodedURI())) &#123;</span><br><span class="line">                res.setStatus(400);</span><br><span class="line">                res.setMessage(&quot;Invalid URI&quot;);</span><br><span class="line">                connector.getService().getContainer().logAccess(</span><br><span class="line">                        request, response, 0, true);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            // Character decoding</span><br><span class="line">            convertURI(decodedURI, request);</span><br><span class="line">            // Check that the URI is still normalized</span><br><span class="line">            if (!checkNormalize(req.decodedURI())) &#123;</span><br><span class="line">                res.setStatus(400);</span><br><span class="line">                res.setMessage(&quot;Invalid URI character encoding&quot;);</span><br><span class="line">                connector.getService().getContainer().logAccess(</span><br><span class="line">                        request, response, 0, true);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            /* The URI is chars or String, and has been sent using an in-memory</span><br><span class="line">             * protocol handler. The following assumptions are made:</span><br><span class="line">             * - req.requestURI() has been set to the &#x27;original&#x27; non-decoded,</span><br><span class="line">             *   non-normalized URI</span><br><span class="line">             * - req.decodedURI() has been set to the decoded, normalized form</span><br><span class="line">             *   of req.requestURI()</span><br><span class="line">             */</span><br><span class="line">            decodedURI.toChars();</span><br><span class="line">            // Remove all path parameters; any needed path parameter should be set</span><br><span class="line">            // using the request object rather than passing it in the URL</span><br><span class="line">            CharChunk uriCC = decodedURI.getCharChunk();</span><br><span class="line">            int semicolon = uriCC.indexOf(&#x27;;&#x27;);</span><br><span class="line">            if (semicolon &gt; 0) &#123;</span><br><span class="line">                decodedURI.setChars</span><br><span class="line">                    (uriCC.getBuffer(), uriCC.getStart(), semicolon);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Request mapping.</span><br><span class="line">        MessageBytes serverName;</span><br><span class="line">        if (connector.getUseIPVHosts()) &#123;</span><br><span class="line">            serverName = req.localName();</span><br><span class="line">            if (serverName.isNull()) &#123;</span><br><span class="line">                // well, they did ask for it</span><br><span class="line">                res.action(ActionCode.REQ_LOCAL_NAME_ATTRIBUTE, null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            serverName = req.serverName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Version for the second mapping loop and</span><br><span class="line">        // Context that we expect to get for that version</span><br><span class="line">        String version = null;</span><br><span class="line">        Context versionContext = null;</span><br><span class="line">        boolean mapRequired = true;</span><br><span class="line"></span><br><span class="line">        while (mapRequired) &#123;</span><br><span class="line">            // This will map the the latest version by default</span><br><span class="line">//请求转化成Host、Context、Wrapper</span><br><span class="line">            connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class="line">                    version, request.getMappingData());</span><br><span class="line"></span><br><span class="line">            // If there is no context at this point, it is likely no ROOT context</span><br><span class="line">            // has been deployed</span><br><span class="line">            if (request.getContext() == null) &#123;</span><br><span class="line">                res.setStatus(404);</span><br><span class="line">                res.setMessage(&quot;Not found&quot;);</span><br><span class="line">                // No context, so use host</span><br><span class="line">                Host host = request.getHost();</span><br><span class="line">                // Make sure there is a host (might not be during shutdown)</span><br><span class="line">                if (host != null) &#123;</span><br><span class="line">                    host.logAccess(request, response, 0, true);</span><br><span class="line">                &#125;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Now we have the context, we can parse the session ID from the URL</span><br><span class="line">            // (if any). Need to do this before we redirect in case we need to</span><br><span class="line">            // include the session id in the redirect</span><br><span class="line">            String sessionID;</span><br><span class="line">            if (request.getServletContext().getEffectiveSessionTrackingModes()</span><br><span class="line">                    .contains(SessionTrackingMode.URL)) &#123;</span><br><span class="line"></span><br><span class="line">                // Get the session ID if there was one</span><br><span class="line">                sessionID = request.getPathParameter(</span><br><span class="line">                        SessionConfig.getSessionUriParamName(</span><br><span class="line">                                request.getContext()));</span><br><span class="line">                if (sessionID != null) &#123;</span><br><span class="line">                    request.setRequestedSessionId(sessionID);</span><br><span class="line">                    request.setRequestedSessionURL(true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Look for session ID in cookies and SSL session</span><br><span class="line">            parseSessionCookiesId(request);</span><br><span class="line">            parseSessionSslId(request);</span><br><span class="line"></span><br><span class="line">            sessionID = request.getRequestedSessionId();</span><br><span class="line"></span><br><span class="line">            mapRequired = false;</span><br><span class="line">            if (version != null &amp;&amp; request.getContext() == versionContext) &#123;</span><br><span class="line">                // We got the version that we asked for. That is it.</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                version = null;</span><br><span class="line">                versionContext = null;</span><br><span class="line"></span><br><span class="line">                Context[] contexts = request.getMappingData().contexts;</span><br><span class="line">                // Single contextVersion means no need to remap</span><br><span class="line">                // No session ID means no possibility of remap</span><br><span class="line">                if (contexts != null &amp;&amp; sessionID != null) &#123;</span><br><span class="line">                    // Find the context associated with the session</span><br><span class="line">                    for (int i = (contexts.length); i &gt; 0; i--) &#123;</span><br><span class="line">                        Context ctxt = contexts[i - 1];</span><br><span class="line">                        if (ctxt.getManager().findSession(sessionID) != null) &#123;</span><br><span class="line">                            // We found a context. Is it the one that has</span><br><span class="line">                            // already been mapped?</span><br><span class="line">                            if (!ctxt.equals(request.getMappingData().context)) &#123;</span><br><span class="line">                                // Set version so second time through mapping</span><br><span class="line">                                // the correct context is found</span><br><span class="line">                                version = ctxt.getWebappVersion();</span><br><span class="line">                                versionContext = ctxt;</span><br><span class="line">                                // Reset mapping</span><br><span class="line">                                request.getMappingData().recycle();</span><br><span class="line">                                mapRequired = true;</span><br><span class="line">                                // Recycle cookies and session info in case the</span><br><span class="line">                                // correct context is configured with different</span><br><span class="line">                                // settings</span><br><span class="line">                                request.recycleSessionInfo();</span><br><span class="line">                                request.recycleCookieInfo(true);</span><br><span class="line">                            &#125;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!mapRequired &amp;&amp; request.getContext().getPaused()) &#123;</span><br><span class="line">                // Found a matching context but it is paused. Mapping data will</span><br><span class="line">                // be wrong since some Wrappers may not be registered at this</span><br><span class="line">                // point.</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    // Should never happen</span><br><span class="line">                &#125;</span><br><span class="line">                // Reset mapping</span><br><span class="line">                request.getMappingData().recycle();</span><br><span class="line">                mapRequired = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Possible redirect</span><br><span class="line">        MessageBytes redirectPathMB = request.getMappingData().redirectPath;</span><br><span class="line">        if (!redirectPathMB.isNull()) &#123;</span><br><span class="line">            String redirectPath = URLEncoder.DEFAULT.encode(</span><br><span class="line">                    redirectPathMB.toString(), StandardCharsets.UTF_8);</span><br><span class="line">            String query = request.getQueryString();</span><br><span class="line">            if (request.isRequestedSessionIdFromURL()) &#123;</span><br><span class="line">                // This is not optimal, but as this is not very common, it</span><br><span class="line">                // shouldn&#x27;t matter</span><br><span class="line">                redirectPath = redirectPath + &quot;;&quot; +</span><br><span class="line">                        SessionConfig.getSessionUriParamName(</span><br><span class="line">                            request.getContext()) +</span><br><span class="line">                    &quot;=&quot; + request.getRequestedSessionId();</span><br><span class="line">            &#125;</span><br><span class="line">            if (query != null) &#123;</span><br><span class="line">                // This is not optimal, but as this is not very common, it</span><br><span class="line">                // shouldn&#x27;t matter</span><br><span class="line">                redirectPath = redirectPath + &quot;?&quot; + query;</span><br><span class="line">            &#125;</span><br><span class="line">            response.sendRedirect(redirectPath);</span><br><span class="line">            request.getContext().logAccess(request, response, 0, true);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Filter trace method</span><br><span class="line">        if (!connector.getAllowTrace()</span><br><span class="line">                &amp;&amp; req.method().equalsIgnoreCase(&quot;TRACE&quot;)) &#123;</span><br><span class="line">            Wrapper wrapper = request.getWrapper();</span><br><span class="line">            String header = null;</span><br><span class="line">            if (wrapper != null) &#123;</span><br><span class="line">                String[] methods = wrapper.getServletMethods();</span><br><span class="line">                if (methods != null) &#123;</span><br><span class="line">                    for (int i=0; i&lt;methods.length; i++) &#123;</span><br><span class="line">                        if (&quot;TRACE&quot;.equals(methods[i])) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (header == null) &#123;</span><br><span class="line">                            header = methods[i];</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            header += &quot;, &quot; + methods[i];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res.setStatus(405);</span><br><span class="line">            res.addHeader(&quot;Allow&quot;, header);</span><br><span class="line">            res.setMessage(&quot;TRACE method is not allowed&quot;);</span><br><span class="line">            request.getContext().logAccess(request, response, 0, true);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        doConnectorAuthenticationAuthorization(req, request);</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>在 Service 内只有一个 Engine ，但可能有多个 Connector ，在 Engine 内部 Engine 和 Host ，Host 和 Context，Context 和 Wrapper 都是一对多的关系。但浏览器发出一次请求连接并不需要也不可能让部署在 Tomcat 中的所有 Web 应用的所有 Servlet 类都执行一遍，本文所说的 Map 机制就是为了 Connector 在接收到一次 Socket 连接时转化成请求后，能够找到 Engine 下具体哪个 Host、哪个 Context、哪个 Wrapper来执行这个请求。</p>
<p>StandardPipeline内部有三个成员变量basic（Valve）、container（Container）、first（Valve）</p>
<p>StandardPipeline</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void addValve(Valve valve) &#123;</span><br><span class="line"></span><br><span class="line">        // Validate that we can add this Valve</span><br><span class="line">        if (valve instanceof Contained)</span><br><span class="line">            ((Contained) valve).setContainer(this.container);</span><br><span class="line"></span><br><span class="line">        // Start the new component if necessary</span><br><span class="line">        if (getState().isAvailable()) &#123;</span><br><span class="line">            if (valve instanceof Lifecycle) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    ((Lifecycle) valve).start();</span><br><span class="line">                &#125; catch (LifecycleException e) &#123;</span><br><span class="line">                    log.error(&quot;StandardPipeline.addValve: start: &quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Add this Valve to the set associated with this Pipeline</span><br><span class="line">//每次给管道添加一个普通阀的时候如果管道内原来没有普通阀则将新添加的阀作为该管道的成员变量 first 的引用，如果管道内已有普通阀，则把新加的阀加到所有普通阀链条末端，并且将该阀的下一个阀的引用设置为管道的基础阀</span><br><span class="line">        if (first == null) &#123;</span><br><span class="line">            first = valve;</span><br><span class="line">            valve.setNext(basic);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Valve current = first;</span><br><span class="line">            while (current != null) &#123;</span><br><span class="line">                if (current.getNext() == basic) &#123;</span><br><span class="line">                    current.setNext(valve);</span><br><span class="line">                    valve.setNext(basic);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                current = current.getNext();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        container.fireContainerEvent(Container.ADD_VALVE_EVENT, valve);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//如果管道中有普通阀则返回普通阀链条最开始的那个，否则就返回基础阀。</span><br><span class="line">    @Override</span><br><span class="line">    public Valve getFirst() &#123;</span><br><span class="line">        if (first != null) &#123;</span><br><span class="line">            return first;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return basic;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Valve共分为两类，一类叫基础阀（通过 getBasic、setBasic 方法调用），一类是普通阀（通过 addValve、removeValve 调用）。管道都是包含在一个容器当中，所以 API 里还有 getContainer 和 setContainer 方法。一个管道一般有一个基础阀（通过 setBasic 添加），可以有 0 到多个普通阀（通过 addValve 添加）。</p>
<p>如果想加普通阀<code>&lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</code></p>
<p>所以上面的<code>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</code><br>就是StandardContextValve</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public final void invoke(Request request, Response response)</span><br><span class="line">        throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        // Disallow any direct access to resources under WEB-INF or META-INF</span><br><span class="line">        MessageBytes requestPathMB = request.getRequestPathMB();</span><br><span class="line">        if ((requestPathMB.startsWithIgnoreCase(&quot;/META-INF/&quot;, 0))</span><br><span class="line">                || (requestPathMB.equalsIgnoreCase(&quot;/META-INF&quot;))</span><br><span class="line">                || (requestPathMB.startsWithIgnoreCase(&quot;/WEB-INF/&quot;, 0))</span><br><span class="line">                || (requestPathMB.equalsIgnoreCase(&quot;/WEB-INF&quot;))) &#123;</span><br><span class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Select the Wrapper to be used for this Request</span><br><span class="line">//StandardWrapper</span><br><span class="line">        Wrapper wrapper = request.getWrapper();</span><br><span class="line">        if (wrapper == null || wrapper.isUnavailable()) &#123;</span><br><span class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Acknowledge the request</span><br><span class="line">        try &#123;</span><br><span class="line">            response.sendAcknowledgement();</span><br><span class="line">        &#125; catch (IOException ioe) &#123;</span><br><span class="line">            container.getLogger().error(sm.getString(</span><br><span class="line">                    &quot;standardContextValve.acknowledgeException&quot;), ioe);</span><br><span class="line">            request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, ioe);</span><br><span class="line">            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (request.isAsyncSupported()) &#123;</span><br><span class="line">            request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());</span><br><span class="line">        &#125;</span><br><span class="line">//这里又链式调用了StandardWrapperValve的invoke</span><br><span class="line">        wrapper.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>StandardWrapperValve</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public final void invoke(Request request, Response response)</span><br><span class="line">        throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        // Initialize local variables we may need</span><br><span class="line">        boolean unavailable = false;</span><br><span class="line">        Throwable throwable = null;</span><br><span class="line">        // This should be a Request attribute...</span><br><span class="line">        long t1=System.currentTimeMillis();</span><br><span class="line">        requestCount.incrementAndGet();</span><br><span class="line">        StandardWrapper wrapper = (StandardWrapper) getContainer();</span><br><span class="line">        Servlet servlet = null;</span><br><span class="line">        Context context = (Context) wrapper.getParent();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">//分配一个servlet实例</span><br><span class="line">            if (!unavailable) &#123;</span><br><span class="line">                servlet = wrapper.allocate();</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">        MessageBytes requestPathMB = request.getRequestPathMB();</span><br><span class="line">        DispatcherType dispatcherType = DispatcherType.REQUEST;</span><br><span class="line">        if (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;</span><br><span class="line">        request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</span><br><span class="line">        request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</span><br><span class="line">                requestPathMB);</span><br><span class="line">        // Create the filter chain for this request    </span><br><span class="line">//ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line">//最后调用了servlet 的FilterChain，然后是各个过滤器的doFilter</span><br><span class="line">        ApplicationFilterChain filterChain =</span><br><span class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">//dofilter &amp; servlet.service</span><br><span class="line">          filterChain.doFilter(request.getRequest(),</span><br><span class="line">                                    response.getResponse());</span><br><span class="line">...</span><br><span class="line">        // Release the filter chain (if any) for this request</span><br><span class="line">        if (filterChain != null) &#123;</span><br><span class="line">            filterChain.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">//解除</span><br><span class="line">            if (servlet != null) &#123;</span><br><span class="line">                wrapper.deallocate(servlet);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        // 如果这个servlet永久不可用,卸载和释放这个实例</span><br><span class="line">        // unload it and release this instance</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>ApplicationFilterFactory</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static ApplicationFilterChain createFilterChain(ServletRequest request,</span><br><span class="line">            Wrapper wrapper, Servlet servlet) &#123;</span><br><span class="line">...</span><br><span class="line">        filterChain.setServlet(servlet);</span><br><span class="line">        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line">...</span><br><span class="line">        return filterChain;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ApplicationFilterChain</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest request, ServletResponse response)</span><br><span class="line">        throws IOException, ServletException &#123;</span><br><span class="line">...</span><br><span class="line">internalDoFilter(req,res);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void internalDoFilter(ServletRequest request,</span><br><span class="line">                                  ServletResponse response)</span><br><span class="line">        throws IOException, ServletException &#123;</span><br><span class="line">...</span><br><span class="line">filter.doFilter(request, response, this);</span><br><span class="line">...</span><br><span class="line">            if ((request instanceof HttpServletRequest) &amp;&amp;</span><br><span class="line">                    (response instanceof HttpServletResponse) &amp;&amp;</span><br><span class="line">                    Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">                final ServletRequest req = request;</span><br><span class="line">                final ServletResponse res = response;</span><br><span class="line">                Principal principal =</span><br><span class="line">                    ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line">                Object[] args = new Object[]&#123;req, res&#125;;</span><br><span class="line">                SecurityUtil.doAsPrivilege(&quot;service&quot;,</span><br><span class="line">                                           servlet,</span><br><span class="line">                                           classTypeUsedInService,</span><br><span class="line">                                           args,</span><br><span class="line">                                           principal);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                servlet.service(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显最后就调用到service了，后续大家应该很了解</p>
<p><img src="https://user-images.githubusercontent.com/7789698/37269633-5e197dc2-2606-11e8-8dbb-74a52180de09.png" alt="sequencediagram22"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/bf6044ee.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/bf6044ee.html" class="post-title-link" itemprop="url">Tomcat 源码解析（四）--Lifecycle 机制和实现原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-11 22:43:10" itemprop="dateCreated datePublished" datetime="2018-03-11T22:43:10+08:00">2018-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Lifecycle接口"><a href="#Lifecycle接口" class="headerlink" title="Lifecycle接口"></a>Lifecycle接口</h1> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * Add a LifecycleEvent listener to this component.</span><br><span class="line">     *</span><br><span class="line">     * @param listener The listener to add</span><br><span class="line">     */</span><br><span class="line">    public void addLifecycleListener(LifecycleListener listener);//给该组将添加一个监听器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Get the life cycle listeners associated with this life cycle. If this</span><br><span class="line">     * component has no listeners registered, a zero-length array is returned.</span><br><span class="line">     */</span><br><span class="line">    public LifecycleListener[] findLifecycleListeners();//获取该组件所有已注册的监听器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Remove a LifecycleEvent listener from this component.</span><br><span class="line">     *</span><br><span class="line">     * @param listener The listener to remove</span><br><span class="line">     */</span><br><span class="line">    public void removeLifecycleListener(LifecycleListener listener);//删除该组件中的一个监听器</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>LifecycleListener接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public interface LifecycleListener &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Acknowledge the occurrence of the specified event.</span><br><span class="line">     *</span><br><span class="line">     * @param event LifecycleEvent that has occurred</span><br><span class="line">     */</span><br><span class="line">    public void lifecycleEvent(LifecycleEvent event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>LifecycleEvent接口（继承jdk 内置的 java.util.EventObject）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public final class LifecycleEvent extends EventObject &#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // ----------------------------------------------------------- Constructors</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Construct a new LifecycleEvent with the specified parameters.</span><br><span class="line">     *</span><br><span class="line">     * @param lifecycle Component on which this event occurred</span><br><span class="line">     * @param type Event type (required)</span><br><span class="line">     * @param data Event data (if any)</span><br><span class="line">     */</span><br><span class="line">    public LifecycleEvent(Lifecycle lifecycle, String type, Object data) &#123;</span><br><span class="line"></span><br><span class="line">        super(lifecycle);</span><br><span class="line">        this.type = type;</span><br><span class="line">        this.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // ----------------------------------------------------- Instance Variables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The event data associated with this event.</span><br><span class="line">     */</span><br><span class="line">    private final Object data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The event type this instance represents.</span><br><span class="line">     */</span><br><span class="line">    private final String type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // ------------------------------------------------------------- Properties</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Return the event data of this event.</span><br><span class="line">     */</span><br><span class="line">    public Object getData() &#123;</span><br><span class="line"></span><br><span class="line">        return (this.data);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Return the Lifecycle on which this event occurred.</span><br><span class="line">     */</span><br><span class="line">    public Lifecycle getLifecycle() &#123;</span><br><span class="line"></span><br><span class="line">        return (Lifecycle) getSource();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Return the event type of this event.</span><br><span class="line">     */</span><br><span class="line">    public String getType() &#123;</span><br><span class="line"></span><br><span class="line">        return (this.type);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>LifecycleSupport的fireLifecycleEvent，向注册到组件中的所有监听器发布这个新构造的事件对象。</p>
<p>在 LifecycleBase类里LifecycleSupport是这么初始化的：<code>private final LifecycleSupport lifecycle = new LifecycleSupport(this);</code>，就是把StandardServer(LifecycleBase)的实例作为Lifecycle</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void fireLifecycleEvent(String type, Object data) &#123;</span><br><span class="line"></span><br><span class="line">    LifecycleEvent event = new LifecycleEvent(lifecycle, type, data);</span><br><span class="line">    LifecycleListener interested[] = listeners;</span><br><span class="line">    for (int i = 0; i &lt; interested.length; i++)</span><br><span class="line">        interested[i].lifecycleEvent(event);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>org.apache.catalina.startup.Catalina 类的 createStartDigester 方法有这么一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(&quot;Server/Listener&quot;,</span><br><span class="line">                         null, // MUST be specified in the element</span><br><span class="line">                         &quot;className&quot;);</span><br><span class="line">digester.addSetProperties(&quot;Server/Listener&quot;);</span><br><span class="line">digester.addSetNext(&quot;Server/Listener&quot;,</span><br><span class="line">                    &quot;addLifecycleListener&quot;,</span><br><span class="line">                    &quot;org.apache.catalina.LifecycleListener&quot;);</span><br></pre></td></tr></table></figure>



<p>LifecycleSupport</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    public void addLifecycleListener(LifecycleListener listener) &#123;</span><br><span class="line"></span><br><span class="line">      synchronized (listenersLock) &#123;</span><br><span class="line">          LifecycleListener results[] =</span><br><span class="line">            new LifecycleListener[listeners.length + 1];</span><br><span class="line">          for (int i = 0; i &lt; listeners.length; i++)</span><br><span class="line">              results[i] = listeners[i];</span><br><span class="line">          results[listeners.length] = listener;</span><br><span class="line">          listeners = results;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">private LifecycleListener listeners[] = new LifecycleListener[0];  </span><br></pre></td></tr></table></figure>



<p>如果对设计模式比较熟悉的话会发现 Tomcat 的 Lifecycle 使用的是观察者模式：LifecycleListener 代表的是抽象观察者，它定义一个 lifecycleEvent 方法，而实现该接口的监听器是作为具体的观察者。Lifecycle  接口代表的是抽象主题，它定义了管理观察者的方法和它要所做的其它方法。而各组件代表的是具体主题，它实现了抽象主题的所有方法。通常会由具体主题保存对具体观察者对象有用的内部状态；在这种内部状态改变时给其观察者发出一个通知。Tomcat 对这种模式做了改进，增加了另外两个工具类：LifecycleSupport、LifecycleEvent ，它们作为辅助类扩展了观察者的功能。LifecycleEvent 中定义了事件类别，不同的事件在具体观察者中可区别处理，更加灵活。LifecycleSupport 类代理了所有具体主题对观察者的管理，将这个管理抽出来统一实现，以后如果修改只要修改 LifecycleSupport 类就可以了，不需要去修改所有具体主题，因为所有具体主题的对观察者的操作都被代理给 LifecycleSupport 类了。<br>事件的发布使用的是推模式，即每发布一个事件都会通知主题的所有具体观察者，由各观察者再来决定是否需要对该事件进行后续处理。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/50d0f6b3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/50d0f6b3.html" class="post-title-link" itemprop="url">Tomcat 源码解析（三）--各组件init start</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-11 22:43:00" itemprop="dateCreated datePublished" datetime="2018-03-11T22:43:00+08:00">2018-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我们看到最早的解析，是解析xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line">  &lt;!-- Security listener. Documentation at /docs/config/listeners.html</span><br><span class="line">  &lt;Listener className=&quot;org.apache.catalina.security.SecurityListener&quot; /&gt;</span><br><span class="line">  --&gt;</span><br><span class="line">  &lt;!--APR library loader. Documentation at /docs/apr.html --&gt;</span><br><span class="line">  &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;</span><br><span class="line">  &lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span><br><span class="line">  &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;</span><br><span class="line">  &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;</span><br><span class="line">  &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- Global JNDI resources</span><br><span class="line">       Documentation at /docs/jndi-resources-howto.html</span><br><span class="line">  --&gt;</span><br><span class="line">  &lt;GlobalNamingResources&gt;</span><br><span class="line">    &lt;!-- Editable user database that can also be used by</span><br><span class="line">         UserDatabaseRealm to authenticate users</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;</span><br><span class="line">              type=&quot;org.apache.catalina.UserDatabase&quot;</span><br><span class="line">              description=&quot;User database that can be updated and saved&quot;</span><br><span class="line">              factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span><br><span class="line">              pathname=&quot;conf/tomcat-users.xml&quot; /&gt;</span><br><span class="line">  &lt;/GlobalNamingResources&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- A &quot;Service&quot; is a collection of one or more &quot;Connectors&quot; that share</span><br><span class="line">       a single &quot;Container&quot; Note:  A &quot;Service&quot; is not itself a &quot;Container&quot;,</span><br><span class="line">       so you may not define subcomponents such as &quot;Valves&quot; at this level.</span><br><span class="line">       Documentation at /docs/config/service.html</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;Service name=&quot;Catalina&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--The connectors can use a shared executor, you can define one or more named thread pools--&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Executor name=&quot;tomcatThreadPool&quot; namePrefix=&quot;catalina-exec-&quot;</span><br><span class="line">        maxThreads=&quot;150&quot; minSpareThreads=&quot;4&quot;/&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!-- A &quot;Connector&quot; represents an endpoint by which requests are received</span><br><span class="line">         and responses are returned. Documentation at :</span><br><span class="line">         Java HTTP Connector: /docs/config/http.html (blocking &amp; non-blocking)</span><br><span class="line">         Java AJP  Connector: /docs/config/ajp.html</span><br><span class="line">         APR (HTTP/AJP) Connector: /docs/apr.html</span><br><span class="line">         Define a non-SSL HTTP/1.1 Connector on port 8080</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">               connectionTimeout=&quot;20000&quot;</span><br><span class="line">               redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line">    &lt;!-- A &quot;Connector&quot; using the shared thread pool--&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Connector executor=&quot;tomcatThreadPool&quot;</span><br><span class="line">               port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">               connectionTimeout=&quot;20000&quot;</span><br><span class="line">               redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;!-- Define a SSL HTTP/1.1 Connector on port 8443</span><br><span class="line">         This connector uses the JSSE configuration, when using APR, the</span><br><span class="line">         connector should be using the OpenSSL style configuration</span><br><span class="line">         described in the APR documentation --&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Connector port=&quot;8443&quot; protocol=&quot;HTTP/1.1&quot; SSLEnabled=&quot;true&quot;</span><br><span class="line">               maxThreads=&quot;150&quot; scheme=&quot;https&quot; secure=&quot;true&quot;</span><br><span class="line">               clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot; /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span><br><span class="line">    &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!-- An Engine represents the entry point (within Catalina) that processes</span><br><span class="line">         every request.  The Engine implementation for Tomcat stand alone</span><br><span class="line">         analyzes the HTTP headers included with the request, and passes them</span><br><span class="line">         on to the appropriate Host (virtual host).</span><br><span class="line">         Documentation at /docs/config/engine.html --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- You should set jvmRoute to support load-balancing via AJP ie :</span><br><span class="line">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot; jvmRoute=&quot;jvm1&quot;&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!--For clustering, please take a look at documentation at:</span><br><span class="line">          /docs/cluster-howto.html  (simple how to)</span><br><span class="line">          /docs/config/cluster.html (reference documentation) --&gt;</span><br><span class="line">      &lt;!--</span><br><span class="line">      &lt;Cluster className=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;/&gt;</span><br><span class="line">      --&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- Use the LockOutRealm to prevent attempts to guess user passwords</span><br><span class="line">           via a brute-force attack --&gt;</span><br><span class="line">      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</span><br><span class="line">        &lt;!-- This Realm uses the UserDatabase configured in the global JNDI</span><br><span class="line">             resources under the key &quot;UserDatabase&quot;.  Any edits</span><br><span class="line">             that are performed against this UserDatabase are immediately</span><br><span class="line">             available for use by the Realm.  --&gt;</span><br><span class="line">        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span><br><span class="line">               resourceName=&quot;UserDatabase&quot;/&gt;</span><br><span class="line">      &lt;/Realm&gt;</span><br><span class="line"></span><br><span class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- SingleSignOn valve, share authentication between web applications</span><br><span class="line">             Documentation at: /docs/config/valve.html --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span><br><span class="line">        --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Access log processes all example.</span><br><span class="line">             Documentation at: /docs/config/valve.html</span><br><span class="line">             Note: The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/Host&gt;</span><br><span class="line">    &lt;/Engine&gt;</span><br><span class="line">  &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br></pre></td></tr></table></figure>

<h1 id="StandardServer"><a href="#StandardServer" class="headerlink" title="StandardServer"></a>StandardServer</h1><p><img src="https://user-images.githubusercontent.com/7789698/37250854-7eee792e-2540-11e8-908d-9a3ed3205c72.png" alt="image"></p>
<h2 id="StandardServer-LifecycleBase-的init"><a href="#StandardServer-LifecycleBase-的init" class="headerlink" title="StandardServer(LifecycleBase)的init"></a>StandardServer(LifecycleBase)的init</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public final synchronized void init() throws LifecycleException &#123;</span><br><span class="line">        if (!state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">            invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</span><br><span class="line">        &#125;</span><br><span class="line">        setStateInternal(LifecycleState.INITIALIZING, null, false);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            initInternal();</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            setStateInternal(LifecycleState.FAILED, null, false);</span><br><span class="line">            throw new LifecycleException(</span><br><span class="line">                    sm.getString(&quot;lifecycleBase.initFail&quot;,toString()), t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setStateInternal(LifecycleState.INITIALIZED, null, false);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>initInternal</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected void initInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">        super.initInternal();</span><br><span class="line"></span><br><span class="line">        // Register global String cache</span><br><span class="line">        // Note although the cache is global, if there are multiple Servers</span><br><span class="line">        // present in the JVM (may happen when embedding) then the same cache</span><br><span class="line">        // will be registered under multiple names</span><br><span class="line">        onameStringCache = register(new StringCache(), &quot;type=StringCache&quot;);</span><br><span class="line"></span><br><span class="line">        // Register the MBeanFactory</span><br><span class="line">        MBeanFactory factory = new MBeanFactory();</span><br><span class="line">        factory.setContainer(this);</span><br><span class="line">        onameMBeanFactory = register(factory, &quot;type=MBeanFactory&quot;);</span><br><span class="line"></span><br><span class="line">        // Register the naming resources</span><br><span class="line">        globalNamingResources.init();</span><br><span class="line"></span><br><span class="line">        // Populate the extension validator with JARs from common and shared</span><br><span class="line">        // class loaders</span><br><span class="line">        if (getCatalina() != null) &#123;</span><br><span class="line">            ClassLoader cl = getCatalina().getParentClassLoader();</span><br><span class="line">            // Walk the class loader hierarchy. Stop at the system class loader.</span><br><span class="line">            // This will add the shared (if present) and common class loaders</span><br><span class="line">            while (cl != null &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</span><br><span class="line">                if (cl instanceof URLClassLoader) &#123;</span><br><span class="line">                    URL[] urls = ((URLClassLoader) cl).getURLs();</span><br><span class="line">                    for (URL url : urls) &#123;</span><br><span class="line">                        if (url.getProtocol().equals(&quot;file&quot;)) &#123;</span><br><span class="line">                            try &#123;</span><br><span class="line">                                File f = new File (url.toURI());</span><br><span class="line">                                if (f.isFile() &amp;&amp;</span><br><span class="line">                                        f.getName().endsWith(&quot;.jar&quot;)) &#123;</span><br><span class="line">                                    ExtensionValidator.addSystemResource(f);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; catch (URISyntaxException e) &#123;</span><br><span class="line">                                // Ignore</span><br><span class="line">                            &#125; catch (IOException e) &#123;</span><br><span class="line">                                // Ignore</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                cl = cl.getParent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 初始化每个services</span><br><span class="line">        for (int i = 0; i &lt; services.length; i++) &#123;</span><br><span class="line">            services[i].init();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="StandardServer-LifecycleBase-的setStateInternal，fireLifecycleEvent是LifecycleSupport的fireLifecycleEvent"><a href="#StandardServer-LifecycleBase-的setStateInternal，fireLifecycleEvent是LifecycleSupport的fireLifecycleEvent" class="headerlink" title="StandardServer(LifecycleBase)的setStateInternal，fireLifecycleEvent是LifecycleSupport的fireLifecycleEvent"></a>StandardServer(LifecycleBase)的setStateInternal，fireLifecycleEvent是LifecycleSupport的fireLifecycleEvent</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">private synchronized void setStateInternal(LifecycleState state,</span><br><span class="line">            Object data, boolean check) throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">        if (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(&quot;lifecycleBase.setState&quot;, this, state));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (check) &#123;</span><br><span class="line">            // Must have been triggered by one of the abstract methods (assume</span><br><span class="line">            // code in this class is correct)</span><br><span class="line">            // null is never a valid state</span><br><span class="line">            if (state == null) &#123;</span><br><span class="line">                invalidTransition(&quot;null&quot;);</span><br><span class="line">                // Unreachable code - here to stop eclipse complaining about</span><br><span class="line">                // a possible NPE further down the method</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Any method can transition to failed</span><br><span class="line">            // startInternal() permits STARTING_PREP to STARTING</span><br><span class="line">            // stopInternal() permits STOPPING_PREP to STOPPING and FAILED to</span><br><span class="line">            // STOPPING</span><br><span class="line">            if (!(state == LifecycleState.FAILED ||</span><br><span class="line">                    (this.state == LifecycleState.STARTING_PREP &amp;&amp;</span><br><span class="line">                            state == LifecycleState.STARTING) ||</span><br><span class="line">                    (this.state == LifecycleState.STOPPING_PREP &amp;&amp;</span><br><span class="line">                            state == LifecycleState.STOPPING) ||</span><br><span class="line">                    (this.state == LifecycleState.FAILED &amp;&amp;</span><br><span class="line">                            state == LifecycleState.STOPPING))) &#123;</span><br><span class="line">                // No other transition permitted</span><br><span class="line">                invalidTransition(state.name());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">//将入参 LifecycleState 实例赋值给本类中的实例变量保存起来</span><br><span class="line">        this.state = state;</span><br><span class="line">        String lifecycleEvent = state.getLifecycleEvent();</span><br><span class="line">        if (lifecycleEvent != null) &#123;</span><br><span class="line">//发布事件</span><br><span class="line">            fireLifecycleEvent(lifecycleEvent, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="StandardServer-LifecycleBase-的start"><a href="#StandardServer-LifecycleBase-的start" class="headerlink" title="StandardServer(LifecycleBase)的start"></a>StandardServer(LifecycleBase)的start</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public final synchronized void start() throws LifecycleException &#123;</span><br><span class="line">//如果已经调用过start，返回</span><br><span class="line">        if (LifecycleState.STARTING_PREP.equals(state) ||</span><br><span class="line">                LifecycleState.STARTING.equals(state) ||</span><br><span class="line">                LifecycleState.STARTED.equals(state)) &#123;</span><br><span class="line"></span><br><span class="line">            if (log.isDebugEnabled()) &#123;</span><br><span class="line">                Exception e = new LifecycleException();</span><br><span class="line">                log.debug(sm.getString(&quot;lifecycleBase.alreadyStarted&quot;,</span><br><span class="line">                        toString()), e);</span><br><span class="line">            &#125; else if (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(sm.getString(&quot;lifecycleBase.alreadyStarted&quot;,</span><br><span class="line">                        toString()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">//调用init</span><br><span class="line">        if (state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">            init();</span><br><span class="line">        &#125; else if (state.equals(LifecycleState.FAILED))&#123;</span><br><span class="line">//stop</span><br><span class="line">            stop();</span><br><span class="line">        &#125; else if (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</span><br><span class="line">                !state.equals(LifecycleState.STOPPED)) &#123;</span><br><span class="line">            invalidTransition(Lifecycle.BEFORE_START_EVENT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setStateInternal(LifecycleState.STARTING_PREP, null, false);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">//重要</span><br><span class="line">            startInternal();</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            setStateInternal(LifecycleState.FAILED, null, false);</span><br><span class="line">            throw new LifecycleException(</span><br><span class="line">                    sm.getString(&quot;lifecycleBase.startFail&quot;,toString()), t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (state.equals(LifecycleState.FAILED) ||</span><br><span class="line">                state.equals(LifecycleState.MUST_STOP)) &#123;</span><br><span class="line">            stop();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // Shouldn&#x27;t be necessary but acts as a check that sub-classes are</span><br><span class="line">            // doing what they are supposed to.</span><br><span class="line">            if (!state.equals(LifecycleState.STARTING)) &#123;</span><br><span class="line">                invalidTransition(Lifecycle.AFTER_START_EVENT);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            setStateInternal(LifecycleState.STARTED, null, false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>startInternal</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">       fireLifecycleEvent(CONFIGURE_START_EVENT, null);</span><br><span class="line">       setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">       globalNamingResources.start();</span><br><span class="line"></span><br><span class="line">       // Start所有service</span><br><span class="line">       synchronized (servicesLock) &#123;</span><br><span class="line">           for (int i = 0; i &lt; services.length; i++) &#123;</span><br><span class="line">               services[i].start();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h1 id="StandardService"><a href="#StandardService" class="headerlink" title="StandardService"></a>StandardService</h1> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected void initInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">        super.initInternal();</span><br><span class="line"></span><br><span class="line">        if (container != null) &#123;</span><br><span class="line">            container.init();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Initialize any Executors</span><br><span class="line">        for (Executor executor : findExecutors()) &#123;</span><br><span class="line">            if (executor instanceof JmxEnabled) &#123;</span><br><span class="line">                ((JmxEnabled) executor).setDomain(getDomain());</span><br><span class="line">            &#125;</span><br><span class="line">            executor.init();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Initialize mapper listener</span><br><span class="line">        mapperListener.init();</span><br><span class="line"></span><br><span class="line">        // Initialize our defined Connectors</span><br><span class="line">        synchronized (connectorsLock) &#123;</span><br><span class="line">            for (Connector connector : connectors) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    connector.init();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    String message = sm.getString(</span><br><span class="line">                            &quot;standardService.connector.initFailed&quot;, connector);</span><br><span class="line">                    log.error(message, e);</span><br><span class="line"></span><br><span class="line">                    if (Boolean.getBoolean(&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;))</span><br><span class="line">                        throw new LifecycleException(message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">    protected void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">        //...</span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        // 开启StandardEngine</span><br><span class="line">        if (container != null) &#123;</span><br><span class="line">            synchronized (container) &#123;</span><br><span class="line">                container.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        synchronized (executors) &#123;</span><br><span class="line">            for (Executor executor: executors) &#123;</span><br><span class="line">                executor.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mapperListener.start();</span><br><span class="line"></span><br><span class="line">        // 开启Connector</span><br><span class="line">        synchronized (connectorsLock) &#123;</span><br><span class="line">            for (Connector connector: connectors) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    // If it has already failed, don&#x27;t try and start it</span><br><span class="line">                    if (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                        connector.start();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(sm.getString(</span><br><span class="line">                            &quot;standardService.connector.startFailed&quot;,</span><br><span class="line">                            connector), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h1 id="StandardEngine"><a href="#StandardEngine" class="headerlink" title="StandardEngine"></a>StandardEngine</h1><p>initInternal、startInternal是直接调用父类initInternal、startInternal</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected synchronized void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">        // Start our subordinate components, if any</span><br><span class="line">        logger = null;</span><br><span class="line">        getLogger();</span><br><span class="line">        Cluster cluster = getClusterInternal();</span><br><span class="line">        if ((cluster != null) &amp;&amp; (cluster instanceof Lifecycle))</span><br><span class="line">            ((Lifecycle) cluster).start();</span><br><span class="line">        Realm realm = getRealmInternal();</span><br><span class="line">        if ((realm != null) &amp;&amp; (realm instanceof Lifecycle))</span><br><span class="line">            ((Lifecycle) realm).start();</span><br><span class="line"></span><br><span class="line">        // Start our child containers, if any</span><br><span class="line">        Container children[] = findChildren();</span><br><span class="line">        List&lt;Future&lt;Void&gt;&gt; results = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int i = 0; i &lt; children.length; i++) &#123;</span><br><span class="line">//StartChild实现了Callable ，call里面其实就是Container#start</span><br><span class="line">            results.add(startStopExecutor.submit(new StartChild(children[i])));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boolean fail = false;</span><br><span class="line">        for (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                result.get();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(&quot;containerBase.threadedStartFailed&quot;), e);</span><br><span class="line">                fail = true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        if (fail) &#123;</span><br><span class="line">            throw new LifecycleException(</span><br><span class="line">                    sm.getString(&quot;containerBase.threadedStartFailed&quot;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Start the Valves in our pipeline (including the basic), if any</span><br><span class="line">        if (pipeline instanceof Lifecycle)</span><br><span class="line">            ((Lifecycle) pipeline).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        // Start our thread</span><br><span class="line">        threadStart();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="StandardHost"><a href="#StandardHost" class="headerlink" title="StandardHost"></a>StandardHost</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> @Override</span><br><span class="line">    protected synchronized void startInternal() throws LifecycleException &#123;</span><br><span class="line">        // Set error report valve</span><br><span class="line">        String errorValve = getErrorReportValveClass();</span><br><span class="line">        if ((errorValve != null) &amp;&amp; (!errorValve.equals(&quot;&quot;))) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                boolean found = false;</span><br><span class="line">                Valve[] valves = getPipeline().getValves();</span><br><span class="line">                for (Valve valve : valves) &#123;</span><br><span class="line">                    if (errorValve.equals(valve.getClass().getName())) &#123;</span><br><span class="line">                        found = true;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if(!found) &#123;</span><br><span class="line">                    Valve valve =</span><br><span class="line">                        (Valve) Class.forName(errorValve).getConstructor().newInstance();</span><br><span class="line">                    getPipeline().addValve(valve);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">//...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        super.startInternal();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Connector</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    protected void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">        // Validate settings before starting</span><br><span class="line">        if (getPort() &lt; 0) &#123;</span><br><span class="line">            throw new LifecycleException(sm.getString(</span><br><span class="line">                    &quot;coyoteConnector.invalidPort&quot;, Integer.valueOf(getPort())));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">//其实就是Http11AprProtocol见后文</span><br><span class="line">            protocolHandler.start();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new LifecycleException(</span><br><span class="line">                    sm.getString(&quot;coyoteConnector.protocolHandlerStartFailed&quot;), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>initInternal<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected void initInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">        super.initInternal();</span><br><span class="line"></span><br><span class="line">        // Initialize adapter，后面处理service的时候用的就是这个</span><br><span class="line">        adapter = new CoyoteAdapter(this);</span><br><span class="line">        protocolHandler.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">        // Make sure parseBodyMethodsSet has a default</span><br><span class="line">        if (null == parseBodyMethodsSet) &#123;</span><br><span class="line">            setParseBodyMethods(getParseBodyMethods());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (protocolHandler.isAprRequired() &amp;&amp; !AprLifecycleListener.isAprAvailable()) &#123;</span><br><span class="line">            throw new LifecycleException(sm.getString(&quot;coyoteConnector.protocolHandlerNoApr&quot;,</span><br><span class="line">                    getProtocolHandlerClassName()));</span><br><span class="line">        &#125;</span><br><span class="line">        if (AprLifecycleListener.isAprAvailable() &amp;&amp; AprLifecycleListener.getUseOpenSSL() &amp;&amp;</span><br><span class="line">                protocolHandler instanceof AbstractHttp11JsseProtocol) &#123;</span><br><span class="line">            AbstractHttp11JsseProtocol&lt;?&gt; jsseProtocolHandler =</span><br><span class="line">                    (AbstractHttp11JsseProtocol&lt;?&gt;) protocolHandler;</span><br><span class="line">            if (jsseProtocolHandler.isSSLEnabled() &amp;&amp;</span><br><span class="line">                    jsseProtocolHandler.getSslImplementationName() == null) &#123;</span><br><span class="line">                // OpenSSL is compatible with the JSSE configuration, so use it if APR is available</span><br><span class="line">                jsseProtocolHandler.setSslImplementationName(OpenSSLImplementation.class.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            protocolHandler.init();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new LifecycleException(</span><br><span class="line">                    sm.getString(&quot;coyoteConnector.protocolHandlerInitializationFailed&quot;), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://user-images.githubusercontent.com/7789698/37251128-77badb12-2544-11e8-906d-92071230aac8.png" alt="image"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://juejin.im/post/5a6d6f6751882573520da54d">https://juejin.im/post/5a6d6f6751882573520da54d</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/143b4ffc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/143b4ffc.html" class="post-title-link" itemprop="url">Tomcat 源码解析（二）--Bootstrap.jar</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-11 22:42:50" itemprop="dateCreated datePublished" datetime="2018-03-11T22:42:50+08:00">2018-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>之前我们看到其实启动脚本就是使用Bootstrap 的main启动的</p>
<h1 id="解析Bootstrap"><a href="#解析Bootstrap" class="headerlink" title="解析Bootstrap"></a>解析Bootstrap</h1><p>Bootstrap 的main</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String args[]) &#123;</span><br><span class="line"></span><br><span class="line">        if (daemon == null) &#123;</span><br><span class="line">            // Don&#x27;t set daemon until init() has completed</span><br><span class="line">            Bootstrap bootstrap = new Bootstrap();</span><br><span class="line">            try &#123;</span><br><span class="line">                bootstrap.init();</span><br><span class="line">            &#125; catch (Throwable t) &#123;</span><br><span class="line">                handleThrowable(t);</span><br><span class="line">                t.printStackTrace();</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            daemon = bootstrap;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // When running as a service the call to stop will be on a new</span><br><span class="line">            // thread so make sure the correct class loader is used to prevent</span><br><span class="line">            // a range of class not found exceptions.</span><br><span class="line">            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            String command = &quot;start&quot;;</span><br><span class="line">            if (args.length &gt; 0) &#123;</span><br><span class="line">                command = args[args.length - 1];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (command.equals(&quot;startd&quot;)) &#123;</span><br><span class="line">                args[args.length - 1] = &quot;start&quot;;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                daemon.start();</span><br><span class="line">            &#125; else if (command.equals(&quot;stopd&quot;)) &#123;</span><br><span class="line">                args[args.length - 1] = &quot;stop&quot;;</span><br><span class="line">                daemon.stop();</span><br><span class="line">            &#125; else if (command.equals(&quot;start&quot;)) &#123;</span><br><span class="line">                daemon.setAwait(true);</span><br><span class="line">//调用load ,最后调用Catalina#load</span><br><span class="line">                daemon.load(args);</span><br><span class="line">//调用start</span><br><span class="line">                daemon.start();</span><br><span class="line">            &#125; else if (command.equals(&quot;stop&quot;)) &#123;</span><br><span class="line">                daemon.stopServer(args);</span><br><span class="line">            &#125; else if (command.equals(&quot;configtest&quot;)) &#123;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                if (null==daemon.getServer()) &#123;</span><br><span class="line">                    System.exit(1);</span><br><span class="line">                &#125;</span><br><span class="line">                System.exit(0);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.warn(&quot;Bootstrap: command \&quot;&quot; + command + &quot;\&quot; does not exist.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            // Unwrap the Exception for clearer error reporting</span><br><span class="line">            if (t instanceof InvocationTargetException &amp;&amp;</span><br><span class="line">                    t.getCause() != null) &#123;</span><br><span class="line">                t = t.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">            System.exit(1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>init</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public void init() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        initClassLoaders();</span><br><span class="line"></span><br><span class="line">//设置目前线程的类装载器catalinaLoader</span><br><span class="line">        Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line"></span><br><span class="line">        SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line"></span><br><span class="line">        // 加载类Catalina并实例化最后赋值给catalinaDaemon</span><br><span class="line">        if (log.isDebugEnabled())</span><br><span class="line">            log.debug(&quot;Loading startup class&quot;);</span><br><span class="line">        Class&lt;?&gt; startupClass =</span><br><span class="line">            catalinaLoader.loadClass</span><br><span class="line">            (&quot;org.apache.catalina.startup.Catalina&quot;);</span><br><span class="line">        Object startupInstance = startupClass.newInstance();</span><br><span class="line"></span><br><span class="line">        // 以 sharedLoader 作为入参通过反射调用该对象的 setParentClassLoader 方法。</span><br><span class="line"> //也就是sharedLoader作为父ClassLoader</span><br><span class="line">        if (log.isDebugEnabled())</span><br><span class="line">            log.debug(&quot;Setting startup class properties&quot;);</span><br><span class="line">        String methodName = &quot;setParentClassLoader&quot;;</span><br><span class="line">        Class&lt;?&gt; paramTypes[] = new Class[1];</span><br><span class="line">        paramTypes[0] = Class.forName(&quot;java.lang.ClassLoader&quot;);</span><br><span class="line">        Object paramValues[] = new Object[1];</span><br><span class="line">        paramValues[0] = sharedLoader;</span><br><span class="line">        Method method =</span><br><span class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">        method.invoke(startupInstance, paramValues);</span><br><span class="line"></span><br><span class="line">        catalinaDaemon = startupInstance;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void initClassLoaders() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">//catalina.properties 的common.loader（&quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;）  </span><br><span class="line">//创建commonLoader类加载器</span><br><span class="line">            commonLoader = createClassLoader(&quot;common&quot;, null);</span><br><span class="line">            if( commonLoader == null ) &#123;</span><br><span class="line">                // no config file, default to this loader - we might be in a &#x27;single&#x27; env.</span><br><span class="line">                commonLoader=this.getClass().getClassLoader();</span><br><span class="line">            &#125;</span><br><span class="line">//server.loader （搜索路径空）</span><br><span class="line">//创建catalinaLoader类加载器 </span><br><span class="line">            catalinaLoader = createClassLoader(&quot;server&quot;, commonLoader);</span><br><span class="line">//shared.loader （搜索路径空）</span><br><span class="line">//创建sharedLoader类加载器</span><br><span class="line">            sharedLoader = createClassLoader(&quot;shared&quot;, commonLoader);</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            log.error(&quot;Class loader creation threw exception&quot;, t);</span><br><span class="line">            System.exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>start</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    public void start()</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">        if( catalinaDaemon==null ) init();</span><br><span class="line"></span><br><span class="line">//通过反射调用执行Catalina #start</span><br><span class="line">        Method method = catalinaDaemon.getClass().getMethod(&quot;start&quot;, (Class [] )null);</span><br><span class="line">        method.invoke(catalinaDaemon, (Object [])null);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="解析Catalina"><a href="#解析Catalina" class="headerlink" title="解析Catalina"></a>解析Catalina</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">public void load() &#123;</span><br><span class="line"></span><br><span class="line">        long t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line">        initDirs();</span><br><span class="line"></span><br><span class="line">        // Before digester - it may be needed</span><br><span class="line"></span><br><span class="line">        initNaming();</span><br><span class="line"></span><br><span class="line">        // 创建Digester</span><br><span class="line">        Digester digester = createStartDigester();</span><br><span class="line"></span><br><span class="line">        InputSource inputSource = null;</span><br><span class="line">        InputStream inputStream = null;</span><br><span class="line">        File file = null;</span><br><span class="line">        try &#123;</span><br><span class="line">//读取CatalinaBase/conf/server.xml</span><br><span class="line">            file = configFile();</span><br><span class="line">            inputStream = new FileInputStream(file);</span><br><span class="line">            inputSource = new InputSource(file.toURI().toURL().toString());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            if (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(sm.getString(&quot;catalina.configFail&quot;, file), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (inputStream == null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">//读conf/server.xml</span><br><span class="line">                inputStream = getClass().getClassLoader()</span><br><span class="line">                    .getResourceAsStream(getConfigFile());</span><br><span class="line">                inputSource = new InputSource</span><br><span class="line">                    (getClass().getClassLoader()</span><br><span class="line">                     .getResource(getConfigFile()).toString());</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                if (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(&quot;catalina.configFail&quot;,</span><br><span class="line">                            getConfigFile()), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // This should be included in catalina.jar</span><br><span class="line">        // Alternative: don&#x27;t bother with xml, just create it manually.</span><br><span class="line">        if( inputStream==null ) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                inputStream = getClass().getClassLoader()</span><br><span class="line">                        .getResourceAsStream(&quot;server-embed.xml&quot;);</span><br><span class="line">                inputSource = new InputSource</span><br><span class="line">                (getClass().getClassLoader()</span><br><span class="line">                        .getResource(&quot;server-embed.xml&quot;).toString());</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                if (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(&quot;catalina.configFail&quot;,</span><br><span class="line">                            &quot;server-embed.xml&quot;), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if (inputStream == null || inputSource == null) &#123;</span><br><span class="line">            if  (file == null) &#123;</span><br><span class="line">                log.warn(sm.getString(&quot;catalina.configFail&quot;,</span><br><span class="line">                        getConfigFile() + &quot;] or [server-embed.xml]&quot;));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.warn(sm.getString(&quot;catalina.configFail&quot;,</span><br><span class="line">                        file.getAbsolutePath()));</span><br><span class="line">                if (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">                    log.warn(&quot;Permissions incorrect, read permission is not allowed on the file.&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            inputSource.setByteStream(inputStream);</span><br><span class="line">            digester.push(this);</span><br><span class="line">            digester.parse(inputSource);</span><br><span class="line">        &#125; catch (SAXParseException spe) &#123;</span><br><span class="line">            log.warn(&quot;Catalina.start using &quot; + getConfigFile() + &quot;: &quot; +</span><br><span class="line">                    spe.getMessage());</span><br><span class="line">            return;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(&quot;Catalina.start using &quot; + getConfigFile() + &quot;: &quot; , e);</span><br><span class="line">            return;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                // Ignore</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">//Server 设置Catalina为本实例,设置CatalinaHome、CatalinaBase 初始化</span><br><span class="line">        getServer().setCatalina(this);</span><br><span class="line">        getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">        getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line"></span><br><span class="line">        // Stream redirection</span><br><span class="line">        initStreams();</span><br><span class="line"></span><br><span class="line">        // Start the new server</span><br><span class="line">        try &#123;</span><br><span class="line">            getServer().init();</span><br><span class="line">        &#125; catch (LifecycleException e) &#123;</span><br><span class="line">            if (Boolean.getBoolean(&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;)) &#123;</span><br><span class="line">                throw new java.lang.Error(e);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.error(&quot;Catalina.start&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long t2 = System.nanoTime();</span><br><span class="line">        if(log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(&quot;Initialization processed in &quot; + ((t2 - t1) / 1000000) + &quot; ms&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中Digester是很重要的东西，重点在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//创建Digester</span><br><span class="line">Digester digester = createStartDigester();  </span><br><span class="line">//读取conf/server.xml，放入流</span><br><span class="line">inputSource.setByteStream(inputStream);  </span><br><span class="line">//吧当前对象压入</span><br><span class="line">digester.push(this);  </span><br><span class="line">//解析xml</span><br><span class="line">digester.parse(inputSource);  </span><br><span class="line">getServer().setCatalina(this);  </span><br><span class="line">//调用 Server 接口对象的 init 方法。其实就是StandardServer的init(内部initInternal)</span><br><span class="line">getServer().init();  </span><br></pre></td></tr></table></figure>
<p>这样经过对 xml 文件的解析将会产生 org.apache.catalina.core.StandardServer、org.apache.catalina.core.StandardService、org.apache.catalina.connector.Connector、org.apache.catalina.core.StandardEngine、org.apache.catalina.core.StandardHost、org.apache.catalina.core.StandardContext 等等</p>
<p>Catalina的start</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public void start() &#123;</span><br><span class="line"></span><br><span class="line">        if (getServer() == null) &#123;</span><br><span class="line">            load();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (getServer() == null) &#123;</span><br><span class="line">            log.fatal(&quot;Cannot start server. Server instance is not configured.&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line">        // 调用Server的start</span><br><span class="line">        try &#123;</span><br><span class="line">            getServer().start();</span><br><span class="line">        &#125; catch (LifecycleException e) &#123;</span><br><span class="line">            log.fatal(sm.getString(&quot;catalina.serverStartFail&quot;), e);</span><br><span class="line">            try &#123;</span><br><span class="line">//destroy</span><br><span class="line">                getServer().destroy();</span><br><span class="line">            &#125; catch (LifecycleException e1) &#123;</span><br><span class="line">                log.debug(&quot;destroy() failed for failed Server &quot;, e1);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long t2 = System.nanoTime();</span><br><span class="line">        if(log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(&quot;Server startup in &quot; + ((t2 - t1) / 1000000) + &quot; ms&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 注册 shutdown hook</span><br><span class="line">        if (useShutdownHook) &#123;</span><br><span class="line">            if (shutdownHook == null) &#123;</span><br><span class="line">                shutdownHook = new CatalinaShutdownHook();</span><br><span class="line">            &#125;</span><br><span class="line">            Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line"></span><br><span class="line">            // If JULI is being used, disable JULI&#x27;s shutdown hook since</span><br><span class="line">            // shutdown hooks run in parallel and log messages may be lost</span><br><span class="line">            // if JULI&#x27;s hook completes before the CatalinaShutdownHook()</span><br><span class="line">            LogManager logManager = LogManager.getLogManager();</span><br><span class="line">            if (logManager instanceof ClassLoaderLogManager) &#123;</span><br><span class="line">                ((ClassLoaderLogManager) logManager).setUseShutdownHook(</span><br><span class="line">                        false);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (await) &#123;</span><br><span class="line">            await();</span><br><span class="line">            stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/f42d2c92.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/f42d2c92.html" class="post-title-link" itemprop="url">Tomcat 源码解析（一）--脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-11 22:42:39" itemprop="dateCreated datePublished" datetime="2018-03-11T22:42:39+08:00">2018-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我们来看下startup.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Better OS/400 detection: see Bugzilla 31132</span></span><br><span class="line">os400=false</span><br><span class="line">case &quot;`uname`&quot; in</span><br><span class="line">OS400*) os400=true;;</span><br><span class="line">esac</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$0</span> 表示Shell本身的文件名</span></span><br><span class="line">PRG=&quot;$0&quot;</span><br><span class="line"></span><br><span class="line">while [ -h &quot;$PRG&quot; ] ; do</span><br><span class="line"><span class="meta">#</span><span class="bash">取到软连接的真实文件或真实目录</span></span><br><span class="line">  ls=`ls -ld &quot;$PRG&quot;`</span><br><span class="line">  link=`expr &quot;$ls&quot; : &#x27;.*-&gt; \(.*\)$&#x27;`</span><br><span class="line">  if expr &quot;$link&quot; : &#x27;/.*&#x27; &gt; /dev/null; then</span><br><span class="line">    PRG=&quot;$link&quot;</span><br><span class="line">  else</span><br><span class="line">    PRG=`dirname &quot;$PRG&quot;`/&quot;$link&quot;</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">获取脚本文件所在的绝对路径</span></span><br><span class="line">PRGDIR=`dirname &quot;$PRG&quot;`</span><br><span class="line">EXECUTABLE=catalina.sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Check that target executable exists</span></span><br><span class="line">if $os400; then</span><br><span class="line"><span class="meta">  #</span><span class="bash"> -x will Only work on the os400 <span class="keyword">if</span> the files are:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 1. owned by the user</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 2. owned by the PRIMARY group of the user</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> this will not work <span class="keyword">if</span> the user belongs <span class="keyword">in</span> secondary groups</span></span><br><span class="line">  eval</span><br><span class="line">else</span><br><span class="line">  if [ ! -x &quot;$PRGDIR&quot;/&quot;$EXECUTABLE&quot; ]; then</span><br><span class="line">    echo &quot;Cannot find $PRGDIR/$EXECUTABLE&quot;</span><br><span class="line">    echo &quot;The file is absent or does not have execute permission&quot;</span><br><span class="line">    echo &quot;This file is needed to run this program&quot;</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$@</span> 所有参数列表</span></span><br><span class="line">exec &quot;$PRGDIR&quot;/&quot;$EXECUTABLE&quot; start &quot;$@&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以其实就是执行<code> catalina.sh start $@</code></p>
<p>catalina.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line"># OS specific support.  $var _must_ be set to either true or false.</span><br><span class="line">cygwin=false</span><br><span class="line">darwin=false</span><br><span class="line">os400=false</span><br><span class="line">case &quot;`uname`&quot; in</span><br><span class="line">CYGWIN*) cygwin=true;;</span><br><span class="line">Darwin*) darwin=true;;</span><br><span class="line">OS400*) os400=true;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"># resolve links - $0 may be a softlink</span><br><span class="line">PRG=&quot;$0&quot;</span><br><span class="line"></span><br><span class="line">while [ -h &quot;$PRG&quot; ]; do</span><br><span class="line">  ls=`ls -ld &quot;$PRG&quot;`</span><br><span class="line">  link=`expr &quot;$ls&quot; : &#x27;.*-&gt; \(.*\)$&#x27;`</span><br><span class="line">  if expr &quot;$link&quot; : &#x27;/.*&#x27; &gt; /dev/null; then</span><br><span class="line">    PRG=&quot;$link&quot;</span><br><span class="line">  else</span><br><span class="line">    PRG=`dirname &quot;$PRG&quot;`/&quot;$link&quot;</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># Get standard environment variables</span><br><span class="line">PRGDIR=`dirname &quot;$PRG&quot;`</span><br><span class="line"></span><br><span class="line"># -z CATALINA_HOME长度为0为真 ，取脚本所在目录上层作为CATALINA_HOME</span><br><span class="line">[ -z &quot;$CATALINA_HOME&quot; ] &amp;&amp; CATALINA_HOME=`cd &quot;$PRGDIR/..&quot; &gt;/dev/null; pwd`</span><br><span class="line"></span><br><span class="line"># CATALINA_BASE没设置 CATALINA_BASE就设为CATALINA_HOME</span><br><span class="line">[ -z &quot;$CATALINA_BASE&quot; ] &amp;&amp; CATALINA_BASE=&quot;$CATALINA_HOME&quot;</span><br><span class="line"></span><br><span class="line"># 校验 确保中间没有“:”</span><br><span class="line">case $CATALINA_HOME in</span><br><span class="line">  *:*) echo &quot;Using CATALINA_HOME:   $CATALINA_HOME&quot;;</span><br><span class="line">       echo &quot;Unable to start as CATALINA_HOME contains a colon (:) character&quot;;</span><br><span class="line">       exit 1;</span><br><span class="line">esac</span><br><span class="line">case $CATALINA_BASE in</span><br><span class="line">  *:*) echo &quot;Using CATALINA_BASE:   $CATALINA_BASE&quot;;</span><br><span class="line">       echo &quot;Unable to start as CATALINA_BASE contains a colon (:) character&quot;;</span><br><span class="line">       exit 1;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"># Ensure that any user defined CLASSPATH variables are not used on startup</span><br><span class="line">CLASSPATH=</span><br><span class="line"></span><br><span class="line">#-r 存在文件  setenv.sh则执行</span><br><span class="line">if [ -r &quot;$CATALINA_BASE/bin/setenv.sh&quot; ]; then</span><br><span class="line">  . &quot;$CATALINA_BASE/bin/setenv.sh&quot;</span><br><span class="line">elif [ -r &quot;$CATALINA_HOME/bin/setenv.sh&quot; ]; then</span><br><span class="line">  . &quot;$CATALINA_HOME/bin/setenv.sh&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Cygwin 下，存在变量则用cygpath</span><br><span class="line">if $cygwin; then</span><br><span class="line">  [ -n &quot;$JAVA_HOME&quot; ] &amp;&amp; JAVA_HOME=`cygpath --unix &quot;$JAVA_HOME&quot;`</span><br><span class="line">  [ -n &quot;$JRE_HOME&quot; ] &amp;&amp; JRE_HOME=`cygpath --unix &quot;$JRE_HOME&quot;`</span><br><span class="line">  [ -n &quot;$CATALINA_HOME&quot; ] &amp;&amp; CATALINA_HOME=`cygpath --unix &quot;$CATALINA_HOME&quot;`</span><br><span class="line">  [ -n &quot;$CATALINA_BASE&quot; ] &amp;&amp; CATALINA_BASE=`cygpath --unix &quot;$CATALINA_BASE&quot;`</span><br><span class="line">  [ -n &quot;$CLASSPATH&quot; ] &amp;&amp; CLASSPATH=`cygpath --path --unix &quot;$CLASSPATH&quot;`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># For OS400</span><br><span class="line">if $os400; then</span><br><span class="line">  # Set job priority to standard for interactive (interactive - 6) by using</span><br><span class="line">  # the interactive priority - 6, the helper threads that respond to requests</span><br><span class="line">  # will be running at the same priority as interactive jobs.</span><br><span class="line">  COMMAND=&#x27;chgjob job(&#x27;$JOBNAME&#x27;) runpty(6)&#x27;</span><br><span class="line">  system $COMMAND</span><br><span class="line"></span><br><span class="line">  # Enable multi threading</span><br><span class="line">  export QIBM_MULTI_THREADED=Y</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># setclasspath.sh 见下面</span><br><span class="line">if $os400; then</span><br><span class="line">  # -r will Only work on the os400 if the files are:</span><br><span class="line">  # 1. owned by the user</span><br><span class="line">  # 2. owned by the PRIMARY group of the user</span><br><span class="line">  # this will not work if the user belongs in secondary groups</span><br><span class="line">  . &quot;$CATALINA_HOME&quot;/bin/setclasspath.sh</span><br><span class="line">else</span><br><span class="line">  if [ -r &quot;$CATALINA_HOME&quot;/bin/setclasspath.sh ]; then</span><br><span class="line">    . &quot;$CATALINA_HOME&quot;/bin/setclasspath.sh</span><br><span class="line">  else</span><br><span class="line">    echo &quot;Cannot find $CATALINA_HOME/bin/setclasspath.sh&quot;</span><br><span class="line">    echo &quot;This file is needed to run this program&quot;</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 添加bootstrap.jar（作用看后续，主要是org.apache.catalina.startup.Bootstrap）到 CLASSPATH</span><br><span class="line">if [ ! -z &quot;$CLASSPATH&quot; ] ; then</span><br><span class="line">  CLASSPATH=&quot;$CLASSPATH&quot;:</span><br><span class="line">fi</span><br><span class="line">CLASSPATH=&quot;$CLASSPATH&quot;&quot;$CATALINA_HOME&quot;/bin/bootstrap.jar</span><br><span class="line"></span><br><span class="line">#设置CATALINA_OUT（日志）</span><br><span class="line">if [ -z &quot;$CATALINA_OUT&quot; ] ; then</span><br><span class="line">  CATALINA_OUT=&quot;$CATALINA_BASE&quot;/logs/catalina.out</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#设置CATALINA_TMPDIR（temp文件）</span><br><span class="line">if [ -z &quot;$CATALINA_TMPDIR&quot; ] ; then</span><br><span class="line">  # Define the java.io.tmpdir to use for Catalina</span><br><span class="line">  CATALINA_TMPDIR=&quot;$CATALINA_BASE&quot;/temp</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 添加 tomcat-juli.jar 到 classpath</span><br><span class="line">if [ -r &quot;$CATALINA_BASE/bin/tomcat-juli.jar&quot; ] ; then</span><br><span class="line">  CLASSPATH=$CLASSPATH:$CATALINA_BASE/bin/tomcat-juli.jar</span><br><span class="line">else</span><br><span class="line">  CLASSPATH=$CLASSPATH:$CATALINA_HOME/bin/tomcat-juli.jar</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Bugzilla 37848: When no TTY is available, don&#x27;t output to console</span><br><span class="line">have_tty=0</span><br><span class="line">if [ &quot;`tty`&quot; != &quot;not a tty&quot; ]; then</span><br><span class="line">    have_tty=1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># For Cygwin, switch paths to Windows format before running java</span><br><span class="line">if $cygwin; then</span><br><span class="line">  JAVA_HOME=`cygpath --absolute --windows &quot;$JAVA_HOME&quot;`</span><br><span class="line">  JRE_HOME=`cygpath --absolute --windows &quot;$JRE_HOME&quot;`</span><br><span class="line">  CATALINA_HOME=`cygpath --absolute --windows &quot;$CATALINA_HOME&quot;`</span><br><span class="line">  CATALINA_BASE=`cygpath --absolute --windows &quot;$CATALINA_BASE&quot;`</span><br><span class="line">  CATALINA_TMPDIR=`cygpath --absolute --windows &quot;$CATALINA_TMPDIR&quot;`</span><br><span class="line">  CLASSPATH=`cygpath --path --windows &quot;$CLASSPATH&quot;`</span><br><span class="line">  JAVA_ENDORSED_DIRS=`cygpath --path --windows &quot;$JAVA_ENDORSED_DIRS&quot;`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Set juli LogManager config file if it is present and an override has not been issued</span><br><span class="line">if [ -z &quot;$LOGGING_CONFIG&quot; ]; then</span><br><span class="line">  if [ -r &quot;$CATALINA_BASE&quot;/conf/logging.properties ]; then</span><br><span class="line">    LOGGING_CONFIG=&quot;-Djava.util.logging.config.file=$CATALINA_BASE/conf/logging.properties&quot;</span><br><span class="line">  else</span><br><span class="line">    # Bugzilla 45585</span><br><span class="line">    LOGGING_CONFIG=&quot;-Dnop&quot;</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$LOGGING_MANAGER&quot; ]; then</span><br><span class="line">  LOGGING_MANAGER=&quot;-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Uncomment the following line to make the umask available when using the</span><br><span class="line"># org.apache.catalina.security.SecurityListener</span><br><span class="line">#JAVA_OPTS=&quot;$JAVA_OPTS -Dorg.apache.catalina.security.SecurityListener.UMASK=`umask`&quot;</span><br><span class="line"></span><br><span class="line"># ----- Execute The Requested Command -----------------------------------------</span><br><span class="line"></span><br><span class="line"># Bugzilla 37848: only output this if we have a TTY</span><br><span class="line">if [ $have_tty -eq 1 ]; then</span><br><span class="line">  echo &quot;Using CATALINA_BASE:   $CATALINA_BASE&quot;</span><br><span class="line">  echo &quot;Using CATALINA_HOME:   $CATALINA_HOME&quot;</span><br><span class="line">  echo &quot;Using CATALINA_TMPDIR: $CATALINA_TMPDIR&quot;</span><br><span class="line">  if [ &quot;$1&quot; = &quot;debug&quot; ] ; then</span><br><span class="line">    echo &quot;Using JAVA_HOME:       $JAVA_HOME&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;Using JRE_HOME:        $JRE_HOME&quot;</span><br><span class="line">  fi</span><br><span class="line">  echo &quot;Using CLASSPATH:       $CLASSPATH&quot;</span><br><span class="line">  if [ ! -z &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">    echo &quot;Using CATALINA_PID:    $CATALINA_PID&quot;</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$1&quot; = &quot;jpda&quot; ] ; then</span><br><span class="line">  if [ -z &quot;$JPDA_TRANSPORT&quot; ]; then</span><br><span class="line">    JPDA_TRANSPORT=&quot;dt_socket&quot;</span><br><span class="line">  fi</span><br><span class="line">  if [ -z &quot;$JPDA_ADDRESS&quot; ]; then</span><br><span class="line">    JPDA_ADDRESS=&quot;localhost:8000&quot;</span><br><span class="line">  fi</span><br><span class="line">  if [ -z &quot;$JPDA_SUSPEND&quot; ]; then</span><br><span class="line">    JPDA_SUSPEND=&quot;n&quot;</span><br><span class="line">  fi</span><br><span class="line">  if [ -z &quot;$JPDA_OPTS&quot; ]; then</span><br><span class="line">    JPDA_OPTS=&quot;-agentlib:jdwp=transport=$JPDA_TRANSPORT,address=$JPDA_ADDRESS,server=y,suspend=$JPDA_SUSPEND&quot;</span><br><span class="line">  fi</span><br><span class="line">  CATALINA_OPTS=&quot;$CATALINA_OPTS $JPDA_OPTS&quot;</span><br><span class="line">#shift 向左移动一个参数</span><br><span class="line">  shift</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$1&quot; = &quot;debug&quot; ] ; then</span><br><span class="line">  if $os400; then</span><br><span class="line">    echo &quot;Debug command not available on OS400&quot;</span><br><span class="line">    exit 1</span><br><span class="line">  else</span><br><span class="line">    shift</span><br><span class="line">    if [ &quot;$1&quot; = &quot;-security&quot; ] ; then</span><br><span class="line">      if [ $have_tty -eq 1 ]; then</span><br><span class="line">        echo &quot;Using Security Manager&quot;</span><br><span class="line">      fi</span><br><span class="line">      shift</span><br><span class="line">      exec &quot;$_RUNJDB&quot; &quot;$LOGGING_CONFIG&quot; $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \</span><br><span class="line">        -Djava.endorsed.dirs=&quot;$JAVA_ENDORSED_DIRS&quot; -classpath &quot;$CLASSPATH&quot; \</span><br><span class="line">        -sourcepath &quot;$CATALINA_HOME&quot;/../../java \</span><br><span class="line">        -Djava.security.manager \</span><br><span class="line">        -Djava.security.policy==&quot;$CATALINA_BASE&quot;/conf/catalina.policy \</span><br><span class="line">        -Dcatalina.base=&quot;$CATALINA_BASE&quot; \</span><br><span class="line">        -Dcatalina.home=&quot;$CATALINA_HOME&quot; \</span><br><span class="line">        -Djava.io.tmpdir=&quot;$CATALINA_TMPDIR&quot; \</span><br><span class="line">        org.apache.catalina.startup.Bootstrap &quot;$@&quot; start</span><br><span class="line">    else</span><br><span class="line">      exec &quot;$_RUNJDB&quot; &quot;$LOGGING_CONFIG&quot; $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \</span><br><span class="line">        -Djava.endorsed.dirs=&quot;$JAVA_ENDORSED_DIRS&quot; -classpath &quot;$CLASSPATH&quot; \</span><br><span class="line">        -sourcepath &quot;$CATALINA_HOME&quot;/../../java \</span><br><span class="line">        -Dcatalina.base=&quot;$CATALINA_BASE&quot; \</span><br><span class="line">        -Dcatalina.home=&quot;$CATALINA_HOME&quot; \</span><br><span class="line">        -Djava.io.tmpdir=&quot;$CATALINA_TMPDIR&quot; \</span><br><span class="line">        org.apache.catalina.startup.Bootstrap &quot;$@&quot; start</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">elif [ &quot;$1&quot; = &quot;run&quot; ]; then</span><br><span class="line"></span><br><span class="line">  shift</span><br><span class="line">  if [ &quot;$1&quot; = &quot;-security&quot; ] ; then</span><br><span class="line">    if [ $have_tty -eq 1 ]; then</span><br><span class="line">      echo &quot;Using Security Manager&quot;</span><br><span class="line">    fi</span><br><span class="line">    shift</span><br><span class="line">    eval exec &quot;\&quot;$_RUNJAVA\&quot;&quot; &quot;\&quot;$LOGGING_CONFIG\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \</span><br><span class="line">      -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">      -Djava.security.manager \</span><br><span class="line">      -Djava.security.policy==&quot;\&quot;$CATALINA_BASE/conf/catalina.policy\&quot;&quot; \</span><br><span class="line">      -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">      -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">      -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap &quot;$@&quot; start</span><br><span class="line">  else</span><br><span class="line">    eval exec &quot;\&quot;$_RUNJAVA\&quot;&quot; &quot;\&quot;$LOGGING_CONFIG\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \</span><br><span class="line">      -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">      -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">      -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">      -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap &quot;$@&quot; start</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">#start</span><br><span class="line">elif [ &quot;$1&quot; = &quot;start&quot; ] ; then</span><br><span class="line"></span><br><span class="line">#启动前如果pid存在，kill掉</span><br><span class="line">  if [ ! -z &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">    if [ -f &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">      if [ -s &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">        echo &quot;Existing PID file found during start.&quot;</span><br><span class="line">        if [ -r &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">          PID=`cat &quot;$CATALINA_PID&quot;`</span><br><span class="line">          ps -p $PID &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">          if [ $? -eq 0 ] ; then</span><br><span class="line">            echo &quot;Tomcat appears to still be running with PID $PID. Start aborted.&quot;</span><br><span class="line">            exit 1</span><br><span class="line">          else</span><br><span class="line">            echo &quot;Removing/clearing stale PID file.&quot;</span><br><span class="line">            rm -f &quot;$CATALINA_PID&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">            if [ $? != 0 ]; then</span><br><span class="line">              if [ -w &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">                cat /dev/null &gt; &quot;$CATALINA_PID&quot;</span><br><span class="line">              else</span><br><span class="line">                echo &quot;Unable to remove or clear stale PID file. Start aborted.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">              fi</span><br><span class="line">            fi</span><br><span class="line">          fi</span><br><span class="line">        else</span><br><span class="line">          echo &quot;Unable to read PID file. Start aborted.&quot;</span><br><span class="line">          exit 1</span><br><span class="line">        fi</span><br><span class="line">      else</span><br><span class="line">        rm -f &quot;$CATALINA_PID&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        if [ $? != 0 ]; then</span><br><span class="line">          if [ ! -w &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">            echo &quot;Unable to remove or write to empty PID file. Start aborted.&quot;</span><br><span class="line">            exit 1</span><br><span class="line">          fi</span><br><span class="line">        fi</span><br><span class="line">      fi</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  shift</span><br><span class="line">  touch &quot;$CATALINA_OUT&quot;</span><br><span class="line">  if [ &quot;$1&quot; = &quot;-security&quot; ] ; then</span><br><span class="line">    if [ $have_tty -eq 1 ]; then</span><br><span class="line">      echo &quot;Using Security Manager&quot;</span><br><span class="line">    fi</span><br><span class="line">    shift</span><br><span class="line">    eval &quot;\&quot;$_RUNJAVA\&quot;&quot; &quot;\&quot;$LOGGING_CONFIG\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \</span><br><span class="line">      -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">      -Djava.security.manager \</span><br><span class="line">      -Djava.security.policy==&quot;\&quot;$CATALINA_BASE/conf/catalina.policy\&quot;&quot; \</span><br><span class="line">      -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">      -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">      -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap &quot;$@&quot; start \</span><br><span class="line">      &gt;&gt; &quot;$CATALINA_OUT&quot; 2&gt;&amp;1 &quot;&amp;&quot;</span><br><span class="line"></span><br><span class="line">  else</span><br><span class="line"># 启动最关键的地方</span><br><span class="line">    eval &quot;\&quot;$_RUNJAVA\&quot;&quot; &quot;\&quot;$LOGGING_CONFIG\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \</span><br><span class="line">      -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">      -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">      -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">      -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap &quot;$@&quot; start \</span><br><span class="line">      &gt;&gt; &quot;$CATALINA_OUT&quot; 2&gt;&amp;1 &quot;&amp;&quot;</span><br><span class="line"></span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [ ! -z &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">    echo $! &gt; &quot;$CATALINA_PID&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  echo &quot;Tomcat started.&quot;</span><br><span class="line"></span><br><span class="line">elif [ &quot;$1&quot; = &quot;stop&quot; ] ; then</span><br><span class="line"></span><br><span class="line">  shift</span><br><span class="line"></span><br><span class="line">  SLEEP=5</span><br><span class="line">  if [ ! -z &quot;$1&quot; ]; then</span><br><span class="line">    echo $1 | grep &quot;[^0-9]&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    if [ $? -gt 0 ]; then</span><br><span class="line">      SLEEP=$1</span><br><span class="line">      shift</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  FORCE=0</span><br><span class="line">  if [ &quot;$1&quot; = &quot;-force&quot; ]; then</span><br><span class="line">    shift</span><br><span class="line">    FORCE=1</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [ ! -z &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">    if [ -f &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">      if [ -s &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">        kill -0 `cat &quot;$CATALINA_PID&quot;` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        if [ $? -gt 0 ]; then</span><br><span class="line">          echo &quot;PID file found but no matching process was found. Stop aborted.&quot;</span><br><span class="line">          exit 1</span><br><span class="line">        fi</span><br><span class="line">      else</span><br><span class="line">        echo &quot;PID file is empty and has been ignored.&quot;</span><br><span class="line">      fi</span><br><span class="line">    else</span><br><span class="line">      echo &quot;\$CATALINA_PID was set but the specified file does not exist. Is Tomcat running? Stop aborted.&quot;</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  eval &quot;\&quot;$_RUNJAVA\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS \</span><br><span class="line">    -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">    -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">    -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">    -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">    org.apache.catalina.startup.Bootstrap &quot;$@&quot; stop</span><br><span class="line"></span><br><span class="line">  # stop failed. Shutdown port disabled? Try a normal kill.</span><br><span class="line">  if [ $? != 0 ]; then</span><br><span class="line">    if [ ! -z &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">      echo &quot;The stop command failed. Attempting to signal the process to stop through OS signal.&quot;</span><br><span class="line">      kill -15 `cat &quot;$CATALINA_PID&quot;` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [ ! -z &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">    if [ -f &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">      while [ $SLEEP -ge 0 ]; do</span><br><span class="line">        kill -0 `cat &quot;$CATALINA_PID&quot;` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        if [ $? -gt 0 ]; then</span><br><span class="line">          rm -f &quot;$CATALINA_PID&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">          if [ $? != 0 ]; then</span><br><span class="line">            if [ -w &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">              cat /dev/null &gt; &quot;$CATALINA_PID&quot;</span><br><span class="line">              # If Tomcat has stopped don&#x27;t try and force a stop with an empty PID file</span><br><span class="line">              FORCE=0</span><br><span class="line">            else</span><br><span class="line">              echo &quot;The PID file could not be removed or cleared.&quot;</span><br><span class="line">            fi</span><br><span class="line">          fi</span><br><span class="line">          echo &quot;Tomcat stopped.&quot;</span><br><span class="line">          break</span><br><span class="line">        fi</span><br><span class="line">        if [ $SLEEP -gt 0 ]; then</span><br><span class="line">          sleep 1</span><br><span class="line">        fi</span><br><span class="line">        if [ $SLEEP -eq 0 ]; then</span><br><span class="line">          if [ $FORCE -eq 0 ]; then</span><br><span class="line">            echo &quot;Tomcat did not stop in time. PID file was not removed. To aid diagnostics a thread dump has been written to standard out.&quot;</span><br><span class="line">            kill -3 `cat &quot;$CATALINA_PID&quot;`</span><br><span class="line">          fi</span><br><span class="line">        fi</span><br><span class="line">        SLEEP=`expr $SLEEP - 1 `</span><br><span class="line">      done</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  KILL_SLEEP_INTERVAL=5</span><br><span class="line">  if [ $FORCE -eq 1 ]; then</span><br><span class="line">    if [ -z &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">      echo &quot;Kill failed: \$CATALINA_PID not set&quot;</span><br><span class="line">    else</span><br><span class="line">      if [ -f &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">        PID=`cat &quot;$CATALINA_PID&quot;`</span><br><span class="line">        echo &quot;Killing Tomcat with the PID: $PID&quot;</span><br><span class="line">        kill -9 $PID</span><br><span class="line">        while [ $KILL_SLEEP_INTERVAL -ge 0 ]; do</span><br><span class="line">            kill -0 `cat &quot;$CATALINA_PID&quot;` &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">            if [ $? -gt 0 ]; then</span><br><span class="line">                rm -f &quot;$CATALINA_PID&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">                if [ $? != 0 ]; then</span><br><span class="line">                    if [ -w &quot;$CATALINA_PID&quot; ]; then</span><br><span class="line">                        cat /dev/null &gt; &quot;$CATALINA_PID&quot;</span><br><span class="line">                    else</span><br><span class="line">                        echo &quot;The PID file could not be removed.&quot;</span><br><span class="line">                    fi</span><br><span class="line">                fi</span><br><span class="line">                # Set this to zero else a warning will be issued about the process still running</span><br><span class="line">                KILL_SLEEP_INTERVAL=0</span><br><span class="line">                echo &quot;The Tomcat process has been killed.&quot;</span><br><span class="line">                break</span><br><span class="line">            fi</span><br><span class="line">            if [ $KILL_SLEEP_INTERVAL -gt 0 ]; then</span><br><span class="line">                sleep 1</span><br><span class="line">            fi</span><br><span class="line">            KILL_SLEEP_INTERVAL=`expr $KILL_SLEEP_INTERVAL - 1 `</span><br><span class="line">        done</span><br><span class="line">        if [ $KILL_SLEEP_INTERVAL -gt 0 ]; then</span><br><span class="line">            echo &quot;Tomcat has not been killed completely yet. The process might be waiting on some system call or might be UNINTERRUPTIBLE.&quot;</span><br><span class="line">        fi</span><br><span class="line">      fi</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">elif [ &quot;$1&quot; = &quot;configtest&quot; ] ; then</span><br><span class="line"></span><br><span class="line">    eval &quot;\&quot;$_RUNJAVA\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS \</span><br><span class="line">      -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">      -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">      -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">      -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">      org.apache.catalina.startup.Bootstrap configtest</span><br><span class="line">    result=$?</span><br><span class="line">    if [ $result -ne 0 ]; then</span><br><span class="line">        echo &quot;Configuration error detected!&quot;</span><br><span class="line">    fi</span><br><span class="line">    exit $result</span><br><span class="line"></span><br><span class="line">elif [ &quot;$1&quot; = &quot;version&quot; ] ; then</span><br><span class="line"></span><br><span class="line">    &quot;$_RUNJAVA&quot;   \</span><br><span class="line">      -classpath &quot;$CATALINA_HOME/lib/catalina.jar&quot; \</span><br><span class="line">      org.apache.catalina.util.ServerInfo</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">  echo &quot;Usage: catalina.sh ( commands ... )&quot;</span><br><span class="line">  echo &quot;commands:&quot;</span><br><span class="line">  if $os400; then</span><br><span class="line">    echo &quot;  debug             Start Catalina in a debugger (not available on OS400)&quot;</span><br><span class="line">    echo &quot;  debug -security   Debug Catalina with a security manager (not available on OS400)&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;  debug             Start Catalina in a debugger&quot;</span><br><span class="line">    echo &quot;  debug -security   Debug Catalina with a security manager&quot;</span><br><span class="line">  fi</span><br><span class="line">  echo &quot;  jpda start        Start Catalina under JPDA debugger&quot;</span><br><span class="line">  echo &quot;  run               Start Catalina in the current window&quot;</span><br><span class="line">  echo &quot;  run -security     Start in the current window with security manager&quot;</span><br><span class="line">  echo &quot;  start             Start Catalina in a separate window&quot;</span><br><span class="line">  echo &quot;  start -security   Start in a separate window with security manager&quot;</span><br><span class="line">  echo &quot;  stop              Stop Catalina, waiting up to 5 seconds for the process to end&quot;</span><br><span class="line">  echo &quot;  stop n            Stop Catalina, waiting up to n seconds for the process to end&quot;</span><br><span class="line">  echo &quot;  stop -force       Stop Catalina, wait up to 5 seconds and then use kill -KILL if still running&quot;</span><br><span class="line">  echo &quot;  stop n -force     Stop Catalina, wait up to n seconds and then use kill -KILL if still running&quot;</span><br><span class="line">  echo &quot;  configtest        Run a basic syntax check on server.xml - check exit code for result&quot;</span><br><span class="line">  echo &quot;  version           What version of tomcat are you running?&quot;</span><br><span class="line">  echo &quot;Note: Waiting for the process to end and use of the -force option require that \$CATALINA_PID is defined&quot;</span><br><span class="line">  exit 1</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p> setclasspath.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line"># Make sure prerequisite environment variables are set</span><br><span class="line">if [ -z &quot;$JAVA_HOME&quot; -a -z &quot;$JRE_HOME&quot; ]; then</span><br><span class="line">  if $darwin; then</span><br><span class="line">    # Bugzilla 54390</span><br><span class="line">    if [ -x &#x27;/usr/libexec/java_home&#x27; ] ; then</span><br><span class="line">      export JAVA_HOME=`/usr/libexec/java_home`</span><br><span class="line">    # Bugzilla 37284 (reviewed).</span><br><span class="line">    elif [ -d &quot;/System/Library/Frameworks/JavaVM.framework/Versions/CurrentJDK/Home&quot; ]; then</span><br><span class="line">      export JAVA_HOME=&quot;/System/Library/Frameworks/JavaVM.framework/Versions/CurrentJDK/Home&quot;</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    JAVA_PATH=`which java 2&gt;/dev/null`</span><br><span class="line">    if [ &quot;x$JAVA_PATH&quot; != &quot;x&quot; ]; then</span><br><span class="line">      JAVA_PATH=`dirname $JAVA_PATH 2&gt;/dev/null`</span><br><span class="line">      JRE_HOME=`dirname $JAVA_PATH 2&gt;/dev/null`</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;x$JRE_HOME&quot; = &quot;x&quot; ]; then</span><br><span class="line">      # XXX: Should we try other locations?</span><br><span class="line">      if [ -x /usr/bin/java ]; then</span><br><span class="line">        JRE_HOME=/usr</span><br><span class="line">      fi</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">  if [ -z &quot;$JAVA_HOME&quot; -a -z &quot;$JRE_HOME&quot; ]; then</span><br><span class="line">    echo &quot;Neither the JAVA_HOME nor the JRE_HOME environment variable is defined&quot;</span><br><span class="line">    echo &quot;At least one of these environment variable is needed to run this program&quot;</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line">if [ -z &quot;$JAVA_HOME&quot; -a &quot;$1&quot; = &quot;debug&quot; ]; then</span><br><span class="line">  echo &quot;JAVA_HOME should point to a JDK in order to run in debug mode.&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line">if [ -z &quot;$JRE_HOME&quot; ]; then</span><br><span class="line">  JRE_HOME=&quot;$JAVA_HOME&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># If we&#x27;re running under jdb, we need a full jdk.</span><br><span class="line">if [ &quot;$1&quot; = &quot;debug&quot; ] ; then</span><br><span class="line">  if [ &quot;$os400&quot; = &quot;true&quot; ]; then</span><br><span class="line">    if [ ! -x &quot;$JAVA_HOME&quot;/bin/java -o ! -x &quot;$JAVA_HOME&quot;/bin/javac ]; then</span><br><span class="line">      echo &quot;The JAVA_HOME environment variable is not defined correctly&quot;</span><br><span class="line">      echo &quot;This environment variable is needed to run this program&quot;</span><br><span class="line">      echo &quot;NB: JAVA_HOME should point to a JDK not a JRE&quot;</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    if [ ! -x &quot;$JAVA_HOME&quot;/bin/java -o ! -x &quot;$JAVA_HOME&quot;/bin/jdb -o ! -x &quot;$JAVA_HOME&quot;/bin/javac ]; then</span><br><span class="line">      echo &quot;The JAVA_HOME environment variable is not defined correctly&quot;</span><br><span class="line">      echo &quot;This environment variable is needed to run this program&quot;</span><br><span class="line">      echo &quot;NB: JAVA_HOME should point to a JDK not a JRE&quot;</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Don&#x27;t override the endorsed dir if the user has set it previously</span><br><span class="line">if [ -z &quot;$JAVA_ENDORSED_DIRS&quot; ]; then</span><br><span class="line">  # Set the default -Djava.endorsed.dirs argument</span><br><span class="line">  JAVA_ENDORSED_DIRS=&quot;$CATALINA_HOME&quot;/endorsed</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 设置_RUNJAVA</span><br><span class="line">_RUNJAVA=&quot;$JRE_HOME&quot;/bin/java</span><br><span class="line">if [ &quot;$os400&quot; != &quot;true&quot; ]; then</span><br><span class="line">  _RUNJDB=&quot;$JAVA_HOME&quot;/bin/jdb</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>start最关键的地方<br>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">eval &quot;\&quot;$_RUNJAVA\&quot;&quot; &quot;\&quot;$LOGGING_CONFIG\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \</span><br><span class="line">    -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">    -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">    -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">    -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">    org.apache.catalina.startup.Bootstrap &quot;$@&quot; start \</span><br><span class="line">    &gt;&gt; &quot;$CATALINA_OUT&quot; 2&gt;&amp;1 &quot;&amp;&quot;</span><br></pre></td></tr></table></figure></p>
<p>stop最关键的地方<br>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">eval &quot;\&quot;$_RUNJAVA\&quot;&quot; $LOGGING_MANAGER $JAVA_OPTS \</span><br><span class="line">    -Djava.endorsed.dirs=&quot;\&quot;$JAVA_ENDORSED_DIRS\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; \</span><br><span class="line">    -Dcatalina.base=&quot;\&quot;$CATALINA_BASE\&quot;&quot; \</span><br><span class="line">    -Dcatalina.home=&quot;\&quot;$CATALINA_HOME\&quot;&quot; \</span><br><span class="line">    -Djava.io.tmpdir=&quot;\&quot;$CATALINA_TMPDIR\&quot;&quot; \</span><br><span class="line">    org.apache.catalina.startup.Bootstrap &quot;$@&quot; stop</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/79fd2ad8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/hexo/post/79fd2ad8.html" class="post-title-link" itemprop="url">Spring AOP 源码解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-09 22:42:29" itemprop="dateCreated datePublished" datetime="2018-03-09T22:42:29+08:00">2018-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>首先通过继承BeanDefinitionParser的触发过程看<a href="http://www1350.github.io/#post/84">http://www1350.github.io/#post/84</a></p>
<p><img src="https://user-images.githubusercontent.com/7789698/37197018-fc2e50b4-23b3-11e8-90bb-3d4ff69603ce.png" alt="sequencediagram11"></p>
<p>通过继承NamespaceHandlerSupport来注册，最核心的类就是AnnotationAwareAspectJAutoProxyCreator</p>
<img width="1074" alt="sssxx2 2x" src="https://user-images.githubusercontent.com/7789698/37197055-1d5bbd44-23b4-11e8-9784-cd943486df30.png">
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/hexo/post/79fd2ad8.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/hexo/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/hexo/">1</a><span class="space">&hellip;</span><a class="page-number" href="/hexo/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/hexo/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/hexo/page/8/">8</a><a class="extend next" rel="next" href="/hexo/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Absurd</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/hexo/js/comments.js"></script><script src="/hexo/js/utils.js"></script><script src="/hexo/js/motion.js"></script><script src="/hexo/js/schemes/muse.js"></script><script src="/hexo/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/hexo/js/third-party/search/local-search.js"></script>





  





</body>
</html>
