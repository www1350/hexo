<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/hexo/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hexo/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hexo/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/hexo/images/logo.svg" color="#222">

<link rel="stylesheet" href="/hexo/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www1350.github.io","root":"/hexo/","images":"/hexo/images","scheme":"Mist","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/hexo/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/hexo/js/config.js"></script>
<meta name="description" content="cglib（字节码生成库）是一个生成和转化Java字节码的高级api。被使用在AOP上。在实现内部，CGLIB库使用了ASM这一个轻量但高性能的字节码操作框架来转化字节码，产生新类 Enhancer是cglib一个很重要的类。Enhancer动态创建一个子类。 Enhancer只能在java字节码级别构造方法，但是不能构造static或者final类。 123456public Object cr">
<meta property="og:type" content="article">
<meta property="og:title" content="Cglib">
<meta property="og:url" content="https://www1350.github.io/hexo/post/29cef8e0.html">
<meta property="og:site_name" content="Absurd博客">
<meta property="og:description" content="cglib（字节码生成库）是一个生成和转化Java字节码的高级api。被使用在AOP上。在实现内部，CGLIB库使用了ASM这一个轻量但高性能的字节码操作框架来转化字节码，产生新类 Enhancer是cglib一个很重要的类。Enhancer动态创建一个子类。 Enhancer只能在java字节码级别构造方法，但是不能构造static或者final类。 123456public Object cr">
<meta property="og:locale">
<meta property="article:published_time" content="2017-08-31T14:40:21.000Z">
<meta property="article:modified_time" content="2022-01-28T07:09:17.719Z">
<meta property="article:author" content="Absurd">
<meta property="article:tag" content="Cglib">
<meta property="article:tag" content="java">
<meta property="article:tag" content="字节码">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www1350.github.io/hexo/post/29cef8e0.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"https://www1350.github.io/hexo/post/29cef8e0.html","path":"post/29cef8e0.html","title":"Cglib"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Cglib | Absurd博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/hexo/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/hexo/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Absurd博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/hexo/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/hexo/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/hexo/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/hexo/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/hexo/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-bookmarks"><a href="/hexo/bookmarks/" rel="section"><i class="fa fa-archive fa-fw"></i>bookmarks</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Absurd"
      src="/hexo/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Absurd</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/hexo/archives/">
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/hexo/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/hexo/tags/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/www1350" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;www1350" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:www_1350@163.com" title="E-Mail → mailto:www_1350@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www1350.github.io/hexo/post/29cef8e0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo/images/avatar.gif">
      <meta itemprop="name" content="Absurd">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Absurd博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cglib
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-08-31 22:40:21" itemprop="dateCreated datePublished" datetime="2017-08-31T22:40:21+08:00">2017-08-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-28 15:09:17" itemprop="dateModified" datetime="2022-01-28T15:09:17+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/hexo/categories/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>cglib（字节码生成库）是一个生成和转化Java字节码的高级api。被使用在AOP上。在实现内部，CGLIB库使用了ASM这一个轻量但高性能的字节码操作框架来转化字节码，产生新类</p>
<p>Enhancer是cglib一个很重要的类。Enhancer动态创建一个子类。</p>
<p>Enhancer只能在java字节码级别构造方法，但是不能构造static或者final类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Object createProxy(Class targetClass) &#123;</span><br><span class="line">     Enhancer enhancer = new Enhancer();</span><br><span class="line">     enhancer.setSuperclass(targetClass);</span><br><span class="line">     enhancer.setCallback(NoOp.INSTANCE);</span><br><span class="line">     return enhancer.create();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在例子中，默认的无参构造方法被使用来创建目标对象。如果你希望CGLIB创建一个有参数的实例，你应该使用net.sf.cglib.proxy.Enhancer.create(Class[], Object[])。NoOp是内置的一个类，可以看下源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface NoOp extends Callback &#123;</span><br><span class="line">    NoOp INSTANCE = new NoOp() &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class SampleClass &#123;</span><br><span class="line">  public String test(String input) &#123;</span><br><span class="line">    return &quot;Hello world!&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testFixedValue() throws Exception &#123;</span><br><span class="line">  Enhancer enhancer = new Enhancer();</span><br><span class="line">  enhancer.setSuperclass(SampleClass.class);</span><br><span class="line">  enhancer.setCallback(new FixedValue() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Object loadObject() throws Exception &#123;</span><br><span class="line">      return &quot;Hello cglib!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  SampleClass proxy = (SampleClass) enhancer.create();</span><br><span class="line">  assertEquals(&quot;Hello cglib!&quot;, proxy.test(null));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的方式，任何方法都会被代理。比如proxy.toString()会返回”Hello cglib!” ，proxy.hashCode()则会抛出ClassCastException异常因为hashcode需要整数。此外final方法不会被拦截。Object#getClass 会返回类似 “SampleClass$$EnhancerByCGLIB$$e277c63c”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testInvocationHandler() throws Exception &#123;</span><br><span class="line">  Enhancer enhancer = new Enhancer();</span><br><span class="line">  enhancer.setSuperclass(SampleClass.class);</span><br><span class="line">  enhancer.setCallback(new InvocationHandler() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args)</span><br><span class="line">        throws Throwable &#123;</span><br><span class="line">      if(method.getDeclaringClass() != Object.class &amp;&amp; method.getReturnType() == String.class) &#123;</span><br><span class="line">        return &quot;Hello cglib!&quot;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Do not know what to do.&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  SampleClass proxy = (SampleClass) enhancer.create();</span><br><span class="line">  assertEquals(&quot;Hello cglib!&quot;, proxy.test(null));</span><br><span class="line">  assertNotEquals(&quot;Hello cglib!&quot;, proxy.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有调用方法将会分发到相同的InvocationHandler可能会导致死循环.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testMethodInterceptor() throws Exception &#123;</span><br><span class="line">  Enhancer enhancer = new Enhancer();</span><br><span class="line">  enhancer.setSuperclass(SampleClass.class);</span><br><span class="line">  enhancer.setCallback(new MethodInterceptor() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy)</span><br><span class="line">        throws Throwable &#123;</span><br><span class="line">      if(method.getDeclaringClass() != Object.class &amp;&amp; method.getReturnType() == String.class) &#123;</span><br><span class="line">        return &quot;Hello cglib!&quot;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return proxy.invokeSuper(obj, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  SampleClass proxy = (SampleClass) enhancer.create();</span><br><span class="line">  assertEquals(&quot;Hello cglib!&quot;, proxy.test(null));</span><br><span class="line">  assertNotEquals(&quot;Hello cglib!&quot;, proxy.toString());</span><br><span class="line">  proxy.hashCode(); // Does not throw an exception or result in an endless loop.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MethodInterceptor的创建和链接需要生成不同类型的字节码和一些不需要Invocationhandler就能产生的运行对象</p>
<blockquote>
<p>LazyLoader: Even though the LazyLoader’s only method has the same method signature as FixedValue, the LazyLoader is fundamentally different to the FixedValue interceptor. The LazyLoader is actually supposed to return an instance of a subclass of the enhanced class. This instance is requested only when a method is called on the enhanced object and then stored for future invocations of the generated proxy. This makes sense if your object is expensive in its creation without knowing if the object will ever be used. Be aware that some constructor of the enhanced class must be called both for the proxy object and for the lazily loaded object. Thus, make sure that there is another cheap (maybe protected) constructor available or use an interface type for the proxy. You can choose the invoked constructed by supplying arguments to Enhancer#create(Object…).在被代理对象需要懒加载场景下非常有用，如果被代理对象加载完成，那么在以后的代理调用时会重复使用。</p>
<p>Dispatcher: The Dispatcher is like the LazyLoader but will be invoked on every method call without storing the loaded object. This allows to change the implementation of a class without changing the reference to it. Again, be aware that some constructor must be called for both the proxy and the generated objects.与net.sf.cglib.proxy.LazyLoader差不多，但每次调用代理方法时都会调用loadObject方法来加载被代理对象。</p>
<p>ProxyRefDispatcher: This class carries a reference to the proxy object it is invoked from in its signature. This allows for example to delegate method calls to another method of this proxy. Be aware that this can easily cause an endless loop and will always cause an endless loop if the same method is called from within ProxyRefDispatcher#loadObject(Object).与Dispatcher相同，但它的loadObject方法支持传入代理对象。</p>
<p>NoOp: The NoOp class does not what its name suggests. Instead, it delegates each method call to the enhanced class’s method implementation.</p>
</blockquote>
<p>net.sf.cglib.proxy.CallbackFilter允许你在方法级别设置回调。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class PersistenceServiceImpl implements PersistenceService &#123;</span><br><span class="line"></span><br><span class="line">    public void save(long id, String data) &#123;</span><br><span class="line">        System.out.println(data + &quot; has been saved successfully.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String load(long id) &#123;</span><br><span class="line">        return &quot;Jason Zhicheng Li&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>accept方法将代理方法映射到回调。方法返回值是一个回调对象数组中的下标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class PersistenceServiceCallbackFilter implements CallbackFilter &#123;</span><br><span class="line"></span><br><span class="line">    //callback index for save method</span><br><span class="line">    private static final int SAVE = 0;</span><br><span class="line"></span><br><span class="line">    //callback index for load method</span><br><span class="line">    private static final int LOAD = 1;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specify which callback to use for the method being invoked.</span><br><span class="line">     * @method the method being invoked.</span><br><span class="line">     * @return the callback index in the callback array for this method</span><br><span class="line">     */</span><br><span class="line">    public int accept(Method method) &#123;</span><br><span class="line">        String name = method.getName();</span><br><span class="line">        if (&quot;save&quot;.equals(name)) &#123;</span><br><span class="line">            return SAVE;</span><br><span class="line">        &#125;</span><br><span class="line">        // for other methods, including the load method, use the</span><br><span class="line">        // second callback</span><br><span class="line">        return LOAD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Enhancer enhancer = new Enhancer();</span><br><span class="line">enhancer.setSuperclass(PersistenceServiceImpl.class);</span><br><span class="line"></span><br><span class="line">CallbackFilter callbackFilter = new PersistenceServiceCallbackFilter();</span><br><span class="line">enhancer.setCallbackFilter(callbackFilter);</span><br><span class="line"></span><br><span class="line">AuthorizationService authorizationService = ...</span><br><span class="line">Callback saveCallback = new AuthorizationInterceptor(authorizationService);</span><br><span class="line">Callback loadCallback = NoOp.INSTANCE;</span><br><span class="line">Callback[] callbacks = new Callback[]&#123;saveCallback, loadCallback &#125;;</span><br><span class="line">enhancer.setCallbacks(callbacks);</span><br><span class="line">...</span><br><span class="line">return (PersistenceServiceImpl)enhancer.create();</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testCallbackFilter() throws Exception &#123;</span><br><span class="line">  Enhancer enhancer = new Enhancer();</span><br><span class="line">  CallbackHelper callbackHelper = new CallbackHelper(SampleClass.class, new Class[0]) &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected Object getCallback(Method method) &#123;</span><br><span class="line">      if(method.getDeclaringClass() != Object.class &amp;&amp; method.getReturnType() == String.class) &#123;</span><br><span class="line">        return new FixedValue() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public Object loadObject() throws Exception &#123;</span><br><span class="line">            return &quot;Hello cglib!&quot;;</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return NoOp.INSTANCE; // A singleton provided by NoOp.</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  enhancer.setSuperclass(MyClass.class);</span><br><span class="line">  enhancer.setCallbackFilter(callbackHelper);</span><br><span class="line">  enhancer.setCallbacks(callbackHelper.getCallbacks());</span><br><span class="line">  SampleClass proxy = (SampleClass) enhancer.create();</span><br><span class="line">  assertEquals(&quot;Hello cglib!&quot;, proxy.test(null));</span><br><span class="line">  assertNotEquals(&quot;Hello cglib!&quot;, proxy.toString());</span><br><span class="line">  proxy.hashCode(); // Does not throw an exception or result in an endless loop.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Bean generator</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testBeanGenerator() throws Exception &#123;</span><br><span class="line">  BeanGenerator beanGenerator = new BeanGenerator();</span><br><span class="line">  beanGenerator.addProperty(&quot;value&quot;, String.class);</span><br><span class="line">  Object myBean = beanGenerator.create();</span><br><span class="line">   </span><br><span class="line">  Method setter = myBean.getClass().getMethod(&quot;setValue&quot;, String.class);</span><br><span class="line">  setter.invoke(myBean, &quot;Hello cglib!&quot;);</span><br><span class="line">  Method getter = myBean.getClass().getMethod(&quot;getValue&quot;);</span><br><span class="line">  assertEquals(&quot;Hello cglib!&quot;, getter.invoke(myBean));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Bean copier</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class OtherSampleBean &#123;</span><br><span class="line">  private String value;</span><br><span class="line">  public String getValue() &#123;</span><br><span class="line">    return value;</span><br><span class="line">  &#125;</span><br><span class="line">  public void setValue(String value) &#123;</span><br><span class="line">    this.value = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void testBeanCopier() throws Exception &#123;</span><br><span class="line">  BeanCopier copier = BeanCopier.create(SampleBean.class, OtherSampleBean.class, false);</span><br><span class="line">  SampleBean bean = new SampleBean();</span><br><span class="line">  bean.setValue(&quot;Hello cglib!&quot;);</span><br><span class="line">  OtherSampleBean otherBean = new OtherSampleBean();</span><br><span class="line">  copier.copy(bean, otherBean, null);</span><br><span class="line">  assertEquals(&quot;Hello cglib!&quot;, otherBean.getValue()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Bulk bean</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testBulkBean() throws Exception &#123;</span><br><span class="line">  BulkBean bulkBean = BulkBean.create(SampleBean.class,</span><br><span class="line">      new String[]&#123;&quot;getValue&quot;&#125;,</span><br><span class="line">      new String[]&#123;&quot;setValue&quot;&#125;,</span><br><span class="line">      new Class[]&#123;String.class&#125;);</span><br><span class="line">  SampleBean bean = new SampleBean();</span><br><span class="line">  bean.setValue(&quot;Hello world!&quot;);</span><br><span class="line">  assertEquals(1, bulkBean.getPropertyValues(bean).length);</span><br><span class="line">  assertEquals(&quot;Hello world!&quot;, bulkBean.getPropertyValues(bean)[0]);</span><br><span class="line">  bulkBean.setPropertyValues(bean, new Object[] &#123;&quot;Hello cglib!&quot;&#125;);</span><br><span class="line">  assertEquals(&quot;Hello cglib!&quot;, bean.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Bean map</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testBeanGenerator() throws Exception &#123;</span><br><span class="line">  SampleBean bean = new SampleBean();</span><br><span class="line">  BeanMap map = BeanMap.create(bean);</span><br><span class="line">  bean.setValue(&quot;Hello cglib!&quot;);</span><br><span class="line">  assertEquals(&quot;Hello cglib&quot;, map.get(&quot;value&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://github.com/cglib/cglib/wiki/Tutorial">https://github.com/cglib/cglib/wiki/Tutorial</a></p>
<p>AOP源码如下～</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// Configure CGLIB Enhancer...</span><br><span class="line">Enhancer enhancer = createEnhancer();</span><br><span class="line">if (classLoader != null) &#123;</span><br><span class="line">	enhancer.setClassLoader(classLoader);</span><br><span class="line">	if (classLoader instanceof SmartClassLoader &amp;&amp;</span><br><span class="line">	((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">		enhancer.setUseCache(false);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">enhancer.setSuperclass(proxySuperClass);</span><br><span class="line">enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(this.advised));</span><br><span class="line">enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">enhancer.setStrategy(new ClassLoaderAwareUndeclaredThrowableStrategy(classLoader));</span><br><span class="line"></span><br><span class="line">Callback[] callbacks = getCallbacks(rootClass);</span><br><span class="line">Class&lt;?&gt;[] types = new Class&lt;?&gt;[callbacks.length];</span><br><span class="line">for (int x = 0; x &lt; types.length; x++) &#123;</span><br><span class="line">	types[x] = callbacks[x].getClass();</span><br><span class="line">&#125;</span><br><span class="line">// fixedInterceptorMap only populated at this point, after getCallbacks call above</span><br><span class="line">enhancer.setCallbackFilter(new ProxyCallbackFilter(</span><br><span class="line">	this.advised.getConfigurationOnlyCopy(), this.fixedInterceptorMap, this.fixedInterceptorOffset));</span><br><span class="line">enhancer.setCallbackTypes(types);</span><br><span class="line"></span><br><span class="line">protected Object createProxyClassAndInstance(Enhancer enhancer, Callback[] callbacks) &#123;</span><br><span class="line">	enhancer.setInterceptDuringConstruction(false);</span><br><span class="line">	enhancer.setCallbacks(callbacks);</span><br><span class="line">	return (this.constructorArgs != null ?</span><br><span class="line">			enhancer.create(this.constructorArgTypes, this.constructorArgs) :</span><br><span class="line">			enhancer.create());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/hexo/images/wechatpay.png" alt="Absurd WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/hexo/tags/Cglib/" rel="tag"># Cglib</a>
              <a href="/hexo/tags/java/" rel="tag"># java</a>
              <a href="/hexo/tags/%E5%AD%97%E8%8A%82%E7%A0%81/" rel="tag"># 字节码</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/hexo/post/dfdc2005.html" rel="prev" title="JDK动态代理">
                  <i class="fa fa-chevron-left"></i> JDK动态代理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/hexo/post/2400ed9b.html" rel="next" title="SPI">
                  SPI <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Absurd</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/hexo/js/comments.js"></script><script src="/hexo/js/utils.js"></script><script src="/hexo/js/motion.js"></script><script src="/hexo/js/schemes/muse.js"></script><script src="/hexo/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/hexo/js/third-party/search/local-search.js"></script>





  





</body>
</html>
